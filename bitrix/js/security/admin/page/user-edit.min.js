BX.namespace("BX.Security.UserEdit");BX.Security.UserEdit.Otp=function t(e){"use strict";var i=function(t,i){var o={successfulUrl:document.location.href,deactivateDays:null,availableTypes:null,ui:{activateButtonId:"otp-activate",deactivateButtonId:"otp-deactivate",defferButtonId:"otp-deffer",mandatoryActivateButtonId:"otp-mandatory-active",reinitializeButtonId:"otp-reinitialize"}};i=i||{};this._options=c(o,i);this.userId=t||0;var a={availableTypes:this._options.availableTypes,successfulUrl:this._options.successfulUrl};this.device=new s(this.userId,a);this.mobile=new n(this.userId,a);this.recovery=new r(this.userId,a);var l=e(this._options.ui.deactivateButtonId);if(l){this.initializeDeactivatePopup(l,"deactivate")}l=e(this._options.ui.defferButtonId);if(l){this.initializeDeactivatePopup(l,"deffer")}l=e(this._options.ui.mandatoryActivateButtonId);if(l){this.initializeDeactivatePopup(l,"deffer",5)}l=e(this._options.ui.activateButtonId);if(l){e.bind(l,"click",this.mobile.activateOtp.bind(this.mobile))}l=e(this._options.ui.reinitializeButtonId);if(l){e.bind(l,"click",e.proxy((function t(){var e=window.document.body.querySelectorAll('[data-show-on-reinitialize="yes"]');[].forEach.call(e,(function t(e){if(e.style.display)e.style.display="";else e.style.display="none"}),this)}),this))}};i.prototype.initializeDeactivatePopup=function(t,i,o){i=i||"deactivate";if(this._options.deactivateDays){var s=[];for(var n in this._options.deactivateDays){if(!this._options.deactivateDays.hasOwnProperty(n))continue;if(o&&n<o)continue;s.push({TEXT:this._options.deactivateDays[n],ONCLICK:this.mobile.deactivateOtp.bind(this.mobile,null,i,n)})}e.bind(t,"click",function(i){if(i)i.preventDefault();e.adminShowMenu(t,s,{active_class:"",close_on_click:true})}.bind(this))}else{e.bind(t,"click",this.mobile.deactivateOtp.bind(this,null,i,o?o:0))}};var o=function(t,i){var o={actionUrl:"/bitrix/admin/security_otp.ajax.php?lang="+e.message("LANGUAGE_ID"),onCompleteCallback:e.DoNothing,ui:{showButtonId:null,id:null}};i=i||{};this._options=c(o,i);this.initialized=false;this.popup=null;this.container=null;this.userId=t;this.showButton=e(this._options.ui.showButtonId);this.type=null;this.deviceInfo=null;this.typeMenu=[];e.bind(this.showButton,"click",this.show.bind(this))};o.prototype.show=function(t){if(!this.initialized)this.initialize();else this.cleanPopup();this.onShow();if(t)t.preventDefault()};o.prototype.onShow=function(){};o.prototype.onInitialize=function(){};o.prototype.getSecret=function(){};o.prototype.getStartTimestamp=function(){};o.prototype.getType=function(){return this.type};o.prototype.initialize=function(){this.initialized=true;this.container=e(this._options.ui.id);this.popup=this.getPopup();for(var t in this._options.availableTypes){if(!this._options.availableTypes.hasOwnProperty(t)){continue}if(!this._options.mobile&&this._options.availableTypes[t]["mobile_only"]){continue}this.typeMenu.push({TEXT:this._options.availableTypes[t].title,ONCLICK:function t(e,i){if(e==="push"){this.mobilePush.show()}else{this.type=e;if(i===void 0){i=true}this.onShow(true,i)}}.bind(this,this._options.availableTypes[t].type,this._options.availableTypes[t]["required_two_code"])})}var i=this.container.querySelectorAll('input[data-role="check-code"]');this.popup.ClearButtons();this.popup.SetButtons([{title:e.message("JS_CORE_WINDOW_SAVE"),id:"check-button",className:"adm-btn-save",action:function t(e){if(e)e.preventDefault();this.onCheck(i[0],i[1]||null)}.bind(this)},e.CDialog.btnCancel]);this.onInitialize()};o.prototype.getPopup=function(){return new e.CDialog({title:this.container.getAttribute("data-title")||"",resizable:false,content:this.container})};o.prototype.cleanPopup=function(){[].forEach.call(this.container.querySelectorAll('[data-autoclear="yes"]'),(function t(i){switch(i.tagName){case"INPUT":i.value="";break;case"SELECT":break;default:e.cleanNode(i)}}),this)};o.prototype.sendRequest=function(t,i,o,s){e.showWait();i=i||{};i.action=t||"check";i.sessid=e.bitrix_sessid();if(!i.userId)i.user=this.userId;i=e.ajax.prepareData(i);return e.ajax({method:"POST",dataType:"json",url:this._options["actionUrl"],data:i,onsuccess:this.onRequestSuccess.bind(this,o),onfailure:this.onRequestFailed.bind(this,s)})};o.prototype.onRequestSuccess=function(t,i){e.closeWait();if(!i["status"]){this.onRequestFailed(null,i)}else if(i["status"]!=="ok"){this.onRequestFailed(null,i)}else{t(i)}};o.prototype.onRequestFailed=function(t,i){e.closeWait();if(!t){if(i["error"])this.showError(i["error"]);else this.showError(e.message("SEC_OTP_UNKNOWN_ERROR"))}else{t(i)}};o.prototype.showError=function(t){e.UI.Dialogs.MessageBox.alert('<span class="otp-error-wrapper">'+t+"</span>",e.message("SEC_OTP_ERROR_TITLE"))};o.prototype.onCheck=function(t,e){this.activate(t.value,e?e.value:"")};o.prototype.activate=function(t,i){var o={secret:this.getSecret(),type:this.getType(),startTimestamp:this.getStartTimestamp(),deviceInfo:this.deviceInfo,sync1:t,sync2:i};this.sendRequest("check_activate",o,e.proxy(this.onFinish,this))};o.prototype.onFinish=function(){window.location.replace(this._options.successfulUrl)};o.prototype.showPopup=function(){this.popup.Show();this.popup.adjustSizeEx();e.defer(this.popup.adjustPos,this.popup)()};o.prototype.showTypeTitle=function(t){var e=this.container.querySelectorAll("[data-show-type]");[].forEach.call(e,(function e(i){if(i.getAttribute("data-show-type")==t)i.style.display="";else i.style.display="none"}))};o.prototype.showHideRedundantCodes=function(t){var e=this.container.querySelectorAll('[data-require-two-codes="yes"]');[].forEach.call(e,(function e(i){if(t)i.style.display="";else i.style.display="none"}))};var s=function(t,e){var i={ui:{showButtonId:"otp-connect-device",id:"otp-device-popup"}};e=e||{};e=c(i,e);this.secretCodeElement=null;this.startTimestampElement=null;this.typeElement=null;s.superclass.constructor.call(this,t,e)};e.extend(s,o);s.prototype.onShow=function(t,i){if(!t&&this.typeMenu.length){e.adminShowMenu(this.showButton,this.typeMenu,{active_class:"adm-btn-save-active"});return}this.showHideRedundantCodes(i);this.showTypeTitle(this.type);this.showPopup()};s.prototype.onInitialize=function(){this.secretCodeElement=this.container.querySelector('[data-role="secret-code"]');this.typeElement=this.container.querySelector('[data-role="type-selector"]');this.startTimestampElement=this.container.querySelector('[data-role="start-timestamp"]')};s.prototype.getSecret=function(){return this.secretCodeElement.value};s.prototype.getStartTimestamp=function(){return this.startTimestampElement.value};var n=function(t,e){this.mobilePush=new a(t,e);var i={ui:{showButtonId:"otp-connect-mobile",id:"otp-mobile-popup"},mobile:true};e=e||{};e=c(i,e);this.secret=null;this.qrCodeElement=null;this.appSecretElement=null;n.superclass.constructor.call(this,t,e)};e.extend(n,o);n.prototype.onShow=function(t){if(!t&&this.typeMenu.length){e.adminShowMenu(this.showButton,this.typeMenu,{active_class:"adm-btn-save-active"});return}this.sendRequest("get_view_params",{type:this.type||""},function t(i){this.secret=i.data.secret;this.type=i.data.type;this.showHideRedundantCodes(i.data.isTwoCodeRequired);this.showTypeTitle(i.data.type);this.drawQrCode(this.qrCodeElement,i.data.provisionUri);this.appSecretElement.innerHTML=e.util.htmlspecialchars(i.data.appSecretSpaced);this.showPopup()}.bind(this))};n.prototype.onInitialize=function(){this.qrCodeElement=this.container.querySelector('[data-role="qr-code-block"]');this.appSecretElement=this.container.querySelector('[data-role="app-code-block"]');e.bind(e("connect-mobile-manual-input"),"click",(function(){e("connect-by-manual-input").style.display="";e("connect-by-qr").style.display="none"}));e.bind(e("connect-by-manual-input"),"click",(function(){e("connect-by-manual-input").style.display="none";e("connect-by-qr").style.display=""}))};n.prototype.getSecret=function(){return this.secret};n.prototype.drawQrCode=function(t,e){new QRCode(t,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})};n.prototype.deactivateOtp=function(t,e,i){if(t)t.preventDefault();this.sendRequest(e,{days:i},function t(){window.location.replace(this._options.successfulUrl)}.bind(this))};n.prototype.activateOtp=function(t){if(t)t.preventDefault();this.sendRequest("activate",null,function t(){window.location.replace(this._options.successfulUrl)}.bind(this))};var a=function(t,e){var i={ui:{id:"otp-mobile-push-popup"}};e=e||{};e=c(i,e);o.prototype.constructor.call(this,t,e);this.type="push"};e.extend(a,n);a.prototype.onShow=function(){e.removeClass(this.loaderIconElement,"ui-icon-set --check");this.loader.show();this.loaderTextElement.textContent=e.message("SEC_OTP_WAITING_INSTALL");this.sendRequest("get_push_params",{},function t(i){this.drawQrCode(this.qrCodeElement,i.data.mobileAppUri);if(i.data.pullConfig){var o=new e.PullClient;o.subscribe({moduleId:"security",command:"pushOtpCode",callback:function(t){this.secret=t.secret;this.deviceInfo=t.device;this.loaderTextElement.textContent=e.message("SEC_OTP_PUSH_SAVING");this.activate(t.code)}.bind(this)});o.start(i.data.pullConfig)}this.showPopup()}.bind(this))};a.prototype.onInitialize=function(){this.qrCodeElement=this.container.querySelector('[data-role="qr-code-block"]');this.loaderIconElement=this.container.querySelector('[data-role="otp-icon-loader"]');this.loaderTextElement=this.container.querySelector('[data-role="otp-text-loader"]');this.loader=new e.Loader({target:this.loaderIconElement,size:30,mode:"inline",color:"#2675d7"});this.popup.ClearButtons();this.popup.SetButtons([e.CDialog.btnCancel])};a.prototype.showError=function(){const t=e.UI.Dialogs.MessageBox.alert('<span class="otp-error-wrapper">'+e.message("SEC_OTP_PUSH_ERROR")+"</span>",e.message("SEC_OTP_ERROR_TITLE"),function(){t.close();this.popup.Close()}.bind(this))};a.prototype.onFinish=function(){this.loader.hide();e.addClass(this.loaderIconElement,"ui-icon-set --check");this.loaderTextElement.textContent=e.message("SEC_OTP_PUSH_SUCCESS");window.location.replace(this._options.successfulUrl)};var r=function(t,i){var o={actionUrl:"/bitrix/admin/security_otp.ajax.php?lang="+e.message("LANGUAGE_ID"),publicUrl:"/bitrix/admin/security_otp_recovery_codes.php?lang="+e.message("LANGUAGE_ID"),ui:{showButtonId:"otp-show-recovery-codes",id:"otp-recovery-codes"}};i=i||{};i=c(o,i);r.superclass.constructor.call(this,t,i)};e.extend(r,o);r.prototype.onShow=function(t){t=t||null;this.sendRequest(t?"regenerate_recovery_codes":"get_recovery_codes",t?null:{allow_regenerate:"Y"},function t(e){this.drawRecoveryCodes(e.codes);var i=document.body.querySelector('[data-role="otp-recovery-codes-warning"]');if(i)i.style.display="none";this.showPopup()}.bind(this))};r.prototype.onInitialize=function(){this.popup.ClearButtons();this.codesContainer=this.container.querySelector('[data-role="recoverycodes-container"]');this.codesContainer.style.display="";this.codesTemplate=this.container.querySelector('[data-role="recoverycode-template"]').cloneNode(true);e.bind(this.container.querySelector('[data-role="print-codes"]'),"click",function t(){window.open(this._options["publicUrl"]+"&user="+this.userId)}.bind(this));e.bind(this.container.querySelector('[data-role="save-codes"]'),"click",function t(){window.location.href=this._options["publicUrl"]+"&action=download"+"&user="+this.userId}.bind(this));e.bind(this.container.querySelector('[data-role="regenerate-codes"]'),"click",this.onShow.bind(this,true))};r.prototype.drawRecoveryCodes=function(t){[].forEach.call(this.codesContainer.querySelectorAll('[data-autoclear="yes"]'),(function t(i){e.remove(i)}),this);[].forEach.call(t,(function t(i){var o=this.codesTemplate.cloneNode(true);if(!i.used){e.adjust(o,{text:i.value,attrs:{className:"active"}})}else{o.innerHTML="";e.adjust(o,{html:"",children:[e.create("span",{text:i.value}),e.create("span",{text:" ("+p(i.using_date)+")"})],attrs:{className:"used"}})}this.codesContainer.appendChild(o)}),this)};function c(t,e){for(var i in e){if(!e.hasOwnProperty(i))continue;if(e[i]&&e[i].constructor===Object){if(t[i]&&t[i].constructor===Object){t[i]=c(t[i],e[i])}else{t[i]=l(e[i])}}else{t[i]=e[i]}}return t}function l(t){return JSON.parse(JSON.stringify(t))}function p(t){var i=null;if(!e.isAmPmMode())i=[["tommorow","tommorow, H:i"],["today","today, H:i"],["yesterday","yesterday, H:i"],["",e.date.convertBitrixFormat(e.message("FORMAT_DATETIME"))]];else i=[["tommorow","tommorow, g:i a"],["today","today, g:i a"],["yesterday","yesterday, g:i a"],["",e.date.convertBitrixFormat(e.message("FORMAT_DATETIME"))]];return e.date.format(i,parseInt(t),e.date.convertToUTC(new Date))}return i}(BX);
//# sourceMappingURL=user-edit.map.js