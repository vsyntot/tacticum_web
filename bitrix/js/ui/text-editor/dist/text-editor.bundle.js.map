{"version":3,"file":"text-editor.bundle.js","sources":["../src/commands.js","../src/constants.js","../src/debug/constants.js","../src/helpers/get-selected-node.js","../src/bbcode/convert-text-format-element.js","../src/bbcode/import-from-bbcode.js","../src/helpers/is-paragraph-empty.js","../src/bbcode/trim-empty-paragraphs.js","../src/bbcode/export-to-bbcode.js","../src/bbcode/wrap-node-with.js","../src/plugins/base-plugin.js","../src/toolbar/toolbar-item.js","../src/toolbar/button.js","../src/helpers/wrap-text-in-paragraph.js","../src/plugins/quote/quote-node.js","../src/helpers/get-ancestor.js","../src/helpers/is-block-node.js","../src/helpers/wrap-nodes.js","../src/plugins/quote/quote-plugin.js","../src/plugins/spoiler/spoiler-content-node.js","../src/plugins/spoiler/spoiler-title-text-node.js","../src/plugins/spoiler/spoiler-plugin.js","../src/plugins/spoiler/spoiler-title-node.js","../src/plugins/spoiler/spoiler-node.js","../src/plugins/paragraph/custom-paragraph-node.js","../src/plugins/paragraph/paragraph-plugin.js","../src/plugins/code/code-token-node.js","../src/plugins/code/code-node.js","../src/plugins/code/code-plugin.js","../src/helpers/create-node-selection.js","../src/decorator-component.js","../src/helpers/figure-resizer.js","../src/plugins/file/image/file-image-component.js","../src/plugins/file/image/file-image-node.js","../src/plugins/file/file/file-node.js","../src/helpers/calc-image-size.js","../src/plugins/file/video/file-video-component.js","../src/plugins/file/video/file-video-node.js","../src/helpers/get-drag-selection.js","../src/helpers/get-node-in-selection.js","../src/helpers/register-draggable-node.js","../src/plugins/file/file-plugin.js","../src/helpers/validate-image-url.js","../src/plugins/image/image-component.js","../src/plugins/image/image-node.js","../src/helpers/get-editor-paddings.js","../src/helpers/get-selection-position.js","../src/helpers/adjust-dialog-position.js","../src/helpers/restore-selection.js","../src/helpers/sanitize-url.js","../src/plugins/image/image-dialog.js","../src/plugins/image/image-plugin.js","../src/plugins/mention/mention-node.js","../src/plugins/mention/mention-plugin.js","../src/plugins/smiley/smiley-node.js","../src/plugins/smiley/smiley-dialog.js","../src/plugins/smiley/smiley-plugin.js","../src/plugins/video/video-component.js","../src/plugins/video/video-node.js","../src/plugins/video/video-dialog.js","../src/helpers/validate-video-url.js","../src/plugins/video/video-plugin.js","../src/debug/print-format-properties.js","../src/debug/print-node.js","../src/debug/print-node-selection.js","../src/debug/print-range-selection.js","../src/debug/print-table-selection.js","../src/debug/visit-tree.js","../src/debug/generate-content.js","../src/helpers/create-hash-code.js","../src/helpers/is-root-empty.js","../src/themes/default-theme.js","../src/plugins/plugin-collection.js","../src/component-registry.js","../src/scheme-validation.js","../src/plugins/rich-text/rich-text-plugin.js","../src/plugins/clipboard/clipboard-plain-table-node.js","../src/plugins/clipboard/clipboard-plugin.js","../src/plugins/bold/bold-plugin.js","../src/plugins/italic/italic-plugin.js","../src/plugins/strikethrough/strikethrough-plugin.js","../src/plugins/underline/underline-plugin.js","../src/plugins/clear-format/clear-format-plugin.js","../src/plugins/link/link-editor.js","../src/plugins/link/custom-link-node.js","../src/helpers/validate-url.js","../src/plugins/link/link-plugin.js","../src/plugins/auto-link/custom-autolink-node.js","../src/plugins/auto-link/auto-link-plugin.js","../src/plugins/tab-indent/tab-indent-plugin.js","../src/plugins/list/list-plugin.js","../src/plugins/table/table-dialog.js","../src/plugins/table/table-plugin.js","../src/plugins/hashtag/hashtag-node.js","../src/plugins/hashtag/hashtag-plugin.js","../src/helpers/create-nodes-from-text.js","../src/plugins/copilot/copilot-plugin.js","../src/plugins/history/history-plugin.js","../src/plugins/block-toolbar/block-toolbar-plugin.js","../src/toolbar/separator.js","../src/toolbar/toolbar.js","../src/plugins/floating-toolbar/floating-toolbar-plugin.js","../src/plugins/toolbar/toolbar-plugin.js","../src/plugins/placeholder/placeholder-plugin.js","../src/text-editor.js","../src/text-editor-component.js","../src/presets/basic-editor.js","../src/presets/basic-editor-component.js","../src/index.js"],"sourcesContent":["import { createCommand, type LexicalCommand } from 'ui.lexical.core';\n\nexport const HIDE_DIALOG_COMMAND: LexicalCommand = createCommand('HIDE_DIALOG_COMMAND');\nexport const DIALOG_VISIBILITY_COMMAND: LexicalCommand = createCommand('DIALOG_VISIBILITY_COMMAND');\nexport const DRAG_START_COMMAND: LexicalCommand = createCommand('DRAG_START_COMMAND');\nexport const DRAG_END_COMMAND: LexicalCommand = createCommand('DRAG_END_COMMAND');\n","import type { NewLineModeType } from './types/new-line-mode-type';\n\n// Node flags\nexport const UNFORMATTED = 1;\n\nexport const NewLineMode: Record<string, NewLineModeType> = {\n\tLINE_BREAK: 'line-break',\n\tPARAGRAPH: 'paragraph',\n\tMIXED: 'mixed',\n};\n","import type { TextNode, RangeSelection } from 'ui.lexical.core';\n\nexport const NON_SINGLE_WIDTH_CHARS_REPLACEMENT: Readonly<Record<string, string>> = (\n\tObject.freeze({\n\t\t'\\t': '\\\\t',\n\t\t'\\n': '\\\\n',\n\t})\n);\n\nexport const NON_SINGLE_WIDTH_CHARS_REGEX: RegExp = new RegExp(\n\tObject.keys(NON_SINGLE_WIDTH_CHARS_REPLACEMENT).join('|'),\n\t'g',\n);\n\nexport const SYMBOLS: Record<string, string> = Object.freeze({\n\tancestorHasNextSibling: '|',\n\tancestorIsLastChild: ' ',\n\thasNextSibling: '├',\n\tisLastChild: '└',\n\tselectedChar: '^',\n\tselectedLine: '>',\n});\n\nexport const FORMAT_PREDICATES = [\n\t(node: TextNode | RangeSelection) => node.hasFormat('bold') && 'Bold',\n\t(node: TextNode | RangeSelection) => node.hasFormat('code') && 'Code',\n\t(node: TextNode | RangeSelection) => node.hasFormat('italic') && 'Italic',\n\t(node: TextNode | RangeSelection) => node.hasFormat('strikethrough') && 'Strikethrough',\n\t(node: TextNode | RangeSelection) => node.hasFormat('subscript') && 'Subscript',\n\t(node: TextNode | RangeSelection) => node.hasFormat('superscript') && 'Superscript',\n\t(node: TextNode | RangeSelection) => node.hasFormat('underline') && 'Underline',\n];\n\nexport const DETAIL_PREDICATES = [\n\t(node: TextNode) => node.isDirectionless() && 'Directionless',\n\t(node: TextNode) => node.isUnmergeable() && 'Unmergeable',\n];\n\nexport const MODE_PREDICATES = [\n\t(node: TextNode) => node.isToken() && 'Token',\n\t(node: TextNode) => node.isSegmented() && 'Segmented',\n];\n","import { type ElementNode, type RangeSelection, type TextNode } from 'ui.lexical.core';\nimport { $isAtNodeEnd } from 'ui.lexical.selection';\n\nexport function getSelectedNode(selection: RangeSelection): TextNode | ElementNode\n{\n\tconst anchor = selection.anchor;\n\tconst focus = selection.focus;\n\tconst anchorNode = selection.anchor.getNode();\n\tconst focusNode = selection.focus.getNode();\n\tif (anchorNode === focusNode)\n\t{\n\t\treturn anchorNode;\n\t}\n\n\tconst isBackward = selection.isBackward();\n\tif (isBackward)\n\t{\n\t\treturn $isAtNodeEnd(focus) ? anchorNode : focusNode;\n\t}\n\n\treturn $isAtNodeEnd(anchor) ? anchorNode : focusNode;\n}\n","import {\n\t$isTextNode,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport { type BBCodeElementNode } from 'ui.bbcode.model';\nimport type { BBCodeConversionOutput } from './types';\n\nconst nodeNameToTextFormat: Object<string, string> = {\n\tb: 'bold',\n\tstrong: 'bold',\n\ti: 'italic',\n\tem: 'italic',\n\ts: 'strikethrough',\n\tdel: 'strikethrough',\n\tu: 'underline',\n\tsub: 'subscript',\n\tsup: 'superscript',\n};\n\nexport function convertTextFormatElement(node: BBCodeElementNode): BBCodeConversionOutput\n{\n\tconst format: string = nodeNameToTextFormat[node.getName()];\n\tif (format === undefined)\n\t{\n\t\treturn { node: null };\n\t}\n\n\treturn {\n\t\tforChild: (lexicalNode: LexicalNode): LexicalNode => {\n\t\t\tif ($isTextNode(lexicalNode) && !lexicalNode.hasFormat(format))\n\t\t\t{\n\t\t\t\tlexicalNode.toggleFormat(format);\n\t\t\t}\n\n\t\t\treturn lexicalNode;\n\t\t},\n\t\tnode: null,\n\t};\n}\n","import { Type } from 'main.core';\nimport {\n\tBBCodeNewLineNode,\n\tBBCodeTabNode,\n\tBBCodeNode,\n\ttype BBCodeRootNode,\n\ttype BBCodeTextNode,\n\ttype BBCodeElementNode,\n\ttype BBCodeScheme,\n\ttype BBCodeContentNode,\n} from 'ui.bbcode.model';\n\nimport { BBCodeParser } from 'ui.bbcode.parser';\nimport { TextEditor } from 'ui.text-editor';\nimport type { BBCodeTextNodeContent } from '../../../bbcode/model/src/nodes/text-node';\n\nimport {\n\ttype BBCodeChildConversion,\n\ttype BBCodeConversionOutput,\n\ttype BBCodeConversionFn,\n\ttype BBCodeImportMap,\n\ttype BBCodeConversion,\n} from './types';\n\nimport {\n\t$isElementNode,\n\t$isLineBreakNode,\n\t$createLineBreakNode,\n\t$createTabNode,\n\t$createTextNode,\n\t$createParagraphNode,\n\t$isDecoratorNode,\n\ttype LexicalNode,\n\ttype ElementNode,\n\ttype ParagraphNode,\n} from 'ui.lexical.core';\n\nexport function $importFromBBCode(bbcode: string, editor: TextEditor, normalize: boolean = true): Array<LexicalNode>\n{\n\tconst scheme: BBCodeScheme = editor.getBBCodeScheme();\n\tconst parser: BBCodeParser = new BBCodeParser({ scheme });\n\tconst ast: BBCodeRootNode = parser.parse(bbcode);\n\tconst elements: BBCodeContentNode = ast.getChildren();\n\n\t// console.log(ast);\n\n\tlet lexicalNodes = [];\n\tfor (const element of elements)\n\t{\n\t\tconst nodes = $createNodesFromBBCode(element, editor);\n\t\tif (nodes !== null)\n\t\t{\n\t\t\tlexicalNodes = [...lexicalNodes, ...nodes];\n\t\t}\n\t}\n\n\treturn normalize ? $normalizeTextNodes(lexicalNodes) : lexicalNodes;\n}\n\nfunction $createNodesFromBBCode(\n\tnode: BBCodeContentNode,\n\teditor: TextEditor,\n\tforChildMap: Map<string, BBCodeChildConversion> = new Map(),\n\tparentLexicalNode: LexicalNode | null = null,\n): Array<LexicalNode>\n{\n\tif (node instanceof BBCodeNewLineNode)\n\t{\n\t\treturn [$createLineBreakNode()];\n\t}\n\n\tif (node instanceof BBCodeTabNode)\n\t{\n\t\treturn [$createTabNode()];\n\t}\n\n\tlet lexicalNodes: Array<LexicalNode> = [];\n\tlet currentLexicalNode = null;\n\n\tconst transformFunction: BBCodeConversionFn | null = getConversionFunction(node, editor);\n\tconst transformOutput: BBCodeConversionOutput | null = transformFunction ? transformFunction(node) : null;\n\tlet postTransform = null;\n\tif (transformOutput !== null)\n\t{\n\t\tpostTransform = transformOutput.after;\n\t\tconst transformNodes = transformOutput.node;\n\t\tcurrentLexicalNode = Array.isArray(transformNodes) ? transformNodes[transformNodes.length - 1] : transformNodes;\n\t\tif (currentLexicalNode !== null)\n\t\t{\n\t\t\tfor (const [, forChildFunction] of forChildMap)\n\t\t\t{\n\t\t\t\tcurrentLexicalNode = forChildFunction(currentLexicalNode, parentLexicalNode);\n\t\t\t\tif (!currentLexicalNode)\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (currentLexicalNode)\n\t\t\t{\n\t\t\t\tlexicalNodes.push(...(Array.isArray(transformNodes) ? transformNodes : [currentLexicalNode]));\n\t\t\t}\n\t\t}\n\n\t\tif (Type.isFunction(transformOutput.forChild))\n\t\t{\n\t\t\tforChildMap.set(node.getName(), transformOutput.forChild);\n\t\t}\n\t}\n\n\tconst children = node.getChildren();\n\tlet childLexicalNodes = [];\n\tfor (const child of children)\n\t{\n\t\tchildLexicalNodes.push(\n\t\t\t...$createNodesFromBBCode(\n\t\t\t\tchild,\n\t\t\t\teditor,\n\t\t\t\tnew Map(forChildMap),\n\t\t\t\tcurrentLexicalNode,\n\t\t\t),\n\t\t);\n\t}\n\n\tif (Type.isFunction(postTransform))\n\t{\n\t\tchildLexicalNodes = postTransform(childLexicalNodes);\n\t}\n\n\t// Unknown node\n\tif (transformOutput === null)\n\t{\n\t\tif (node.getType() === BBCodeNode.ELEMENT_NODE)\n\t\t{\n\t\t\tconst elementNode: BBCodeElementNode = node;\n\t\t\tif (elementNode.isVoid())\n\t\t\t{\n\t\t\t\tchildLexicalNodes = [$createTextNode(elementNode.getOpeningTag()), ...childLexicalNodes];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tchildLexicalNodes = [\n\t\t\t\t\t$createTextNode(elementNode.getOpeningTag()),\n\t\t\t\t\t...childLexicalNodes,\n\t\t\t\t\t$createTextNode(elementNode.getClosingTag()),\n\t\t\t\t];\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tchildLexicalNodes = [$createTextNode(node.toString()), ...childLexicalNodes];\n\t\t}\n\t}\n\n\tif (currentLexicalNode === null)\n\t{\n\t\t// If it hasn't been converted to a LexicalNode, we hoist its children\n\t\t// up to the same level as it.\n\t\tlexicalNodes = [...lexicalNodes, ...childLexicalNodes];\n\t}\n\telse if ($isElementNode(currentLexicalNode))\n\t{\n\t\t// If the current node is a ElementNode after conversion,\n\t\t// we can append all the children to it.\n\t\tcurrentLexicalNode.append(...childLexicalNodes);\n\t}\n\n\treturn lexicalNodes;\n}\n\nexport function shouldWrapInParagraph(lexicalNode: LexicalNode | ElementNode): boolean\n{\n\tif ($isElementNode(lexicalNode) && lexicalNode.isInline() === false)\n\t{\n\t\treturn false;\n\t}\n\n\treturn !($isDecoratorNode(lexicalNode) && lexicalNode.isInline() === false);\n}\n\nexport function $normalizeTextNodes(lexicalNodes: Array<LexicalNode>): Array<LexicalNode>\n{\n\tconst result = [];\n\tlet currentParagraph = null;\n\tlet lineBreaks = 0;\n\n\tfor (const lexicalNode of lexicalNodes)\n\t{\n\t\tif ($isLineBreakNode(lexicalNode))\n\t\t{\n\t\t\tlineBreaks++;\n\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (shouldWrapInParagraph(lexicalNode))\n\t\t{\n\t\t\tif (currentParagraph === null || lineBreaks >= 2)\n\t\t\t{\n\t\t\t\tresult.push(...$createEmptyParagraphs(lineBreaks - 2));\n\t\t\t\tcurrentParagraph = $createParagraphNode();\n\t\t\t\tresult.push(currentParagraph);\n\t\t\t}\n\t\t\telse if (lineBreaks === 1)\n\t\t\t{\n\t\t\t\tcurrentParagraph.append($createLineBreakNode());\n\t\t\t}\n\n\t\t\tcurrentParagraph.append(lexicalNode);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (lineBreaks > 2)\n\t\t\t{\n\t\t\t\tresult.push(...$createEmptyParagraphs(lineBreaks - 2));\n\t\t\t}\n\n\t\t\tresult.push(lexicalNode);\n\t\t\tcurrentParagraph = null;\n\t\t}\n\n\t\tlineBreaks = 0;\n\t}\n\n\tif (result.length === 0)\n\t{\n\t\treturn [$createParagraphNode()];\n\t}\n\n\treturn result;\n}\n\nfunction $createEmptyParagraphs(count: number = 1): Array<ParagraphNode>\n{\n\tconst result = [];\n\tfor (let i = 0; i < count; i++)\n\t{\n\t\tresult.push($createParagraphNode());\n\t}\n\n\treturn result;\n}\n\nfunction getConversionFunction(node: BBCodeNode, editor: TextEditor): BBCodeConversionFn | null\n{\n\tconst nodeName: string = node.getName();\n\tlet currentConversion: BBCodeConversion | null = null;\n\tconst importMap: BBCodeImportMap = editor.getBBCodeImportMap();\n\tconst conversions = importMap.get(nodeName.toLowerCase());\n\tif (conversions !== undefined)\n\t{\n\t\tfor (const conversion of conversions)\n\t\t{\n\t\t\tconst bbCodeConversion: BBCodeConversion = conversion(node);\n\t\t\tif (\n\t\t\t\tbbCodeConversion !== null\n\t\t\t\t&& (currentConversion === null || currentConversion.priority < bbCodeConversion.priority)\n\t\t\t)\n\t\t\t{\n\t\t\t\tcurrentConversion = bbCodeConversion;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (currentConversion === null)\n\t{\n\t\tif (nodeName === '#text')\n\t\t{\n\t\t\treturn convertTextNode;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\treturn currentConversion.conversion;\n}\n\nfunction convertTextNode(textNode: BBCodeTextNode): BBCodeConversionOutput\n{\n\tlet textContent: BBCodeTextNodeContent = textNode.getContent();\n\ttextContent = textContent\n\t\t.replaceAll(/\\r?\\n|\\t/gm, ' ')\n\t\t.replace('\\r', '')\n\t;\n\n\tif (textContent === '')\n\t{\n\t\treturn { node: null };\n\t}\n\n\treturn { node: $createTextNode(textContent) };\n}\n","import { $isParagraphNode, $isTextNode, $isLineBreakNode, type ElementNode } from 'ui.lexical.core';\n\nexport function $isParagraphEmpty(node: ElementNode): boolean\n{\n\tif (!$isParagraphNode(node))\n\t{\n\t\treturn false;\n\t}\n\n\tif (node.isEmpty())\n\t{\n\t\treturn true;\n\t}\n\n\treturn node.getChildren().every((child) => {\n\t\treturn (\n\t\t\t$isLineBreakNode(child)\n\t\t\t|| ($isTextNode(child) && /^\\s*$/.test(child.getTextContent()))\n\t\t);\n\t});\n}\n","import {\n\ttype LexicalNode,\n\ttype ElementNode,\n} from 'ui.lexical.core';\n\nimport { $isParagraphEmpty } from '../helpers/is-paragraph-empty';\n\nexport function trimEmptyParagraphs(nodes: Array<LexicalNode | ElementNode>): Array<LexicalNode | ElementNode>\n{\n\tconst trimmedNodes = [...nodes];\n\n\t// trim from the start\n\twhile (trimmedNodes.length > 0 && $isParagraphEmpty(trimmedNodes[0]))\n\t{\n\t\ttrimmedNodes.splice(0, 1);\n\t}\n\n\t// trim from the end\n\twhile (trimmedNodes.length > 0 && $isParagraphEmpty(trimmedNodes[trimmedNodes.length - 1]))\n\t{\n\t\ttrimmedNodes.splice(-1, 1);\n\t}\n\n\treturn trimmedNodes;\n}\n","/* eslint-disable @bitrix24/bitrix24-rules/no-native-dom-methods */\n\nimport { Type } from 'main.core';\nimport type {\n\tBBCodeScheme,\n\tBBCodeRootNode,\n\tBBCodeFragmentNode,\n\tBBCodeTextNode,\n} from 'ui.bbcode.model';\n\nimport { TextEditor } from 'ui.text-editor';\n\nimport {\n\t$isElementNode,\n\t$isTextNode,\n\t$isLineBreakNode,\n\t$isTabNode,\n\ttype LexicalNode, ElementNode,\n} from 'ui.lexical.core';\n\nimport { trimEmptyParagraphs } from './trim-empty-paragraphs';\n\nimport type { BBCodeExportOutput, BBCodeExportMap, BBCodeExportFn } from './types';\n\nexport function $exportToBBCode(lexicalNode: LexicalNode | ElementNode, editor: TextEditor): BBCodeRootNode\n{\n\tconst scheme: BBCodeScheme = editor.getBBCodeScheme();\n\tconst root: BBCodeRootNode = scheme.createRoot();\n\tconst topLevelChildren = trimEmptyParagraphs(lexicalNode.getChildren());\n\n\tfor (const topLevelNode of topLevelChildren)\n\t{\n\t\t$appendNodesToBBCode(topLevelNode, root, editor);\n\t\t// root.appendChild(scheme.createNewLine());\n\t}\n\n\treturn root;\n}\n\nfunction $appendNodesToBBCode(currentNode: LexicalNode | ElementNode, parentNode: Node, editor: TextEditor): void\n{\n\tconst { node, after }: BBCodeExportOutput = getExportFunction(currentNode, editor);\n\tif (!node)\n\t{\n\t\treturn;\n\t}\n\n\tconst scheme: BBCodeScheme = editor.getBBCodeScheme();\n\tconst fragment: BBCodeFragmentNode = scheme.createFragment();\n\tconst children = $isElementNode(currentNode) ? currentNode.getChildren() : [];\n\tfor (const childNode of children)\n\t{\n\t\t$appendNodesToBBCode(childNode, fragment, editor);\n\t}\n\n\tnode.appendChild(fragment);\n\tparentNode.appendChild(node);\n\n\tif (Type.isFunction(after))\n\t{\n\t\tconst newElement = after.call(currentNode, node);\n\t\tif (newElement)\n\t\t{\n\t\t\tnode.getParent().replaceChild(node, newElement);\n\t\t}\n\t}\n}\n\nconst formats = [\n\t'bold',\n\t'italic',\n\t'strikethrough',\n\t'underline',\n];\n\nfunction getExportFunction(lexicalNode: LexicalNode, editor: TextEditor): BBCodeExportOutput\n{\n\tconst type = lexicalNode.getType();\n\tconst exportMap: BBCodeExportMap = editor.getBBCodeExportMap();\n\tconst exportFn: BBCodeExportFn = exportMap.get(type);\n\tif (Type.isFunction(exportFn))\n\t{\n\t\treturn exportFn(lexicalNode);\n\t}\n\n\tconst scheme: BBCodeScheme = editor.getBBCodeScheme();\n\tif ($isTextNode(lexicalNode) && lexicalNode.getType() === 'text')\n\t{\n\t\tconst node: BBCodeTextNode = scheme.createText({\n\t\t\tencode: false,\n\t\t\tcontent: lexicalNode.getTextContent(),\n\t\t});\n\n\t\tif (lexicalNode.getFormat() === 0)\n\t\t{\n\t\t\treturn { node };\n\t\t}\n\n\t\tlet currentNode: BBCodeTextNode = node;\n\t\tformats.forEach((format: string): void => {\n\t\t\tconst formatFn: BBCodeExportFn = exportMap.get(`text:${format}`);\n\t\t\tif (Type.isFunction(formatFn))\n\t\t\t{\n\t\t\t\tcurrentNode = formatFn(lexicalNode, currentNode) || currentNode;\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\tnode: currentNode,\n\t\t};\n\t}\n\n\tif ($isLineBreakNode(lexicalNode))\n\t{\n\t\treturn {\n\t\t\tnode: scheme.createNewLine(),\n\t\t};\n\t}\n\n\tif ($isTabNode(lexicalNode))\n\t{\n\t\treturn {\n\t\t\tnode: scheme.createTab(),\n\t\t};\n\t}\n\n\tif ($isTextNode(lexicalNode) || $isElementNode(lexicalNode))\n\t{\n\t\tconst node: BBCodeTextNode = scheme.createText({\n\t\t\tencode: false,\n\t\t\tcontent: lexicalNode.getTextContent(),\n\t\t});\n\n\t\treturn { node };\n\t}\n\n\treturn { node: null };\n}\n","/* eslint-disable @bitrix24/bitrix24-rules/no-native-dom-methods */\nimport { BBCodeElementNode, BBCodeNode } from 'ui.bbcode.model';\nimport { type TextEditor } from '../text-editor';\n\nexport function wrapNodeWith(node: BBCodeNode, tag: string, editor: TextEditor): BBCodeElementNode\n{\n\tconst scheme = editor.getBBCodeScheme();\n\tconst elementNode = scheme.createElement({ name: tag });\n\telementNode.appendChild(node);\n\n\treturn elementNode;\n}\n","import type { LexicalEditor, LexicalNode, LexicalNodeReplacement } from 'ui.lexical.core';\nimport { mergeRegister } from 'ui.lexical.utils';\nimport { BBCodeExportConversion, BBCodeImportConversion } from '../bbcode';\nimport { type TextEditor } from '../text-editor';\nimport type { SchemeValidationOptions } from '../types/scheme-validation-options';\n\nexport interface PluginStaticMembers {\n\tgetName(): string;\n\tgetNodes(editor: TextEditor): Array<Class<LexicalNode>>;\n}\n\nexport interface PluginInterface {}\nexport type PluginClassConstructor = (editor: TextEditor) => PluginInterface;\nexport type PluginConstructor = PluginClassConstructor & PluginStaticMembers;\n\n/**\n * @memberof BX.UI.TextEditor\n */\nexport default class BasePlugin implements PluginStaticMembers\n{\n\t#textEditor: TextEditor = null;\n\t#destroyed: boolean = false;\n\t#removeListeners: Function = () => {};\n\n\tconstructor(textEditor: TextEditor)\n\t{\n\t\tthis.#textEditor = textEditor;\n\t}\n\n\tstatic getName(): string\n\t{\n\t\tthrow new Error('getName must be implemented in a child class');\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode> | LexicalNodeReplacement>\n\t{\n\t\treturn [];\n\t}\n\n\timportBBCode(): BBCodeImportConversion | null\n\t{\n\t\treturn null;\n\t}\n\n\texportBBCode(): BBCodeExportConversion | null\n\t{\n\t\treturn null;\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn null;\n\t}\n\n\tafterInit(): void\n\t{\n\t\t// you can override this method\n\t}\n\n\tgetName(): string\n\t{\n\t\treturn this.constructor.getName();\n\t}\n\n\tgetEditor(): TextEditor\n\t{\n\t\treturn this.#textEditor;\n\t}\n\n\tgetLexicalEditor(): LexicalEditor\n\t{\n\t\treturn this.#textEditor.getLexicalEditor();\n\t}\n\n\tcleanUpRegister(...func: Array<Function>): void\n\t{\n\t\tthis.#removeListeners = mergeRegister(\n\t\t\tthis.#removeListeners,\n\t\t\t...func,\n\t\t);\n\t}\n\n\tisDestroyed(): boolean\n\t{\n\t\treturn this.#destroyed;\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.#destroyed = true;\n\t\tthis.#removeListeners();\n\t\tthis.#removeListeners = null;\n\t}\n}\n","import { EventEmitter } from 'main.core.events';\n\nexport default class ToolbarItem extends EventEmitter\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.ToolbarItem');\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\tthrow new Error('You must implement getContainer() method.');\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tthrow new Error('You must implement render() method.');\n\t}\n}\n","import { Tag, Type, Dom, Text } from 'main.core';\nimport ToolbarItem from './toolbar-item';\n\n/**\n * @memberof BX.UI.TextEditor\n */\nexport default class Button extends ToolbarItem\n{\n\t#format: string = null;\n\t#blockType: string = null;\n\t#active: boolean = false;\n\t#disabled: boolean = false;\n\t#disableInsideUnformatted = false;\n\t#disableCallback: Function = null;\n\t#container: HTMLElement = null;\n\n\tsetContent(content: string | HTMLElement)\n\t{\n\t\tif (Type.isString(content))\n\t\t{\n\t\t\tthis.getContainer().innerHTML = content;\n\t\t}\n\t\telse if (Type.isElementNode(content))\n\t\t{\n\t\t\tthis.getContainer().append(content);\n\t\t}\n\t}\n\n\tsetFormat(format: string)\n\t{\n\t\tthis.#format = format;\n\t}\n\n\tgetFormat(): string | null\n\t{\n\t\treturn this.#format;\n\t}\n\n\thasFormat(): string | null\n\t{\n\t\treturn this.#format;\n\t}\n\n\tsetBlockType(type: string)\n\t{\n\t\tthis.#blockType = type;\n\t}\n\n\tgetBlockType(): string | null\n\t{\n\t\treturn this.#blockType;\n\t}\n\n\tsetTooltip(tooltip: string | null)\n\t{\n\t\tif (Type.isStringFilled(tooltip))\n\t\t{\n\t\t\tDom.attr(this.getContainer(), 'title', Text.encode(tooltip));\n\t\t}\n\t\telse if (tooltip === null)\n\t\t{\n\t\t\tDom.attr(this.getContainer(), 'title', null);\n\t\t}\n\t}\n\n\tdisableInsideUnformatted(): void\n\t{\n\t\tthis.#disableInsideUnformatted = true;\n\t}\n\n\tenableInsideUnformatted(): void\n\t{\n\t\tthis.#disableInsideUnformatted = false;\n\t}\n\n\tshouldDisableInsideUnformatted(): boolean\n\t{\n\t\treturn this.#disableInsideUnformatted;\n\t}\n\n\tsetActive(active: boolean = true): void\n\t{\n\t\tif (active === this.#active)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#active = active;\n\t\tif (active)\n\t\t{\n\t\t\tDom.addClass(this.getContainer(), '--active');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.getContainer(), '--active');\n\t\t}\n\t}\n\n\tisActive(): boolean\n\t{\n\t\treturn this.#active;\n\t}\n\n\tsetDisabled(disabled: boolean = true): void\n\t{\n\t\tif (disabled === this.#disabled)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#disabled = disabled;\n\t\tif (disabled)\n\t\t{\n\t\t\tDom.attr(this.getContainer(), { disabled: true });\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.attr(this.getContainer(), { disabled: null });\n\t\t}\n\t}\n\n\tdisable(): void\n\t{\n\t\tthis.setDisabled(true);\n\t}\n\n\tenable(): void\n\t{\n\t\tthis.setDisabled(false);\n\t}\n\n\tisDisabled(): boolean\n\t{\n\t\treturn this.#disabled;\n\t}\n\n\thasOwnDisableCallback(): boolean\n\t{\n\t\treturn this.#disableCallback !== null;\n\t}\n\n\tsetDisableCallback(fn: Function): void\n\t{\n\t\tif (Type.isFunction(fn))\n\t\t{\n\t\t\tthis.#disableCallback = fn;\n\t\t}\n\t}\n\n\tinvokeDisableCallback(): boolean\n\t{\n\t\treturn this.#disableCallback();\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\tif (this.#container === null)\n\t\t{\n\t\t\tthis.#container = Tag.render`\n\t\t\t\t<button \n\t\t\t\t\ttype=\"button\" \n\t\t\t\t\tclass=\"ui-text-editor-toolbar-button\"\n\t\t\t\t\tonclick=\"${this.#handleClick.bind(this)}\"\n\t\t\t\t>\n\t\t\t\t</button>\n\t\t\t`;\n\t\t}\n\n\t\treturn this.#container;\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\treturn this.getContainer();\n\t}\n\n\t#handleClick(): void\n\t{\n\t\tthis.emit('onClick');\n\t}\n}\n","export function wrapTextInParagraph(text: string): string\n{\n\tlet result = '';\n\tconst parts = text.split(/((?:\\r?\\n){2})/);\n\n\tfor (const part of parts)\n\t{\n\t\tif (part === '\\n\\n' || part === '\\r\\n\\r\\n')\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tresult += `<p>${part.replaceAll(/(\\r?\\n)/g, '<br>')}</p>`;\n\t}\n\n\treturn result;\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { Type, Dom } from 'main.core';\n\nimport {\n\tElementNode,\n\t$applyNodeReplacement,\n\t$createParagraphNode,\n\t$isElementNode,\n\t$isDecoratorNode,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype SerializedElementNode,\n\ttype LexicalEditor,\n\ttype RangeSelection,\n\ttype ParagraphNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n} from 'ui.lexical.core';\n\nimport { $isParagraphEmpty } from '../../helpers/is-paragraph-empty';\n\nexport class QuoteNode extends ElementNode\n{\n\tstatic getType(): string\n\t{\n\t\treturn 'quote';\n\t}\n\n\tstatic clone(node: QuoteNode): QuoteNode\n\t{\n\t\treturn new QuoteNode(node.__key);\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLElement\n\t{\n\t\tconst element = document.createElement('blockquote');\n\t\telement.setAttribute('spellcheck', 'false');\n\n\t\tif (Type.isStringFilled(config?.theme?.quote))\n\t\t{\n\t\t\tDom.addClass(element, config.theme.quote);\n\t\t}\n\n\t\treturn element;\n\t}\n\n\tupdateDOM(prevNode: QuoteNode, anchor: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\tblockquote: (node: Node) => ({\n\t\t\t\tconversion: (element: HTMLElement): DOMConversionOutput => {\n\t\t\t\t\treturn { node: $createQuoteNode() };\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\tstatic importJSON(serializedNode: SerializedElementNode): QuoteNode\n\t{\n\t\tconst node = $createQuoteNode();\n\t\tnode.setFormat(serializedNode.format);\n\t\tnode.setIndent(serializedNode.indent);\n\t\tnode.setDirection(serializedNode.direction);\n\n\t\treturn node;\n\t}\n\n\texportJSON(): SerializedElementNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'quote',\n\t\t};\n\t}\n\n\tcanIndent(): false\n\t{\n\t\treturn false;\n\t}\n\n\tisInline(): false\n\t{\n\t\treturn false;\n\t}\n\n\tcanReplaceWith(replacement: LexicalNode): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tcollapseAtStart(selection: RangeSelection): true\n\t{\n\t\t// const paragraph = $createParagraphNode();\n\t\t// const children = this.getChildren();\n\t\t// children.forEach((child) => paragraph.append(child));\n\t\t// this.replace(paragraph);\n\t\t$removeQuote(this);\n\n\t\treturn true;\n\t}\n\n\tcanBeEmpty(): false\n\t{\n\t\treturn false;\n\t}\n\n\tisShadowRoot(): boolean\n\t{\n\t\treturn true;\n\t}\n\n\t// insertNewAfter(selection: RangeSelection, restoreSelection = true): null | ParagraphNode\n\t// {\n\t// \tconst children = this.getChildren();\n\t// \tconst childrenLength = children.length;\n\t//\n\t// \tif (\n\t// \t\tchildrenLength >= 2\n\t// \t\t&& children[childrenLength - 1].getTextContent() === '\\n'\n\t// \t\t&& children[childrenLength - 2].getTextContent() === '\\n'\n\t// \t\t&& selection.isCollapsed()\n\t// \t\t&& selection.anchor.key === this.__key\n\t// \t\t&& selection.anchor.offset === childrenLength\n\t// \t)\n\t// \t{\n\t// \t\tchildren[childrenLength - 1].remove();\n\t// \t\tchildren[childrenLength - 2].remove();\n\t// \t\tconst newElement = $createParagraphNode();\n\t// \t\tthis.insertAfter(newElement, restoreSelection);\n\t//\n\t// \t\treturn newElement;\n\t// \t}\n\t//\n\t// \tselection.insertLineBreak();\n\t//\n\t// \treturn null;\n\t// }\n}\n\nexport function $createQuoteNode(): QuoteNode\n{\n\treturn $applyNodeReplacement(new QuoteNode());\n}\n\nexport function $isQuoteNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof QuoteNode;\n}\n\nexport function $removeQuote(quoteNode: QuoteNode): boolean\n{\n\tif (!$isQuoteNode(quoteNode))\n\t{\n\t\treturn false;\n\t}\n\n\tlet lastElement = quoteNode;\n\tfor (const child of quoteNode.getChildren())\n\t{\n\t\tif ($isElementNode(child) || $isDecoratorNode(child))\n\t\t{\n\t\t\tlastElement = lastElement.insertAfter(child);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlastElement = lastElement.insertAfter($createParagraphNode().append(child));\n\t\t}\n\t}\n\n\tquoteNode.remove();\n\n\treturn true;\n}\n","import type { LexicalNode } from 'ui.lexical.core';\n\nexport function $getAncestor(node: LexicalNode, predicate: (ancestor: LexicalNode) => boolean): LexicalNode | null\n{\n\tlet parent: LexicalNode = node;\n\twhile (parent !== null && parent.getParent() !== null && !predicate(parent))\n\t{\n\t\tparent = parent.getParentOrThrow();\n\t}\n\n\treturn predicate(parent) ? parent : null;\n}\n","import { $isDecoratorNode, $isElementNode } from 'ui.lexical.core';\nimport type { DecoratorNode, ElementNode, LexicalNode } from 'ui.lexical.core';\n\nexport function $isBlockNode(node: ElementNode | DecoratorNode | LexicalNode): boolean\n{\n\treturn ($isElementNode(node) || $isDecoratorNode(node)) && !node.isInline() && !node.isParentRequired();\n}\n","import type { LexicalNode } from 'ui.lexical.core';\nimport { $isRootOrShadowRoot, type BaseSelection, type ElementNode } from 'ui.lexical.core';\nimport { $getAncestor } from './get-ancestor';\nimport { $isBlockNode } from './is-block-node';\n\nexport function $wrapNodes(selection: BaseSelection | null, createElement: () => ElementNode): ElementNode | null\n{\n\tif (selection === null)\n\t{\n\t\treturn null;\n\t}\n\n\tconst anchor = selection.anchor;\n\tconst anchorNode: ElementNode = anchor.getNode();\n\tconst element: ElementNode = createElement();\n\tif ($isRootOrShadowRoot(anchorNode))\n\t{\n\t\tconst firstChild = anchorNode.getFirstChild();\n\t\tif (firstChild)\n\t\t{\n\t\t\tfirstChild.replace(element, true);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tanchorNode.append(element);\n\t\t}\n\n\t\treturn element;\n\t}\n\n\tconst handled = new Set();\n\tconst nodes: LexicalNode[] = selection.getNodes();\n\tconst firstSelectedBlock = $getAncestor(selection.anchor.getNode(), $isBlockNode);\n\tif (firstSelectedBlock && !nodes.includes(firstSelectedBlock))\n\t{\n\t\tnodes.unshift(firstSelectedBlock);\n\t}\n\n\thandled.add(element.getKey());\n\n\tlet firstNode = true;\n\tfor (const node of nodes)\n\t{\n\t\tif (!$isBlockNode(node) || handled.has(node.getKey()))\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst isParentHandled = $getAncestor(\n\t\t\tnode.getParent(),\n\t\t\t(parentNode: LexicalNode): boolean => handled.has(parentNode.getKey()),\n\t\t);\n\n\t\tif (isParentHandled)\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (firstNode)\n\t\t{\n\t\t\tfirstNode = false;\n\t\t\tnode.replace(element);\n\t\t\telement.append(node);\n\t\t}\n\t\telse\n\t\t{\n\t\t\telement.append(node);\n\t\t}\n\n\t\thandled.add(node.getKey());\n\t}\n\n\treturn element;\n}\n","import { Loc, Type } from 'main.core';\n\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\n\nimport {\n\t$getSelection,\n\t$isRangeSelection,\n\t$createParagraphNode,\n\t$getPreviousSelection,\n\tcreateCommand,\n\tCOMMAND_PRIORITY_LOW,\n\ttype LexicalNode,\n\ttype RangeSelection,\n\ttype ElementNode,\n\ttype LexicalCommand,\n} from 'ui.lexical.core';\n\nimport { $findMatchingParent, $insertNodeToNearestRoot } from 'ui.lexical.utils';\n\nimport {\n\t$importFromBBCode,\n\t$normalizeTextNodes,\n\tshouldWrapInParagraph,\n\ttype BBCodeConversion,\n\ttype BBCodeConversionFn,\n\ttype BBCodeExportOutput,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n} from '../../bbcode';\n\nimport { NewLineMode } from '../../constants';\nimport { $wrapNodes } from '../../helpers/wrap-nodes';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nimport BasePlugin from '../base-plugin';\nimport Button from '../../toolbar/button';\nimport { $createQuoteNode, $isQuoteNode, $removeQuote, QuoteNode } from './quote-node';\n\nimport { type TextEditor } from '../../text-editor';\n\nexport type InsertQuotePayload = {\n\tcontent?: string,\n};\n\n/** @memberof BX.UI.TextEditor.Plugins.Quote */\nexport const INSERT_QUOTE_COMMAND: LexicalCommand<InsertQuotePayload> = createCommand('INSERT_QUOTE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Quote */\nexport const FORMAT_QUOTE_COMMAND: LexicalCommand = createCommand('FORMAT_QUOTE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Quote */\nexport const REMOVE_QUOTE_COMMAND: LexicalCommand = createCommand('REMOVE_QUOTE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Quote */\nexport const TOGGLE_QUOTE_COMMAND: LexicalCommand = createCommand('TOGGLE_QUOTE_COMMAND');\n\nexport class QuotePlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Quote';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [QuoteNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tquote: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createQuoteNode(),\n\t\t\t\t\t\tafter: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t\t\t\t\t\treturn $normalizeTextNodes(childLexicalNodes);\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tquote: (lexicalNode: LexicalNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'quote' }),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: QuoteNode,\n\t\t\t\tvalidate: ((quoteNode: QuoteNode) => {\n\t\t\t\t\tlet prevParagraph = null;\n\t\t\t\t\tquoteNode.getChildren().forEach((child: LexicalNode | ElementNode) => {\n\t\t\t\t\t\tif (shouldWrapInParagraph(child))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (prevParagraph === null)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst paragraph = $createParagraphNode();\n\t\t\t\t\t\t\t\tchild.replace(paragraph);\n\t\t\t\t\t\t\t\tparagraph.append(child);\n\t\t\t\t\t\t\t\tprevParagraph = paragraph;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprevParagraph.append(child);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprevParagraph = null;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn false;\n\t\t\t\t}),\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tquote: 'quote',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_QUOTE_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tconst quoteNode = $createQuoteNode();\n\t\t\t\t\tif (Type.isPlainObject(payload) && Type.isStringFilled(payload.content))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst nodes = $importFromBBCode(payload.content, this.getEditor(), false);\n\t\t\t\t\t\tquoteNode.append(...$normalizeTextNodes(nodes));\n\t\t\t\t\t\t$insertNodeToNearestRoot(quoteNode);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tquoteNode.append($createParagraphNode());\n\t\t\t\t\t\t$insertNodeToNearestRoot(quoteNode);\n\t\t\t\t\t}\n\n\t\t\t\t\tquoteNode.selectStart();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tFORMAT_QUOTE_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\tif ($isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst quoteNode = $createQuoteNode();\n\t\t\t\t\t\t$wrapNodes(selection, () => quoteNode);\n\n\t\t\t\t\t\tif (quoteNode.isEmpty())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tquoteNode.append($createParagraphNode());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tquoteNode.selectStart();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tREMOVE_QUOTE_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet quoteNode = $findMatchingParent(selection.anchor.getNode(), $isQuoteNode);\n\t\t\t\t\tif (!quoteNode)\n\t\t\t\t\t{\n\t\t\t\t\t\tquoteNode = $findMatchingParent(selection.focus.getNode(), $isQuoteNode);\n\t\t\t\t\t}\n\n\t\t\t\t\t$removeQuote(quoteNode);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tTOGGLE_QUOTE_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet quoteNode = $findMatchingParent(selection.anchor.getNode(), $isQuoteNode);\n\t\t\t\t\tif (!quoteNode)\n\t\t\t\t\t{\n\t\t\t\t\t\tquoteNode = $findMatchingParent(selection.focus.getNode(), $isQuoteNode);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (quoteNode)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(REMOVE_QUOTE_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.getEditor().getNewLineMode() === NewLineMode.LINE_BREAK)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_QUOTE_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_QUOTE_COMMAND);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('quote', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --quote\"></span>');\n\t\t\tbutton.setBlockType('quote');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_QUOTE'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tif (button.isActive())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(REMOVE_QUOTE_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.getEditor().getNewLineMode() === NewLineMode.LINE_BREAK)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_QUOTE_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_QUOTE_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","/*\neslint-disable no-underscore-dangle,\n@bitrix24/bitrix24-rules/no-pseudo-private,\n@bitrix24/bitrix24-rules/no-native-dom-methods\n*/\n\nimport { Dom, Type } from 'main.core';\n\nimport { type SpoilerNode, $createSpoilerNode } from './spoiler-node';\n\nimport {\n\tElementNode,\n\t$isElementNode,\n\t$isDecoratorNode,\n\t$createParagraphNode,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype SerializedElementNode,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\ntype SerializedSpoilerContentNode = SerializedElementNode;\n\nexport function convertSpoilerContentElement(domNode: HTMLElement): DOMConversionOutput | null\n{\n\tconst node = $createSpoilerContentNode();\n\n\treturn { node };\n}\n\nexport class SpoilerContentNode extends ElementNode\n{\n\tstatic getType(): string\n\t{\n\t\treturn 'spoiler-content';\n\t}\n\n\tstatic clone(node: SpoilerContentNode): SpoilerContentNode\n\t{\n\t\treturn new SpoilerContentNode(node.__key);\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLElement\n\t{\n\t\tconst dom = document.createElement('div');\n\n\t\tif (Type.isStringFilled(config?.theme?.spoiler?.content))\n\t\t{\n\t\t\tDom.addClass(dom, config.theme.spoiler.content);\n\t\t}\n\n\t\treturn dom;\n\t}\n\n\tupdateDOM(prevNode: SpoilerContentNode, dom: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\tdiv: (domNode: HTMLElement) => {\n\t\t\t\tif (!domNode.hasAttribute('data-spoiler-content'))\n\t\t\t\t{\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tconversion: convertSpoilerContentElement,\n\t\t\t\t\tpriority: 2,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tstatic importJSON(serializedNode: SerializedSpoilerContentNode): SpoilerContentNode\n\t{\n\t\treturn $createSpoilerContentNode();\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\tconst element = document.createElement('div');\n\t\telement.setAttribute('data-spoiler-content', 'true');\n\n\t\treturn { element };\n\t}\n\n\texportJSON(): SerializedSpoilerContentNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'spoiler-content',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tisShadowRoot(): boolean\n\t{\n\t\treturn true;\n\t}\n\n\tisParentRequired(): boolean\n\t{\n\t\treturn true;\n\t}\n\n\tcreateParentElementNode(): SpoilerNode\n\t{\n\t\treturn $createSpoilerNode();\n\t}\n\n\tcanIndent(): false\n\t{\n\t\treturn false;\n\t}\n\n\tcanInsertAfter(node: LexicalNode): false\n\t{\n\t\treturn false;\n\t}\n\n\tcanReplaceWith(replacement: LexicalNode): false\n\t{\n\t\treturn false;\n\t}\n\n\tinsertBefore(node: LexicalNode): LexicalNode\n\t{\n\t\tconst firstChild = this.getFirstChild();\n\t\tconst nodeToInsert = (\n\t\t\t$isElementNode(node) || $isDecoratorNode(node)\n\t\t\t\t? node\n\t\t\t\t: $createParagraphNode().append(node)\n\t\t);\n\n\t\tif (firstChild === null)\n\t\t{\n\t\t\tthis.append(nodeToInsert);\n\t\t}\n\t\telse if (firstChild !== nodeToInsert)\n\t\t{\n\t\t\tfirstChild.insertBefore(nodeToInsert);\n\t\t}\n\n\t\treturn nodeToInsert;\n\t}\n\n\tinsertAfter(node: LexicalNode): LexicalNode\n\t{\n\t\tconst nodeToInsert = (\n\t\t\t$isElementNode(node) || $isDecoratorNode(node)\n\t\t\t\t? node\n\t\t\t\t: $createParagraphNode().append(node)\n\t\t);\n\n\t\tthis.append(nodeToInsert);\n\n\t\treturn nodeToInsert;\n\t}\n}\n\nexport function $createSpoilerContentNode(): SpoilerContentNode\n{\n\treturn new SpoilerContentNode();\n}\n\nexport function $isSpoilerContentNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof SpoilerContentNode;\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport {\n\tTextNode,\n\t$applyNodeReplacement,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype SerializedTextNode,\n} from 'ui.lexical.core';\n\nexport class SpoilerTitleTextNode extends TextNode\n{\n\tstatic getType(): string\n\t{\n\t\treturn 'spoiler-title-text';\n\t}\n\n\tstatic clone(node: SpoilerTitleTextNode): SpoilerTitleTextNode\n\t{\n\t\treturn new SpoilerTitleTextNode(node.__text, node.__key);\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\treturn super.createDOM(config);\n\t}\n\n\tstatic importJSON(serializedNode: SerializedTextNode): SpoilerTitleTextNode\n\t{\n\t\treturn $createSpoilerTitleTextNode(serializedNode.text);\n\t}\n\n\texportJSON(): SerializedTextNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'spoiler-title-text',\n\t\t};\n\t}\n}\n\nexport function $createSpoilerTitleTextNode(text = ''): SpoilerTitleTextNode\n{\n\treturn $applyNodeReplacement(new SpoilerTitleTextNode(text));\n}\n\nexport function $isSpoilerTitleTextNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof SpoilerTitleTextNode;\n}\n","/* eslint-disable @bitrix24/bitrix24-rules/no-native-dom-methods */\nimport { Loc, Type } from 'main.core';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\nimport {\n\t$normalizeTextNodes,\n\tshouldWrapInParagraph,\n\ttype BBCodeConversion,\n\ttype BBCodeConversionFn,\n\ttype BBCodeExportOutput,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n} from '../../bbcode';\n\nimport { $findMatchingParent } from 'ui.lexical.utils';\nimport { $getAncestor } from '../../helpers/get-ancestor';\nimport { $isBlockNode } from '../../helpers/is-block-node';\n\nimport { $createSpoilerContentNode, $isSpoilerContentNode, SpoilerContentNode } from './spoiler-content-node';\nimport { $createSpoiler, $createSpoilerNode, $isSpoilerNode, SpoilerNode } from './spoiler-node';\nimport { $createSpoilerTitleNode, $isSpoilerTitleNode, $removeSpoiler, SpoilerTitleNode } from './spoiler-title-node';\n\nimport BasePlugin from '../base-plugin';\nimport Button from '../../toolbar/button';\n\nimport {\n\t$createParagraphNode,\n\t$getPreviousSelection,\n\t$getSelection,\n\t$isElementNode,\n\t$isDecoratorNode,\n\t$isRangeSelection,\n\t$setSelection,\n\tcreateCommand,\n\t$isRootOrShadowRoot,\n\t$createTextNode,\n\t$getRoot,\n\tCOMMAND_PRIORITY_LOW,\n\tCOMMAND_PRIORITY_NORMAL,\n\tINSERT_PARAGRAPH_COMMAND,\n\tDELETE_CHARACTER_COMMAND,\n\tPASTE_COMMAND,\n\tKEY_ENTER_COMMAND,\n\ttype ElementNode,\n\ttype LexicalNode,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nimport { $insertDataTransferForPlainText } from 'ui.lexical.clipboard';\n\nimport { type TextEditor } from '../../text-editor';\nimport { type SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nimport { $createSpoilerTitleTextNode, $isSpoilerTitleTextNode, SpoilerTitleTextNode } from './spoiler-title-text-node';\n\n/** @memberof BX.UI.TextEditor.Plugins.Spoiler */\nexport const INSERT_SPOILER_COMMAND = createCommand('INSERT_SPOILER_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Spoiler */\nexport const REMOVE_SPOILER_COMMAND = createCommand('REMOVE_SPOILER_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Spoiler */\nexport const TOGGLE_SPOILER_COMMAND = createCommand('TOGGLE_SPOILER_COMMAND');\n\nexport class SpoilerPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerNodeTransforms();\n\t\tthis.#registerCommands();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Spoiler';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [\n\t\t\tSpoilerNode,\n\t\t\tSpoilerTitleNode,\n\t\t\tSpoilerContentNode,\n\t\t\tSpoilerTitleTextNode,\n\t\t];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tspoiler: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\tconst title: string = (\n\t\t\t\t\t\tType.isStringFilled(node.getValue())\n\t\t\t\t\t\t\t? trimSpoilerTitle(node.getValue())\n\t\t\t\t\t\t\t: Loc.getMessage('TEXT_EDITOR_SPOILER_TITLE')\n\t\t\t\t\t);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createSpoilerNode(false),\n\t\t\t\t\t\tafter: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t$createSpoilerTitleNode().append($createSpoilerTitleTextNode(title)),\n\t\t\t\t\t\t\t\t$createSpoilerContentNode().append(...$normalizeTextNodes(childLexicalNodes)),\n\t\t\t\t\t\t\t];\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tspoiler: (spoilerNode: SpoilerNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\t\t\t\tconst titleNode = spoilerNode.getChildren()[0];\n\t\t\t\tconst title = trimSpoilerTitle(titleNode.getTextContent());\n\t\t\t\tconst value = title === Loc.getMessage('TEXT_EDITOR_SPOILER_TITLE') ? '' : title;\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'spoiler', value }),\n\t\t\t\t};\n\t\t\t},\n\t\t\t'spoiler-title': (node: SpoilerTitleNode): BBCodeExportOutput => {\n\t\t\t\treturn {\n\t\t\t\t\tnode: null,\n\t\t\t\t};\n\t\t\t},\n\t\t\t'spoiler-content': (node: SpoilerContentNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createFragment(),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [\n\t\t\t\t{\n\t\t\t\t\tnodeClass: SpoilerNode,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tnodeClass: SpoilerContentNode,\n\t\t\t\t\tvalidate: ((contentNode: SpoilerContentNode) => {\n\t\t\t\t\t\tcontentNode.getChildren().forEach((child: LexicalNode | ElementNode) => {\n\t\t\t\t\t\t\tif (shouldWrapInParagraph(child))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst paragraph = $createParagraphNode();\n\t\t\t\t\t\t\t\tchild.replace(paragraph);\n\t\t\t\t\t\t\t\tparagraph.append(child);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tbbcodeMap: {\n\t\t\t\tspoiler: 'spoiler',\n\t\t\t\t'spoiler-content': 'spoiler',\n\t\t\t\t'spoiler-title': 'spoiler',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('spoiler', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --insert-spoiler\"></span>');\n\t\t\tbutton.setBlockType('spoiler');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_SPOILER'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tif (button.isActive())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(REMOVE_SPOILER_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_SPOILER_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\t#registerCommands(): () => void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\t// This handles the case when container is collapsed and we delete its previous sibling\n\t\t\t// into it, it would cause collapsed content deleted (since it's display: none, and selection\n\t\t\t// swallows it when deletes single char). Instead we expand container, which is although\n\t\t\t// not perfect, but avoids bigger problem\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDELETE_CHARACTER_COMMAND,\n\t\t\t\tthis.#handleDeleteCharacter.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_ENTER_COMMAND,\n\t\t\t\tthis.#handleEnter.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_PARAGRAPH_COMMAND,\n\t\t\t\t(event: KeyboardEvent) => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif ($isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst spoilerTitleNode: SpoilerTitleNode = $findMatchingParent(\n\t\t\t\t\t\t\tselection.anchor.getNode(),\n\t\t\t\t\t\t\t(node: LexicalNode) => $isSpoilerTitleNode(node),\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (spoilerTitleNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst newBlock: ElementNode = spoilerTitleNode.insertNewAfter(selection);\n\t\t\t\t\t\t\tif (newBlock)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnewBlock.selectStart();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tPASTE_COMMAND,\n\t\t\t\tthis.#handlePaste.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_SPOILER_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\tconst title = Type.isPlainObject(payload) && Type.isStringFilled(payload.title) ? payload.title : undefined;\n\t\t\t\t\t\tlet selection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\t\tif (selection === null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tselection = $getRoot().selectEnd();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst spoiler = insertSpoiler(selection, title);\n\n\t\t\t\t\t\tif (spoiler !== null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tspoiler.getContentNode()?.getChildren()[0]?.select();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tREMOVE_SPOILER_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet spoilerNode = $findMatchingParent(selection.anchor.getNode(), $isSpoilerNode);\n\t\t\t\t\t\tif (!spoilerNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tspoilerNode = $findMatchingParent(selection.focus.getNode(), $isSpoilerNode);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$removeSpoiler(spoilerNode);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tTOGGLE_SPOILER_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet spoilerNode = $findMatchingParent(selection.anchor.getNode(), $isSpoilerNode);\n\t\t\t\t\tif (!spoilerNode)\n\t\t\t\t\t{\n\t\t\t\t\t\tspoilerNode = $findMatchingParent(selection.focus.getNode(), $isSpoilerNode);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (spoilerNode)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(REMOVE_SPOILER_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_SPOILER_COMMAND);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerNodeTransforms(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\t// Structure enforcing transformers for each node type. In case nesting structure is not\n\t\t\t// \"Container > Title + Content\" it'll unwrap nodes and convert it back\n\t\t\t// to regular content.\n\t\t\tthis.getEditor().registerNodeTransform(SpoilerNode, (node) => {\n\t\t\t\tconst children = node.getChildren();\n\t\t\t\tif (children.length !== 2 || !$isSpoilerTitleNode(children[0]) || !$isSpoilerContentNode(children[1]))\n\t\t\t\t{\n\t\t\t\t\tfor (const child of children)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($isElementNode(child) || $isDecoratorNode(child))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode.insertBefore(child);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode.insertBefore($createParagraphNode().append(child));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tnode.remove();\n\t\t\t\t}\n\t\t\t}),\n\n\t\t\tthis.getEditor().registerNodeTransform(SpoilerTitleNode, (node: SpoilerTitleNode) => {\n\t\t\t\tconst parent: ElementNode = node.getParent();\n\t\t\t\tif (!$isSpoilerNode(parent))\n\t\t\t\t{\n\t\t\t\t\tnode.replace($createParagraphNode().append(...node.getChildren()));\n\t\t\t\t}\n\t\t\t\telse if (\n\t\t\t\t\t(node.getChildrenSize() === 1 && !$isSpoilerTitleTextNode(node.getFirstChild()))\n\t\t\t\t\t|| node.getChildrenSize() > 1\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\t$setSelection(null);\n\t\t\t\t\tconst textContent = trimSpoilerTitle(node.getTextContent());\n\t\t\t\t\tnode.clear();\n\t\t\t\t\tnode.append($createSpoilerTitleTextNode(textContent));\n\t\t\t\t\tnode.select();\n\t\t\t\t}\n\t\t\t}),\n\n\t\t\tthis.getEditor().registerNodeTransform(SpoilerTitleTextNode, (node: SpoilerTitleNode) => {\n\t\t\t\tconst parent: ElementNode = node.getParent();\n\t\t\t\tif (!$isSpoilerTitleNode(parent))\n\t\t\t\t{\n\t\t\t\t\tnode.replace($createParagraphNode().append($createTextNode(node.getTextContent())));\n\t\t\t\t}\n\t\t\t}),\n\n\t\t\tthis.getEditor().registerNodeTransform(SpoilerContentNode, (node) => {\n\t\t\t\tconst parent = node.getParent();\n\t\t\t\tif (!$isSpoilerNode(parent))\n\t\t\t\t{\n\t\t\t\t\tconst children = node.getChildren();\n\t\t\t\t\tfor (const child of children)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($isElementNode(child) || $isDecoratorNode(child))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode.insertBefore(child);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode.insertBefore($createParagraphNode().append(child));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tnode.remove();\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\t#handleDeleteCharacter(): boolean\n\t{\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif (!$isRangeSelection(selection) || !selection.isCollapsed() || selection.anchor.offset !== 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst anchorNode = selection.anchor.getNode();\n\t\tconst topLevelElement = anchorNode.getTopLevelElement();\n\t\tif (topLevelElement === null)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst container: SpoilerNode = topLevelElement.getPreviousSibling();\n\t\tif (!$isSpoilerNode(container) || container.getOpen())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tcontainer.setOpen(true);\n\n\t\treturn true;\n\t}\n\n\t#handleEnter(event: KeyboardEvent): boolean\n\t{\n\t\tif (event && (event.ctrlKey || event.metaKey))\n\t\t{\n\t\t\t// Handling CMD+Enter to toggle spoiler element collapsed state\n\t\t\tconst selection: RangeSelection = $getPreviousSelection();\n\t\t\tif ($isRangeSelection(selection) && selection.isCollapsed())\n\t\t\t{\n\t\t\t\tconst parent = $findMatchingParent(\n\t\t\t\t\tselection.anchor.getNode(),\n\t\t\t\t\t(node) => $isElementNode(node) && !node.isInline(),\n\t\t\t\t);\n\n\t\t\t\tif ($isSpoilerTitleNode(parent))\n\t\t\t\t{\n\t\t\t\t\tconst container: SpoilerNode = parent.getParent();\n\t\t\t\t\tif ($isSpoilerNode(container))\n\t\t\t\t\t{\n\t\t\t\t\t\tcontainer.toggleOpen();\n\t\t\t\t\t\t$setSelection(selection.clone());\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t#handlePaste(event: ClipboardEvent): boolean\n\t{\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif (\n\t\t\t!$isRangeSelection(selection)\n\t\t\t|| !(event instanceof ClipboardEvent)\n\t\t\t|| event.clipboardData === null\n\t\t)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst spoilerTitleNode: SpoilerTitleNode = $findMatchingParent(\n\t\t\tselection.anchor.getNode(),\n\t\t\t(node: LexicalNode) => $isSpoilerTitleNode(node),\n\t\t);\n\n\t\tif (spoilerTitleNode)\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t\tthis.getEditor().update(\n\t\t\t\t() => {\n\t\t\t\t\t$insertDataTransferForPlainText(event.clipboardData, selection);\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttag: 'paste',\n\t\t\t\t},\n\t\t\t);\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n}\n\nexport function insertSpoiler(selection: RangeSelection, title?: string)\n{\n\tif (!$isRangeSelection(selection))\n\t{\n\t\treturn null;\n\t}\n\n\tconst anchor = selection.anchor;\n\tconst anchorNode: ElementNode = anchor.getNode();\n\tconst spoiler: SpoilerNode = $createSpoiler(true, title);\n\tif ($isRootOrShadowRoot(anchorNode))\n\t{\n\t\tconst firstChild = anchorNode.getFirstChild();\n\t\tif (firstChild)\n\t\t{\n\t\t\tfirstChild.replace(spoiler, true);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tanchorNode.append(spoiler);\n\t\t}\n\n\t\treturn spoiler;\n\t}\n\n\tconst handled = new Set();\n\tconst nodes: LexicalNode[] = selection.getNodes();\n\tconst firstSelectedBlock = $getAncestor(selection.anchor.getNode(), $isBlockNode);\n\tif (firstSelectedBlock && !nodes.includes(firstSelectedBlock))\n\t{\n\t\tnodes.unshift(firstSelectedBlock);\n\t}\n\n\thandled.add(spoiler.getKey());\n\thandled.add(spoiler.getTitleNode().getKey());\n\thandled.add(spoiler.getContentNode().getKey());\n\n\tlet firstNode = true;\n\tfor (const node of nodes)\n\t{\n\t\tif (!$isBlockNode(node) || handled.has(node.getKey()))\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst isParentHandled = $getAncestor(\n\t\t\tnode.getParent(),\n\t\t\t(parentNode: LexicalNode): boolean => handled.has(parentNode.getKey()),\n\t\t);\n\n\t\tif (isParentHandled)\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (firstNode)\n\t\t{\n\t\t\tfirstNode = false;\n\t\t\tnode.replace(spoiler);\n\t\t\tspoiler.getContentNode().append(node);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tspoiler.getContentNode().append(node);\n\t\t}\n\n\t\t// let parent: ElementNode = node.getParent();\n\t\t// while (parent !== null)\n\t\t// {\n\t\t// \tconst parentKey = parent.getKey();\n\t\t// \tconst nextParent: ElementNode = parent.getParent();\n\t\t// \tif ($isRootOrShadowRoot(nextParent) && !handled.has(parentKey))\n\t\t// \t{\n\t\t// \t\thandled.add(parentKey);\n\t\t// \t\tcreateSpoilerOrMerge(parent);\n\t\t//\n\t\t// \t\tbreak;\n\t\t// \t}\n\t\t//\n\t\t// \tparent = nextParent;\n\t\t// }\n\n\t\thandled.add(node.getKey());\n\t}\n\n\treturn spoiler;\n}\n\nexport function trimSpoilerTitle(title: string): string\n{\n\treturn title.trim()\n\t\t.replaceAll(/\\r?\\n|\\t/gm, '')\n\t\t.replace('\\r', '')\n\t\t.replaceAll(/\\s+/g, ' ')\n\t;\n}\n","/*\neslint-disable no-underscore-dangle,\n@bitrix24/bitrix24-rules/no-pseudo-private,\n@bitrix24/bitrix24-rules/no-native-dom-methods\n*/\n\nimport { Dom, Type } from 'main.core';\nimport { UNFORMATTED } from '../../constants';\n\nimport { $isSpoilerContentNode, SpoilerContentNode } from './spoiler-content-node';\nimport { $createSpoilerNode, $isSpoilerNode, type SpoilerNode } from './spoiler-node';\nimport { trimSpoilerTitle } from './spoiler-plugin';\n\nimport {\n\tElementNode,\n\t$createParagraphNode,\n\t$isElementNode,\n\t$isDecoratorNode,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype RangeSelection,\n\ttype SerializedElementNode,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\nimport { $createSpoilerTitleTextNode } from './spoiler-title-text-node';\n\ntype SerializedSpoilerTitleNode = SerializedElementNode;\n\nexport function convertSummaryElement(domNode: HTMLElement): DOMConversionOutput | null\n{\n\tconst node = $createSpoilerTitleNode();\n\n\treturn { node };\n}\n\nexport class SpoilerTitleNode extends ElementNode\n{\n\t__language: string = 'hack';\n\t__flags: number = UNFORMATTED;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'spoiler-title';\n\t}\n\n\tstatic clone(node: SpoilerTitleNode): SpoilerTitleNode\n\t{\n\t\treturn new SpoilerTitleNode(node.__key);\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLElement\n\t{\n\t\tconst dom = document.createElement('summary');\n\t\tdom.tabIndex = -1;\n\n\t\tif (Type.isStringFilled(config?.theme?.spoiler?.title))\n\t\t{\n\t\t\tDom.addClass(dom, config.theme.spoiler.title);\n\t\t}\n\n\t\tDom.addClass(dom, 'ui-icon-set__scope');\n\n\t\treturn dom;\n\t}\n\n\tupdateDOM(prevNode: SpoilerTitleNode, dom: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\tsummary: (domNode: HTMLElement) => {\n\t\t\t\treturn {\n\t\t\t\t\tconversion: convertSummaryElement,\n\t\t\t\t\tpriority: 1,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tstatic importJSON(serializedNode: SerializedSpoilerTitleNode): SpoilerTitleNode\n\t{\n\t\treturn $createSpoilerTitleNode();\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\tconst element = document.createElement('summary');\n\n\t\treturn { element };\n\t}\n\n\texportJSON(): SerializedSpoilerTitleNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'spoiler-title',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcollapseAtStart(selection: RangeSelection): boolean\n\t{\n\t\tconst spoilerNode: SpoilerNode = this.getParent();\n\t\tif (!$isSpoilerNode(spoilerNode))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn $removeSpoiler(spoilerNode);\n\t}\n\n\tinsertNewAfter(selection: RangeSelection, restoreSelection = true): ElementNode\n\t{\n\t\tconst containerNode: SpoilerNode = this.getParentOrThrow();\n\n\t\tif (!$isSpoilerNode(containerNode))\n\t\t{\n\t\t\tthrow new Error(\n\t\t\t\t'SpoilerTitleNode expects to be child of SpoilerNode',\n\t\t\t);\n\t\t}\n\n\t\tif (containerNode.getOpen())\n\t\t{\n\t\t\tconst contentNode: SpoilerContentNode = this.getNextSibling();\n\t\t\tif (!$isSpoilerContentNode(contentNode))\n\t\t\t{\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'SpoilerTitleNode expects to have SpoilerContentNode sibling',\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst firstChild = contentNode.getFirstChild();\n\t\t\tif ($isElementNode(firstChild) || $isDecoratorNode(firstChild))\n\t\t\t{\n\t\t\t\treturn firstChild;\n\t\t\t}\n\n\t\t\tconst paragraph = $createParagraphNode();\n\t\t\tcontentNode.append(paragraph);\n\n\t\t\treturn paragraph;\n\t\t}\n\n\t\tconst paragraph = $createParagraphNode();\n\t\tcontainerNode.insertAfter(paragraph, restoreSelection);\n\n\t\treturn paragraph;\n\t}\n\n\tisParentRequired(): boolean\n\t{\n\t\treturn true;\n\t}\n\n\tcreateParentElementNode(): SpoilerNode\n\t{\n\t\treturn $createSpoilerNode();\n\t}\n\n\tcanIndent(): false\n\t{\n\t\treturn false;\n\t}\n\n\tinsertAfter(nodeToInsert: LexicalNode): LexicalNode\n\t{\n\t\tconst textContent = nodeToInsert.getTextContent();\n\t\tthis.clear();\n\t\tthis.append($createSpoilerTitleTextNode(trimSpoilerTitle(textContent)));\n\n\t\treturn this;\n\t}\n}\n\nexport function $createSpoilerTitleNode(): SpoilerTitleNode\n{\n\treturn new SpoilerTitleNode();\n}\n\nexport function $isSpoilerTitleNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof SpoilerTitleNode;\n}\n\nexport function $removeSpoiler(spoilerNode: SpoilerNode): boolean\n{\n\tif (!$isSpoilerNode(spoilerNode))\n\t{\n\t\treturn false;\n\t}\n\n\tconst contentNode: SpoilerContentNode = spoilerNode.getContentNode();\n\tlet lastElement = spoilerNode;\n\n\tif (contentNode !== null)\n\t{\n\t\tfor (const child of contentNode.getChildren())\n\t\t{\n\t\t\tif ($isElementNode(child) || $isDecoratorNode(child))\n\t\t\t{\n\t\t\t\tlastElement = lastElement.insertAfter(child);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tlastElement = lastElement.insertAfter($createParagraphNode().append(child));\n\t\t\t}\n\t\t}\n\t}\n\n\tspoilerNode.remove();\n\n\treturn true;\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\nimport { Dom, Type, Loc, Event } from 'main.core';\n\nimport { $createSpoilerContentNode, $isSpoilerContentNode, SpoilerContentNode } from './spoiler-content-node';\nimport { $createSpoilerTitleNode, $isSpoilerTitleNode, SpoilerTitleNode } from './spoiler-title-node';\n\nimport {\n\tElementNode,\n\t$isElementNode,\n\t$isDecoratorNode,\n\t$createParagraphNode,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype NodeKey,\n\ttype SerializedElementNode,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\nimport { $createSpoilerTitleTextNode } from './spoiler-title-text-node';\n\ntype SerializedSpoilerNode = SerializedElementNode & { open: boolean };\n\nexport class SpoilerNode extends ElementNode\n{\n\t__open: boolean;\n\n\tconstructor(open: boolean, key?: NodeKey)\n\t{\n\t\tsuper(key);\n\n\t\tthis.__open = open;\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'spoiler';\n\t}\n\n\tstatic clone(node: SpoilerNode): SpoilerNode\n\t{\n\t\treturn new SpoilerNode(node.__open, node.__key);\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLElement\n\t{\n\t\tconst details = document.createElement('details');\n\t\tif (Type.isStringFilled(config?.theme?.spoiler?.container))\n\t\t{\n\t\t\tDom.addClass(details, config.theme.spoiler.container);\n\t\t}\n\n\t\tdetails.open = this.__open;\n\n\t\tEvent.bind(details, 'toggle', () => {\n\t\t\tconst open = editor.getEditorState().read(() => this.getOpen());\n\t\t\tif (open !== details.open)\n\t\t\t{\n\t\t\t\teditor.update(() => this.toggleOpen());\n\t\t\t}\n\t\t});\n\n\t\treturn details;\n\t}\n\n\tupdateDOM(prevNode: SpoilerNode, dom: HTMLDetailsElement, config: EditorConfig): boolean\n\t{\n\t\tif (prevNode.__open !== this.__open)\n\t\t{\n\t\t\tdom.open = this.__open;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tstatic importDOM(): DOMConversionMap<HTMLDetailsElement> | null\n\t{\n\t\treturn {\n\t\t\tdetails: (domNode: HTMLDetailsElement) => {\n\t\t\t\treturn {\n\t\t\t\t\tconversion: (details: HTMLDetailsElement): DOMConversionOutput | null => {\n\t\t\t\t\t\tconst isOpen = Type.isBoolean(details.open) ? details.open : true;\n\n\t\t\t\t\t\treturn { node: $createSpoiler(isOpen) };\n\t\t\t\t\t},\n\t\t\t\t\tpriority: 1,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tstatic importJSON(serializedNode: SerializedSpoilerNode): SpoilerNode\n\t{\n\t\treturn $createSpoilerNode(serializedNode.open);\n\t}\n\n\texportDOM(editor: LexicalEditor): DOMExportOutput\n\t{\n\t\tconst details = document.createElement('details');\n\t\tif (this.__open)\n\t\t{\n\t\t\tdetails.setAttribute('open', true);\n\t\t}\n\n\t\treturn { element: details };\n\t}\n\n\texportJSON(): SerializedSpoilerNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\topen: this.__open,\n\t\t\ttype: 'spoiler',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\t// isShadowRoot(): boolean\n\t// {\n\t// \treturn true;\n\t// }\n\n\tcanBeEmpty(): false\n\t{\n\t\treturn false;\n\t}\n\n\tappend(...nodesToAppend: LexicalNode[]): this\n\t{\n\t\tfor (const node of nodesToAppend)\n\t\t{\n\t\t\tif ($isSpoilerTitleNode(node))\n\t\t\t{\n\t\t\t\tconst titleNode: SpoilerTitleNode = node;\n\t\t\t\tif (this.getTitleNode() === null)\n\t\t\t\t{\n\t\t\t\t\tsuper.append(titleNode);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.getTitleNode().clear();\n\t\t\t\t\tthis.getTitleNode().append($createSpoilerTitleTextNode(node.getTextContent()));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if ($isSpoilerContentNode(node))\n\t\t\t{\n\t\t\t\tconst contentNode: SpoilerContentNode = node;\n\t\t\t\tif (this.getContentNode() === null)\n\t\t\t\t{\n\t\t\t\t\tsuper.append(contentNode);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.getContentNode().append(...contentNode.getChildren());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if ($isElementNode(node) || $isDecoratorNode(node))\n\t\t\t{\n\t\t\t\tthis.getContentNode().append(node);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.getContentNode().append($createParagraphNode().append(node));\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tgetTitleNode(): SpoilerTitleNode | null\n\t{\n\t\treturn this.getChildren()[0] || null;\n\t}\n\n\tgetContentNode(): SpoilerContentNode | null\n\t{\n\t\treturn this.getChildren()[1] || null;\n\t}\n\n\tsetOpen(open: boolean): void\n\t{\n\t\tconst writable = this.getWritable();\n\t\twritable.__open = open;\n\t}\n\n\tgetOpen(): boolean\n\t{\n\t\treturn this.getLatest().__open;\n\t}\n\n\ttoggleOpen(): void\n\t{\n\t\tthis.setOpen(!this.getOpen());\n\t}\n}\n\nexport function $createSpoiler(isOpen: boolean, title: string = Loc.getMessage('TEXT_EDITOR_SPOILER_TITLE')): SpoilerNode\n{\n\treturn $createSpoilerNode(isOpen).append(\n\t\t$createSpoilerTitleNode().append($createSpoilerTitleTextNode(title)),\n\t\t$createSpoilerContentNode(),\n\t);\n}\n\nexport function $createSpoilerNode(isOpen: boolean): SpoilerNode\n{\n\treturn new SpoilerNode(isOpen);\n}\n\nexport function $isSpoilerNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof SpoilerNode;\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport {\n\t$createParagraphNode,\n\t$isTextNode,\n\t$hasUpdateTag,\n\t$isRootNode,\n\tParagraphNode,\n\ttype RangeSelection,\n\ttype NodeKey,\n\ttype SerializedParagraphNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMConversion,\n} from 'ui.lexical.core';\n\nimport { NewLineMode } from '../../constants';\nimport type { NewLineModeType } from '../../types/new-line-mode-type';\n\nexport type SerializedCustomParagraphNode = SerializedParagraphNode & {\n\tmode: NewLineModeType,\n}\n\nexport class CustomParagraphNode extends ParagraphNode\n{\n\t__mode: NewLineModeType = NewLineMode.MIXED;\n\n\tconstructor(__mode: NewLineModeType, key?: NodeKey)\n\t{\n\t\tsuper(key);\n\t\tthis.__mode = __mode;\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'custom-paragraph';\n\t}\n\n\tstatic clone(node: CustomParagraphNode): CustomParagraphNode\n\t{\n\t\treturn new CustomParagraphNode(node.__mode, node.__key);\n\t}\n\n\tinsertNewAfter(selection: RangeSelection, restoreSelection: boolean): ParagraphNode\n\t{\n\t\tif (this.__mode === NewLineMode.PARAGRAPH)\n\t\t{\n\t\t\treturn super.insertNewAfter(selection, restoreSelection);\n\t\t}\n\n\t\tif (this.__mode === NewLineMode.MIXED)\n\t\t{\n\t\t\tconst children = this.getChildren();\n\t\t\tconst childrenLength = children.length;\n\n\t\t\tif (\n\t\t\t\tchildrenLength >= 1\n\t\t\t\t&& children[childrenLength - 1].getTextContent() === '\\n'\n\t\t\t\t&& selection.isCollapsed()\n\t\t\t\t&& selection.anchor.key === this.__key\n\t\t\t\t&& selection.anchor.offset === childrenLength\n\t\t\t)\n\t\t\t{\n\t\t\t\tchildren[childrenLength - 1].remove();\n\t\t\t\tconst newElement = $createParagraphNode();\n\t\t\t\tthis.insertAfter(newElement, restoreSelection);\n\n\t\t\t\treturn newElement;\n\t\t\t}\n\n\t\t\tif ($hasUpdateTag('paste'))\n\t\t\t{\n\t\t\t\treturn super.insertNewAfter(selection, restoreSelection);\n\t\t\t}\n\t\t}\n\n\t\tselection.insertLineBreak();\n\n\t\treturn null;\n\t}\n\n\t// createDOM(config) {\n\t// \tconst dom = super.createDOM(config);\n\t// \tdom.style = \"border: 1px dashed tomato\";\n\t//\n\t// \treturn dom;\n\t// }\n\n\texportJSON(): SerializedCustomParagraphNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\tmode: this.__mode,\n\t\t\ttype: 'custom-paragraph',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\tp: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: (element: HTMLElement): DOMConversionOutput => {\n\t\t\t\t\treturn { node: $createParagraphNode() };\n\t\t\t\t},\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\th1: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: convertHeadingElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\th2: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: convertHeadingElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\th3: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: convertHeadingElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\th4: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: convertHeadingElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\th5: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: convertHeadingElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\th6: (node: Node): DOMConversion => ({\n\t\t\t\tconversion: convertHeadingElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t};\n\t}\n\n\tcollapseAtStart(): boolean\n\t{\n\t\tconst children = this.getChildren();\n\t\t// If we have an empty (trimmed) first paragraph and try and remove it,\n\t\t// delete the paragraph as long as we have another sibling to go to\n\t\tif (\n\t\t\tchildren.length === 0\n\t\t\t|| ($isTextNode(children[0]) && children[0].getTextContent().trim() === '')\n\t\t)\n\t\t{\n\t\t\tconst nextSibling = this.getNextSibling();\n\t\t\tif (nextSibling !== null)\n\t\t\t{\n\t\t\t\tthis.selectNext();\n\t\t\t\tthis.remove();\n\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tconst prevSibling = this.getPreviousSibling();\n\t\t\tif (prevSibling !== null)\n\t\t\t{\n\t\t\t\tthis.selectPrevious();\n\t\t\t\tthis.remove();\n\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tconst parentNode = this.getParent();\n\t\t\tif (\n\t\t\t\tparentNode !== null\n\t\t\t\t&& !$isRootNode(parentNode)\n\t\t\t\t&& Object.getPrototypeOf(parentNode).hasOwnProperty('collapseAtStart'))\n\t\t\t{\n\t\t\t\treturn parentNode.collapseAtStart();\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tstatic importJSON(serializedParagraphNode: SerializedCustomParagraphNode): ParagraphNode\n\t{\n\t\treturn super.importJSON(serializedParagraphNode);\n\t}\n}\n\nfunction convertHeadingElement(element: HTMLElement): DOMConversionOutput\n{\n\treturn {\n\t\tnode: $createParagraphNode(),\n\t\tforChild: (lexicalNode) => {\n\t\t\tif ($isTextNode(lexicalNode))\n\t\t\t{\n\t\t\t\tlexicalNode.toggleFormat('bold');\n\t\t\t}\n\n\t\t\treturn lexicalNode;\n\t\t},\n\t};\n}\n","\nimport { BBCodeNode, type BBCodeElementNode } from 'ui.bbcode.model';\nimport { $insertDataTransferForPlainText } from 'ui.lexical.clipboard';\nimport type { ElementNode } from 'ui.lexical.core';\nimport {\n\tRootNode,\n\tParagraphNode,\n\t$createParagraphNode,\n\t$isParagraphNode,\n\tcreateCommand,\n\t$getSelection,\n\t$isRangeSelection,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\tKEY_ARROW_UP_COMMAND,\n\tKEY_ARROW_LEFT_COMMAND,\n\tKEY_ARROW_DOWN_COMMAND,\n\tKEY_ARROW_RIGHT_COMMAND,\n\tPASTE_COMMAND,\n\ttype LexicalNode,\n\ttype RangeSelection,\n\ttype LexicalCommand,\n\ttype LexicalNodeReplacement,\n} from 'ui.lexical.core';\n\nimport { $setBlocksType } from 'ui.lexical.selection';\nimport { $findMatchingParent } from 'ui.lexical.utils';\n\nimport type {\n\tBBCodeConversion,\n\tBBCodeConversionFn,\n\tBBCodeConversionOutput,\n\tBBCodeExportConversion,\n\tBBCodeExportOutput,\n\tBBCodeImportConversion,\n} from '../../bbcode';\nimport { NewLineMode } from '../../constants';\nimport { wrapTextInParagraph } from '../../helpers/wrap-text-in-paragraph';\n\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nimport BasePlugin from '../base-plugin';\n\nimport { $isCodeNode } from '../code';\nimport { $isQuoteNode } from '../quote';\nimport { $isSpoilerNode } from '../spoiler';\nimport { CustomParagraphNode } from './custom-paragraph-node';\n\nimport { type TextEditor } from '../../text-editor';\n\nimport './paragraph.css';\n\n/** @memberof BX.UI.TextEditor.Plugins.Paragraph */\nexport const FORMAT_PARAGRAPH_COMMAND: LexicalCommand = createCommand('FORMAT_PARAGRAPH_COMMAND');\n\nexport class ParagraphPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerListeners();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Paragraph';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode> | LexicalNodeReplacement>\n\t{\n\t\treturn [\n\t\t\tCustomParagraphNode,\n\t\t\t{\n\t\t\t\treplace: ParagraphNode,\n\t\t\t\twith: (node: ParagraphNode) => {\n\t\t\t\t\treturn new CustomParagraphNode(editor.getNewLineMode());\n\t\t\t\t},\n\t\t\t\twithClass: CustomParagraphNode,\n\t\t\t},\n\t\t];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tp: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => convertParagraphNode(node),\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tleft: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => convertParagraphNode(node),\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tright: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => convertParagraphNode(node),\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tcenter: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => convertParagraphNode(node),\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tjustify: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => convertParagraphNode(node),\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tparagraph: (lexicalNode: LexicalNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'p' }),\n\t\t\t\t};\n\t\t\t},\n\t\t\t'custom-paragraph': (lexicalNode: LexicalNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'p' }),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: CustomParagraphNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\troot: '#root',\n\t\t\t\ttab: '#tab',\n\t\t\t\ttext: '#text',\n\t\t\t\tparagraph: 'p',\n\t\t\t\t'custom-paragraph': 'p',\n\t\t\t\tlinebreak: '#linebreak',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tFORMAT_PARAGRAPH_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif ($isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\t$setBlocksType(selection, () => $createParagraphNode());\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerNodeTransform(RootNode, (root: RootNode) => {\n\t\t\t\tconst selection = $getSelection();\n\t\t\t\tif ($isRangeSelection(selection))\n\t\t\t\t{\n\t\t\t\t\tconst anchorNode = selection.anchor.getNode();\n\t\t\t\t\tconst focusNode = selection.focus.getNode();\n\t\t\t\t\tif (!anchorNode.isAttached() || !focusNode.isAttached())\n\t\t\t\t\t{\n\t\t\t\t\t\troot.selectEnd();\n\t\t\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t'TextEditor: selection has been moved to the end of the editor because the previously '\n\t\t\t\t\t\t\t+ 'selected nodes have been removed and selection wasn\\'t moved to another node. '\n\t\t\t\t\t\t\t+ 'Ensure selection changes after removing/replacing a selected node.',\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst lastChild = root.getLastChild();\n\t\t\t\tif (!$isParagraphNode(lastChild))\n\t\t\t\t{\n\t\t\t\t\troot.append($createParagraphNode());\n\t\t\t\t}\n\t\t\t}),\n\n\t\t\t// When a block node is the first child pressing up/left arrow will insert paragraph\n\t\t\t// above it to allow adding more content. It's similar what $insertBlockNode\n\t\t\t// (mainly for decorators), except it'll always be possible to continue adding\n\t\t\t// new content even if leading paragraph is accidentally deleted\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_ARROW_UP_COMMAND,\n\t\t\t\tthis.#handleEscapeUp.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_ARROW_LEFT_COMMAND,\n\t\t\t\tthis.#handleEscapeUp.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\t// When a block node is the last child pressing down/right arrow will insert paragraph\n\t\t\t// below it to allow adding more content. It's similar what $insertBlockNode\n\t\t\t// (mainly for decorators), except it'll always be possible to continue adding\n\t\t\t// new content even if trailing paragraph is accidentally deleted\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_ARROW_DOWN_COMMAND,\n\t\t\t\tthis.#handleEscapeDown.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_ARROW_RIGHT_COMMAND,\n\t\t\t\tthis.#handleEscapeDown.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tPASTE_COMMAND,\n\t\t\t\tthis.#handlePaste.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#isBlockNode(node: LexicalNode | null | undefined): boolean\n\t{\n\t\treturn $isQuoteNode(node) || $isCodeNode(node) || $isSpoilerNode(node);\n\t}\n\n\t#handlePaste(event): boolean\n\t{\n\t\t// if (this.getEditor().getNewLineMode() === NewLineMode.PARAGRAPH)\n\t\t// {\n\t\t// \t// use a build-in algorithm (Rich Text Plugin)\n\t\t// \treturn false;\n\t\t// }\n\n\t\tif (this.getEditor().getNewLineMode() === NewLineMode.LINE_BREAK)\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t\tthis.getEditor().update(\n\t\t\t\t() => {\n\t\t\t\t\tconst selection = $getSelection();\n\t\t\t\t\tconst { clipboardData } = event;\n\t\t\t\t\tif (clipboardData !== null && $isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\t$insertDataTransferForPlainText(clipboardData, selection);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttag: 'paste',\n\t\t\t\t},\n\t\t\t);\n\n\t\t\treturn true;\n\t\t}\n\n\t\t// Mixed Mode\n\t\tconst clipboardData: DataTransfer = event.clipboardData;\n\t\tif (\n\t\t\t!clipboardData\n\t\t\t|| clipboardData.items.length !== 1\n\t\t\t|| (clipboardData.items[0].type !== 'text/plain' && clipboardData.items[0].type !== 'text/uri-list')\n\t\t)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst text = clipboardData.getData('text/plain') || clipboardData.getData('text/uri-list');\n\t\tconst hasLineBreaks = /\\n/.test(text);\n\t\tif (!hasLineBreaks)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tconst html = wrapTextInParagraph(text);\n\t\tconst dataTransfer = new DataTransfer();\n\t\tdataTransfer.setData('text/plain', clipboardData.getData('text/plain'));\n\t\tdataTransfer.setData('text/html', html);\n\t\tconst pasteEvent = new ClipboardEvent('paste', {\n\t\t\tclipboardData: dataTransfer,\n\t\t\tbubbles: true,\n\t\t\tcancelable: true,\n\t\t});\n\n\t\tif (pasteEvent.clipboardData.items.length === 0)\n\t\t{\n\t\t\t// Firefox\n\t\t\tpasteEvent.clipboardData.setData('text/plain', clipboardData.getData('text/plain'));\n\t\t\tpasteEvent.clipboardData.setData('text/html', html);\n\t\t}\n\n\t\tthis.getEditor().getEditableContainer().dispatchEvent(pasteEvent);\n\n\t\treturn true;\n\t}\n\n\t#handleEscapeUp(): boolean\n\t{\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif ($isRangeSelection(selection) && selection.isCollapsed() && selection.anchor.offset === 0)\n\t\t{\n\t\t\tconst container: ElementNode = $findMatchingParent(selection.anchor.getNode(), this.#isBlockNode);\n\t\t\tif (this.#isBlockNode(container))\n\t\t\t{\n\t\t\t\tconst parent: ElementNode = container.getParent();\n\t\t\t\tif (\n\t\t\t\t\tparent !== null\n\t\t\t\t\t&& parent.getFirstChild() === container\n\t\t\t\t\t&& (\n\t\t\t\t\t\tselection.anchor.key === container.getFirstDescendant()?.getKey()\n\t\t\t\t\t\t|| selection.anchor.key === container.getKey()\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tcontainer.insertBefore($createParagraphNode());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t#handleEscapeDown(): boolean\n\t{\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif ($isRangeSelection(selection) && selection.isCollapsed())\n\t\t{\n\t\t\tconst container: ElementNode = $findMatchingParent(selection.anchor.getNode(), this.#isBlockNode);\n\t\t\tif (this.#isBlockNode(container))\n\t\t\t{\n\t\t\t\tconst parent: ElementNode = container.getParent();\n\t\t\t\tif (parent !== null && parent.getLastChild() === container)\n\t\t\t\t{\n\t\t\t\t\tconst firstDescendant = container.getFirstDescendant();\n\t\t\t\t\tconst lastDescendant = container.getLastDescendant();\n\t\t\t\t\tif (\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\tlastDescendant !== null\n\t\t\t\t\t\t\t&& selection.anchor.key === lastDescendant.getKey()\n\t\t\t\t\t\t\t&& selection.anchor.offset === lastDescendant.getTextContentSize()\n\t\t\t\t\t\t) || (\n\t\t\t\t\t\t\tfirstDescendant !== null\n\t\t\t\t\t\t\t&& selection.anchor.key === firstDescendant.getKey()\n\t\t\t\t\t\t\t&& selection.anchor.offset === firstDescendant.getTextContentSize()\n\t\t\t\t\t\t) || (\n\t\t\t\t\t\t\tselection.anchor.key === container.getKey()\n\t\t\t\t\t\t\t&& selection.anchor.offset === container.getTextContentSize()\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\tcontainer.insertAfter($createParagraphNode());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n}\n\nfunction convertParagraphNode(bbcodeNode: BBCodeNode): BBCodeConversionOutput\n{\n\treturn {\n\t\tnode: $createParagraphNode(),\n\t\t// after: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t// \treturn trimLineBreaks(childLexicalNodes);\n\t\t// },\n\t};\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { UNFORMATTED } from '../../constants';\n\nimport {\n\tTextNode,\n\t$applyNodeReplacement,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype SerializedTextNode,\n\ttype EditorThemeClasses,\n} from 'ui.lexical.core';\n\nimport { addClassNamesToElement, removeClassNamesFromElement } from 'ui.lexical.utils';\n\nimport { $createCodeNode, type CodeNode } from './code-node';\n\ntype SerializedCodeTokenNode = { highlightType: string | null | undefined } & SerializedTextNode;\n\nexport class CodeTokenNode extends TextNode\n{\n\t/** @internal */\n\t__highlightType: string | null | undefined;\n\t__flags: number = UNFORMATTED;\n\n\tconstructor(text: string, highlightType?: string | null | undefined, key?: NodeKey)\n\t{\n\t\tsuper(text, key);\n\t\tthis.__highlightType = highlightType;\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'code-token';\n\t}\n\n\tstatic clone(node: CodeTokenNode): CodeTokenNode\n\t{\n\t\treturn new CodeTokenNode(\n\t\t\tnode.__text,\n\t\t\tnode.__highlightType || undefined,\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tgetHighlightType(): string | null | undefined\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__highlightType;\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst element = super.createDOM(config);\n\t\tconst className = getHighlightThemeClass(\n\t\t\tconfig.theme,\n\t\t\tthis.__highlightType,\n\t\t);\n\n\t\taddClassNamesToElement(element, className);\n\n\t\treturn element;\n\t}\n\n\tupdateDOM(prevNode: CodeTokenNode, dom: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\tconst update = super.updateDOM(prevNode, dom, config);\n\t\tconst prevClassName = getHighlightThemeClass(config.theme, prevNode.__highlightType);\n\t\tconst nextClassName = getHighlightThemeClass(config.theme, this.__highlightType);\n\t\tif (prevClassName !== nextClassName)\n\t\t{\n\t\t\tif (prevClassName)\n\t\t\t{\n\t\t\t\tremoveClassNamesFromElement(dom, prevClassName);\n\t\t\t}\n\n\t\t\tif (nextClassName)\n\t\t\t{\n\t\t\t\taddClassNamesToElement(dom, nextClassName);\n\t\t\t}\n\t\t}\n\n\t\treturn update;\n\t}\n\n\tstatic importJSON(serializedNode: SerializedCodeTokenNode): CodeTokenNode\n\t{\n\t\tconst node = $createCodeTokenNode(serializedNode.text, serializedNode.highlightType);\n\t\tnode.setFormat(serializedNode.format);\n\t\tnode.setDetail(serializedNode.detail);\n\t\tnode.setMode(serializedNode.mode);\n\t\tnode.setStyle(serializedNode.style);\n\n\t\treturn node;\n\t}\n\n\texportJSON(): SerializedCodeTokenNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\thighlightType: this.getHighlightType(),\n\t\t\ttype: 'code-token',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\t// Prevent formatting (bold, underline, etc)\n\tsetFormat(format: number): this\n\t{\n\t\treturn this;\n\t}\n\n\tisParentRequired(): true\n\t{\n\t\treturn true;\n\t}\n\n\tcreateParentElementNode(): CodeNode\n\t{\n\t\treturn $createCodeNode();\n\t}\n}\n\nfunction getHighlightThemeClass(\n\ttheme: EditorThemeClasses,\n\thighlightType: string | null | undefined,\n): string | null | undefined\n{\n\treturn (\n\t\thighlightType\n\t\t&& theme\n\t\t&& theme.codeHighlight\n\t\t&& theme.codeHighlight[highlightType]\n\t);\n}\n\nexport function $createCodeTokenNode(text: string, highlightType?: string | null | undefined): CodeTokenNode\n{\n\treturn $applyNodeReplacement(new CodeTokenNode(text, highlightType));\n}\n\nexport function $isCodeTokenNode(node: LexicalNode | CodeTokenNode | null | undefined): boolean\n{\n\treturn node instanceof CodeTokenNode;\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { Type, Dom } from 'main.core';\n\nimport {\n\tElementNode,\n\t$applyNodeReplacement,\n\t$createParagraphNode,\n\t$isTabNode,\n\t$isTextNode,\n\t$createLineBreakNode,\n\t$createTabNode,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype SerializedElementNode,\n\ttype LexicalEditor,\n\ttype RangeSelection,\n\ttype ParagraphNode,\n\ttype TabNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n} from 'ui.lexical.core';\nimport { UNFORMATTED } from '../../constants';\n\nimport { type CodeTokenNode, $isCodeTokenNode, $createCodeTokenNode } from './code-token-node';\nimport { getFirstCodeNodeOfLine } from './code-plugin';\n\nexport class CodeNode extends ElementNode\n{\n\t__language = 'lexical-hack';\n\t__flags: number = UNFORMATTED;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'code';\n\t}\n\n\tstatic clone(node: CodeNode): CodeNode\n\t{\n\t\treturn new CodeNode(node.__key);\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLElement\n\t{\n\t\tconst element: HTMLElement = document.createElement('code');\n\t\telement.setAttribute('spellcheck', 'false');\n\n\t\tif (Type.isStringFilled(config?.theme?.code))\n\t\t{\n\t\t\tDom.addClass(element, config.theme.code);\n\t\t}\n\n\t\treturn element;\n\t}\n\n\tupdateDOM(prevNode: CodeNode, anchor: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\texportDOM(editor: LexicalEditor): DOMExportOutput\n\t{\n\t\tconst element = document.createElement('pre');\n\t\telement.setAttribute('spellcheck', 'false');\n\n\t\tif (Type.isStringFilled(editor._config?.theme?.code))\n\t\t{\n\t\t\tDom.addClass(element, editor._config.theme.code);\n\t\t}\n\n\t\treturn { element };\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\t// Typically <pre> is used for code blocks, and <code> for inline code styles\n\t\t\t// but if it's a multi line <code> we'll create a block. Pass through to\n\t\t\t// inline format handled by TextNode otherwise.\n\t\t\tcode: (node: Node) => {\n\t\t\t\tconst isMultiLine = (\n\t\t\t\t\tnode.textContent !== null\n\t\t\t\t\t&& (/\\r?\\n/.test(node.textContent) || hasChildDOMNodeTag(node, 'BR'))\n\t\t\t\t);\n\n\t\t\t\treturn isMultiLine\n\t\t\t\t\t? {\n\t\t\t\t\t\tconversion: convertPreElement,\n\t\t\t\t\t\tpriority: 1,\n\t\t\t\t\t}\n\t\t\t\t\t: null\n\t\t\t\t;\n\t\t\t},\n\t\t\tdiv: (node: Node) => ({\n\t\t\t\tconversion: convertDivElement,\n\t\t\t\tpriority: 1,\n\t\t\t}),\n\t\t\tpre: (node: Node) => ({\n\t\t\t\tconversion: convertPreElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\ttable: (node: Node) => {\n\t\t\t\tconst table: HTMLTableElement = node;\n\t\t\t\t// domNode is a <table> since we matched it by nodeName\n\t\t\t\tif (isGitHubCodeTable(table))\n\t\t\t\t{\n\t\t\t\t\treturn {\n\t\t\t\t\t\tconversion: convertTableElement,\n\t\t\t\t\t\tpriority: 3,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t\ttd: (node: Node) => {\n\t\t\t\t// element is a <td> since we matched it by nodeName\n\t\t\t\tconst td: HTMLTableCellElement = node;\n\t\t\t\tconst table: HTMLTableElement | null = td.closest('table');\n\n\t\t\t\tif (isGitHubCodeCell(td))\n\t\t\t\t{\n\t\t\t\t\treturn {\n\t\t\t\t\t\tconversion: convertTableCellElement,\n\t\t\t\t\t\tpriority: 3,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif (table && isGitHubCodeTable(table))\n\t\t\t\t{\n\t\t\t\t\t// Return a no-op if it's a table cell in a code table, but not a code line.\n\t\t\t\t\t// Otherwise it'll fall back to the T\n\t\t\t\t\treturn {\n\t\t\t\t\t\tconversion: convertCodeNoop,\n\t\t\t\t\t\tpriority: 3,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t\ttr: (node: Node) => {\n\t\t\t\t// element is a <tr> since we matched it by nodeName\n\t\t\t\tconst tr: HTMLTableCellElement = node;\n\t\t\t\tconst table: HTMLTableElement | null = tr.closest('table');\n\t\t\t\tif (table && isGitHubCodeTable(table))\n\t\t\t\t{\n\t\t\t\t\treturn {\n\t\t\t\t\t\tconversion: convertCodeNoop,\n\t\t\t\t\t\tpriority: 3,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t};\n\t}\n\n\tstatic importJSON(serializedNode: SerializedElementNode): CodeNode\n\t{\n\t\tconst node = $createCodeNode();\n\t\tnode.setFormat(serializedNode.format);\n\t\tnode.setIndent(serializedNode.indent);\n\t\tnode.setDirection(serializedNode.direction);\n\n\t\treturn node;\n\t}\n\n\texportJSON(): SerializedElementNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'code',\n\t\t};\n\t}\n\n\tcanIndent(): false\n\t{\n\t\treturn false;\n\t}\n\n\tcanReplaceWith(replacement: LexicalNode): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tisInline(): false\n\t{\n\t\treturn false;\n\t}\n\n\tcollapseAtStart(selection: RangeSelection): true\n\t{\n\t\tconst paragraph = $createParagraphNode();\n\t\tconst children = this.getChildren();\n\t\tchildren.forEach((child) => paragraph.append(child));\n\t\tthis.replace(paragraph);\n\n\t\treturn true;\n\t}\n\n\tinsertNewAfter(selection: RangeSelection, restoreSelection = true): null | ParagraphNode | CodeTokenNode | TabNode\n\t{\n\t\tconst children = this.getChildren();\n\t\tconst childrenLength = children.length;\n\n\t\tif (\n\t\t\tchildrenLength >= 2\n\t\t\t&& children[childrenLength - 1].getTextContent() === '\\n'\n\t\t\t&& children[childrenLength - 2].getTextContent() === '\\n'\n\t\t\t&& selection.isCollapsed()\n\t\t\t&& selection.anchor.key === this.__key\n\t\t\t&& selection.anchor.offset === childrenLength\n\t\t)\n\t\t{\n\t\t\tchildren[childrenLength - 1].remove();\n\t\t\tchildren[childrenLength - 2].remove();\n\t\t\tconst newElement = $createParagraphNode();\n\t\t\tthis.insertAfter(newElement, restoreSelection);\n\n\t\t\treturn newElement;\n\t\t}\n\n\t\t// If the selection is within the codeblock, find all leading tabs and\n\t\t// spaces of the current line. Create a new line that has all those\n\t\t// tabs and spaces, such that leading indentation is preserved.\n\t\tconst { anchor, focus } = selection;\n\t\tconst firstPoint = anchor.isBefore(focus) ? anchor : focus;\n\t\tconst firstSelectionNode = firstPoint.getNode();\n\t\tif ($isTextNode(firstSelectionNode))\n\t\t{\n\t\t\tlet node = getFirstCodeNodeOfLine(firstSelectionNode);\n\t\t\tconst insertNodes = [];\n\t\t\t// eslint-disable-next-line no-constant-condition\n\t\t\twhile (true)\n\t\t\t{\n\t\t\t\tif ($isTabNode(node))\n\t\t\t\t{\n\t\t\t\t\tinsertNodes.push($createTabNode());\n\t\t\t\t\tnode = node.getNextSibling();\n\t\t\t\t}\n\t\t\t\telse if ($isCodeTokenNode(node))\n\t\t\t\t{\n\t\t\t\t\tlet spaces = 0;\n\t\t\t\t\tconst text = node.getTextContent();\n\t\t\t\t\tconst textSize = node.getTextContentSize();\n\t\t\t\t\twhile (spaces < textSize && text[spaces] === ' ')\n\t\t\t\t\t{\n\t\t\t\t\t\tspaces++;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (spaces !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tinsertNodes.push($createCodeTokenNode(' '.repeat(spaces)));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (spaces !== textSize)\n\t\t\t\t\t{\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = node.getNextSibling();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst split = firstSelectionNode.splitText(anchor.offset)[0];\n\t\t\tconst x = anchor.offset === 0 ? 0 : 1;\n\t\t\tconst index = split.getIndexWithinParent() + x;\n\t\t\tconst codeNode = firstSelectionNode.getParentOrThrow();\n\t\t\tconst nodesToInsert = [$createLineBreakNode(), ...insertNodes];\n\t\t\tcodeNode.splice(index, 0, nodesToInsert);\n\t\t\tconst last = insertNodes[insertNodes.length - 1];\n\t\t\tif (last)\n\t\t\t{\n\t\t\t\tlast.select();\n\t\t\t}\n\t\t\telse if (anchor.offset === 0)\n\t\t\t{\n\t\t\t\tsplit.selectPrevious();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsplit.getNextSibling()?.selectNext(0, 0);\n\t\t\t}\n\t\t}\n\n\t\tif ($isCodeNode(firstSelectionNode))\n\t\t{\n\t\t\tconst { offset } = selection.anchor;\n\t\t\tfirstSelectionNode.splice(offset, 0, [$createLineBreakNode()]);\n\t\t\tfirstSelectionNode.select(offset + 1, offset + 1);\n\t\t}\n\n\t\treturn null;\n\t}\n}\n\nexport function $createCodeNode(): CodeNode\n{\n\treturn $applyNodeReplacement(new CodeNode());\n}\n\nexport function $isCodeNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof CodeNode;\n}\n\nfunction convertPreElement(domNode: Node): DOMConversionOutput\n{\n\treturn { node: $createCodeNode() };\n}\n\nfunction convertDivElement(domNode: Node): DOMConversionOutput\n{\n\t// domNode is a <div> since we matched it by nodeName\n\tconst div = domNode;\n\tconst isCode = isCodeElement(div);\n\tif (!isCode && !isCodeChildElement(div))\n\t{\n\t\treturn {\n\t\t\tnode: null,\n\t\t};\n\t}\n\n\treturn {\n\t\tafter: (childLexicalNodes) => {\n\t\t\tconst domParent = domNode.parentNode;\n\t\t\tif (domParent !== null && domNode !== domParent.lastChild)\n\t\t\t{\n\t\t\t\tchildLexicalNodes.push($createLineBreakNode());\n\t\t\t}\n\n\t\t\treturn childLexicalNodes;\n\t\t},\n\t\tnode: isCode ? $createCodeNode() : null,\n\t};\n}\n\nfunction convertTableElement(): DOMConversionOutput\n{\n\treturn { node: $createCodeNode() };\n}\n\nfunction convertCodeNoop(): DOMConversionOutput\n{\n\treturn { node: null };\n}\n\nfunction convertTableCellElement(domNode: Node): DOMConversionOutput\n{\n\t// domNode is a <td> since we matched it by nodeName\n\tconst cell = domNode;\n\n\treturn {\n\t\tafter: (childLexicalNodes) => {\n\t\t\tif (cell.parentNode && cell.parentNode.nextSibling)\n\t\t\t{\n\t\t\t\t// Append newline between code lines\n\t\t\t\tchildLexicalNodes.push($createLineBreakNode());\n\t\t\t}\n\n\t\t\treturn childLexicalNodes;\n\t\t},\n\t\tnode: null,\n\t};\n}\n\nfunction isCodeElement(div: HTMLElement): boolean\n{\n\treturn div.style.fontFamily.match('monospace') !== null;\n}\n\nfunction isCodeChildElement(node: HTMLElement): boolean\n{\n\tlet parent = node.parentElement;\n\twhile (parent !== null)\n\t{\n\t\tif (isCodeElement(parent))\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tparent = parent.parentElement;\n\t}\n\n\treturn false;\n}\n\nfunction isGitHubCodeCell(cell: HTMLTableCellElement): boolean\n{\n\treturn cell.classList.contains('js-file-line');\n}\n\nfunction isGitHubCodeTable(table: HTMLTableElement): boolean\n{\n\treturn table.classList.contains('js-file-line-container');\n}\n\nfunction hasChildDOMNodeTag(node: Node, tagName: string): boolean\n{\n\tlet hasChild = false;\n\tfor (const child of node.childNodes)\n\t{\n\t\tif (Type.isElementNode(child) && child.tagName === tagName)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\thasChild = hasChildDOMNodeTag(child, tagName);\n\t}\n\n\treturn hasChild;\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { Loc, Type } from 'main.core';\nimport { CodeParser, type CodeToken } from 'ui.code-parser';\nimport { $insertDataTransferForPlainText } from 'ui.lexical.clipboard';\n\nimport {\n\tKEY_TAB_COMMAND,\n\tINSERT_TAB_COMMAND,\n\tFORMAT_TEXT_COMMAND,\n\tPASTE_COMMAND,\n\tCOMMAND_PRIORITY_LOW,\n\tCOMMAND_PRIORITY_NORMAL,\n\tCOMMAND_PRIORITY_HIGH,\n\tINDENT_CONTENT_COMMAND,\n\tOUTDENT_CONTENT_COMMAND,\n\tCOMMAND_PRIORITY_EDITOR,\n\tTextNode,\n\t$createTabNode,\n\t$insertNodes,\n\t$getSelection,\n\t$isRangeSelection,\n\t$isTabNode,\n\t$isLineBreakNode,\n\t$getNodeByKey,\n\t$createLineBreakNode,\n\t$createTextNode,\n\t$isTextNode,\n\tcreateCommand,\n\t$getPreviousSelection,\n\ttype RangeSelection,\n\ttype LexicalCommand,\n\ttype LineBreakNode,\n\ttype TabNode,\n\ttype LexicalNode,\n\ttype NodeKey,\n} from 'ui.lexical.core';\n\nimport { $setBlocksType } from 'ui.lexical.selection';\nimport { $findMatchingParent, $insertNodeToNearestRoot } from 'ui.lexical.utils';\n\nimport { getSelectedNode } from '../../helpers/get-selected-node';\nimport { TextEditorLexicalNode } from '../../types/text-editor-lexical-node';\n\nimport BasePlugin from '../base-plugin';\nimport Button from '../../toolbar/button';\nimport { FORMAT_PARAGRAPH_COMMAND } from '../paragraph';\nimport { CodeNode, $isCodeNode, $createCodeNode } from './code-node';\nimport { CodeTokenNode, $isCodeTokenNode, $createCodeTokenNode } from './code-token-node';\n\nimport { type TextEditor } from '../../text-editor';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\nimport type {\n\tBBCodeConversion,\n\tBBCodeConversionFn,\n\tBBCodeExportConversion,\n\tBBCodeExportOutput,\n\tBBCodeImportConversion,\n} from '../../bbcode';\n\nexport type InsertCodePayload = {\n\tcontent?: string,\n};\n\n/** @memberof BX.UI.TextEditor.Plugins.Code */\nexport const FORMAT_CODE_COMMAND: LexicalCommand = createCommand('FORMAT_CODE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Code */\nexport const TOGGLE_CODE_COMMAND: LexicalCommand = createCommand('TOGGLE_CODE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Code */\nexport const INSERT_CODE_COMMAND: LexicalCommand<InsertCodePayload> = createCommand('INSERT_CODE_COMMAND');\n\nexport class CodePlugin extends BasePlugin\n{\n\t#nodesCurrentlyHighlighting = new Set();\n\t#codeParser = new CodeParser();\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerComponents();\n\t\tthis.#registerListeners();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Code';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [CodeNode, CodeTokenNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tcode: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createCodeNode(),\n\t\t\t\t\t\tafter: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t\t\t\t\t\t// const childNodes = trimLineBreaks(childLexicalNodes);\n\t\t\t\t\t\t\tconst content = childLexicalNodes.map(\n\t\t\t\t\t\t\t\t(childNode: LexicalNode) => childNode.getTextContent(),\n\t\t\t\t\t\t\t).join('');\n\n\t\t\t\t\t\t\t// return getCodeTokenNodes(parse(content));\n\t\t\t\t\t\t\treturn [$createTextNode(content)];\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tcode: (lexicalNode: LexicalNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'code' }),\n\t\t\t\t};\n\t\t\t},\n\t\t\t'code-token': (lexicalNode: LexicalNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createText({\n\t\t\t\t\t\tcontent: lexicalNode.getTextContent(),\n\t\t\t\t\t\tencode: false,\n\t\t\t\t\t}),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: CodeNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tcode: 'code',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('code', () => {\n\t\t\tconst button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --enclose-text-in-code-tag\"></span>');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_CODE'));\n\t\t\tbutton.setBlockType('code');\n\t\t\tbutton.subscribe('onClick', () => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\tif (button.isActive())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_PARAGRAPH_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_CODE_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tconst handleTextNodeTransform = this.#handleTextNodeTransform.bind(this);\n\n\t\tthis.cleanUpRegister(\n\t\t\t// Prevent formatting\n\t\t\tthis.getEditor().registerNodeTransform(CodeNode, this.#handleCodeNodeTransform.bind(this)),\n\t\t\tthis.getEditor().registerNodeTransform(TextNode, handleTextNodeTransform),\n\t\t\tthis.getEditor().registerNodeTransform(CodeTokenNode, handleTextNodeTransform),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tFORMAT_TEXT_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst node = getSelectedNode(selection);\n\t\t\t\t\t// const parent = node.getParent();\n\n\t\t\t\t\treturn $isCodeTokenNode(node) || $isCodeNode(node);\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_HIGH,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_TAB_COMMAND,\n\t\t\t\t(event) => {\n\t\t\t\t\tconst command = this.#handleTab(event.shiftKey);\n\t\t\t\t\tif (command === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tthis.getEditor().dispatchCommand(command);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_TAB_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection = $getSelection();\n\t\t\t\t\tif (!$isSelectionInCode(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\t$insertNodes([$createTabNode()]);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINDENT_CONTENT_COMMAND,\n\t\t\t\t(payload): boolean => this.#handleMultilineIndent(INDENT_CONTENT_COMMAND),\n\t\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tOUTDENT_CONTENT_COMMAND,\n\t\t\t\t(payload): boolean => this.#handleMultilineIndent(OUTDENT_CONTENT_COMMAND),\n\t\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tPASTE_COMMAND,\n\t\t\t\t(event) => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (\n\t\t\t\t\t\t!$isRangeSelection(selection)\n\t\t\t\t\t\t|| !(event instanceof ClipboardEvent)\n\t\t\t\t\t\t|| event.clipboardData === null\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst codeNode: CodeNode = $findMatchingParent(\n\t\t\t\t\t\tselection.anchor.getNode(),\n\t\t\t\t\t\t(node: LexicalNode) => $isCodeNode(node),\n\t\t\t\t\t);\n\n\t\t\t\t\tif (codeNode)\n\t\t\t\t\t{\n\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\tthis.getEditor().update(\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t$insertDataTransferForPlainText(event.clipboardData, selection);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttag: 'paste',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_CODE_COMMAND,\n\t\t\t\t(payload: InsertCodePayload) => {\n\t\t\t\t\tconst codeNode = $createCodeNode();\n\t\t\t\t\tif (Type.isPlainObject(payload) && Type.isStringFilled(payload.content))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst tokenNodes = getCodeTokenNodes(this.#codeParser.parse(payload.content));\n\t\t\t\t\t\tcodeNode.append(...tokenNodes);\n\t\t\t\t\t\t$insertNodeToNearestRoot(codeNode);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$insertNodeToNearestRoot(codeNode);\n\t\t\t\t\t\tcodeNode.selectEnd();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tFORMAT_CODE_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\tif ($isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\tif (selection.isCollapsed())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$setBlocksType(selection, () => $createCodeNode());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst textContent = selection.getTextContent();\n\t\t\t\t\t\t\tconst codeNode = $createCodeNode();\n\t\t\t\t\t\t\tselection.insertNodes([codeNode]);\n\n\t\t\t\t\t\t\tconst newSelection: RangeSelection = $getSelection();\n\t\t\t\t\t\t\tif ($isRangeSelection(newSelection))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnewSelection.insertRawText(textContent);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tTOGGLE_CODE_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection() || $getPreviousSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst codeParent = $findMatchingParent(\n\t\t\t\t\t\tselection.anchor.getNode(),\n\t\t\t\t\t\t(node: TextEditorLexicalNode) => {\n\t\t\t\t\t\t\treturn ($isCodeNode(node) || $isCodeTokenNode(node));\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\n\t\t\t\t\tif (codeParent)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_PARAGRAPH_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_CODE_COMMAND);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t);\n\t}\n\n\t#handleCodeNodeTransform(node: CodeNode): void\n\t{\n\t\tconst nodeKey = node.getKey();\n\t\tif (this.#nodesCurrentlyHighlighting.has(nodeKey))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#nodesCurrentlyHighlighting.add(nodeKey);\n\n\t\t// Using nested update call to pass `skipTransforms` since we don't want\n\t\t// each individual code-token node to be transformed again as it's already\n\t\t// in its final state\n\t\tthis.getEditor().update(\n\t\t\t() => {\n\t\t\t\tupdateAndRetainSelection(nodeKey, () => {\n\t\t\t\t\tconst currentNode = $getNodeByKey(nodeKey);\n\n\t\t\t\t\tif (!$isCodeNode(currentNode) || !currentNode.isAttached())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\tconst code = currentNode.getTextContent();\n\t\t\t\t\tconst codeTokenNodes = getCodeTokenNodes(this.#codeParser.parse(code));\n\t\t\t\t\tconst diffRange = getDiffRange(currentNode.getChildren(), codeTokenNodes);\n\n\t\t\t\t\tconst { from, to, nodesForReplacement } = diffRange;\n\t\t\t\t\tif (from !== to || nodesForReplacement.length > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode.splice(from, to - from, nodesForReplacement);\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t});\n\t\t\t},\n\t\t\t{\n\t\t\t\tonUpdate: () => {\n\t\t\t\t\tthis.#nodesCurrentlyHighlighting.delete(nodeKey);\n\t\t\t\t},\n\t\t\t\tskipTransforms: true,\n\t\t\t},\n\t\t);\n\t}\n\n\t#handleTextNodeTransform(node: TextNode)\n\t{\n\t\t// Since CodeNode has flat children structure we only need to check\n\t\t// if node's parent is a code node and run highlighting if so\n\t\tconst parentNode = node.getParent();\n\t\tif ($isCodeNode(parentNode))\n\t\t{\n\t\t\tthis.#handleCodeNodeTransform(parentNode);\n\t\t}\n\t\telse if ($isCodeTokenNode(node))\n\t\t{\n\t\t\t// When code block converted into paragraph or other element\n\t\t\t// code token nodes converted back to normal text\n\t\t\tnode.replace($createTextNode(node.__text));\n\t\t}\n\t}\n\n\t#handleTab(shiftKey: boolean): null | LexicalCommand<void>\n\t{\n\t\tconst selection = $getSelection();\n\t\tif (!$isRangeSelection(selection) || !$isSelectionInCode(selection))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst indentOrOutdent = shiftKey ? OUTDENT_CONTENT_COMMAND : INDENT_CONTENT_COMMAND;\n\t\tconst tabOrOutdent = shiftKey ? OUTDENT_CONTENT_COMMAND : INSERT_TAB_COMMAND;\n\n\t\t// 1. If multiple lines selected: indent/outdent\n\t\tconst codeLines = $getCodeLines(selection);\n\t\tif (codeLines.length > 1)\n\t\t{\n\t\t\treturn indentOrOutdent;\n\t\t}\n\n\t\t// 2. If entire line selected: indent/outdent\n\t\tconst selectionNodes = selection.getNodes();\n\t\tconst firstNode = selectionNodes[0];\n\t\tif ($isCodeNode(firstNode))\n\t\t{\n\t\t\treturn indentOrOutdent;\n\t\t}\n\n\t\tconst firstOfLine = getFirstCodeNodeOfLine(firstNode);\n\t\tconst lastOfLine = getLastCodeNodeOfLine(firstNode);\n\t\tconst anchor = selection.anchor;\n\t\tconst focus = selection.focus;\n\t\tlet selectionFirst = null;\n\t\tlet selectionLast = null;\n\t\tif (focus.isBefore(anchor))\n\t\t{\n\t\t\tselectionFirst = focus;\n\t\t\tselectionLast = anchor;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tselectionFirst = anchor;\n\t\t\tselectionLast = focus;\n\t\t}\n\n\t\tif (\n\t\t\tfirstOfLine !== null\n\t\t\t&& lastOfLine !== null\n\t\t\t&& selectionFirst.key === firstOfLine.getKey()\n\t\t\t&& selectionFirst.offset === 0\n\t\t\t&& selectionLast.key === lastOfLine.getKey()\n\t\t\t&& selectionLast.offset === lastOfLine.getTextContentSize()\n\t\t)\n\t\t{\n\t\t\treturn indentOrOutdent;\n\t\t}\n\n\t\t// 3. Else: tab/outdent\n\t\treturn tabOrOutdent;\n\t}\n\n\t#handleMultilineIndent(type: LexicalCommand): boolean\n\t{\n\t\tconst selection = $getSelection();\n\t\tif (!$isRangeSelection(selection) || !$isSelectionInCode(selection))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst codeLines = $getCodeLines(selection);\n\t\tconst codeLinesLength = codeLines.length;\n\t\t// Multiple lines selection\n\t\tif (codeLines.length > 1)\n\t\t{\n\t\t\tfor (let i = 0; i < codeLinesLength; i++)\n\t\t\t{\n\t\t\t\tconst line = codeLines[i];\n\t\t\t\tif (line.length > 0)\n\t\t\t\t{\n\t\t\t\t\tlet firstOfLine: null | CodeTokenNode | TabNode | LineBreakNode = line[0];\n\t\t\t\t\t// First and last lines might not be complete\n\t\t\t\t\tif (i === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tfirstOfLine = getFirstCodeNodeOfLine(firstOfLine);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (firstOfLine !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (type === INDENT_CONTENT_COMMAND)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-dom-methods\n\t\t\t\t\t\t\tfirstOfLine.insertBefore($createTabNode());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if ($isTabNode(firstOfLine))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfirstOfLine.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\n\t\t// Just one line\n\t\tconst selectionNodes = selection.getNodes();\n\t\tconst firstNode = selectionNodes[0];\n\t\tif ($isCodeNode(firstNode))\n\t\t{\n\t\t\t// CodeNode is empty\n\t\t\tif (type === INDENT_CONTENT_COMMAND)\n\t\t\t{\n\t\t\t\tselection.insertNodes([$createTabNode()]);\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\n\t\tconst firstOfLine = getFirstCodeNodeOfLine(firstNode);\n\t\tif (type === INDENT_CONTENT_COMMAND)\n\t\t{\n\t\t\tif ($isLineBreakNode(firstOfLine))\n\t\t\t{\n\t\t\t\tfirstOfLine.insertAfter($createTabNode());\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-dom-methods\n\t\t\t\tfirstOfLine.insertBefore($createTabNode());\n\t\t\t}\n\t\t}\n\t\telse if ($isTabNode(firstOfLine))\n\t\t{\n\t\t\tfirstOfLine.remove();\n\t\t}\n\n\t\treturn true;\n\t}\n}\n\nfunction $isSelectionInCode(selection: null | RangeSelection): boolean\n{\n\tif (!$isRangeSelection(selection))\n\t{\n\t\treturn false;\n\t}\n\tconst anchorNode = selection.anchor.getNode();\n\tconst focusNode = selection.focus.getNode();\n\tif (anchorNode.is(focusNode) && $isCodeNode(anchorNode))\n\t{\n\t\treturn true;\n\t}\n\n\tconst anchorParent = anchorNode.getParent();\n\n\treturn $isCodeNode(anchorParent) && anchorParent.is(focusNode.getParent());\n}\n\nfunction $getCodeLines(selection: RangeSelection): Array<Array<CodeTokenNode | TabNode>>\n{\n\tconst nodes = selection.getNodes();\n\tconst lines: Array<Array<CodeTokenNode | TabNode>> = [[]];\n\tif (nodes.length === 1 && $isCodeNode(nodes[0]))\n\t{\n\t\treturn lines;\n\t}\n\n\tlet lastLine: Array<CodeTokenNode | TabNode> = lines[0];\n\tfor (const [i, node] of nodes.entries())\n\t{\n\t\tif ($isLineBreakNode(node))\n\t\t{\n\t\t\tif (i !== 0 && lastLine.length > 0)\n\t\t\t{\n\t\t\t\tlastLine = [];\n\t\t\t\tlines.push(lastLine);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlastLine.push(node);\n\t\t}\n\t}\n\n\treturn lines;\n}\n\nexport function getFirstCodeNodeOfLine(\n\tanchor: CodeTokenNode | TabNode | LineBreakNode,\n): null | CodeTokenNode | TabNode | LineBreakNode\n{\n\tlet previousNode = anchor;\n\tlet node: null | LexicalNode = anchor;\n\twhile ($isCodeTokenNode(node) || $isTabNode(node))\n\t{\n\t\tpreviousNode = node;\n\t\tnode = node.getPreviousSibling();\n\t}\n\n\treturn previousNode;\n}\n\nexport function getLastCodeNodeOfLine(\n\tanchor: CodeTokenNode | TabNode | LineBreakNode,\n): CodeTokenNode | TabNode | LineBreakNode\n{\n\tlet nextNode = anchor;\n\tlet node: null | LexicalNode = anchor;\n\twhile ($isCodeTokenNode(node) || $isTabNode(node))\n\t{\n\t\tnextNode = node;\n\t\tnode = node.getNextSibling();\n\t}\n\n\treturn nextNode;\n}\n\ntype DiffRange = {\n\tfrom: number;\n\tnodesForReplacement: Array<LexicalNode>;\n\tto: number;\n};\n\n// Finds minimal diff range between two nodes lists. It returns from/to range boundaries of prevNodes\n// that needs to be replaced with `nodes` (subset of nextNodes) to make prevNodes equal to nextNodes.\nfunction getDiffRange(prevNodes: LexicalNode[], nextNodes: LexicalNode[]): DiffRange\n{\n\tlet leadingMatch = 0;\n\twhile (leadingMatch < prevNodes.length)\n\t{\n\t\tif (!isEqual(prevNodes[leadingMatch], nextNodes[leadingMatch]))\n\t\t{\n\t\t\tbreak;\n\t\t}\n\t\tleadingMatch++;\n\t}\n\n\tconst prevNodesLength: number = prevNodes.length;\n\tconst nextNodesLength: number = nextNodes.length;\n\tconst maxTrailingMatch: number = Math.min(prevNodesLength, nextNodesLength) - leadingMatch;\n\n\tlet trailingMatch = 0;\n\twhile (trailingMatch < maxTrailingMatch)\n\t{\n\t\ttrailingMatch++;\n\t\tif (!isEqual(prevNodes[prevNodesLength - trailingMatch], nextNodes[nextNodesLength - trailingMatch]))\n\t\t{\n\t\t\ttrailingMatch--;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tconst from: number = leadingMatch;\n\tconst to: number = prevNodesLength - trailingMatch;\n\tconst nodesForReplacement: LexicalNode[] = nextNodes.slice(\n\t\tleadingMatch,\n\t\tnextNodesLength - trailingMatch,\n\t);\n\n\treturn {\n\t\tfrom,\n\t\tnodesForReplacement,\n\t\tto,\n\t};\n}\n\nfunction isEqual(nodeA: LexicalNode, nodeB: LexicalNode): boolean\n{\n\t// Only checking for code token nodes, tabs and linebreaks. If it's regular text node\n\t// returning false so that it's transformed into code token node\n\treturn (\n\t\t(\n\t\t\t$isCodeTokenNode(nodeA)\n\t\t\t&& $isCodeTokenNode(nodeB)\n\t\t\t&& nodeA.__text === nodeB.__text\n\t\t\t&& nodeA.__highlightType === nodeB.__highlightType\n\t\t)\n\t\t|| ($isTabNode(nodeA) && $isTabNode(nodeB))\n\t\t|| ($isLineBreakNode(nodeA) && $isLineBreakNode(nodeB))\n\t);\n}\n\nfunction getCodeTokenNodes(tokens: Array<CodeToken>): LexicalNode[]\n{\n\tconst nodes: LexicalNode[] = [];\n\ttokens.forEach((token: CodeToken): void => {\n\t\tconst partials: string[] = token.content.split(/([\\t\\n])/);\n\t\tconst partialsLength: number = partials.length;\n\t\tfor (let i = 0; i < partialsLength; i++)\n\t\t{\n\t\t\tconst part: string = partials[i];\n\t\t\tif (part === '\\n' || part === '\\r\\n')\n\t\t\t{\n\t\t\t\tnodes.push($createLineBreakNode());\n\t\t\t}\n\t\t\telse if (part === '\\t')\n\t\t\t{\n\t\t\t\tnodes.push($createTabNode());\n\t\t\t}\n\t\t\telse if (part.length > 0)\n\t\t\t{\n\t\t\t\tnodes.push($createCodeTokenNode(part, token.type));\n\t\t\t}\n\t\t}\n\t});\n\n\treturn nodes;\n}\n\n// Wrapping update function into selection retainer, that tries to keep cursor at the same\n// position as before.\nfunction updateAndRetainSelection(nodeKey: NodeKey, updateFn: () => boolean): void\n{\n\tconst node: LexicalNode | null = $getNodeByKey(nodeKey);\n\tif (!$isCodeNode(node) || !node.isAttached())\n\t{\n\t\treturn;\n\t}\n\n\t// If it's not range selection (or null selection) there's no need to change it,\n\t// but we can still run highlighting logic\n\tconst selection: RangeSelection = $getSelection();\n\tif (!$isRangeSelection(selection))\n\t{\n\t\tupdateFn();\n\n\t\treturn;\n\t}\n\n\tconst anchor = selection.anchor;\n\tconst anchorOffset: number = anchor.offset;\n\tconst isNewLineAnchor: boolean = (\n\t\tanchor.type === 'element'\n\t\t&& $isLineBreakNode(node.getChildAtIndex(anchor.offset - 1))\n\t);\n\n\t// Calculating previous text offset (all text node prior to anchor + anchor own text offset)\n\tlet textOffset = 0;\n\tif (!isNewLineAnchor)\n\t{\n\t\tconst anchorNode = anchor.getNode();\n\t\ttextOffset = (\n\t\t\tanchorOffset\n\t\t\t+ anchorNode.getPreviousSiblings().reduce((offset, _node) => {\n\t\t\t\treturn offset + _node.getTextContentSize();\n\t\t\t}, 0)\n\t\t);\n\t}\n\n\tconst hasChanges: boolean = updateFn();\n\tif (!hasChanges)\n\t{\n\t\treturn;\n\t}\n\n\t// Non-text anchors only happen for line breaks, otherwise\n\t// selection will be within text node (code token node)\n\tif (isNewLineAnchor)\n\t{\n\t\tanchor.getNode().select(anchorOffset, anchorOffset);\n\n\t\treturn;\n\t}\n\n\t// If it was non-element anchor then we walk through child nodes\n\t// and looking for a position of original text offset\n\tnode.getChildren().some((child) => {\n\t\tconst isText: boolean = $isTextNode(child);\n\t\tif (isText || $isLineBreakNode(child))\n\t\t{\n\t\t\tconst textContentSize = child.getTextContentSize();\n\t\t\tif (isText && textContentSize >= textOffset)\n\t\t\t{\n\t\t\t\tchild.select(textOffset, textOffset);\n\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\ttextOffset -= textContentSize;\n\t\t}\n\n\t\treturn false;\n\t});\n}\n","import {\n\t$getSelection,\n\t$getNodeByKey,\n\t$isNodeSelection,\n\t$createNodeSelection,\n\t$setSelection,\n\ttype NodeKey,\n\ttype NodeSelection,\n} from 'ui.lexical.core';\n\nimport { mergeRegister } from 'ui.lexical.utils';\n\nimport { type TextEditor } from '../text-editor';\n\nfunction isNodeSelected(editor: TextEditor, key: NodeKey): boolean\n{\n\treturn editor.getEditorState().read(() => {\n\t\tconst node = $getNodeByKey(key);\n\t\tif (node === null)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn node.isSelected();\n\t});\n}\n\nexport function createNodeSelection(editor: TextEditor, key: NodeKey)\n{\n\tlet isSelected = false;\n\tconst subscribers = new Set();\n\tconst onSelect = (fn: Function) => {\n\t\tsubscribers.add(fn);\n\t};\n\n\tconst unregisterListener = mergeRegister(\n\t\teditor.registerUpdateListener(() => {\n\t\t\tisSelected = isNodeSelected(editor, key);\n\t\t\tfor (const subscribeFunc of subscribers)\n\t\t\t{\n\t\t\t\tsubscribeFunc(isSelected);\n\t\t\t}\n\t\t}),\n\t\teditor.registerEditableListener((isEditable: boolean): boolean => {\n\t\t\tisSelected = isNodeSelected(editor, key);\n\t\t\tfor (const subscribeFunc of subscribers)\n\t\t\t{\n\t\t\t\tsubscribeFunc(isSelected && isEditable);\n\t\t\t}\n\t\t}),\n\t);\n\n\tconst setSelected = (selected: boolean) => {\n\t\teditor.update(() => {\n\t\t\tlet selection: NodeSelection = $getSelection();\n\t\t\tif (!$isNodeSelection(selection))\n\t\t\t{\n\t\t\t\tselection = $createNodeSelection();\n\t\t\t\t$setSelection(selection);\n\t\t\t}\n\n\t\t\tif (selected)\n\t\t\t{\n\t\t\t\tselection.add(key);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tselection.delete(key);\n\t\t\t}\n\t\t});\n\t};\n\n\tconst clearSelection = () => {\n\t\teditor.update(() => {\n\t\t\tconst selection: NodeSelection = $getSelection();\n\t\t\tif ($isNodeSelection(selection))\n\t\t\t{\n\t\t\t\tselection.clear();\n\t\t\t}\n\t\t});\n\t};\n\n\treturn {\n\t\tisSelected: () => {\n\t\t\treturn isSelected;\n\t\t},\n\t\tdispose: () => {\n\t\t\tunregisterListener();\n\t\t},\n\t\tonSelect,\n\t\tsetSelected,\n\t\tclearSelection,\n\t};\n}\n","import { Dom, Type, type JsonObject, type JsonValue } from 'main.core';\n\nimport {\n\t$getSelection,\n\t$isNodeSelection,\n\t$getNodeByKey,\n\tCOMMAND_PRIORITY_LOW,\n\tCLICK_COMMAND,\n\tKEY_DELETE_COMMAND,\n\tKEY_BACKSPACE_COMMAND,\n} from 'ui.lexical.core';\n\nimport { mergeRegister } from 'ui.lexical.utils';\nimport { createNodeSelection } from './helpers/create-node-selection';\n\nimport { type TextEditor } from './text-editor';\nimport { type DecoratorComponentOptions } from './types/decorator-component-options';\n\nexport default class DecoratorComponent\n{\n\t#textEditor: TextEditor = null;\n\t#target: HTMLElement = null;\n\t#nodeKey: string = null;\n\t#options: JsonObject = {};\n\t#nodeSelection = null;\n\t#unregisterCommands: Function = null;\n\n\tconstructor(componentOptions: DecoratorComponentOptions)\n\t{\n\t\tconst { textEditor, target, nodeKey, options } = componentOptions;\n\n\t\tthis.#textEditor = textEditor;\n\t\tthis.#target = target;\n\t\tthis.#nodeKey = nodeKey;\n\t\tthis.#options = options;\n\n\t\tthis.#nodeSelection = createNodeSelection(this.getEditor(), this.getNodeKey());\n\t\tthis.#nodeSelection.onSelect((selected: boolean) => {\n\t\t\tif (selected)\n\t\t\t{\n\t\t\t\tDom.addClass(this.getTarget(), '--selected');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.getTarget(), '--selected');\n\t\t\t}\n\t\t});\n\n\t\tthis.#unregisterCommands = this.#registerCommands();\n\t}\n\n\tupdate(options: JsonObject): void\n\t{\n\t\t// update\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.#nodeSelection.dispose();\n\t\tthis.#unregisterCommands();\n\t}\n\n\tgetEditor(): TextEditor\n\t{\n\t\treturn this.#textEditor;\n\t}\n\n\tgetNodeKey(): string\n\t{\n\t\treturn this.#nodeKey;\n\t}\n\n\tgetTarget(): HTMLElement\n\t{\n\t\treturn this.#target;\n\t}\n\n\tgetNodeSelection()\n\t{\n\t\treturn this.#nodeSelection;\n\t}\n\n\tisSelected(): boolean\n\t{\n\t\treturn this.#nodeSelection.isSelected();\n\t}\n\n\tsetSelected(selected: boolean)\n\t{\n\t\tthis.#nodeSelection.setSelected(selected);\n\t}\n\n\tgetOptions(): JsonObject\n\t{\n\t\treturn this.#options;\n\t}\n\n\tgetOption(option: string, defaultValue?: JsonValue): JsonValue\n\t{\n\t\tif (!Type.isUndefined(this.#options[option]))\n\t\t{\n\t\t\treturn this.#options[option];\n\t\t}\n\n\t\tif (!Type.isUndefined(defaultValue))\n\t\t{\n\t\t\treturn defaultValue;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t#registerCommands(): Function\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tCLICK_COMMAND,\n\t\t\t\t(event: MouseEvent) => {\n\t\t\t\t\tif (!this.getEditor().isEditable())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.getTarget().contains(event.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tif (event.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#nodeSelection.setSelected(!this.#nodeSelection.isSelected());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#nodeSelection.clearSelection();\n\t\t\t\t\t\t\tthis.#nodeSelection.setSelected(true);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_DELETE_COMMAND,\n\t\t\t\tthis.#handleDelete.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_BACKSPACE_COMMAND,\n\t\t\t\tthis.#handleDelete.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#handleDelete(event: KeyboardEvent): boolean\n\t{\n\t\tif (this.#nodeSelection.isSelected() && $isNodeSelection($getSelection()))\n\t\t{\n\t\t\tevent.preventDefault();\n\n\t\t\tconst node = $getNodeByKey(this.getNodeKey());\n\t\t\tthis.#nodeSelection.setSelected(false);\n\t\t\tif (node)\n\t\t\t{\n\t\t\t\tnode.remove();\n\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n}\n","import { Type, Tag, Dom, Event } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { type TextEditor } from '../text-editor';\n\nfunction clamp(value: number, min: number, max: number): number\n{\n\treturn Math.min(Math.max(value, min), max);\n}\n\nconst Direction = {\n\tEAST: 1,\n\tSOUTH: 2,\n\tWEST: 4,\n\tNORTH: 8,\n};\n\nimport './figure-resizer.css';\n\nexport default class FigureResizer extends EventEmitter\n{\n\t#positioning = {\n\t\tcurrentHeight: 0,\n\t\tcurrentWidth: 0,\n\t\tdirection: 0,\n\t\tisResizing: false,\n\t\tratio: 0,\n\t\tstartHeight: 0,\n\t\tstartWidth: 0,\n\t\tstartX: 0,\n\t\tstartY: 0,\n\t};\n\n\t#freeTransform: boolean = false;\n\n\t#onPointerDownHandler: Function = null;\n\t#onPointerMoveHandler: Function = null;\n\t#onPointerUpHandler: Function = null;\n\n\t#container: HTMLElement = null;\n\t#target: HTMLElement = null;\n\t#editor: TextEditor = null;\n\n\t#maxWidth: 'none' | number = 'none';\n\t#maxHeight: 'none' | number = 'none';\n\t#minWidth: number = 16;\n\t#minHeight: number = 16;\n\n\tconstructor({\n\t\ttarget,\n\t\teditor,\n\t\toriginalWidth,\n\t\toriginalHeight,\n\t\tminWidth,\n\t\tminHeight,\n\t\tmaxWidth,\n\t\tmaxHeight,\n\t\tevents,\n\t\tfreeTransform,\n\t})\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.FigureResizer');\n\n\t\tthis.#target = target;\n\t\tthis.#editor = editor;\n\n\t\tthis.#minWidth = Math.min(\n\t\t\tMath.max(this.#minWidth, Type.isNumber(minWidth) ? minWidth : this.#minWidth),\n\t\t\tType.isNumber(originalWidth) ? originalWidth : Infinity,\n\t\t);\n\t\tthis.#minHeight = Math.min(\n\t\t\tMath.max(this.#minHeight, Type.isNumber(minHeight) ? minHeight : this.#minHeight),\n\t\t\tType.isNumber(originalHeight) ? originalHeight : Infinity,\n\t\t);\n\n\t\tthis.#maxWidth = Type.isNumber(maxWidth) ? maxWidth : 'none';\n\t\tthis.#maxHeight = Type.isNumber(maxHeight) ? maxHeight : 'none';\n\t\tthis.#freeTransform = freeTransform === true;\n\n\t\tthis.#onPointerDownHandler = this.#handlePointerDown.bind(this);\n\t\tthis.#onPointerMoveHandler = this.#handlePointerMove.bind(this);\n\t\tthis.#onPointerUpHandler = this.#handlePointerUp.bind(this);\n\n\t\tthis.subscribeFromOptions(events);\n\t}\n\n\tshow(): void\n\t{\n\t\tDom.addClass(this.getContainer(), '--shown');\n\t}\n\n\thide(): void\n\t{\n\t\tDom.removeClass(this.getContainer(), '--shown');\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\tif (this.#container === null)\n\t\t{\n\t\t\tconst freeTransform = Tag.render`\n\t\t\t\t<div\n\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --north\"\n\t\t\t\t\tdata-direction=\"${Direction.NORTH}\"\n\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t></div>\n\t\t\t\t<div\n\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --east\"\n\t\t\t\t\tdata-direction=\"${Direction.EAST}\"\n\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t></div>\n\t\t\t\t<div\n\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --south\"\n\t\t\t\t\tdata-direction=\"${Direction.SOUTH}\"\n\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t></div>\n\t\t\t\t<div\n\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --west\"\n\t\t\t\t\tdata-direction=\"${Direction.WEST}\"\n\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t></div>\n\t\t\t`;\n\n\t\t\tthis.#container = Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-figure-resizer\">\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --north-east\"\n\t\t\t\t\t\tdata-direction=\"${Direction.NORTH | Direction.EAST}\" \n\t\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --south-east\"\n\t\t\t\t\t\tdata-direction=\"${Direction.SOUTH | Direction.EAST}\" \n\t\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --south-west\"\n\t\t\t\t\t\tdata-direction=\"${Direction.SOUTH | Direction.WEST}\" \n\t\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t<div \n\t\t\t\t\t\tclass=\"ui-text-editor-figure-resizer-handle --north-west\"\n\t\t\t\t\t\tdata-direction=\"${Direction.NORTH | Direction.WEST}\" \n\t\t\t\t\t\tonpointerdown=\"${this.#onPointerDownHandler}\"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t${this.#freeTransform ? freeTransform : null}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}\n\n\t\treturn this.#container;\n\t}\n\n\tgetTarget(): HTMLElement\n\t{\n\t\treturn this.#target;\n\t}\n\n\tsetTarget(target: HTMLElement): void\n\t{\n\t\tthis.#target = target;\n\t}\n\n\tgetEditor(): TextEditor\n\t{\n\t\treturn this.#editor;\n\t}\n\n\tisResizing(): boolean\n\t{\n\t\treturn this.#positioning.isResizing;\n\t}\n\n\t#handlePointerDown(event: PointerEvent)\n\t{\n\t\tif (!this.getEditor().isEditable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tevent.preventDefault();\n\n\t\tconst direction: number = Number(event.target.dataset.direction);\n\n\t\tconst target = this.getTarget();\n\t\tconst { width, height } = target.getBoundingClientRect();\n\n\t\tthis.#positioning.startWidth = width;\n\t\tthis.#positioning.startHeight = height;\n\t\tthis.#positioning.ratio = width / height;\n\t\tthis.#positioning.currentWidth = width;\n\t\tthis.#positioning.currentHeight = height;\n\t\tthis.#positioning.startX = event.clientX;\n\t\tthis.#positioning.startY = event.clientY;\n\t\tthis.#positioning.isResizing = true;\n\t\tthis.#positioning.direction = direction;\n\n\t\t// setStartCursor(direction);\n\t\tthis.emit('onResizeStart');\n\n\t\tDom.addClass(this.getContainer(), '--resizing');\n\t\tDom.style(target, {\n\t\t\twidth: `${width}px`,\n\t\t\theight: `${height}px`,\n\t\t});\n\n\t\tEvent.bind(document, 'pointermove', this.#onPointerMoveHandler);\n\t\tEvent.bind(document, 'pointerup', this.#onPointerUpHandler);\n\t}\n\n\t#handlePointerMove(event: PointerEvent)\n\t{\n\t\tconst target = this.getTarget();\n\t\tconst isHorizontal = this.#positioning.direction & (Direction.EAST | Direction.WEST);\n\t\tconst isVertical = this.#positioning.direction & (Direction.SOUTH | Direction.NORTH);\n\n\t\tif (this.#positioning.isResizing)\n\t\t{\n\t\t\t// Corner cursor\n\t\t\tif (isHorizontal && isVertical)\n\t\t\t{\n\t\t\t\tlet diff = Math.floor(this.#positioning.startX - event.clientX);\n\t\t\t\tdiff = this.#positioning.direction & Direction.EAST ? -diff : diff;\n\n\t\t\t\tconst width = Math.round(clamp(\n\t\t\t\t\tthis.#positioning.startWidth + diff,\n\t\t\t\t\tthis.#minWidth,\n\t\t\t\t\tthis.#getMaxContainerWidth(),\n\t\t\t\t));\n\n\t\t\t\tconst height = Math.ceil(width / this.#positioning.ratio);\n\n\t\t\t\tDom.style(target, {\n\t\t\t\t\twidth: `${width}px`,\n\t\t\t\t\theight: `${height}px`,\n\t\t\t\t});\n\n\t\t\t\tthis.emit('onResize', { width, height });\n\n\t\t\t\tthis.#positioning.currentHeight = height;\n\t\t\t\tthis.#positioning.currentWidth = width;\n\t\t\t}\n\t\t\telse if (isVertical)\n\t\t\t{\n\t\t\t\tlet diff = Math.floor(this.#positioning.startY - event.clientY);\n\t\t\t\tdiff = this.#positioning.direction & Direction.SOUTH ? -diff : diff;\n\n\t\t\t\tconst height = Math.round(Math.max(\n\t\t\t\t\tthis.#positioning.startHeight + diff,\n\t\t\t\t\tthis.#minHeight,\n\t\t\t\t\t// this.#getMaxContainerHeight(),\n\t\t\t\t));\n\n\t\t\t\tDom.style(target, 'height', `${height}px`);\n\t\t\t\tthis.emit('onResize', { width: this.#positioning.currentWidth, height });\n\n\t\t\t\tthis.#positioning.currentHeight = height;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tlet diff = Math.floor(this.#positioning.startX - event.clientX);\n\t\t\t\tdiff = this.#positioning.direction & Direction.EAST ? -diff : diff;\n\n\t\t\t\tconst width = Math.round(clamp(\n\t\t\t\t\tthis.#positioning.startWidth + diff,\n\t\t\t\t\tthis.#minWidth,\n\t\t\t\t\tthis.#getMaxContainerWidth(),\n\t\t\t\t));\n\n\t\t\t\tDom.style(target, 'width', `${width}px`);\n\t\t\t\tthis.emit('onResize', { width, height: this.#positioning.currentHeight });\n\n\t\t\t\tthis.#positioning.currentWidth = width;\n\t\t\t}\n\t\t}\n\t}\n\n\t#handlePointerUp()\n\t{\n\t\tif (this.#positioning.isResizing)\n\t\t{\n\t\t\tsetTimeout(() => {\n\t\t\t\tconst width: number = this.#positioning.currentWidth;\n\t\t\t\tconst height: number = this.#positioning.currentHeight;\n\n\t\t\t\tthis.#positioning.startWidth = 0;\n\t\t\t\tthis.#positioning.startHeight = 0;\n\t\t\t\tthis.#positioning.ratio = 0;\n\t\t\t\tthis.#positioning.startX = 0;\n\t\t\t\tthis.#positioning.startY = 0;\n\t\t\t\tthis.#positioning.currentWidth = 0;\n\t\t\t\tthis.#positioning.currentHeight = 0;\n\t\t\t\tthis.#positioning.isResizing = false;\n\n\t\t\t\tDom.removeClass(this.getContainer(), '--resizing');\n\n\t\t\t\tthis.emit('onResizeEnd', { width, height });\n\t\t\t\t// setEndCursor();\n\n\t\t\t\tEvent.unbind(document, 'pointermove', this.#onPointerMoveHandler);\n\t\t\t\tEvent.unbind(document, 'pointerup', this.#onPointerUpHandler);\n\t\t\t}, 200);\n\t\t}\n\t}\n\n\t#getMaxContainerWidth(): number\n\t{\n\t\tconst maxWidth = Type.isNumber(this.#maxWidth) ? this.#maxWidth : Infinity;\n\n\t\tconst editorRootElement = this.getEditor().getRootElement();\n\t\tif (editorRootElement !== null)\n\t\t{\n\t\t\treturn Math.min(editorRootElement.getBoundingClientRect().width - 20, maxWidth);\n\t\t}\n\n\t\treturn 100;\n\t}\n\n\t#getMaxContainerHeight(): number\n\t{\n\t\tif (Type.isNumber(this.#maxHeight))\n\t\t{\n\t\t\treturn this.#maxHeight;\n\t\t}\n\n\t\tconst editorRootElement = this.getEditor().getRootElement();\n\t\tif (editorRootElement !== null)\n\t\t{\n\t\t\treturn editorRootElement.getBoundingClientRect().height - 20;\n\t\t}\n\n\t\treturn 100;\n\t}\n}\n","import { Dom, Tag } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\nimport type { BaseEvent } from 'main.core.events';\nimport type { EditorConfig } from 'ui.lexical.core';\n\nimport { $getNodeByKey } from 'ui.lexical.core';\n\nimport DecoratorComponent from '../../../decorator-component';\nimport FigureResizer from '../../../helpers/figure-resizer';\nimport { $isFileImageNode, type FileImageNode } from './file-image-node';\n\nimport type { JsonObject } from 'main.core';\nimport type { DecoratorComponentOptions } from '../../../types/decorator-component-options';\n\nexport class FileImageComponent extends DecoratorComponent\n{\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\t#figureResizer: FigureResizer = null;\n\n\tconstructor(options: DecoratorComponentOptions)\n\t{\n\t\tsuper(options);\n\n\t\tthis.#figureResizer = new FigureResizer({\n\t\t\ttarget: this.getImage(),\n\t\t\teditor: this.getEditor(),\n\t\t\toriginalWidth: this.getOption('width'),\n\t\t\toriginalHeight: this.getOption('height'),\n\t\t\tevents: {\n\t\t\t\tonResizeStart: this.#handleResizeStart.bind(this),\n\t\t\t\tonResizeEnd: this.#handleResizeEnd.bind(this),\n\t\t\t},\n\t\t});\n\n\t\tthis.getNodeSelection().onSelect((selected: boolean) => {\n\t\t\tif (selected || this.#figureResizer.isResizing())\n\t\t\t{\n\t\t\t\tDom.addClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.hide();\n\t\t\t}\n\n\t\t\tconst draggable = selected && !this.#figureResizer.isResizing();\n\t\t\tthis.#setDraggable(draggable);\n\t\t});\n\n\t\tthis.update(this.getOptions());\n\t\tthis.#render();\n\t}\n\n\t#render()\n\t{\n\t\tDom.append(this.#getContainer(), this.getTarget());\n\t}\n\n\t#getContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\tconst figureResizer = this.#figureResizer.getContainer();\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-file-image-component\">\n\t\t\t\t\t${this.#getImageContainer()}\n\t\t\t\t\t${figureResizer}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getImageContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('image-container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-file-image-container\">\n\t\t\t\t\t${this.getImage()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#setDraggable(draggable: boolean): void\n\t{\n\t\tDom.attr(this.#getImageContainer(), { draggable });\n\t\tif (draggable)\n\t\t{\n\t\t\tDom.addClass(this.#getContainer(), '--draggable');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.#getContainer(), '--draggable');\n\t\t}\n\t}\n\n\t#handleResizeStart(event: BaseEvent): void\n\t{\n\t\tthis.#setDraggable(false);\n\t\tthis.setSelected(true);\n\t}\n\n\t#handleResizeEnd(event: BaseEvent): void\n\t{\n\t\tthis.setSelected(true);\n\n\t\tthis.getEditor().update(() => {\n\t\t\tconst node: FileImageNode = $getNodeByKey(this.getNodeKey());\n\t\t\tif ($isFileImageNode(node))\n\t\t\t{\n\t\t\t\tconst { width, height } = event.getData();\n\t\t\t\tnode.setWidthAndHeight(width, height);\n\t\t\t}\n\t\t});\n\t}\n\n\tgetImage(): HTMLImageElement\n\t{\n\t\treturn this.#refs.remember('image', () => {\n\t\t\tconst img: HTMLImageElement = document.createElement('img');\n\t\t\timg.draggable = false;\n\t\t\timg.src = this.getOption('src');\n\n\t\t\tconst config: EditorConfig = this.getOption('config', {});\n\t\t\tif (config?.theme?.image?.img)\n\t\t\t{\n\t\t\t\timg.className = config.theme.image.img;\n\t\t\t}\n\n\t\t\treturn img;\n\t\t});\n\t}\n\n\tupdate(options: JsonObject)\n\t{\n\t\tconst width = options.width > 0 ? `${options.width}px` : 'inherit';\n\t\tconst aspectRatio = options.width > 0 && options.height > 0 ? `${options.width} / ${options.height}` : 'auto';\n\n\t\tDom.style(this.getImage(), { width, height: 'auto', aspectRatio });\n\t}\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Type, Dom } from 'main.core';\n\nimport {\n\tDecoratorNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype SerializedDecoratorNode,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\nimport { FileImageComponent } from './file-image-component';\n\nimport type { UploaderFileInfo } from 'ui.uploader.core';\nimport type { DecoratorOptions } from '../../../types/decorator-options';\n\nexport type SerializedFileImageNode = SerializedDecoratorNode & {\n\tserverFileId: string | number,\n\tinfo: UploaderFileInfo,\n\twidth: number,\n\theight: number,\n};\n\nimport './file-image.css';\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport class FileImageNode extends DecoratorNode\n{\n\t__serverFileId: string | number;\n\t__info: UploaderFileInfo;\n\t__width: number;\n\t__height: number;\n\n\tconstructor(\n\t\tserverFileId: string | number,\n\t\tinfo: UploaderFileInfo,\n\t\twidth?: number,\n\t\theight?: number,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tsuper(key);\n\n\t\tthis.__serverFileId = serverFileId;\n\t\tthis.__info = Type.isPlainObject(info) ? info : {};\n\t\tthis.__width = Type.isNumber(width) && width > 0 ? Math.round(width) : this.__info.previewWidth;\n\t\tthis.__height = Type.isNumber(height) && height > 0 ? Math.round(height) : this.__info.previewHeight;\n\t}\n\n\tstatic useDecoratorComponent = true;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'file-image';\n\t}\n\n\tstatic clone(node: FileImageNode): FileImageNode\n\t{\n\t\treturn new FileImageNode(node.__serverFileId, node.__info, node.__width, node.__height, node.__key);\n\t}\n\n\tgetId(): string | number\n\t{\n\t\treturn this.__serverFileId;\n\t}\n\n\tgetServerFileId(): string | number\n\t{\n\t\treturn this.__serverFileId;\n\t}\n\n\tgetInfo(): UploaderFileInfo\n\t{\n\t\treturn this.__info;\n\t}\n\n\tsetWidthAndHeight(width: number, height: number): void\n\t{\n\t\tconst writable = this.getWritable();\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\twritable.__width = Math.round(width);\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\twritable.__height = Math.round(height);\n\t\t}\n\t}\n\n\tgetWidth(): number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__width;\n\t}\n\n\tgetHeight(): number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__height;\n\t}\n\n\tisResized(): boolean\n\t{\n\t\treturn this.__info.previewWidth !== this.getWidth() || this.__info.previewHeight !== this.getHeight();\n\t}\n\n\tstatic importJSON(serializedNode: SerializedFileImageNode): FileImageNode\n\t{\n\t\treturn $createFileImageNode(\n\t\t\tserializedNode.serverFileId,\n\t\t\tserializedNode.info,\n\t\t\tserializedNode.width,\n\t\t\tserializedNode.height,\n\t\t);\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\timg: (domNode: HTMLImageElement) => {\n\t\t\t\tif (!domNode.hasAttribute('data-file-image-id'))\n\t\t\t\t{\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tconversion: (img: HTMLImageElement): DOMConversionOutput | null => {\n\t\t\t\t\t\tconst { fileImageId, fileImageInfo } = img.dataset;\n\t\t\t\t\t\tlet info = null;\n\t\t\t\t\t\ttry\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinfo = JSON.parse(fileImageInfo);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst node = $createFileImageNode(fileImageId, info);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tnode,\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t\tpriority: 1,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\treturn { element: null };\n\t}\n\n\texportJSON(): SerializedFileImageNode\n\t{\n\t\treturn {\n\t\t\tinfo: this.__info,\n\t\t\tserverFileId: this.__serverFileId,\n\t\t\twidth: this.getWidth(),\n\t\t\theight: this.getHeight(),\n\t\t\ttype: 'file-image',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLSpanElement\n\t{\n\t\tconst span = document.createElement('span');\n\t\tif (Type.isStringFilled(config?.theme?.image?.container))\n\t\t{\n\t\t\tDom.addClass(span, config.theme.image.container);\n\t\t}\n\n\t\treturn span;\n\t}\n\n\tupdateDOM(prevNode: FileImageNode, anchor: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tdecorate(editor: LexicalEditor, config: EditorConfig): DecoratorOptions\n\t{\n\t\treturn {\n\t\t\tcomponentClass: FileImageComponent,\n\t\t\toptions: {\n\t\t\t\tsrc: this.__info.previewUrl,\n\t\t\t\twidth: this.getWidth(),\n\t\t\t\theight: this.getHeight(),\n\t\t\t\tmaxWidth: this.getWidth(),\n\t\t\t\tmaxHeight: this.getHeight(),\n\t\t\t\tconfig,\n\t\t\t\t// maxWidth: this.__info.previewWidth,\n\t\t\t\t// maxHeight: this.__info.previewHeight,\n\t\t\t},\n\t\t};\n\t}\n\n\tisInline(): true\n\t{\n\t\treturn true;\n\t}\n}\n\nexport function $createFileImageNode(\n\tserverFileId: string | number,\n\tinfo: UploaderFileInfo = {},\n\twidth: number = null,\n\theight: number = null,\n): FileImageNode\n{\n\treturn new FileImageNode(serverFileId, info, width, height);\n}\n\nexport function $isFileImageNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof FileImageNode;\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Type, Dom } from 'main.core';\n\nimport {\n\tTextNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype SerializedDecoratorNode,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\nimport type { UploaderFileInfo } from 'ui.uploader.core';\n\nexport type SerializedFileNode = SerializedDecoratorNode & {\n\tserverFileId: string | number,\n\tinfo: UploaderFileInfo,\n};\n\nimport './file.css';\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport class FileNode extends TextNode\n{\n\t__serverFileId: string | number;\n\t__info: UploaderFileInfo;\n\n\tconstructor(\n\t\tserverFileId: string | number,\n\t\tinfo: UploaderFileInfo,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tconst fileInfo = Type.isPlainObject(info) ? info : {};\n\n\t\tsuper(fileInfo.name || '', key);\n\n\t\tthis.__serverFileId = serverFileId;\n\t\tthis.__info = fileInfo;\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'file';\n\t}\n\n\tstatic clone(node: FileNode): FileNode\n\t{\n\t\treturn new FileNode(node.__serverFileId, node.__info, node.__key);\n\t}\n\n\tgetId(): string | number\n\t{\n\t\treturn this.__serverFileId;\n\t}\n\n\tgetServerFileId(): string | number\n\t{\n\t\treturn this.__serverFileId;\n\t}\n\n\tgetInfo(): UploaderFileInfo\n\t{\n\t\treturn this.__info;\n\t}\n\n\tgetName(): string\n\t{\n\t\treturn this.__info.name || 'unknown';\n\t}\n\n\tstatic importJSON(serializedNode: SerializedFileNode): FileNode\n\t{\n\t\treturn $createFileNode(serializedNode.serverFileId, serializedNode.info);\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\tspan: (domNode: HTMLElement) => {\n\t\t\t\tif (!domNode.hasAttribute('data-file-id'))\n\t\t\t\t{\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tconversion: (span: HTMLSpanElement): DOMConversionOutput | null => {\n\t\t\t\t\t\tconst { fileId, fileInfo } = domNode.dataset;\n\t\t\t\t\t\tlet info = null;\n\t\t\t\t\t\ttry\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinfo = JSON.parse(fileInfo);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst node = $createFileNode(fileId, info);\n\n\t\t\t\t\t\treturn { node };\n\t\t\t\t\t},\n\t\t\t\t\tpriority: 1,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\tconst element = document.createElement('span');\n\t\telement.textContent = this.getName();\n\t\telement.setAttribute('data-file-id', this.__serverFileId);\n\t\telement.setAttribute('data-file-info', JSON.stringify(this.__info));\n\n\t\treturn { element };\n\t}\n\n\texportJSON(): SerializedFileNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\tinfo: this.__info,\n\t\t\tserverFileId: this.__serverFileId,\n\t\t\ttype: 'file',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLSpanElement\n\t{\n\t\tconst span = document.createElement('span');\n\t\tif (Type.isStringFilled(config?.theme?.file))\n\t\t{\n\t\t\tDom.addClass(span, config.theme.file);\n\t\t}\n\n\t\tspan.textContent = this.getName();\n\n\t\treturn span;\n\t}\n\n\tupdateDOM(prevNode: FileNode, anchor: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n}\n\nexport function $createFileNode(serverFileId: string | number, info: UploaderFileInfo = {}): FileNode\n{\n\treturn new FileNode(serverFileId, info).setMode('token');\n}\n\nexport function $isFileNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof FileNode;\n}\n","export function calcImageSize(previewWidth, previewHeight, renderWidth, renderHeight): [number, number]\n{\n\tconst ratioWidth: number = renderWidth / previewWidth;\n\tconst ratioHeight: number = renderHeight / previewHeight;\n\tconst ratio: number = Math.min(ratioWidth, ratioHeight);\n\n\tconst useOriginalSize = ratio > 1; // image is too small\n\tconst width = useOriginalSize ? previewWidth : previewWidth * ratio;\n\tconst height = useOriginalSize ? previewHeight : previewHeight * ratio;\n\n\treturn [width, height];\n}\n","import type { JsonObject } from 'main.core';\nimport { Dom, Tag, Type } from 'main.core';\nimport { type BaseCache, MemoryCache } from 'main.core.cache';\nimport type { BaseEvent } from 'main.core.events';\nimport { $getNodeByKey } from 'ui.lexical.core';\nimport type { EditorConfig } from 'ui.lexical.core';\n\nimport DecoratorComponent from '../../../decorator-component';\nimport { calcImageSize } from '../../../helpers/calc-image-size';\nimport FigureResizer from '../../../helpers/figure-resizer';\nimport type { DecoratorComponentOptions } from '../../../types/decorator-component-options';\nimport { $isFileVideoNode, FileVideoNode } from './file-video-node';\n\nexport class FileVideoComponent extends DecoratorComponent\n{\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\t#figureResizer: FigureResizer = null;\n\n\tconstructor(options: DecoratorComponentOptions)\n\t{\n\t\tsuper(options);\n\n\t\tthis.#figureResizer = new FigureResizer({\n\t\t\ttarget: this.#getVideo(),\n\t\t\teditor: this.getEditor(),\n\t\t\tminWidth: 120,\n\t\t\tminHeight: 120,\n\t\t\tevents: {\n\t\t\t\tonResize: this.#handleResize.bind(this),\n\t\t\t\tonResizeEnd: this.#handleResizeEnd.bind(this),\n\t\t\t},\n\t\t});\n\n\t\tthis.getNodeSelection().onSelect((selected: boolean) => {\n\t\t\tif (selected || this.#figureResizer.isResizing())\n\t\t\t{\n\t\t\t\tDom.addClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.hide();\n\t\t\t}\n\n\t\t\tthis.#setDraggable(selected);\n\t\t});\n\n\t\tthis.update(this.getOptions());\n\t\tthis.#render();\n\t}\n\n\t#render()\n\t{\n\t\tDom.append(this.#getContainer(), this.getTarget());\n\t}\n\n\t#getContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-video-component\">\n\t\t\t\t\t<div class=\"ui-text-editor-video-object-container\">${this.#getVideo()}</div>\n\t\t\t\t\t${this.#figureResizer.getContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getVideo(): HTMLIFrameElement | HTMLVideoElement\n\t{\n\t\treturn this.#refs.remember('video', () => {\n\t\t\tconst video: HTMLVideoElement = Dom.create({\n\t\t\t\ttag: 'video',\n\t\t\t\tattrs: {\n\t\t\t\t\tcontrols: true,\n\t\t\t\t\tpreload: 'metadata',\n\t\t\t\t\tplaysinline: true,\n\t\t\t\t\tsrc: this.getOption('src'),\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tloadedmetadata: (event: Event) => {\n\t\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\t\tconst node: FileVideoNode = $getNodeByKey(this.getNodeKey());\n\t\t\t\t\t\t\tif ($isFileVideoNode(node) && node.getWidth() === 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst [width, height] = calcImageSize(\n\t\t\t\t\t\t\t\t\tevent.target.videoWidth,\n\t\t\t\t\t\t\t\t\tevent.target.videoHeight,\n\t\t\t\t\t\t\t\t\t600,\n\t\t\t\t\t\t\t\t\t600,\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tnode.setWidthAndHeight(width, height);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tconst config: EditorConfig = this.getOption('config', {});\n\t\t\tif (config?.theme?.video?.object)\n\t\t\t{\n\t\t\t\tvideo.className = config.theme.video.object;\n\t\t\t}\n\n\t\t\treturn video;\n\t\t});\n\t}\n\n\t#handleResize(event: BaseEvent): void\n\t{\n\t\tthis.update(event.getData());\n\t}\n\n\t#handleResizeEnd(event: BaseEvent): void\n\t{\n\t\tthis.setSelected(true);\n\n\t\tthis.getEditor().update(() => {\n\t\t\tconst node: FileVideoNode = $getNodeByKey(this.getNodeKey());\n\t\t\tif ($isFileVideoNode(node))\n\t\t\t{\n\t\t\t\tconst { width, height } = event.getData();\n\t\t\t\tnode.setWidthAndHeight(width, height);\n\t\t\t}\n\t\t});\n\t}\n\n\t#setDraggable(draggable: boolean): void\n\t{\n\t\tDom.attr(this.#getContainer(), { draggable });\n\t\tif (draggable)\n\t\t{\n\t\t\tDom.addClass(this.#getContainer(), '--draggable');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.#getContainer(), '--draggable');\n\t\t}\n\t}\n\n\tupdate(options: JsonObject): void\n\t{\n\t\tconst width = Type.isNumber(options.width) && options.width > 0 ? options.width : null;\n\t\tconst height = Type.isNumber(options.height) && options.height > 0 ? options.height : null;\n\t\tconst aspectRatio = width > 0 && height > 0 ? `${width} / ${height}` : 'auto';\n\n\t\tDom.adjust(this.#getVideo(), {\n\t\t\tattrs: {\n\t\t\t\twidth,\n\t\t\t\theight: null,\n\t\t\t},\n\t\t\tstyle: {\n\t\t\t\twidth,\n\t\t\t\theight: 'auto',\n\t\t\t\taspectRatio,\n\t\t\t},\n\t\t});\n\t}\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Type, Dom } from 'main.core';\n\nimport {\n\t$applyNodeReplacement,\n\tDecoratorNode,\n\ttype DOMConversionMap,\n\ttype DOMExportOutput,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype SerializedDecoratorNode,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\nimport { FileVideoComponent } from './file-video-component';\n\nimport type { UploaderFileInfo } from 'ui.uploader.core';\nimport type { DecoratorOptions } from '../../../types/decorator-options';\n\nexport type SerializedFileVideoNode = SerializedDecoratorNode & {\n\tserverFileId: string | number,\n\tinfo: UploaderFileInfo,\n\twidth: number,\n\theight: number,\n};\n\nimport './file-video.css';\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport class FileVideoNode extends DecoratorNode\n{\n\t__serverFileId: string | number;\n\t__info: UploaderFileInfo;\n\t__width: number = 0;\n\t__height: number = 0;\n\n\tconstructor(\n\t\tserverFileId: string | number,\n\t\tinfo: UploaderFileInfo,\n\t\twidth?: number,\n\t\theight?: number,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tsuper(key);\n\n\t\tthis.__serverFileId = serverFileId;\n\t\tthis.__info = Type.isPlainObject(info) ? info : {};\n\t\tthis.__width = (\n\t\t\tType.isNumber(width) && width > 0\n\t\t\t\t? Math.round(width)\n\t\t\t\t: (this.__info.previewWidth > 0 ? this.__info.previewWidth : this.__width))\n\t\t;\n\n\t\tthis.__height = (\n\t\t\tType.isNumber(height) && height > 0\n\t\t\t\t? Math.round(height)\n\t\t\t\t: (this.__info.previewHeight > 0 ? this.__info.previewHeight : this.__height)\n\t\t);\n\t}\n\n\tstatic useDecoratorComponent = true;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'file-video';\n\t}\n\n\tstatic clone(node: FileVideoNode): FileVideoNode\n\t{\n\t\treturn new FileVideoNode(node.__serverFileId, node.__info, node.__width, node.__height, node.__key);\n\t}\n\n\tgetId(): string | number\n\t{\n\t\treturn this.__serverFileId;\n\t}\n\n\tgetServerFileId(): string | number\n\t{\n\t\treturn this.__serverFileId;\n\t}\n\n\tgetInfo(): UploaderFileInfo\n\t{\n\t\treturn this.__info;\n\t}\n\n\tsetWidthAndHeight(width: number, height: number): void\n\t{\n\t\tconst writable = this.getWritable();\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\twritable.__width = Math.round(width);\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\twritable.__height = Math.round(height);\n\t\t}\n\t}\n\n\tgetWidth(): number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__width;\n\t}\n\n\tgetHeight(): number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__height;\n\t}\n\n\tstatic importJSON(serializedNode: SerializedFileVideoNode): FileVideoNode\n\t{\n\t\treturn $createFileVideoNode(\n\t\t\tserializedNode.serverFileId,\n\t\t\tserializedNode.info,\n\t\t\tserializedNode.width,\n\t\t\tserializedNode.height,\n\t\t);\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn null;\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\treturn { element: null };\n\t}\n\n\texportJSON(): SerializedFileVideoNode\n\t{\n\t\treturn {\n\t\t\tinfo: this.__info,\n\t\t\tserverFileId: this.__serverFileId,\n\t\t\twidth: this.getWidth(),\n\t\t\theight: this.getHeight(),\n\t\t\ttype: 'file-video',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLSpanElement\n\t{\n\t\tconst div = document.createElement('span');\n\n\t\tif (Type.isStringFilled(config?.theme?.video?.container))\n\t\t{\n\t\t\tDom.addClass(div, config.theme.video.container);\n\t\t}\n\n\t\treturn div;\n\t}\n\n\tupdateDOM(prevNode: FileVideoNode, anchor: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tdecorate(editor: LexicalEditor, config: EditorConfig): DecoratorOptions\n\t{\n\t\treturn {\n\t\t\tcomponentClass: FileVideoComponent,\n\t\t\toptions: {\n\t\t\t\tsrc: this.__info.downloadUrl,\n\t\t\t\twidth: this.getWidth(),\n\t\t\t\theight: this.getHeight(),\n\t\t\t\tmaxWidth: this.getWidth(),\n\t\t\t\tmaxHeight: this.getHeight(),\n\t\t\t\tconfig,\n\t\t\t},\n\t\t};\n\t}\n\n\tisInline(): true\n\t{\n\t\treturn true;\n\t}\n}\n\nexport function $createFileVideoNode(\n\tserverFileId: string | number,\n\tinfo: UploaderFileInfo = {},\n\twidth: number = null,\n\theight: number = null,\n): FileVideoNode\n{\n\tconst node: FileVideoNode = new FileVideoNode(serverFileId, info, width, height);\n\n\treturn $applyNodeReplacement(node);\n}\n\nexport function $isFileVideoNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof FileVideoNode;\n}\n","interface DragEvent {\n\trangeOffset?: number;\n\trangeParent?: Node;\n}\n\nexport function getDragSelection(event: DragEvent): Range | null\n{\n\tconst target: Element | Document | null = event.target;\n\tlet targetWindow = null;\n\tif (target !== null)\n\t{\n\t\ttargetWindow = target.nodeType === 9 ? target.defaultView : target.ownerDocument.defaultView;\n\t}\n\n\tlet range = null;\n\tconst domSelection = (targetWindow || window).getSelection();\n\tif (document.caretRangeFromPoint)\n\t{\n\t\trange = document.caretRangeFromPoint(event.clientX, event.clientY);\n\t}\n\telse if (event.rangeParent && domSelection !== null)\n\t{\n\t\tdomSelection.collapse(event.rangeParent, event.rangeOffset || 0);\n\t\trange = domSelection.getRangeAt(0);\n\t}\n\telse\n\t{\n\t\tthrow new Error('Cannot get the selection when dragging');\n\t}\n\n\treturn range;\n}\n","import { $getSelection, $isNodeSelection, type LexicalNode } from 'ui.lexical.core';\n\nexport function getNodeInSelection(predicate: (node: LexicalNode) => boolean): LexicalNode | null\n{\n\tconst selection = $getSelection();\n\tif (!$isNodeSelection(selection))\n\t{\n\t\treturn null;\n\t}\n\n\tconst nodes = selection.getNodes();\n\tconst node = nodes[0];\n\n\treturn predicate(node) ? node : null;\n}\n","import { Tag, Type } from 'main.core';\nimport {\n\t$createRangeSelection, $setSelection,\n\tCOMMAND_PRIORITY_HIGH,\n\tCOMMAND_PRIORITY_LOW,\n\tDRAGOVER_COMMAND,\n\tDRAGSTART_COMMAND,\n\tDROP_COMMAND,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport { mergeRegister } from 'ui.lexical.utils';\nimport { DRAG_START_COMMAND, DRAG_END_COMMAND } from '../commands';\n\nimport { getDragSelection } from './get-drag-selection';\nimport { getNodeInSelection } from './get-node-in-selection';\n\nimport { type TextEditor } from '../text-editor';\n\nconst DRAG_DATA_FORMAT = 'application/x-lexical-drag-image';\nconst TRANSPARENT_IMAGE = Tag.render`<img src=\"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\">`;\n\nexport function registerDraggableNode(\n\teditor: TextEditor,\n\ttargetNode: Class<LexicalNode>,\n\tonDrop: Function,\n): () => void\n{\n\tconst isTargetNode = (node: LexicalNode | null | undefined): boolean => {\n\t\treturn node instanceof targetNode;\n\t};\n\n\tconst getDraggableNode = (): LexicalNode | null => {\n\t\treturn getNodeInSelection((node: LexicalNode) => isTargetNode(node));\n\t};\n\n\treturn mergeRegister(\n\t\teditor.registerCommand(\n\t\t\tDRAGSTART_COMMAND,\n\t\t\t(event: DragEvent): boolean => {\n\t\t\t\tconst draggableNode: LexicalNode = getDraggableNode();\n\t\t\t\tif (!draggableNode)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tconst success = handleDragStart(event, draggableNode);\n\t\t\t\tif (success)\n\t\t\t\t{\n\t\t\t\t\teditor.dispatchCommand(DRAG_START_COMMAND);\n\t\t\t\t}\n\n\t\t\t\treturn success;\n\t\t\t},\n\t\t\tCOMMAND_PRIORITY_HIGH,\n\t\t),\n\n\t\teditor.registerCommand(\n\t\t\tDRAGOVER_COMMAND,\n\t\t\t(event: DragEvent): boolean => {\n\t\t\t\tconst draggableNode: LexicalNode = getDraggableNode();\n\t\t\t\tif (!draggableNode)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn handleDragOver(event, editor);\n\t\t\t},\n\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t),\n\n\t\teditor.registerCommand(\n\t\t\tDROP_COMMAND,\n\t\t\t(event: DragEvent): boolean => {\n\t\t\t\tconst draggableNode: LexicalNode = getDraggableNode();\n\t\t\t\tif (!draggableNode)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\teditor.dispatchCommand(DRAG_END_COMMAND);\n\n\t\t\t\treturn handleDragDrop(event, editor, draggableNode, onDrop);\n\t\t\t},\n\t\t\tCOMMAND_PRIORITY_HIGH,\n\t\t),\n\t);\n}\n\nfunction handleDragStart(event: DragEvent, draggableNode: LexicalNode): boolean\n{\n\tconst dataTransfer = event.dataTransfer;\n\tif (!dataTransfer)\n\t{\n\t\treturn false;\n\t}\n\n\tdataTransfer.setData('text/plain', '_');\n\tdataTransfer.setDragImage(TRANSPARENT_IMAGE, 0, 0);\n\tdataTransfer.setData(\n\t\tDRAG_DATA_FORMAT,\n\t\tJSON.stringify({\n\t\t\tdata: draggableNode.exportJSON(),\n\t\t\ttype: draggableNode.getType(),\n\t\t}),\n\t);\n\n\treturn true;\n}\n\nfunction handleDragOver(event: DragEvent, editor: TextEditor): boolean\n{\n\tif (!canDrop(event, editor))\n\t{\n\t\tevent.preventDefault();\n\t}\n\n\treturn true;\n}\n\nfunction handleDragDrop(\n\tevent: DragEvent,\n\teditor: TextEditor,\n\tdraggableNode: LexicalNode,\n\tonDrop: Function,\n): boolean\n{\n\tconst dragData = event.dataTransfer?.getData(DRAG_DATA_FORMAT);\n\tif (!dragData)\n\t{\n\t\treturn false;\n\t}\n\n\tconst { type, data } = JSON.parse(dragData);\n\tif (type !== draggableNode.getType() || !Type.isPlainObject(data))\n\t{\n\t\treturn false;\n\t}\n\n\tevent.preventDefault();\n\tif (canDrop(event, editor) && Type.isFunction(onDrop))\n\t{\n\t\tconst range = getDragSelection(event);\n\t\tdraggableNode.remove();\n\t\tconst rangeSelection = $createRangeSelection();\n\t\tif (range !== null && range !== undefined)\n\t\t{\n\t\t\trangeSelection.applyDOMRange(range);\n\t\t}\n\n\t\t$setSelection(rangeSelection);\n\n\t\tonDrop(data);\n\t}\n\n\treturn true;\n}\n\nfunction canDrop(event: DragEvent, editor: TextEditor): boolean\n{\n\tconst target = event.target;\n\tconst selectors = ['code', '.ui-text-editor__file-image'];\n\tconst imageClassName = editor.getThemeClass('image');\n\tif (Type.isStringFilled(imageClassName))\n\t{\n\t\tselectors.push(`.${imageClassName}`);\n\t}\n\n\t// editor.getBBCodeScheme().isAllowedTag();\n\n\treturn (\n\t\ttarget instanceof HTMLElement\n\t\t&& target.closest(selectors.join(',')) === null\n\t\t&& editor.getEditableContainer().contains(target.parentElement)\n\t);\n}\n","import { Type, Text } from 'main.core';\n\nimport {\n\t$createTextNode,\n\tcreateCommand,\n\t$isRootOrShadowRoot,\n\t$insertNodes,\n\t$createParagraphNode,\n\t$nodesOfType,\n\t$isRangeSelection,\n\t$createLineBreakNode,\n\t$isParagraphNode,\n\t$getSelection,\n\tCOMMAND_PRIORITY_EDITOR,\n\ttype ElementNode,\n\ttype TextNode,\n\ttype ParagraphNode,\n\ttype PointType,\n\ttype RangeSelection,\n\ttype LexicalCommand,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport { $wrapNodeInElement, $findMatchingParent } from 'ui.lexical.utils';\nimport { NewLineMode } from '../../constants';\nimport { calcImageSize } from '../../helpers/calc-image-size';\n\nimport { registerDraggableNode } from '../../helpers/register-draggable-node';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\nimport BasePlugin from '../base-plugin';\n\nimport { FileNode, $createFileNode } from './file/file-node';\nimport { FileImageNode, $createFileImageNode } from './image/file-image-node';\nimport { FileVideoNode, $createFileVideoNode } from './video/file-video-node';\n\nimport type {\n\tBBCodeConversion,\n\tBBCodeExportOutput,\n\tBBCodeImportConversion,\n\tBBCodeExportConversion,\n\tBBCodeConversionFn,\n} from '../../bbcode';\n\nimport type { UploaderFileInfo } from 'ui.uploader.core';\nimport { type TextEditor } from '../../text-editor';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\n\ntype InsertFilePayload = {\n\tserverFileId: string | number,\n\tinfo: UploaderFileInfo,\n\twidth?: number,\n\theight?: number,\n};\n\ntype RemoveFilePayload = {\n\tserverFileId: string | number,\n\tskipHistoryStack?: boolean,\n};\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport const FileType = {\n\tFILE: 'file',\n\tIMAGE: 'image',\n\tVIDEO: 'video',\n};\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport const ADD_FILE_COMMAND: LexicalCommand<InsertFilePayload> = createCommand('ADD_FILE_COMMAND');\nexport const ADD_FILES_COMMAND: LexicalCommand<InsertFilePayload> = createCommand('ADD_FILES_COMMAND');\nexport const INSERT_FILE_COMMAND: LexicalCommand<InsertFilePayload> = createCommand('INSERT_FILE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport const REMOVE_FILE_COMMAND: LexicalCommand<string | number> = createCommand('REMOVE_FILE_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport const GET_INSERTED_FILES_COMMAND: LexicalCommand = createCommand('GET_INSERTED_FILES_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.File */\nexport class FilePlugin extends BasePlugin\n{\n\t#enabled: boolean = false;\n\t#mode: 'disk' | 'file' = 'file';\n\t#files: Map<string | number, UploaderFileInfo> = new Map();\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tconst modeOption = editor.getOption('file.mode');\n\t\tthis.#enabled = ['file', 'disk'].includes(modeOption);\n\t\tif (!this.#enabled)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#mode = modeOption;\n\n\t\tconst files: UploaderFileInfo[] = editor.getOption('file.files', []);\n\t\tthis.addFiles(files);\n\n\t\tthis.#registerListeners();\n\n\t\tthis.cleanUpRegister(\n\t\t\tregisterDraggableNode(\n\t\t\t\tthis.getEditor(),\n\t\t\t\tFileImageNode,\n\t\t\t\t(data) => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_FILE_COMMAND, data);\n\t\t\t\t},\n\t\t\t),\n\t\t\tregisterDraggableNode(\n\t\t\t\tthis.getEditor(),\n\t\t\t\tFileVideoNode,\n\t\t\t\t(data) => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_FILE_COMMAND, data);\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'File';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [FileNode, FileImageNode, FileVideoNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion | null\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\t[this.getMode()]: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\t// [DISK FILE ID=n14194]\n\t\t\t\t\t// [DISK FILE ID=14194]\n\n\t\t\t\t\t// [FILE ID=5b87ba3b-edb1-49df-a840-50d17b6c3e8c.fbbdd477d5ff19d61...a875e731fa89cfd1e1]\n\t\t\t\t\t// [FILE ID=14194]\n\t\t\t\t\tlet serverFileId = node.getAttribute('id');\n\t\t\t\t\tconst createTextNode = () => {\n\t\t\t\t\t\treturn { node: $createTextNode(node.toString()) };\n\t\t\t\t\t};\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t!Type.isStringFilled(serverFileId)\n\t\t\t\t\t\t|| (this.getMode() === 'disk' && !/^n?\\d+$/i.test(serverFileId))\n\t\t\t\t\t\t|| (this.getMode() === 'file' && !/^(\\d+|[\\da-f-]{36}\\.[\\da-f]{32,})$/i.test(serverFileId))\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn createTextNode();\n\t\t\t\t\t}\n\n\t\t\t\t\tconst info = this.getFile(serverFileId);\n\t\t\t\t\tif (info === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn createTextNode();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (info.serverFileId.toString() !== serverFileId.toString())\n\t\t\t\t\t{\n\t\t\t\t\t\tserverFileId = info.serverFileId.toString();\n\t\t\t\t\t}\n\n\t\t\t\t\tconst fileType = this.getFileType(info);\n\t\t\t\t\tif (fileType === FileType.IMAGE)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst width = Text.toInteger(node.getAttribute('width'));\n\t\t\t\t\t\tconst height = Text.toInteger(node.getAttribute('height'));\n\n\t\t\t\t\t\treturn { node: $createFileImageNode(serverFileId, info, width, height) };\n\t\t\t\t\t}\n\n\t\t\t\t\tif (fileType === FileType.VIDEO)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst width = Text.toInteger(node.getAttribute('width'));\n\t\t\t\t\t\tconst height = Text.toInteger(node.getAttribute('height'));\n\n\t\t\t\t\t\treturn { node: $createFileVideoNode(serverFileId, info, width, height) };\n\t\t\t\t\t}\n\n\t\t\t\t\treturn { node: $createFileNode(serverFileId, info) };\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion | null\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tfile: (lexicalNode: FileNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\t\t\t\tconst attributes = this.getMode() === 'disk' ? { file: '' } : {};\n\t\t\t\tattributes.id = lexicalNode.getServerFileId();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: this.getMode(), attributes, inline: true }),\n\t\t\t\t};\n\t\t\t},\n\t\t\t'file-video': (lexicalNode: FileVideoNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\t\t\t\tconst attributes = this.getMode() === 'disk' ? { file: '' } : {};\n\t\t\t\tattributes.id = lexicalNode.getServerFileId();\n\n\t\t\t\tconst node = scheme.createElement({ name: this.getMode(), attributes, inline: false });\n\t\t\t\tnode.setAttribute('width', lexicalNode.getWidth());\n\t\t\t\tnode.setAttribute('height', lexicalNode.getHeight());\n\n\t\t\t\treturn { node };\n\t\t\t},\n\t\t\t'file-image': (lexicalNode: FileImageNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\t\t\t\tconst attributes = this.getMode() === 'disk' ? { file: '' } : {};\n\t\t\t\tattributes.id = lexicalNode.getServerFileId();\n\n\t\t\t\tconst node = scheme.createElement({ name: this.getMode(), attributes, inline: true });\n\t\t\t\tif (lexicalNode.isResized())\n\t\t\t\t{\n\t\t\t\t\tnode.setAttribute('width', lexicalNode.getWidth());\n\t\t\t\t\tnode.setAttribute('height', lexicalNode.getHeight());\n\t\t\t\t}\n\n\t\t\t\treturn { node };\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\tif (!this.isEnabled())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tbbcodeMap: {\n\t\t\t\tfile: this.getMode(),\n\t\t\t\t'file-image': this.getMode(),\n\t\t\t\t'file-video': this.getMode(),\n\t\t\t},\n\t\t};\n\t}\n\n\tisEnabled(): boolean\n\t{\n\t\treturn this.#enabled;\n\t}\n\n\tgetMode(): 'disk' | 'file'\n\t{\n\t\treturn this.#mode;\n\t}\n\n\taddFile(file: UploaderFileInfo): void\n\t{\n\t\tif (Type.isPlainObject(file) && (Type.isStringFilled(file.serverFileId) || Type.isNumber(file.serverFileId)))\n\t\t{\n\t\t\tconst serverFileId = file.serverFileId.toString();\n\t\t\tif (!this.#files.has(serverFileId))\n\t\t\t{\n\t\t\t\tthis.#files.set(file.serverFileId.toString(), file);\n\t\t\t}\n\t\t}\n\t}\n\n\taddFiles(files: UploaderFileInfo[]): void\n\t{\n\t\tif (Type.isArrayFilled(files))\n\t\t{\n\t\t\tfiles.forEach((file: UploaderFileInfo) => {\n\t\t\t\tthis.addFile(file);\n\t\t\t});\n\t\t}\n\t}\n\n\tgetFile(serverFileId: string | number): UploaderFileInfo | null\n\t{\n\t\tif (Type.isStringFilled(serverFileId) || Type.isNumber(serverFileId))\n\t\t{\n\t\t\tconst file = this.#files.get(serverFileId.toString()) || null;\n\n\t\t\tif (file)\n\t\t\t{\n\t\t\t\treturn file;\n\t\t\t}\n\n\t\t\tfor (const item of this.#files.values())\n\t\t\t{\n\t\t\t\tif (\n\t\t\t\t\titem.serverFileId.toString() === serverFileId.toString()\n\t\t\t\t\t|| (item.customData?.objectId && `n${item.customData.objectId.toString()}` === serverFileId.toString())\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\treturn item;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tgetFileType(file: UploaderFileInfo): string\n\t{\n\t\tif (file?.isImage)\n\t\t{\n\t\t\treturn FileType.IMAGE;\n\t\t}\n\n\t\tif (file?.isVideo)\n\t\t{\n\t\t\treturn FileType.VIDEO;\n\t\t}\n\n\t\treturn FileType.FILE;\n\t}\n\n\tremoveFile(serverFileId: string | number, skipHistoryStack: boolean = true): void\n\t{\n\t\tif (Type.isStringFilled(serverFileId) || Type.isNumber(serverFileId))\n\t\t{\n\t\t\tthis.#files.delete(serverFileId.toString());\n\n\t\t\tthis.getEditor().update(() => {\n\t\t\t\tconst nodes = [\n\t\t\t\t\t...$nodesOfType(FileNode),\n\t\t\t\t\t...$nodesOfType(FileImageNode),\n\t\t\t\t\t...$nodesOfType(FileVideoNode),\n\t\t\t\t];\n\n\t\t\t\tnodes.forEach((node: FileNode | FileImageNode | FileVideoNode) => {\n\t\t\t\t\tif (node.getServerFileId().toString() === serverFileId.toString())\n\t\t\t\t\t{\n\t\t\t\t\t\tnode.remove();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}, skipHistoryStack ? { tag: 'history-merge' } : {});\n\t\t}\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_FILE_COMMAND,\n\t\t\t\t(payload: InsertFilePayload) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!Type.isPlainObject(payload)\n\t\t\t\t\t\t|| !Type.isPlainObject(payload.info)\n\t\t\t\t\t\t|| (!Type.isNumber(payload.serverFileId) && !Type.isStringFilled(payload.serverFileId))\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.addFile(payload.info);\n\n\t\t\t\t\tconst fileType = this.getFileType(payload.info);\n\t\t\t\t\tlet node = null;\n\n\t\t\t\t\tconst previewWidth = payload.info.previewWidth;\n\t\t\t\t\tconst previewHeight = payload.info.previewHeight;\n\t\t\t\t\tconst renderWidth = payload.width;\n\t\t\t\t\tconst renderHeight = payload.height;\n\t\t\t\t\tif (fileType === FileType.IMAGE)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst [width, height] = calcImageSize(previewWidth, previewHeight, renderWidth, renderHeight);\n\t\t\t\t\t\tnode = $createFileImageNode(payload.serverFileId, payload.info, width, height);\n\t\t\t\t\t}\n\t\t\t\t\telse if (fileType === FileType.VIDEO)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet width = 0;\n\t\t\t\t\t\tlet height = 0;\n\t\t\t\t\t\tif (previewWidth > 0 && previewHeight > 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t[width, height] = calcImageSize(previewWidth, previewHeight, renderWidth, renderHeight);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = $createFileVideoNode(payload.serverFileId, payload.info, width, height);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = $createFileNode(payload.serverFileId, payload.info);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif ($isRangeSelection(selection) && fileType !== FileType.FILE && payload.inline !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst focus: PointType = selection.focus;\n\t\t\t\t\t\tconst focusNode: TextNode | ElementNode = focus.getNode();\n\t\t\t\t\t\tif (!selection.isCollapsed())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfocusNode.selectEnd();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst parentNode: ParagraphNode = $findMatchingParent(\n\t\t\t\t\t\t\tfocusNode,\n\t\t\t\t\t\t\t(parent: ElementNode) => $isParagraphNode(parent),\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (parentNode === null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$insertNodes([node]);\n\t\t\t\t\t\t\tif ($isRootOrShadowRoot(node.getParentOrThrow()))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$wrapNodeInElement(node, $createParagraphNode).selectEnd();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (parentNode.isEmpty())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tparentNode.append(node);\n\t\t\t\t\t\t\tnode.selectEnd();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (this.getEditor().getNewLineMode() === NewLineMode.LINE_BREAK)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tparentNode.append($createLineBreakNode());\n\t\t\t\t\t\t\t\tparentNode.append(node);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst paragraph = $createParagraphNode();\n\t\t\t\t\t\t\t\tparagraph.append(node);\n\t\t\t\t\t\t\t\tparentNode.insertAfter(paragraph);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnode.selectEnd();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$insertNodes([node]);\n\t\t\t\t\t\tif ($isRootOrShadowRoot(node.getParentOrThrow()))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$wrapNodeInElement(node, $createParagraphNode).selectEnd();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tREMOVE_FILE_COMMAND,\n\t\t\t\t(payload: RemoveFilePayload): boolean => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!Type.isPlainObject(payload)\n\t\t\t\t\t\t|| (!Type.isNumber(payload.serverFileId) && !Type.isStringFilled(payload.serverFileId))\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.removeFile(payload.serverFileId, payload.skipHistoryStack);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tGET_INSERTED_FILES_COMMAND,\n\t\t\t\t(fn: Function): boolean => {\n\t\t\t\t\tif (!Type.isFunction(fn))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst nodes = [\n\t\t\t\t\t\t...$nodesOfType(FileNode),\n\t\t\t\t\t\t...$nodesOfType(FileImageNode),\n\t\t\t\t\t\t...$nodesOfType(FileVideoNode),\n\t\t\t\t\t];\n\n\t\t\t\t\tfn(nodes);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tADD_FILE_COMMAND,\n\t\t\t\t(file: UploaderFileInfo): boolean => {\n\t\t\t\t\tthis.addFile(file);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tADD_FILES_COMMAND,\n\t\t\t\t(files: UploaderFileInfo[]): boolean => {\n\t\t\t\t\tthis.addFiles(files);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t);\n\t}\n}\n","export function validateImageUrl(url: string): boolean\n{\n\treturn /^(http:|https:|ftp:|blob:|\\/)/i.test(url);\n}\n","import { Dom, Tag } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\nimport type { BaseEvent } from 'main.core.events';\nimport type { EditorConfig } from 'ui.lexical.core';\n\nimport { $getNodeByKey } from 'ui.lexical.core';\n\nimport DecoratorComponent from '../../decorator-component';\nimport FigureResizer from '../../helpers/figure-resizer';\nimport { $isImageNode, ImageNode } from './image-node';\n\nimport type { JsonObject } from 'main.core';\nimport type { DecoratorComponentOptions } from '../../types/decorator-component-options';\n\nexport default class ImageComponent extends DecoratorComponent\n{\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\t#figureResizer: FigureResizer = null;\n\t#maxWidth: number | 'none' = 'none';\n\n\tconstructor(options: DecoratorComponentOptions)\n\t{\n\t\tsuper(options);\n\n\t\tthis.#figureResizer = new FigureResizer({\n\t\t\ttarget: this.getImage(),\n\t\t\teditor: this.getEditor(),\n\t\t\toriginalWidth: this.getOption('width'),\n\t\t\toriginalHeight: this.getOption('height'),\n\t\t\tmaxWidth: this.getMaxWidth(),\n\t\t\tevents: {\n\t\t\t\tonResizeStart: this.#handleResizeStart.bind(this),\n\t\t\t\tonResizeEnd: this.#handleResizeEnd.bind(this),\n\t\t\t},\n\t\t});\n\n\t\tthis.getNodeSelection().onSelect((selected: boolean) => {\n\t\t\tif (selected || this.#figureResizer.isResizing())\n\t\t\t{\n\t\t\t\tDom.addClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.hide();\n\t\t\t}\n\n\t\t\tconst draggable = selected && !this.#figureResizer.isResizing();\n\t\t\tthis.#setDraggable(draggable);\n\t\t});\n\n\t\tthis.update(this.getOptions());\n\t\tthis.#render();\n\t}\n\n\t#render()\n\t{\n\t\tDom.append(this.#getContainer(), this.getTarget());\n\t}\n\n\t#getContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\tconst figureResizer = this.#figureResizer.getContainer();\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-image-component\">\n\t\t\t\t\t${this.#getImageContainer()}\n\t\t\t\t\t${figureResizer}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getImageContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('image-container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-image-container\">\n\t\t\t\t\t${this.getImage()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#setDraggable(draggable: boolean): void\n\t{\n\t\tDom.attr(this.#getImageContainer(), { draggable });\n\t\tif (draggable)\n\t\t{\n\t\t\tDom.addClass(this.#getContainer(), '--draggable');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.#getContainer(), '--draggable');\n\t\t}\n\t}\n\n\t#handleResizeStart(event: BaseEvent): void\n\t{\n\t\tthis.#setDraggable(false);\n\t\tthis.setSelected(true);\n\t}\n\n\t#handleResizeEnd(event: BaseEvent): void\n\t{\n\t\tthis.setSelected(true);\n\n\t\tthis.getEditor().update(() => {\n\t\t\tconst node: ImageNode = $getNodeByKey(this.getNodeKey());\n\t\t\tif ($isImageNode(node))\n\t\t\t{\n\t\t\t\tconst { width, height } = event.getData();\n\t\t\t\tnode.setWidthAndHeight(width, height);\n\t\t\t}\n\t\t});\n\t}\n\n\tgetImage(): HTMLImageElement\n\t{\n\t\treturn this.#refs.remember('image', () => {\n\t\t\tconst img: HTMLImageElement = document.createElement('img');\n\t\t\timg.draggable = false;\n\t\t\timg.src = this.getOption('src');\n\n\t\t\tconst config: EditorConfig = this.getOption('config', {});\n\t\t\tif (config?.theme?.image?.img)\n\t\t\t{\n\t\t\t\timg.className = config.theme.image.img;\n\t\t\t}\n\n\t\t\timg.onerror = (event) => {\n\t\t\t\timg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';\n\t\t\t\tDom.addClass(this.getTarget(), '--error ui-icon-set__scope');\n\t\t\t};\n\n\t\t\treturn img;\n\t\t});\n\t}\n\n\tgetMaxWidth(): 'none' | number\n\t{\n\t\treturn this.#maxWidth;\n\t}\n\n\tupdate(options: JsonObject)\n\t{\n\t\tconst width = options.width > 0 ? `${options.width}px` : 'inherit';\n\t\tconst aspectRatio = options.width > 0 && options.height > 0 ? `${options.width} / ${options.height}` : 'auto';\n\n\t\tthis.#maxWidth = options.maxWidth;\n\n\t\tDom.style(this.getImage(), { width, height: 'auto', aspectRatio });\n\t}\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Type } from 'main.core';\nimport { validateImageUrl } from '../../helpers/validate-image-url';\nimport type { DecoratorOptions } from '../../types/decorator-options';\nimport ImageComponent from './image-component';\n\nimport {\n\tDecoratorNode,\n\t$applyNodeReplacement,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype LexicalEditor,\n\ttype NodeKey,\n\ttype SerializedLexicalNode,\n} from 'ui.lexical.core';\n\nexport interface ImagePayload {\n\tsrc: string;\n\twidth?: number;\n\theight?: number;\n\tmaxWidth?: number;\n\tkey?: NodeKey;\n}\n\nexport type SerializedImageNode = SerializedLexicalNode & {\n\tsrc: string;\n\twidth?: number;\n\theight?: number;\n\tmaxWidth?: number;\n};\n\nexport class ImageNode extends DecoratorNode\n{\n\t__src: string;\n\t__width: 'inherit' | number = 'inherit';\n\t__height: 'inherit' | number = 'inherit';\n\t__maxWidth: number = 'none';\n\n\tconstructor(\n\t\tsrc: string,\n\t\twidth?: 'inherit' | number,\n\t\theight?: 'inherit' | number,\n\t\tmaxWidth?: number,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tsuper(key);\n\n\t\tif (validateImageUrl(src))\n\t\t{\n\t\t\tthis.__src = src;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.__src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';\n\t\t}\n\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\tthis.__width = Math.round(width);\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\tthis.__height = Math.round(height);\n\t\t}\n\n\t\tif (Type.isNumber(maxWidth))\n\t\t{\n\t\t\tthis.__maxWidth = Math.round(maxWidth);\n\t\t}\n\t}\n\n\tstatic useDecoratorComponent = true;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'image';\n\t}\n\n\tstatic clone(node: ImageNode): ImageNode\n\t{\n\t\treturn new ImageNode(\n\t\t\tnode.__src,\n\t\t\tnode.__width,\n\t\t\tnode.__height,\n\t\t\tnode.__maxWidth,\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tstatic importJSON(serializedNode: SerializedImageNode): ImageNode\n\t{\n\t\tconst { width, height, src, maxWidth } = serializedNode;\n\n\t\treturn $createImageNode({ src, width, height, maxWidth });\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\tconst element = document.createElement('img');\n\t\telement.setAttribute('src', this.__src);\n\t\telement.setAttribute('width', this.__width.toString());\n\t\telement.setAttribute('height', this.__height.toString());\n\n\t\treturn { element };\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\timg: (node: Node) => ({\n\t\t\t\tconversion: (domNode: HTMLImageElement): null | DOMConversionOutput => {\n\t\t\t\t\tif (domNode instanceof HTMLImageElement && validateImageUrl(domNode.src))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst { src, width, height } = domNode;\n\t\t\t\t\t\tconst imageNode = $createImageNode({ src, width, height });\n\n\t\t\t\t\t\treturn { node: imageNode };\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportJSON(): SerializedImageNode\n\t{\n\t\treturn {\n\t\t\tsrc: this.getSrc(),\n\t\t\twidth: this.getWidth(),\n\t\t\theight: this.getHeight(),\n\t\t\tmaxWidth: this.getMaxWidth(),\n\t\t\ttype: 'image',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tsetWidthAndHeight(width: 'inherit' | number, height: 'inherit' | number): void\n\t{\n\t\tconst writable = this.getWritable();\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\twritable.__width = Math.round(width);\n\t\t}\n\t\telse if (width === 'inherit')\n\t\t{\n\t\t\twritable.__width = width;\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\twritable.__height = Math.round(height);\n\t\t}\n\t\telse if (height === 'inherit')\n\t\t{\n\t\t\twritable.__height = height;\n\t\t}\n\t}\n\n\tsetMaxWidth(maxWidth: number | 'none'): void\n\t{\n\t\tif (Type.isNumber(maxWidth) || maxWidth === 'none')\n\t\t{\n\t\t\tconst writable = this.getWritable();\n\t\t\twritable.__maxWidth = Type.isNumber(maxWidth) ? Math.round(maxWidth) : maxWidth;\n\t\t}\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst span = document.createElement('span');\n\t\tconst theme = config.theme;\n\t\tconst className = theme?.image?.container;\n\t\tif (className !== undefined)\n\t\t{\n\t\t\tspan.className = className;\n\t\t}\n\n\t\treturn span;\n\t}\n\n\tupdateDOM(): false\n\t{\n\t\treturn false;\n\t}\n\n\tgetSrc(): string\n\t{\n\t\treturn this.__src;\n\t}\n\n\tgetWidth(): 'inherit' | number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__width;\n\t}\n\n\tgetHeight(): 'inherit' | number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__height;\n\t}\n\n\tgetMaxWidth(): 'none' | number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__maxWidth;\n\t}\n\n\tdecorate(editor: LexicalEditor, config: EditorConfig): DecoratorOptions\n\t{\n\t\treturn {\n\t\t\tcomponentClass: ImageComponent,\n\t\t\toptions: {\n\t\t\t\tsrc: this.getSrc(),\n\t\t\t\twidth: this.getWidth(),\n\t\t\t\theight: this.getHeight(),\n\t\t\t\tmaxWidth: this.getMaxWidth(),\n\t\t\t\tconfig,\n\t\t\t},\n\t\t};\n\t}\n\n\tisInline(): true\n\t{\n\t\treturn true;\n\t}\n}\n\nexport function $createImageNode({ src, width, height, maxWidth, key }): ImageNode\n{\n\treturn $applyNodeReplacement(new ImageNode(src, width, height, maxWidth, key));\n}\n\nexport function $isImageNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof ImageNode;\n}\n","import { type TextEditor } from '../text-editor';\n\nconst paddings: WeakMap<TextEditor, { left: number, right: number }> = new WeakMap();\n\nexport function getEditorPaddings(editor: TextEditor): { left: number, right: number }\n{\n\tif (paddings.has(editor))\n\t{\n\t\treturn paddings.get(editor);\n\t}\n\n\tconst scrollerContainer = editor.getEditableContainer();\n\tconst computedStyle = window.getComputedStyle(scrollerContainer);\n\tconst paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;\n\tconst paddingRight = parseFloat(computedStyle.paddingRight) || 0;\n\n\tconst result = {\n\t\tleft: paddingLeft,\n\t\tright: paddingRight,\n\t};\n\n\tpaddings.set(editor, result);\n\n\treturn result;\n}\n","import {\n\t$isTextNode,\n\t$isRangeSelection,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nimport { type TextEditor } from '../text-editor';\n\nexport function $getSelectionPosition(\n\teditor: TextEditor,\n\tselection: RangeSelection,\n\tscrollerContainer: HTMLElement,\n)\n{\n\t// const range: Range = window.getSelection().getRangeAt(0);\n\tconst range: Range = createRange(selection, editor);\n\tif (range === null)\n\t{\n\t\treturn null;\n\t}\n\n\tconst rangeRects = range.getClientRects();\n\tconst isMultiline = rangeRects.length > 1;\n\tconst isBackward = selection.isBackward();\n\tlet rangeRect = isBackward ? rangeRects[0] : rangeRects[rangeRects.length - 1];\n\n\tif (selection.isCollapsed() && (!rangeRect || (rangeRect.left === 0 && rangeRect.top === 0)))\n\t{\n\t\tlet anchorNode = editor.getElementByKey(selection.anchor.key);\n\t\tlet anchorOffset = selection.anchor.offset;\n\t\tif (anchorNode === null)\n\t\t{\n\t\t\tanchorNode = range.startContainer;\n\t\t\tanchorOffset = range.startOffset;\n\t\t}\n\n\t\tconst targetNode = anchorNode.childNodes[anchorOffset] || anchorNode;\n\n\t\tconst position = targetNode.getBoundingClientRect();\n\t\trangeRect = new DOMRect(\n\t\t\tposition.left,\n\t\t\tposition.top,\n\t\t\t1,\n\t\t\tposition.height,\n\t\t);\n\t}\n\n\tif (!rangeRect)\n\t{\n\t\treturn null;\n\t}\n\n\tconst verticalGap = 10;\n\n\tconst isBodyContainer = scrollerContainer === document.body;\n\tconst scrollLeft = isBodyContainer ? window.pageXOffset : scrollerContainer.scrollLeft;\n\tconst scrollTop = isBodyContainer ? window.pageYOffset : scrollerContainer.scrollTop;\n\n\tlet left = (isBackward ? rangeRect.left : rangeRect.right) + scrollLeft;\n\tlet top = rangeRect.top + scrollTop;\n\tlet bottom = rangeRect.bottom + scrollTop + verticalGap;\n\n\tif (!isBodyContainer)\n\t{\n\t\tconst scrollerRect = scrollerContainer.getBoundingClientRect();\n\t\ttop -= scrollerRect.top;\n\t\tleft -= scrollerRect.left;\n\t\tbottom -= scrollerRect.top;\n\t}\n\n\treturn {\n\t\tleft,\n\t\ttop,\n\t\tbottom,\n\t\tisBackward,\n\t\tisMultiline,\n\t};\n}\n\nfunction createRange(selection: RangeSelection, editor: TextEditor): Range | null\n{\n\tif (!$isRangeSelection(selection))\n\t{\n\t\treturn null;\n\t}\n\n\tconst range = document.createRange();\n\tconst anchorNode = selection.anchor.getNode();\n\tconst focusNode = selection.focus.getNode();\n\n\tconst anchorKey = anchorNode.getKey();\n\tconst focusKey = focusNode.getKey();\n\n\tlet anchorDOM: Node | Text | null = editor.getElementByKey(anchorKey);\n\tlet focusDOM: Node | Text | null = editor.getElementByKey(focusKey);\n\tlet anchorOffset = selection.anchor.offset;\n\tlet focusOffset = selection.focus.offset;\n\n\tif ($isTextNode(anchorNode))\n\t{\n\t\tanchorDOM = getDOMTextNode(anchorDOM);\n\t}\n\n\tif ($isTextNode(focusNode))\n\t{\n\t\tfocusDOM = getDOMTextNode(focusDOM);\n\t}\n\n\tif (anchorDOM === null || focusDOM === null)\n\t{\n\t\treturn null;\n\t}\n\n\tif (anchorDOM.nodeName === 'BR')\n\t{\n\t\t[anchorDOM, anchorOffset] = getDOMIndexWithinParent(anchorDOM);\n\t}\n\n\tif (focusDOM.nodeName === 'BR')\n\t{\n\t\t[focusDOM, focusOffset] = getDOMIndexWithinParent(focusDOM);\n\t}\n\n\tconst firstChild = anchorDOM.firstChild;\n\n\tif (\n\t\tanchorDOM === focusDOM\n\t\t&& firstChild !== null\n\t\t&& firstChild.nodeName === 'BR'\n\t\t&& anchorOffset === 0\n\t\t&& focusOffset === 0\n\t)\n\t{\n\t\tfocusOffset = 1;\n\t}\n\n\ttry\n\t{\n\t\trange.setStart(anchorDOM, anchorOffset);\n\t\trange.setEnd(focusDOM, focusOffset);\n\t}\n\tcatch\n\t{\n\t\treturn null;\n\t}\n\n\tif (range.collapsed && (anchorOffset !== focusOffset || anchorKey !== focusKey))\n\t{\n\t\t// Range is backwards, we need to reverse it\n\t\trange.setStart(focusDOM, focusOffset);\n\t\trange.setEnd(anchorDOM, anchorOffset);\n\t}\n\n\treturn range;\n}\n\nfunction getDOMTextNode(element: Node | null): Text | null\n{\n\tlet node = element;\n\twhile (node !== null)\n\t{\n\t\tif (node.nodeType === Node.TEXT_NODE)\n\t\t{\n\t\t\treturn node;\n\t\t}\n\n\t\tnode = node.firstChild;\n\t}\n\n\treturn null;\n}\n\nfunction getDOMIndexWithinParent(node: ChildNode): [ParentNode, number]\n{\n\tconst parent = node.parentNode;\n\tif (parent === null)\n\t{\n\t\tthrow new Error('Should never happen');\n\t}\n\n\treturn [parent, [...parent.childNodes].indexOf(node)];\n}\n","import { Dom, Type } from 'main.core';\nimport { $getSelection, $isRangeSelection } from 'ui.lexical.core';\nimport { getEditorPaddings } from './get-editor-paddings';\nimport { $getSelectionPosition } from './get-selection-position';\n\nimport { type Popup } from 'main.popup';\nimport { type TextEditor } from '../text-editor';\n\nconst lastPositionMap: WeakMap<Popup, 'top' | 'bottom'> = new WeakMap();\n\nexport function $adjustDialogPosition(\n\tpopup: Popup,\n\teditor: TextEditor,\n\tinitPosition?: (selectionPosition: Object) => {},\n): boolean\n{\n\tconst selection = $getSelection();\n\tif (!$isRangeSelection(selection))\n\t{\n\t\treturn false;\n\t}\n\n\t// for an embedded popup: document.body -> editor.getScrollerContainer()\n\tconst selectionPosition = $getSelectionPosition(editor, selection, document.body);\n\tif (selectionPosition === null)\n\t{\n\t\treturn false;\n\t}\n\n\tconst { top, left, bottom, isBackward } = selectionPosition;\n\tconst scrollerRect: DOMRect = Dom.getPosition(editor.getScrollerContainer());\n\tconst popupRect: DOMRect = Dom.getPosition(popup.getPopupContainer());\n\n\tconst popupWidth: number = popupRect.width;\n\tlet offsetLeft: number = popupWidth / 2;\n\n\tconst editorPaddings = getEditorPaddings(editor);\n\n\t// Try to fit a popup within a scroll area\n\tif (left - offsetLeft < scrollerRect.left)\n\t{\n\t\t// Left boundary\n\t\tconst overflow = scrollerRect.left - (left - offsetLeft);\n\t\toffsetLeft -= overflow + editorPaddings.left;\n\t}\n\telse if (scrollerRect.right < (left + popupWidth - offsetLeft))\n\t{\n\t\t// Right boundary\n\t\toffsetLeft += (left + popupWidth - offsetLeft) - scrollerRect.right + editorPaddings.right;\n\t}\n\n\tpopup.setOffset({ offsetLeft: -offsetLeft });\n\n\tif (bottom < scrollerRect.top || top > scrollerRect.bottom)\n\t{\n\t\t// hide our popup\n\t\tDom.style(popup.getPopupContainer(), { left: '-9999px', top: '-9999px' });\n\t}\n\telse\n\t{\n\t\tconst initialPosition = Type.isFunction(initPosition) ? initPosition(selectionPosition) : (isBackward ? 'top' : 'bottom');\n\t\tconst lastPosition = lastPositionMap.get(popup) || null;\n\t\tlet position = lastPosition === null ? initialPosition : lastPosition;\n\t\tif (top + popupRect.height > scrollerRect.bottom && (scrollerRect.top < top - popupRect.height))\n\t\t{\n\t\t\tposition = 'top';\n\t\t}\n\t\telse if (top - popupRect.height < scrollerRect.top)\n\t\t{\n\t\t\tposition = 'bottom';\n\t\t}\n\n\t\tlastPositionMap.set(popup, position);\n\n\t\tpopup.setBindElement({ left, top, bottom });\n\t\tpopup.adjustPosition({ position, forceBindPosition: true });\n\t}\n\n\treturn true;\n}\n\nexport function clearDialogPosition(popup: Popup)\n{\n\tlastPositionMap.delete(popup);\n}\n","import {\n\t$getNodeByKey,\n\t$getSelection,\n\t$isRangeSelection,\n\t$setSelection,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nexport function $restoreSelection(lastSelection: RangeSelection): boolean\n{\n\tconst selection = $getSelection();\n\tif (!$isRangeSelection(selection) && lastSelection !== null)\n\t{\n\t\tconst isSelectionAlive = (\n\t\t\t$getNodeByKey(lastSelection.anchor.key) !== null && $getNodeByKey(lastSelection.focus.key) !== null\n\t\t);\n\n\t\tif (isSelectionAlive)\n\t\t{\n\t\t\t$setSelection(lastSelection);\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\treturn false;\n}\n","import { Type } from 'main.core';\n\n// eslint-disable-next-line no-control-regex\nconst ATTRIBUTE_WHITESPACES = /[\\u0000-\\u0020\\u00A0\\u1680\\u180E\\u2000-\\u2029\\u205F\\u3000]/g;\nconst SAFE_URL = /^(?:(?:https?|ftps?|mailto):|[^a-z]|[+.a-z-]+(?:[^+.:a-z-]|$))/i;\n\nexport function sanitizeUrl(url: string): string\n{\n\tif (!Type.isStringFilled(url))\n\t{\n\t\treturn '';\n\t}\n\n\tconst normalizedUrl = url.replaceAll(ATTRIBUTE_WHITESPACES, '');\n\n\treturn SAFE_URL.test(normalizedUrl) ? normalizedUrl : '';\n}\n","import { Tag, Type, Loc } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\nimport { EventEmitter, type BaseEvent } from 'main.core.events';\nimport { Popup, PopupTarget, PopupTargetOptions } from 'main.popup';\nimport { sanitizeUrl } from '../../helpers/sanitize-url';\n\nimport './image-dialog.css';\n\nexport type ImageDialogOptions = {\n\ttargetContainer?: HTMLElement,\n\tevents?: Object<string, (event: BaseEvent) => {}>,\n}\n\nexport default class ImageDialog extends EventEmitter\n{\n\t#popup: Popup = null;\n\t#imageUrl: string = '';\n\t#targetContainer: HTMLElement = null;\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\n\tconstructor(options: ImageDialogOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.ImageDialog');\n\n\t\tconst imageDialogOptions: ImageDialogOptions = Type.isPlainObject(options) ? options : {};\n\n\t\tthis.setTargetContainer(imageDialogOptions.targetContainer);\n\t\tthis.subscribeFromOptions(imageDialogOptions.events);\n\t}\n\n\tshow(options: { target: PopupTarget, targetOptions: PopupTargetOptions } = {}): void\n\t{\n\t\tconst target: PopupTarget = options.target ?? undefined;\n\t\tconst targetOptions: PopupTargetOptions = Type.isPlainObject(options.targetOptions) ? options.targetOptions : {};\n\n\t\tif (!Type.isUndefined(target))\n\t\t{\n\t\t\tthis.getPopup().setBindElement(target);\n\t\t}\n\n\t\tthis.getPopup().adjustPosition({\n\t\t\t...targetOptions,\n\t\t\tforceBindPosition: true,\n\t\t});\n\n\t\tthis.getPopup().show();\n\t}\n\n\thide(): void\n\t{\n\t\tthis.getPopup().close();\n\t}\n\n\tisShown(): boolean\n\t{\n\t\treturn this.#popup !== null && this.#popup.isShown();\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.getPopup().destroy();\n\t}\n\n\tsetImageUrl(url: string): void\n\t{\n\t\tif (Type.isString(url))\n\t\t{\n\t\t\tthis.#imageUrl = sanitizeUrl(url);\n\t\t}\n\t}\n\n\tgetImageUrl(): string\n\t{\n\t\treturn this.#imageUrl;\n\t}\n\n\tsetTargetContainer(container: HTMLElement): void\n\t{\n\t\tif (Type.isElementNode(container))\n\t\t{\n\t\t\tthis.#targetContainer = container;\n\t\t}\n\t}\n\n\tgetTargetContainer(): HTMLElement | null\n\t{\n\t\treturn this.#targetContainer;\n\t}\n\n\tgetPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tautoHide: true,\n\t\t\t\tcacheable: false,\n\t\t\t\tpadding: 0,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\ttargetContainer: this.getTargetContainer(),\n\t\t\t\tcontent: this.getContainer(),\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.emit('onClose');\n\t\t\t\t\t},\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.emit('onDestroy');\n\t\t\t\t\t},\n\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\tthis.emit('onShow');\n\t\t\t\t\t},\n\t\t\t\t\tonAfterShow: () => {\n\t\t\t\t\t\tthis.emit('onAfterShow');\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-image-dialog\">\n\t\t\t\t\t<div class=\"ui-text-editor-image-dialog-form\">\n\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-s ui-ctl-inline ui-ctl-w100 ui-text-editor-image-dialog-textbox\">\n\t\t\t\t\t\t\t<div class=\"ui-ctl-tag\">${Loc.getMessage('TEXT_EDITOR_IMAGE_URL')}</div>\n\t\t\t\t\t\t\t${this.getUrlTextBox()}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button type=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-image-dialog-button\" \n\t\t\t\t\t\t\tonclick=\"${this.#handleSaveBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"image-dialog-save-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --check\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button \n\t\t\t\t\t\t\ttype=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-image-dialog-button\"\n\t\t\t\t\t\t\tonclick=\"${this.#handleCancelBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"image-dialog-cancel-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --cross-60\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetUrlTextBox(): HTMLInputElement\n\t{\n\t\treturn this.#refs.remember('url-textbox', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<input \n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\tplaceholder=\"https://example.com/image.jpeg\"\n\t\t\t\t\tvalue=\"${this.getImageUrl()}\"\n\t\t\t\t\tonkeydown=\"${this.#handleTextBoxKeyDown.bind(this)}\"\n\t\t\t\t\tdata-testid=\"image-dialog-textbox\"\n\t\t\t\t>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#handleSaveBtnClick(): void\n\t{\n\t\tconst url: string = this.getUrlTextBox().value.trim();\n\t\tif (url.length > 0)\n\t\t{\n\t\t\tthis.setImageUrl(url);\n\t\t\tthis.emit('onSave');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getUrlTextBox().focus();\n\t\t}\n\t}\n\n\t#handleTextBoxKeyDown(event: KeyboardEvent)\n\t{\n\t\tif (event.key === 'Enter')\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t\tthis.#handleSaveBtnClick();\n\t\t}\n\t}\n\n\t#handleCancelBtnClick(): void\n\t{\n\t\tthis.emit('onCancel');\n\t}\n}\n","import { Event, Loc, Type } from 'main.core';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\n\nimport {\n\ttype BBCodeConversion,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n\ttype BBCodeExportOutput,\n\ttype BBCodeConversionFn,\n} from '../../bbcode';\n\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { $adjustDialogPosition } from '../../helpers/adjust-dialog-position';\nimport {\n\tcreateCommand,\n\t$createTextNode,\n\t$insertNodes,\n\t$isRootOrShadowRoot,\n\t$createParagraphNode,\n\t$getSelection,\n\t$isRangeSelection,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\ttype LexicalNode,\n\ttype LexicalCommand,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nimport { $wrapNodeInElement, mergeRegister } from 'ui.lexical.utils';\nimport { registerDraggableNode } from '../../helpers/register-draggable-node';\nimport { $restoreSelection } from '../../helpers/restore-selection';\nimport { validateImageUrl } from '../../helpers/validate-image-url';\n\nimport Button from '../../toolbar/button';\nimport BasePlugin from '../base-plugin';\nimport ImageDialog from './image-dialog';\nimport { $createImageNode, ImageNode, type ImagePayload } from './image-node';\n\nimport { type TextEditor } from '../../text-editor';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nimport './image-plugin.css';\n\nexport type InsertImagePayload = Readonly<ImagePayload>;\nexport const INSERT_IMAGE_COMMAND: LexicalCommand<InsertImagePayload> = createCommand('INSERT_IMAGE_COMMAND');\nexport const INSERT_IMAGE_DIALOG_COMMAND: LexicalCommand = createCommand('INSERT_IMAGE_DIALOG_COMMAND');\n\nexport class ImagePlugin extends BasePlugin\n{\n\t#imageDialog: ImageDialog = null;\n\t#onEditorScroll: Function = this.#handleEditorScroll.bind(this);\n\t#lastSelection: RangeSelection = null;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.#registerCommands(),\n\t\t\tregisterDraggableNode(\n\t\t\t\tthis.getEditor(),\n\t\t\t\tImageNode,\n\t\t\t\t(data) => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_IMAGE_COMMAND, data);\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Image';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [ImageNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\timg: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\t// [img]{url}[/img]\n\t\t\t\t\t// [img width={width} height={height}]{url}[/img]\n\t\t\t\t\tconst src = node.getContent().trim();\n\t\t\t\t\tconst width = Number(node.getAttribute('width'));\n\t\t\t\t\tconst height = Number(node.getAttribute('height'));\n\n\t\t\t\t\tif (validateImageUrl(src))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tnode: $createImageNode({ src, width, height }),\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createTextNode(node.toString()),\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\timage: (lexicalNode: ImageNode): BBCodeExportOutput => {\n\t\t\t\tconst attributes = {};\n\t\t\t\tconst width = lexicalNode.getWidth();\n\t\t\t\tconst height = lexicalNode.getHeight();\n\t\t\t\tif (Type.isNumber(width) && Type.isNumber(height))\n\t\t\t\t{\n\t\t\t\t\tattributes.width = width;\n\t\t\t\t\tattributes.height = height;\n\t\t\t\t}\n\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({\n\t\t\t\t\t\tname: 'img',\n\t\t\t\t\t\tinline: true,\n\t\t\t\t\t\tattributes,\n\t\t\t\t\t}),\n\t\t\t\t\tafter: (elementNode: BBCodeElementNode) => {\n\t\t\t\t\t\telementNode.setChildren([scheme.createText(lexicalNode.getSrc())]);\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: ImageNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\timage: 'img',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerCommands(): () => void\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_IMAGE_COMMAND,\n\t\t\t\t(payload: InsertImagePayload) => {\n\t\t\t\t\tif (!validateImageUrl(payload?.src))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst imageNode = $createImageNode(payload);\n\t\t\t\t\t$insertNodes([imageNode]);\n\t\t\t\t\tif ($isRootOrShadowRoot(imageNode.getParentOrThrow()))\n\t\t\t\t\t{\n\t\t\t\t\t\t$wrapNodeInElement(imageNode, $createParagraphNode).selectEnd();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_IMAGE_DIALOG_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = selection.clone();\n\t\t\t\t\tif (this.#imageDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#imageDialog.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND, { sender: 'image-dialog' });\n\n\t\t\t\t\tthis.#imageDialog = new ImageDialog({\n\t\t\t\t\t\t// for an embedded popup: document.body -> this.getEditor().getScrollerContainer()\n\t\t\t\t\t\ttargetContainer: document.body,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tonSave: () => {\n\t\t\t\t\t\t\t\tconst url = this.#imageDialog.getImageUrl();\n\t\t\t\t\t\t\t\tif (!Type.isStringFilled(url))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.#imageDialog.hide();\n\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_IMAGE_COMMAND, { src: url });\n\n\t\t\t\t\t\t\t\tthis.#imageDialog.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonCancel: () => {\n\t\t\t\t\t\t\t\tthis.#imageDialog.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\t\t\tthis.#handleDialogDestroy();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\t\t\tthis.#handleDialogDestroy();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\t\t\tif ($adjustDialogPosition(this.#imageDialog.getPopup(), this.getEditor()))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tEvent.bind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\t\t\t\t\t\t\t\tthis.getEditor().highlightSelection();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonAfterShow: () => {\n\t\t\t\t\t\t\t\tthis.#imageDialog.getUrlTextBox().focus();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.#imageDialog.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (payload?.sender === 'image-dialog')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = null;\n\n\t\t\t\t\tif (this.#imageDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#imageDialog.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.#imageDialog !== null && this.#imageDialog.isShown();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#restoreSelection(): boolean\n\t{\n\t\tconst success = $restoreSelection(this.#lastSelection);\n\t\tthis.#lastSelection = null;\n\n\t\treturn success;\n\t}\n\n\t#handleDialogDestroy(): void\n\t{\n\t\tif (this.#imageDialog === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#imageDialog = null;\n\t\tEvent.unbind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\tthis.getEditor().resetHighlightSelection();\n\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\t\t\t// this.getEditor().focus();\n\t\t});\n\t}\n\n\t#handleEditorScroll(): void\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\t$adjustDialogPosition(this.#imageDialog.getPopup(), this.getEditor());\n\t\t});\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('image', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --incert-image\"></span>');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_IMAGE'));\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tif (this.#imageDialog !== null && this.#imageDialog.isShown())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.getEditor().focus(() => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_IMAGE_DIALOG_COMMAND);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#imageDialog !== null)\n\t\t{\n\t\t\tthis.#imageDialog.destroy();\n\t\t}\n\t}\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Type, Dom } from 'main.core';\n\nimport {\n\t$applyNodeReplacement,\n\tElementNode,\n\t$isRangeSelection,\n\t$createParagraphNode,\n\ttype DOMConversionMap,\n\ttype DOMConversionOutput,\n\ttype DOMExportOutput,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype SerializedElementNode,\n\ttype LexicalEditor,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nexport type SerializedMentionNode = {\n\tmentionName: string,\n\tentityId: string,\n\tid: string | number,\n} & SerializedElementNode;\n\nexport class MentionNode extends ElementNode\n{\n\t__id: string | number;\n\t__entityId: string;\n\n\tconstructor(\n\t\tentityId: string,\n\t\tid: string | number,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tsuper(key);\n\n\t\tthis.__entityId = entityId;\n\t\tthis.__id = id;\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'mention';\n\t}\n\n\tstatic clone(node: MentionNode): MentionNode\n\t{\n\t\treturn new MentionNode(\n\t\t\tnode.__entityId,\n\t\t\tnode.__id,\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tgetId(): string | number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__id;\n\t}\n\n\tgetEntityId(): string\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__entityId;\n\t}\n\n\tstatic importJSON(serializedNode: SerializedMentionNode): MentionNode\n\t{\n\t\tconst node: MentionNode = $createMentionNode(\n\t\t\tserializedNode.entityId,\n\t\t\tserializedNode.id,\n\t\t);\n\n\t\tnode.setFormat(serializedNode.format);\n\t\tnode.setDirection(serializedNode.direction);\n\n\t\treturn node;\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\tspan: (domNode: HTMLElement) => {\n\t\t\t\tif (!domNode.hasAttribute('data-mention-id'))\n\t\t\t\t{\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tconversion: convertMentionElement,\n\t\t\t\t\tpriority: 1,\n\t\t\t\t};\n\t\t\t},\n\t\t\ta: (domNode: HTMLElement) => {\n\t\t\t\tif (!domNode.hasAttribute('data-mention-id'))\n\t\t\t\t{\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tconversion: convertMentionElement,\n\t\t\t\t\tpriority: 1,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\tconst element = document.createElement('span');\n\t\telement.setAttribute('data-mention-entity-id', this.__entityId);\n\t\telement.setAttribute('data-mention-id', this.__id.toString());\n\n\t\treturn { element };\n\t}\n\n\texportJSON(): SerializedMentionNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\tentityId: this.__entityId,\n\t\t\tid: this.__id,\n\t\t\ttype: 'mention',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcreateDOM(config: EditorConfig, editor: LexicalEditor): HTMLSpanElement\n\t{\n\t\tconst element = document.createElement('span');\n\t\tif (Type.isStringFilled(config?.theme?.mention))\n\t\t{\n\t\t\tDom.addClass(element, config.theme.mention);\n\t\t}\n\n\t\treturn element;\n\t}\n\n\tupdateDOM(prevNode: MentionNode, anchor: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tcanInsertTextBefore(): false\n\t{\n\t\treturn false;\n\t}\n\n\tcanInsertTextAfter(): false\n\t{\n\t\treturn false;\n\t}\n\n\tcanBeEmpty(): false\n\t{\n\t\treturn false;\n\t}\n\n\tisInline(): true\n\t{\n\t\treturn true;\n\t}\n\n\tinsertNewAfter(selection: RangeSelection, restoreSelection: boolean): ParagraphNode\n\t{\n\t\tconst newElement = $createParagraphNode();\n\t\tconst direction = this.getDirection();\n\t\tnewElement.setDirection(direction);\n\t\tthis.insertAfter(newElement, restoreSelection);\n\n\t\treturn newElement;\n\t}\n\n\textractWithChild(\n\t\tchild: LexicalNode,\n\t\tselection: RangeSelection,\n\t\tdestination: 'clone' | 'html',\n\t): boolean\n\t{\n\t\tif (!$isRangeSelection(selection))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst anchor = selection.anchor;\n\t\tconst focus = selection.focus;\n\t\tconst anchorNode = anchor.getNode();\n\t\tconst focusNode = focus.getNode();\n\t\tconst isBackward: boolean = selection.isBackward();\n\t\tconst selectionLength: number = (\n\t\t\tisBackward\n\t\t\t\t? anchor.offset - focus.offset\n\t\t\t\t: focus.offset - anchor.offset\n\t\t);\n\n\t\treturn (\n\t\t\tthis.isParentOf(anchorNode)\n\t\t\t&& this.isParentOf(focusNode)\n\t\t\t&& this.getTextContent().length === selectionLength\n\t\t);\n\t}\n}\n\nfunction convertMentionElement(domNode: HTMLElement): DOMConversionOutput | null\n{\n\tconst textContent = domNode.textContent;\n\tif (textContent !== null)\n\t{\n\t\tconst { mentionEntityId, mentionId } = domNode.dataset;\n\t\tconst node = $createMentionNode(mentionEntityId, mentionId);\n\n\t\treturn {\n\t\t\tnode,\n\t\t};\n\t}\n\n\treturn null;\n}\n\nexport function $createMentionNode(entityId: string, id: string | number): MentionNode\n{\n\tconst mentionNode: MentionNode = new MentionNode(entityId, id);\n\n\treturn $applyNodeReplacement(mentionNode);\n}\n\nexport function $isMentionNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof MentionNode;\n}\n","import { Type, Runtime, Loc, Event, Dom } from 'main.core';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\n\nimport type {\n\tBBCodeConversionOutput,\n\tBBCodeConversion,\n\tBBCodeImportConversion,\n\tBBCodeExportConversion,\n\tBBCodeExportOutput,\n} from '../../bbcode';\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { getEditorPaddings } from '../../helpers/get-editor-paddings';\nimport { $getSelectionPosition } from '../../helpers/get-selection-position';\nimport Button from '../../toolbar/button';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nimport BasePlugin from '../base-plugin';\nimport { $createMentionNode, MentionNode } from './mention-node';\n\nimport type { Dialog, DialogOptions } from 'ui.entity-selector';\nimport type { BaseEvent } from 'main.core.events';\nimport { type TextEditor } from '../../text-editor';\n\nimport {\n\t$getSelection,\n\t$isRangeSelection,\n\t$isTextNode,\n\t$createTextNode,\n\tcreateCommand,\n\t$createParagraphNode,\n\t$insertNodes,\n\t$isRootOrShadowRoot,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\tKEY_ARROW_DOWN_COMMAND,\n\tKEY_ARROW_UP_COMMAND,\n\tKEY_ENTER_COMMAND,\n\tKEY_ESCAPE_COMMAND,\n\tKEY_TAB_COMMAND,\n\tKEY_DOWN_COMMAND,\n\ttype RangeSelection,\n\ttype LexicalNode,\n\ttype TextNode,\n\ttype LexicalCommand,\n} from 'ui.lexical.core';\n\nimport { $wrapNodeInElement, mergeRegister } from 'ui.lexical.utils';\n\nimport './mention.css';\n\nexport type QueryMatch = {\n\tleadOffset: number;\n\tmatchingString: string;\n\treplaceableString: string;\n};\n\nconst PUNCTUATION = '\\\\.,\\\\+\\\\*\\\\?\\\\$\\\\@\\\\|#{}\\\\(\\\\)\\\\^\\\\-\\\\[\\\\]\\\\\\\\/!%\\'\"~=<>_:;';\nconst TRIGGERS = ['@', '+'].join('');\n\n// Chars we expect to see in a mention (non-space, non-punctuation).\nconst VALID_CHARS = `[^${TRIGGERS}${PUNCTUATION}\\\\s]`;\n\n// Non-standard series of chars. Each series must be preceded and followed by\n// a valid char.\nconst VALID_JOINS = (\n\t'(?:'\n\t+ '\\\\.[ |$]|' // E.g. \"r. \" in \"Mr. Smith\"\n\t+ ' |' // E.g. \" \" in \"Josh Duck\"\n\t+ `[${PUNCTUATION}]|` // E.g. \"-' in \"Salier-Hellendag\"\n\t+ ')'\n);\n\nconst LENGTH_LIMIT = 25;\n\nconst mentionRegex = new RegExp(\n\t'(^|\\\\s|\\\\()('\n\t+ `[${TRIGGERS}]`\n\t+ `((?:${VALID_CHARS}${VALID_JOINS}){0,${LENGTH_LIMIT}})`\n\t+ ')$',\n);\n\nexport type InsertMentionPayload = {\n\tentityId: string,\n\tid: string | number,\n\ttext: string,\n\tbefore?: string,\n\tafter?: string,\n};\n\nexport const INSERT_MENTION_COMMAND: LexicalCommand<InsertMentionPayload> = createCommand('INSERT_MENTION_COMMAND');\nexport const INSERT_MENTION_DIALOG_COMMAND: LexicalCommand<InsertMentionPayload> = createCommand('INSERT_MENTION_DIALOG_COMMAND');\n\nexport class MentionPlugin extends BasePlugin\n{\n\t#dialog: Dialog = null;\n\t#lastQueryMatch: QueryMatch = null;\n\t#mentionListening: boolean = false;\n\t#removeKeyboardCommandsLock: Function = null;\n\t#removeUpdateListener: Function = null;\n\t#onEditorScroll: Function = this.#handleEditorScroll.bind(this);\n\t#lastPosition: { left: number, top: number } = null;\n\t#timeoutId: number = null;\n\t#triggerByAtSign: boolean = false;\n\n\t#dialogOptions: DialogOptions = null;\n\t#entities: Set<string> = new Set();\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tconst entities = editor.getOption('mention.entities', []);\n\t\tthis.#entities = Type.isArrayFilled(entities) ? new Set(entities) : new Set();\n\n\t\tconst dialogOptions = editor.getOption('mention.dialogOptions');\n\t\tif (Type.isPlainObject(dialogOptions))\n\t\t{\n\t\t\tthis.#dialogOptions = dialogOptions;\n\t\t\tif (Type.isArrayFilled(this.#dialogOptions.entities))\n\t\t\t{\n\t\t\t\tfor (const entity of this.#dialogOptions.entities)\n\t\t\t\t{\n\t\t\t\t\tif (Type.isPlainObject(entity) && Type.isStringFilled(entity.id))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#entities.add(entity.id);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.#registerKeyDownListener();\n\t\t}\n\n\t\tif (this.#entities.size > 0)\n\t\t{\n\t\t\tthis.#registerCommands();\n\t\t\tthis.#registerComponents();\n\t\t}\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Mention';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [MentionNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion | null\n\t{\n\t\tif (this.#entities.size > 0)\n\t\t{\n\t\t\tconst map = {};\n\t\t\tfor (const entityId of this.#entities)\n\t\t\t{\n\t\t\t\tmap[entityId] = (): BBCodeConversion => ({\n\t\t\t\t\tconversion: this.#convertMentionElement,\n\t\t\t\t\tpriority: 0,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn map;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tmention: (lexicalNode: MentionNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({\n\t\t\t\t\t\tname: lexicalNode.getEntityId(),\n\t\t\t\t\t\tvalue: lexicalNode.getId(),\n\t\t\t\t\t\tinline: true,\n\t\t\t\t\t}),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: MentionNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tmention: '#mention',\n\t\t\t},\n\t\t};\n\t}\n\n\tshouldTriggerByAtSign(): boolean\n\t{\n\t\treturn this.#triggerByAtSign;\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_MENTION_COMMAND,\n\t\t\t\t(payload: InsertMentionPayload) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!Type.isPlainObject(payload)\n\t\t\t\t\t\t|| !Type.isStringFilled(payload.entityId)\n\t\t\t\t\t\t|| !Type.isStringFilled(payload.text)\n\t\t\t\t\t\t|| (!Type.isStringFilled(payload.id) && !Type.isNumber(payload.id))\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.#entities.has(payload.entityId))\n\t\t\t\t\t{\n\t\t\t\t\t\tconsole.error(`TextEditor: MentionPlugin: entity id \"${payload.entityId}\" was not found.`);\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst mentionNode = $createMentionNode(payload.entityId, payload.id);\n\t\t\t\t\tmentionNode.append($createTextNode(payload.text));\n\n\t\t\t\t\tconst nodesToInsert = [];\n\t\t\t\t\tif (Type.isStringFilled(payload.before))\n\t\t\t\t\t{\n\t\t\t\t\t\tnodesToInsert.push($createTextNode(payload.before));\n\t\t\t\t\t}\n\n\t\t\t\t\tnodesToInsert.push(mentionNode);\n\n\t\t\t\t\tif (Type.isStringFilled(payload.after))\n\t\t\t\t\t{\n\t\t\t\t\t\tnodesToInsert.push($createTextNode(payload.after));\n\t\t\t\t\t}\n\n\t\t\t\t\t$insertNodes(nodesToInsert);\n\t\t\t\t\tif ($isRootOrShadowRoot(mentionNode.getParentOrThrow()))\n\t\t\t\t\t{\n\t\t\t\t\t\t$wrapNodeInElement(mentionNode, $createParagraphNode).selectEnd();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_MENTION_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.getEditor().update(\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tconst currentText = this.#getTextUpToAnchor(selection);\n\t\t\t\t\t\t\tlet needSpace = currentText !== null && !/(\\s|\\()$/.test(currentText);\n\t\t\t\t\t\t\tif (needSpace)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst anchor = selection.anchor;\n\t\t\t\t\t\t\t\tconst anchorNode = anchor.getNode();\n\t\t\t\t\t\t\t\tif (anchorNode.getIndexWithinParent() === 0 && anchor.offset === 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tneedSpace = false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tselection.insertText(needSpace ? ' @' : '@');\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tonUpdate: () => {\n\t\t\t\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\t\t\t\tconst match: null | QueryMatch = this.#getQueryMatch($getSelection());\n\t\t\t\t\t\t\t\t\tif (match !== null && !this.#isSelectionOnEntityBoundary(match.leadOffset))\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tthis.#openDialog(match);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (payload?.sender === 'mention' || (payload?.context === 'resize' && this.#mentionListening))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#hideDialog();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.isDialogVisible();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('mention', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --mention\"></span>');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_MENTION'));\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tif (this.isDialogVisible())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.getEditor().focus(() => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_MENTION_DIALOG_COMMAND);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\t#convertMentionElement(node: BBCodeElementNode): BBCodeConversionOutput\n\t{\n\t\treturn {\n\t\t\tnode: $createMentionNode(node.getName(), node.getValue()),\n\t\t};\n\t}\n\n\t#registerKeyDownListener(): void\n\t{\n\t\tthis.#triggerByAtSign = true;\n\n\t\tconst keyDownListener = (event: KeyboardEvent) => {\n\t\t\tif (this.#mentionListening)\n\t\t\t{\n\t\t\t\tif (event.key === 'Escape' || event.key === 'Enter')\n\t\t\t\t{\n\t\t\t\t\tthis.#stopMentionListening();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (!this.#mentionListening && (event.key === '+' || event.key === '@'))\n\t\t\t{\n\t\t\t\tthis.#timeoutId = setTimeout((): void => {\n\t\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\t\tconst match: null | QueryMatch = this.#getQueryMatch(selection);\n\t\t\t\t\t\tif (match !== null && !this.#isSelectionOnEntityBoundary(match.leadOffset))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#openDialog(match);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}, 300);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t};\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(KEY_DOWN_COMMAND, keyDownListener, COMMAND_PRIORITY_LOW),\n\t\t);\n\t}\n\n\t#registerTextContentListener(): void\n\t{\n\t\tthis.#unregisterTextContentListener();\n\n\t\tthis.#removeUpdateListener = this.getEditor().registerTextContentListener(\n\t\t\tthis.#textContentListener.bind(this),\n\t\t);\n\t}\n\n\t#unregisterTextContentListener(): void\n\t{\n\t\tif (this.#removeUpdateListener !== null)\n\t\t{\n\t\t\tthis.#removeUpdateListener();\n\t\t\tthis.#removeUpdateListener = null;\n\t\t}\n\t}\n\n\t#textContentListener(): void\n\t{\n\t\tthis.getEditor().getEditorState().read(() => {\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tconst match: null | QueryMatch = this.#getQueryMatch(selection);\n\t\t\tif (match !== null && !this.#isSelectionOnEntityBoundary(match.leadOffset))\n\t\t\t{\n\t\t\t\tthis.#openDialog(match);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#hideDialog();\n\t\t\t}\n\t\t});\n\t}\n\n\t#startMentionListening(): void\n\t{\n\t\tthis.#mentionListening = true;\n\t\tthis.#registerTextContentListener();\n\t}\n\n\t#stopMentionListening(): void\n\t{\n\t\tthis.#mentionListening = false;\n\t\tthis.#unregisterTextContentListener();\n\t}\n\n\t#getQueryMatch(selection: RangeSelection, minMatchLength: number = 0): null | QueryMatch\n\t{\n\t\tif (!$isRangeSelection(selection) || !selection.isCollapsed())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst anchor = selection.anchor;\n\t\tconst anchorNode = anchor.getNode();\n\t\tif (!$isTextNode(anchorNode) || !anchorNode.isSimpleText())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst text: string | null = this.#getTextUpToAnchor(selection);\n\n\t\t// console.log(\"text:\", text);\n\n\t\tif (!Type.isStringFilled(text))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn this.#matchMention(text, minMatchLength);\n\t}\n\n\t#getTextUpToAnchor(selection: RangeSelection): string | null\n\t{\n\t\tconst anchor = selection.anchor;\n\t\tif (anchor.type !== 'text')\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst anchorNode = anchor.getNode();\n\t\tif (!anchorNode.isSimpleText())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst anchorOffset: number = anchor.offset;\n\n\t\treturn anchorNode.getTextContent().slice(0, anchorOffset);\n\t}\n\n\t#isSelectionOnEntityBoundary(offset: number): boolean\n\t{\n\t\tif (offset !== 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.getEditor().getEditorState().read(() => {\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tif ($isRangeSelection(selection))\n\t\t\t{\n\t\t\t\tconst anchor = selection.anchor;\n\t\t\t\tconst anchorNode = anchor.getNode();\n\t\t\t\tconst prevSibling = anchorNode.getPreviousSibling();\n\n\t\t\t\treturn $isTextNode(prevSibling) && prevSibling.isTextEntity();\n\t\t\t}\n\n\t\t\treturn false;\n\t\t});\n\t}\n\n\t#matchMention(text: string, minMatchLength: number): QueryMatch | null\n\t{\n\t\tconst match = mentionRegex.exec(text);\n\t\tif (match !== null)\n\t\t{\n\t\t\t// The strategy ignores leading whitespace but we need to know it's\n\t\t\t// length to add it to the leadOffset\n\t\t\tconst maybeLeadingWhitespace = match[1];\n\n\t\t\tconst matchingString = match[3];\n\t\t\tif (matchingString.length >= minMatchLength)\n\t\t\t{\n\t\t\t\treturn {\n\t\t\t\t\tleadOffset: match.index + maybeLeadingWhitespace.length,\n\t\t\t\t\tmatchingString,\n\t\t\t\t\treplaceableString: match[2],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Split Lexical TextNode and return a new TextNode only containing matched text.\n\t * Common use cases include: removing the node, replacing with a new node.\n\t */\n\t#splitNodeContainingQuery(match: QueryMatch): TextNode | null\n\t{\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif (!$isRangeSelection(selection) || !selection.isCollapsed())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst anchor = selection.anchor;\n\t\tif (anchor.type !== 'text')\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst anchorNode = anchor.getNode();\n\t\tif (!anchorNode.isSimpleText())\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst selectionOffset = anchor.offset;\n\t\tconst textContent = anchorNode.getTextContent().slice(0, selectionOffset);\n\t\tconst characterOffset: number = match.replaceableString.length;\n\t\tconst queryOffset: number = this.#getFullMatchOffset(textContent, match.matchingString, characterOffset);\n\n\t\tconst startOffset: number = selectionOffset - queryOffset;\n\t\tif (startOffset < 0)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tlet newNode = null;\n\t\tif (startOffset === 0)\n\t\t{\n\t\t\t[newNode] = anchorNode.splitText(selectionOffset);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t[, newNode] = anchorNode.splitText(startOffset, selectionOffset);\n\t\t}\n\n\t\treturn newNode;\n\t}\n\n\t/**\n \t* Walk backwards along user input and forward through entity title to try\n \t* and replace more of the user's text with entity.\n \t*/\n\t#getFullMatchOffset(documentText: string, entryText: string, offset: number): number\n\t{\n\t\tlet triggerOffset: number = offset;\n\t\tfor (let i: number = triggerOffset; i <= entryText.length; i++)\n\t\t{\n\t\t\tif (documentText.slice(-i) === entryText.slice(0, Math.max(0, i)))\n\t\t\t{\n\t\t\t\ttriggerOffset = i;\n\t\t\t}\n\t\t}\n\n\t\treturn triggerOffset;\n\t}\n\n\t#openDialog(queryMatch: QueryMatch): void\n\t{\n\t\tif (this.isDestroyed())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#lastQueryMatch = queryMatch;\n\t\tif (this.#dialog === null)\n\t\t{\n\t\t\tconst dialogOptions = Type.isPlainObject(this.#dialogOptions) ? { ...this.#dialogOptions } : {};\n\t\t\tconst userEvents = dialogOptions.events;\n\n\t\t\tRuntime.loadExtension('ui.entity-selector').then((exports) => {\n\t\t\t\tif (this.isDestroyed())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst { Dialog } = exports;\n\n\t\t\t\tconst entitySelectorOptions: DialogOptions = {\n\t\t\t\t\tmultiple: false,\n\t\t\t\t\tenableSearch: false,\n\t\t\t\t\tclearSearchOnSelect: true,\n\t\t\t\t\thideOnSelect: true,\n\t\t\t\t\thideByEsc: true,\n\t\t\t\t\tautoHide: true,\n\t\t\t\t\theight: 300,\n\t\t\t\t\twidth: 400,\n\t\t\t\t\toffsetAnimation: false,\n\t\t\t\t\tcompactView: true,\n\t\t\t\t\t...dialogOptions,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\t\tthis.#lockKeyboardCommands();\n\t\t\t\t\t\t\tthis.#startMentionListening();\n\t\t\t\t\t\t\tEvent.bind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonHide: () => {\n\t\t\t\t\t\t\tthis.#handleHideOrDestroy();\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\t\tthis.#handleHideOrDestroy();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t'Item:onBeforeSelect': (event: BaseEvent) => {\n\t\t\t\t\t\t\tconst selectedItem = event.getData().item;\n\t\t\t\t\t\t\tevent.preventDefault();\n\n\t\t\t\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\t\t\t\tconst nodeToReplace: ?TextNode = this.#splitNodeContainingQuery(this.#lastQueryMatch);\n\t\t\t\t\t\t\t\tconst mentionNode: MentionNode = $createMentionNode(\n\t\t\t\t\t\t\t\t\tselectedItem.getEntityId(),\n\t\t\t\t\t\t\t\t\tselectedItem.getId(),\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tmentionNode.append(\n\t\t\t\t\t\t\t\t\t$createTextNode(selectedItem.getTitle()),\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tif (nodeToReplace)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tnodeToReplace.replace(mentionNode);\n\t\t\t\t\t\t\t\t\tmentionNode.select();\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.#hideDialog();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tthis.#dialog = new Dialog(entitySelectorOptions);\n\n\t\t\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND, { sender: 'mention' });\n\n\t\t\t\tthis.#dialog.subscribeFromOptions(userEvents);\n\t\t\t\tthis.#dialog.show();\n\t\t\t\tthis.#dialog.search(queryMatch.matchingString);\n\t\t\t\tthis.#adjustDialogPosition();\n\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error('TextEditor: MentionPlugin: cannot load \"ui.entity-selector\"', error);\n\t\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND, { sender: 'mention' });\n\n\t\t\tthis.#dialog.show();\n\t\t\tthis.#dialog.search(queryMatch.matchingString);\n\t\t\tthis.#adjustDialogPosition();\n\t\t}\n\t}\n\n\tisDialogVisible(): boolean\n\t{\n\t\treturn this.#dialog !== null && this.#dialog.isRendered() && this.#dialog.getPopup().isShown();\n\t}\n\n\t#adjustDialogPosition(): void\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\tconst selectionPosition = $getSelectionPosition(this.getEditor(), $getSelection(), document.body);\n\t\t\tif (selectionPosition === null)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { top, left, bottom } = selectionPosition;\n\t\t\tconst scrollerRect: DOMRect = Dom.getPosition(this.getEditor().getScrollerContainer());\n\t\t\tconst popupWidth = 400;\n\t\t\tconst editorPaddings = getEditorPaddings(this.getEditor());\n\n\t\t\tlet offsetLeft = 10;\n\t\t\tif (left - offsetLeft < scrollerRect.left)\n\t\t\t{\n\t\t\t\t// Left boundary\n\t\t\t\tconst overflow = scrollerRect.left - (left - offsetLeft);\n\t\t\t\toffsetLeft -= overflow + editorPaddings.left;\n\t\t\t}\n\t\t\telse if (scrollerRect.right < (left + popupWidth - offsetLeft))\n\t\t\t{\n\t\t\t\t// Right boundary\n\t\t\t\toffsetLeft += (left + popupWidth - offsetLeft) - scrollerRect.right + editorPaddings.right;\n\t\t\t}\n\n\t\t\tif (bottom < scrollerRect.top || top > scrollerRect.bottom)\n\t\t\t{\n\t\t\t\tDom.addClass(this.#dialog.getPopup().getPopupContainer(), 'ui-text-editor-mention-popup__hidden');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.#dialog.getPopup().getPopupContainer(), 'ui-text-editor-mention-popup__hidden');\n\n\t\t\t\tthis.#dialog.show();\n\t\t\t\tif (this.#lastPosition === null || this.#lastPosition.top !== bottom)\n\t\t\t\t{\n\t\t\t\t\tthis.#lastPosition = { left: left - offsetLeft, top: bottom };\n\t\t\t\t}\n\n\t\t\t\tthis.#dialog.getPopup().setBindElement(this.#lastPosition);\n\t\t\t\tthis.#dialog.getPopup().adjustPosition({ forceBindPosition: true, forceTop: true });\n\t\t\t}\n\t\t});\n\t}\n\n\t#handleEditorScroll(): void\n\t{\n\t\tthis.#adjustDialogPosition();\n\t}\n\n\t#handleHideOrDestroy(): void\n\t{\n\t\tthis.#lastPosition = null;\n\t\tthis.#unlockKeyboardCommands();\n\t\tthis.#stopMentionListening();\n\t\tEvent.unbind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t}\n\n\t#hideDialog(): void\n\t{\n\t\tif (this.#dialog !== null)\n\t\t{\n\t\t\tthis.#dialog.hide();\n\t\t}\n\t}\n\n\t#lockKeyboardCommands(): void\n\t{\n\t\tif (this.#removeKeyboardCommandsLock === null)\n\t\t{\n\t\t\tthis.#removeKeyboardCommandsLock = mergeRegister(\n\t\t\t\tthis.getEditor().registerCommand(KEY_ARROW_DOWN_COMMAND, (): true => true, COMMAND_PRIORITY_LOW),\n\t\t\t\tthis.getEditor().registerCommand(KEY_ARROW_UP_COMMAND, (): true => true, COMMAND_PRIORITY_LOW),\n\t\t\t\tthis.getEditor().registerCommand(KEY_ESCAPE_COMMAND, (): true => true, COMMAND_PRIORITY_LOW),\n\t\t\t\tthis.getEditor().registerCommand(KEY_TAB_COMMAND, (): true => true, COMMAND_PRIORITY_LOW),\n\t\t\t\tthis.getEditor().registerCommand(KEY_ENTER_COMMAND, (): true => true, COMMAND_PRIORITY_LOW),\n\t\t\t);\n\t\t}\n\t}\n\n\t#unlockKeyboardCommands(): void\n\t{\n\t\tif (this.#removeKeyboardCommandsLock !== null)\n\t\t{\n\t\t\tthis.#removeKeyboardCommandsLock();\n\t\t\tthis.#removeKeyboardCommandsLock = null;\n\t\t}\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#timeoutId !== null)\n\t\t{\n\t\t\tclearTimeout(this.#timeoutId);\n\t\t\tthis.#timeoutId = null;\n\t\t}\n\n\t\tif (this.#dialog !== null)\n\t\t{\n\t\t\tthis.#dialog.destroy();\n\t\t}\n\n\t\tthis.#unregisterTextContentListener();\n\t\tthis.#unlockKeyboardCommands();\n\t}\n}\n","/* eslint-disable no-underscore-dangle,@bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Dom, Type } from 'main.core';\nimport type { DecoratorOptions } from '../../types/decorator-options';\n\nimport {\n\tDecoratorNode,\n\t$applyNodeReplacement,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype DOMExportOutput,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\nexport type SerializedSmileyNode = {\n\tsrc: string;\n\ttyping: string;\n\twidth?: number;\n\theight?: number;\n\ttype: 'smiley',\n\tversion: number,\n};\n\nexport class SmileyNode extends DecoratorNode\n{\n\t__src: string;\n\t__typing: string;\n\t__width: number = null;\n\t__height: number = null;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'smiley';\n\t}\n\n\tstatic clone(node: SmileyNode): SmileyNode\n\t{\n\t\treturn new SmileyNode(\n\t\t\tnode.__src,\n\t\t\tnode.__typing,\n\t\t\tnode.__width,\n\t\t\tnode.__height,\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tconstructor(\n\t\tsrc: string,\n\t\ttyping: string,\n\t\twidth?: number,\n\t\theight?: number,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tsuper(key);\n\t\tthis.__src = src;\n\t\tthis.__typing = typing;\n\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\tthis.__width = width;\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\tthis.__height = height;\n\t\t}\n\t}\n\n\tgetSrc(): string\n\t{\n\t\treturn this.__src;\n\t}\n\n\tgetTyping(): string\n\t{\n\t\treturn this.__typing;\n\t}\n\n\tgetWidth(): null | number\n\t{\n\t\treturn this.__width;\n\t}\n\n\tgetHeight(): null | number\n\t{\n\t\treturn this.__height;\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst img: HTMLImageElement = document.createElement('img');\n\t\timg.src = encodeURI(this.__src);\n\t\tif (this.getWidth() > 0 && this.getHeight() > 0)\n\t\t{\n\t\t\tDom.style(img, {\n\t\t\t\twidth: `${this.getWidth()}px`,\n\t\t\t\theight: `${this.getHeight()}px`,\n\t\t\t});\n\t\t}\n\n\t\tif (Type.isStringFilled(config?.theme?.smiley))\n\t\t{\n\t\t\tDom.addClass(img, config.theme.smiley);\n\t\t}\n\n\t\tDom.attr(img, { draggable: false });\n\n\t\treturn img;\n\t}\n\n\tupdateDOM(prevNode: TextNode, dom: HTMLElement, config: EditorConfig): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tstatic importJSON(serializedNode: SerializedSmileyNode): SmileyNode\n\t{\n\t\tconst { src, typing, width, height } = serializedNode;\n\n\t\treturn $createSmileyNode(src, typing, width, height);\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\tconst span = document.createElement('span');\n\t\tspan.textContent = this.getTyping();\n\n\t\treturn { element: span };\n\t}\n\n\texportJSON(): SerializedSmileyNode\n\t{\n\t\treturn {\n\t\t\tsrc: this.getSrc(),\n\t\t\ttyping: this.getTyping(),\n\t\t\twidth: this.getWidth(),\n\t\t\theight: this.getHeight(),\n\t\t\ttype: 'smiley',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tdecorate(editor: LexicalEditor, config: EditorConfig): DecoratorOptions\n\t{\n\t\treturn {};\n\t}\n\n\tgetTextContent(): string\n\t{\n\t\treturn this.getTyping();\n\t}\n\n\tisInline(): true\n\t{\n\t\treturn true;\n\t}\n\n\tisKeyboardSelectable(): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tisIsolated(): boolean\n\t{\n\t\treturn false;\n\t}\n}\n\nexport function $isSmileyNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof SmileyNode;\n}\n\nexport function $createSmileyNode(src: string, typing: string, width: number, height: number): SmileyNode\n{\n\tconst node = new SmileyNode(src, typing, width, height);\n\t// node.setMode('token');\n\t// node.setDetail('unmergeable');\n\n\treturn $applyNodeReplacement(node);\n}\n","import { Type, Runtime } from 'main.core';\nimport { EventEmitter, type BaseEvent } from 'main.core.events';\nimport { Popup } from 'main.popup';\n\nexport type SmileyDialogOptions = {\n\ttargetNode?: HTMLElement,\n\tevents?: Object<string, (event: BaseEvent) => {}>,\n}\n\nexport class SmileyDialog extends EventEmitter\n{\n\t#popup: Popup = null;\n\t#targetNode: HTMLElement = null;\n\n\tconstructor(dialogOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.SmileyDialog');\n\n\t\tconst options: SmileyDialogOptions = Type.isPlainObject(dialogOptions) ? dialogOptions : {};\n\n\t\tthis.setTargetNode(options.targetNode);\n\t\tthis.subscribeFromOptions(options.events);\n\t}\n\n\tshow(): void\n\t{\n\t\tthis.getPopup().adjustPosition({ forceBindPosition: true });\n\t\tthis.getPopup().show();\n\t}\n\n\thide(): void\n\t{\n\t\tthis.getPopup().close();\n\t}\n\n\tisShown(): boolean\n\t{\n\t\treturn this.#popup !== null && this.#popup.isShown();\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.getPopup().destroy();\n\t}\n\n\tsetTargetNode(container: HTMLElement): void\n\t{\n\t\tif (Type.isElementNode(container))\n\t\t{\n\t\t\tthis.#targetNode = container;\n\t\t}\n\t}\n\n\tgetTargetNode(): HTMLElement | null\n\t{\n\t\treturn this.#targetNode;\n\t}\n\n\tgetPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tconst popupWidth = 360;\n\t\t\tconst targetNode = this.getTargetNode();\n\t\t\tconst rect = targetNode.getBoundingClientRect();\n\t\t\tconst targetNodeWidth = rect.width;\n\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tautoHide: true,\n\t\t\t\tpadding: 0,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\twidth: popupWidth,\n\t\t\t\theight: 250,\n\t\t\t\tbindElement: this.getTargetNode(),\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.emit('onClose');\n\t\t\t\t\t},\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.emit('onDestroy');\n\t\t\t\t\t},\n\t\t\t\t\tonFirstShow: () => {\n\t\t\t\t\t\tconst dialog = this;\n\t\t\t\t\t\tRuntime.loadExtension('ui.vue3', 'ui.vue3.components.smiles')\n\t\t\t\t\t\t\t.then((exports) => {\n\t\t\t\t\t\t\t\tconst { BitrixVue, Smiles } = exports;\n\t\t\t\t\t\t\t\tconst app = BitrixVue.createApp({\n\t\t\t\t\t\t\t\t\tmethods: {\n\t\t\t\t\t\t\t\t\t\thandleSelect(text) {\n\t\t\t\t\t\t\t\t\t\t\tdialog.emit('onSelect', { smiley: text.trim() });\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tcomponents: {\n\t\t\t\t\t\t\t\t\t\tSmiles,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttemplate: '<Smiles @selectSmile=\"handleSelect($event.text)\"/>',\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\tapp.mount(this.#popup.getContentContainer());\n\t\t\t\t\t\t\t}).catch(() => {\n\t\t\t\t\t\t\t\tthis.#popup.close();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\t\t\t\t\t},\n\t\t\t\t\tonShow: (event) => {\n\t\t\t\t\t\tconst popup = event.getTarget();\n\t\t\t\t\t\tconst offsetLeft = (targetNodeWidth / 2) - (popupWidth / 2);\n\t\t\t\t\t\tconst angleShift = Popup.getOption('angleLeftOffset') - Popup.getOption('angleMinTop');\n\n\t\t\t\t\t\tpopup.setAngle({ offset: popupWidth / 2 - angleShift });\n\t\t\t\t\t\tpopup.setOffset({ offsetLeft: offsetLeft + Popup.getOption('angleLeftOffset') });\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n}\n","/* eslint-disable no-underscore-dangle */\nimport { Loc, Type } from 'main.core';\nimport { type BaseEvent } from 'main.core.events';\n\nimport {\n\tTextNode,\n\tcreateCommand,\n\t$insertNodes,\n\t$createTextNode,\n\t$createParagraphNode,\n\t$isRootOrShadowRoot,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\ttype LexicalCommand,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport { SmileyParser, SmileyManager } from 'ui.smiley';\n\nimport { $findMatchingParent, $wrapNodeInElement } from 'ui.lexical.utils';\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { UNFORMATTED } from '../../constants';\nimport { TextEditorLexicalNode } from '../../types/text-editor-lexical-node';\n\nimport { $createSmileyNode, SmileyNode } from './smiley-node';\nimport Button from '../../toolbar/button';\nimport { SmileyDialog } from './smiley-dialog';\nimport BasePlugin from '../base-plugin';\n\nimport type {\n\tBBCodeExportOutput,\n\tBBCodeImportConversion,\n\tBBCodeExportConversion,\n} from '../../bbcode';\n\nimport { type TextEditor } from '../../text-editor';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\ntype InsertSmileyPayload = string;\n\nexport const INSERT_SMILEY_COMMAND: LexicalCommand<InsertSmileyPayload> = createCommand('INSERT_SMILEY_COMMAND');\nexport const INSERT_SMILEY_DIALOG_COMMAND: LexicalCommand = createCommand('INSERT_SMILEY_DIALOG_COMMAND');\n\nexport class SmileyPlugin extends BasePlugin\n{\n\t#smileyParser: SmileyParser = null;\n\t#smileyDialog: SmileyDialog = null;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tif (SmileyManager.getSize() > 0)\n\t\t{\n\t\t\tthis.#smileyParser = new SmileyParser(SmileyManager.getAll());\n\t\t\tthis.#registerListeners();\n\t\t\tthis.#registerInsertSmileyCommand();\n\t\t\tthis.#registerComponents();\n\t\t}\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Smiley';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [SmileyNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn null;\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tsmiley: (lexicalNode: SmileyNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createText(lexicalNode.getTyping()),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tbbcodeMap: {\n\t\t\t\tsmiley: '#text',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tconst handledTextNodes = new Set();\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerNodeTransform(TextNode, (node: TextNode) => {\n\t\t\t\tif (!node.isSimpleText() || handledTextNodes.has(node.getKey()))\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst $isUnformatted = $findMatchingParent(\n\t\t\t\t\tnode,\n\t\t\t\t\t(parentNode: TextEditorLexicalNode) => {\n\t\t\t\t\t\treturn (parentNode.__flags & UNFORMATTED) !== 0;\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\tif ($isUnformatted)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst splits = this.#smileyParser.parse(node.getTextContent());\n\t\t\t\tif (splits.length > 0)\n\t\t\t\t{\n\t\t\t\t\tconst splitOffsets = splits.reduce((acc, smiley) => {\n\t\t\t\t\t\tacc.push(smiley.start, smiley.end);\n\n\t\t\t\t\t\treturn acc;\n\t\t\t\t\t}, []);\n\n\t\t\t\t\tconst textNodes = node.splitText(...splitOffsets);\n\t\t\t\t\t// console.log(\"textNodes\", splitOffsets, textNodes);\n\n\t\t\t\t\tfor (const textNode of textNodes)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst smiley = SmileyManager.get(textNode.getTextContent()) || null;\n\t\t\t\t\t\tif (smiley)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// console.log('replace');\n\t\t\t\t\t\t\tconst smileyNode = $createSmileyNode(\n\t\t\t\t\t\t\t\tsmiley.getImage(),\n\t\t\t\t\t\t\t\tsmiley.getTyping(),\n\t\t\t\t\t\t\t\tsmiley.getWidth(),\n\t\t\t\t\t\t\t\tsmiley.getHeight(),\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\ttextNode.replace(smileyNode);\n\t\t\t\t\t\t\t// smileyNode.selectNext(0, 0);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thandledTextNodes.add(textNode.getKey());\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}),\n\n\t\t\tthis.getEditor().registerUpdateListener(() => {\n\t\t\t\thandledTextNodes.clear();\n\t\t\t}),\n\n\t\t\t// Workaround for a disappearing cursor in FireFox and Safari.\n\t\t\t// Lexical always sets contentEditable = 'false' for all decorator nodes.\n\t\t\tthis.getEditor().registerMutationListener(\n\t\t\t\tSmileyNode,\n\t\t\t\t(nodeMutations) => {\n\t\t\t\t\tfor (const [nodeKey, mutation] of nodeMutations)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (mutation === 'created')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst dom = this.getEditor().getElementByKey(nodeKey);\n\t\t\t\t\t\t\tdom.contentEditable = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tif (this.#smileyDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#smileyDialog.hide();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.#smileyDialog !== null && this.#smileyDialog.isShown();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerInsertSmileyCommand(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_SMILEY_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tconst smiley = SmileyManager.get(payload) || null;\n\t\t\t\t\tif (!smiley)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst smileyNode = $createSmileyNode(\n\t\t\t\t\t\tsmiley.getImage(),\n\t\t\t\t\t\tsmiley.getTyping(),\n\t\t\t\t\t\tsmiley.getWidth(),\n\t\t\t\t\t\tsmiley.getHeight(),\n\t\t\t\t\t);\n\n\t\t\t\t\t$insertNodes([$createTextNode(' '), smileyNode, $createTextNode(' ')]);\n\t\t\t\t\tif ($isRootOrShadowRoot(smileyNode.getParentOrThrow()))\n\t\t\t\t\t{\n\t\t\t\t\t\t$wrapNodeInElement(smileyNode, $createParagraphNode).selectEnd();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_SMILEY_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (!Type.isPlainObject(payload) || !Type.isElementNode(payload.targetNode))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.#smileyDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.#smileyDialog.getTargetNode() === payload.targetNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#smileyDialog.show();\n\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.#smileyDialog.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#smileyDialog = new SmileyDialog({\n\t\t\t\t\t\ttargetNode: payload.targetNode,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tonSelect: (event: BaseEvent) => {\n\t\t\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_SMILEY_COMMAND, event.getData().smiley);\n\t\t\t\t\t\t\t\tthis.#smileyDialog.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\t\t\tthis.#smileyDialog = null;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.#smileyDialog.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('smileys', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --insert-emoji\"></span>');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_SMILEYS'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_SMILEY_DIALOG_COMMAND, {\n\t\t\t\t\t\ttargetNode: button.getContainer(),\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#smileyDialog !== null)\n\t\t{\n\t\t\tthis.#smileyDialog.destroy();\n\t\t}\n\t}\n}\n","import { Dom, Tag, Type } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\nimport type { BaseEvent } from 'main.core.events';\nimport type { EditorConfig } from 'ui.lexical.core';\n\nimport { $getNodeByKey } from 'ui.lexical.core';\n\nimport DecoratorComponent from '../../decorator-component';\n\nimport type { JsonObject } from 'main.core';\nimport { calcImageSize } from '../../helpers/calc-image-size';\nimport type { DecoratorComponentOptions } from '../../types/decorator-component-options';\nimport { $isVideoNode, VideoNode } from './video-node';\nimport FigureResizer from '../../helpers/figure-resizer';\n\nexport default class VideoComponent extends DecoratorComponent\n{\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\t#figureResizer: FigureResizer = null;\n\t#trusted: boolean = false;\n\n\tconstructor(options: DecoratorComponentOptions)\n\t{\n\t\tsuper(options);\n\n\t\tthis.#trusted = Type.isStringFilled(this.getOption('provider'));\n\n\t\tthis.#figureResizer = new FigureResizer({\n\t\t\ttarget: this.#getVideo(),\n\t\t\teditor: this.getEditor(),\n\t\t\tminWidth: 120,\n\t\t\tminHeight: 120,\n\t\t\tfreeTransform: true,\n\t\t\tevents: {\n\t\t\t\tonResize: this.#handleResize.bind(this),\n\t\t\t\tonResizeEnd: this.#handleResizeEnd.bind(this),\n\t\t\t},\n\t\t});\n\n\t\tthis.getNodeSelection().onSelect((selected: boolean) => {\n\t\t\tif (selected || this.#figureResizer.isResizing())\n\t\t\t{\n\t\t\t\tDom.addClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.#getContainer(), '--selected');\n\t\t\t\tthis.#figureResizer.hide();\n\t\t\t}\n\t\t});\n\n\t\tthis.update(this.getOptions());\n\t\tthis.#render();\n\t}\n\n\t#render()\n\t{\n\t\tDom.append(this.#getContainer(), this.getTarget());\n\t}\n\n\t#getContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-video-component\">\n\t\t\t\t\t<div class=\"ui-text-editor-video-object-container\">${this.#getVideo()}</div>\n\t\t\t\t\t${this.#figureResizer.getContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getVideo(): HTMLIFrameElement | HTMLVideoElement\n\t{\n\t\treturn this.#refs.remember('video', () => {\n\t\t\tlet video: HTMLIFrameElement | HTMLVideoElement = null;\n\t\t\tconst src = this.getOption('src');\n\t\t\tif (this.#trusted)\n\t\t\t{\n\t\t\t\tvideo = Tag.render`<iframe frameborder=\"0\" src=\"about:blank\" draggable=\"false\" tabindex=\"-1\"></iframe>`;\n\t\t\t\tvideo.src = src;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvideo = Dom.create({\n\t\t\t\t\ttag: 'video',\n\t\t\t\t\tattrs: {\n\t\t\t\t\t\tcontrols: true,\n\t\t\t\t\t\tpreload: 'metadata',\n\t\t\t\t\t\tplaysinline: true,\n\t\t\t\t\t\ttabIndex: -1,\n\t\t\t\t\t\tsrc,\n\t\t\t\t\t},\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tloadedmetadata: (event: Event) => {\n\t\t\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\t\t\tconst node: VideoNode = $getNodeByKey(this.getNodeKey());\n\t\t\t\t\t\t\t\tif ($isVideoNode(node) && node.getWidth() === 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tconst [width, height] = calcImageSize(\n\t\t\t\t\t\t\t\t\t\tevent.target.videoWidth,\n\t\t\t\t\t\t\t\t\t\tevent.target.videoHeight,\n\t\t\t\t\t\t\t\t\t\t600,\n\t\t\t\t\t\t\t\t\t\t600,\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\t\tnode.setWidthAndHeight(width, height);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst config: EditorConfig = this.getOption('config', {});\n\t\t\tif (config?.theme?.video?.object)\n\t\t\t{\n\t\t\t\tvideo.className = config.theme.video.object;\n\t\t\t}\n\n\t\t\treturn video;\n\t\t});\n\t}\n\n\t#handleResize(event: BaseEvent): void\n\t{\n\t\tthis.update(event.getData());\n\t}\n\n\t#handleResizeEnd(event: BaseEvent): void\n\t{\n\t\tthis.setSelected(true);\n\n\t\tthis.getEditor().update(() => {\n\t\t\tconst node: VideoNode = $getNodeByKey(this.getNodeKey());\n\t\t\tif ($isVideoNode(node))\n\t\t\t{\n\t\t\t\tconst { width, height } = event.getData();\n\t\t\t\tnode.setWidthAndHeight(width, height);\n\t\t\t}\n\t\t});\n\t}\n\n\tupdate(options: JsonObject): void\n\t{\n\t\tconst width = Type.isNumber(options.width) && options.width > 0 ? options.width : null;\n\t\tconst height = Type.isNumber(options.height) && options.height > 0 ? options.height : null;\n\t\tconst aspectRatio = width > 0 && height > 0 ? `${width} / ${height}` : 'auto';\n\n\t\tDom.adjust(this.#getVideo(), {\n\t\t\tattrs: {\n\t\t\t\twidth,\n\t\t\t},\n\t\t\tstyle: {\n\t\t\t\twidth,\n\t\t\t\theight: 'auto',\n\t\t\t\taspectRatio,\n\t\t\t},\n\t\t});\n\t}\n}\n","/* eslint-disable no-underscore-dangle, @bitrix24/bitrix24-rules/no-pseudo-private */\n\nimport { Type, Uri } from 'main.core';\nimport VideoComponent from './video-component';\n\nimport {\n\tDecoratorNode,\n\t$applyNodeReplacement,\n\ttype DOMConversionMap,\n\ttype DOMExportOutput,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype LexicalEditor,\n\ttype NodeKey,\n\ttype SerializedLexicalNode,\n} from 'ui.lexical.core';\n\nimport type { DecoratorOptions } from '../../types/decorator-options';\nimport { VideoService } from 'ui.video-service';\n\nexport interface VideoPayload {\n\tsrc: string;\n\twidth?: number;\n\theight?: number;\n\tmaxWidth?: number;\n\tkey?: NodeKey;\n}\n\nexport type SerializedVideoNode = SerializedLexicalNode &\n{\n\tsrc: string;\n\twidth?: number;\n\theight?: number;\n};\n\nexport class VideoNode extends DecoratorNode\n{\n\t__src: string;\n\t__width: number = 560;\n\t__height: number = 315;\n\t__provider: string = null;\n\n\tconstructor(\n\t\tsrc: string,\n\t\twidth?: number,\n\t\theight?: number,\n\t\tkey?: NodeKey,\n\t)\n\t{\n\t\tsuper(key);\n\t\tthis.__src = src;\n\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\tthis.__width = Math.round(width);\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\tthis.__height = Math.round(height);\n\t\t}\n\n\t\tconst url = /^https?:/.test(src) ? src : `https://${src.replace(/^\\/\\//, '')}`;\n\t\tconst uri = new Uri(url);\n\t\tconst videoService = VideoService.createByHost(uri.getHost());\n\t\tif (videoService)\n\t\t{\n\t\t\tthis.__provider = videoService.getId();\n\t\t}\n\t}\n\n\tstatic useDecoratorComponent = true;\n\n\tstatic getType(): string\n\t{\n\t\treturn 'video';\n\t}\n\n\tstatic clone(node: VideoNode): VideoNode\n\t{\n\t\treturn new VideoNode(\n\t\t\tnode.__src,\n\t\t\tnode.__width,\n\t\t\tnode.__height,\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tstatic importJSON(serializedNode: SerializedVideoNode): VideoNode\n\t{\n\t\tconst { width, height, src } = serializedNode;\n\n\t\treturn $createVideoNode({ src, width, height });\n\t}\n\n\texportDOM(): DOMExportOutput\n\t{\n\t\treturn { element: null };\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn null;\n\t}\n\n\texportJSON(): SerializedVideoNode\n\t{\n\t\treturn {\n\t\t\tsrc: this.getSrc(),\n\t\t\twidth: this.getWidth(),\n\t\t\theight: this.getHeight(),\n\t\t\ttype: 'video',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tsetWidthAndHeight(width: number, height: number): void\n\t{\n\t\tconst writable = this.getWritable();\n\t\tif (Type.isNumber(width))\n\t\t{\n\t\t\twritable.__width = Math.round(width);\n\t\t}\n\n\t\tif (Type.isNumber(height))\n\t\t{\n\t\t\twritable.__height = Math.round(height);\n\t\t}\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst span = document.createElement('span');\n\t\tconst theme = config.theme;\n\t\tconst className = theme?.video?.container;\n\t\tif (className !== undefined)\n\t\t{\n\t\t\tspan.className = className;\n\t\t}\n\n\t\treturn span;\n\t}\n\n\tupdateDOM(): false\n\t{\n\t\treturn false;\n\t}\n\n\tgetSrc(): string\n\t{\n\t\treturn this.__src;\n\t}\n\n\tgetWidth(): number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__width;\n\t}\n\n\tgetHeight(): number\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__height;\n\t}\n\n\tgetProvider(): string | null\n\t{\n\t\tconst self = this.getLatest();\n\n\t\treturn self.__provider;\n\t}\n\n\tdecorate(editor: LexicalEditor, config: EditorConfig): DecoratorOptions\n\t{\n\t\treturn {\n\t\t\tcomponentClass: VideoComponent,\n\t\t\toptions: {\n\t\t\t\tsrc: this.getSrc(),\n\t\t\t\twidth: this.getWidth(),\n\t\t\t\theight: this.getHeight(),\n\t\t\t\tprovider: this.getProvider(),\n\t\t\t\tconfig,\n\t\t\t},\n\t\t};\n\t}\n\n\tisInline(): true\n\t{\n\t\treturn true;\n\t}\n}\n\nexport function $createVideoNode({ src, width, height, key }): VideoNode\n{\n\treturn $applyNodeReplacement(new VideoNode(src, width, height, key));\n}\n\nexport function $isVideoNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof VideoNode;\n}\n","import { Tag, Type, Dom, Loc } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\nimport { EventEmitter, type BaseEvent } from 'main.core.events';\nimport { Popup, PopupTarget, PopupTargetOptions } from 'main.popup';\nimport { sanitizeUrl } from '../../helpers/sanitize-url';\n\nimport './video-dialog.css';\n\nexport type VideoDialogOptions = {\n\ttargetContainer?: HTMLElement,\n\tevents?: Object<string, (event: BaseEvent) => {}>,\n}\n\nexport default class VideoDialog extends EventEmitter\n{\n\t#popup: Popup = null;\n\t#videoUrl: string = '';\n\t#targetContainer: HTMLElement = null;\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\n\tconstructor(options: VideoDialogOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.VideoDialog');\n\n\t\tconst videoDialogOptions: VideoDialogOptions = Type.isPlainObject(options) ? options : {};\n\n\t\tthis.setTargetContainer(videoDialogOptions.targetContainer);\n\t\tthis.subscribeFromOptions(videoDialogOptions.events);\n\t}\n\n\tshow(options: { target: PopupTarget, targetOptions: PopupTargetOptions } = {}): void\n\t{\n\t\tconst target: PopupTarget = options.target ?? undefined;\n\t\tconst targetOptions: PopupTargetOptions = Type.isPlainObject(options.targetOptions) ? options.targetOptions : {};\n\n\t\tif (!Type.isUndefined(target))\n\t\t{\n\t\t\tthis.getPopup().setBindElement(target);\n\t\t}\n\n\t\tthis.getPopup().adjustPosition({\n\t\t\t...targetOptions,\n\t\t\tforceBindPosition: true,\n\t\t});\n\n\t\tthis.getPopup().show();\n\t}\n\n\thide(): void\n\t{\n\t\tthis.getPopup().close();\n\t}\n\n\tisShown(): boolean\n\t{\n\t\treturn this.#popup !== null && this.#popup.isShown();\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.getPopup().destroy();\n\t}\n\n\tsetVideoUrl(url: string): void\n\t{\n\t\tif (Type.isString(url))\n\t\t{\n\t\t\tthis.#videoUrl = sanitizeUrl(url);\n\t\t}\n\t}\n\n\tgetVideoUrl(): string\n\t{\n\t\treturn this.#videoUrl;\n\t}\n\n\tsetTargetContainer(container: HTMLElement): void\n\t{\n\t\tif (Type.isElementNode(container))\n\t\t{\n\t\t\tthis.#targetContainer = container;\n\t\t}\n\t}\n\n\tgetTargetContainer(): HTMLElement | null\n\t{\n\t\treturn this.#targetContainer;\n\t}\n\n\tgetPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tautoHide: true,\n\t\t\t\tcacheable: false,\n\t\t\t\tpadding: 0,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\ttargetContainer: this.getTargetContainer(),\n\t\t\t\tcontent: this.getContainer(),\n\t\t\t\tevents: {\n\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\tthis.emit('onShow');\n\t\t\t\t\t},\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.emit('onClose');\n\t\t\t\t\t},\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.emit('onDestroy');\n\t\t\t\t\t},\n\t\t\t\t\tonAfterShow: () => {\n\t\t\t\t\t\tthis.getUrlTextBox().focus();\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-video-dialog\">\n\t\t\t\t\t<div class=\"ui-text-editor-video-dialog-form\">\n\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-s ui-ctl-inline ui-ctl-w100 ui-text-editor-video-dialog-textbox\">\n\t\t\t\t\t\t\t<div class=\"ui-ctl-tag\">${Loc.getMessage('TEXT_EDITOR_VIDEO_INSERT_TITLE')}</div>\n\t\t\t\t\t\t\t${this.getUrlTextBox()}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button type=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-video-dialog-button\" \n\t\t\t\t\t\t\tonclick=\"${this.#handleSaveBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"video-dialog-save-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --check\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button \n\t\t\t\t\t\t\ttype=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-video-dialog-button\"\n\t\t\t\t\t\t\tonclick=\"${this.#handleCancelBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"video-dialog-cancel-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --cross-60\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t${this.getStatusContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetUrlTextBox(): HTMLInputElement\n\t{\n\t\treturn this.#refs.remember('url-textbox', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<input \n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\tplaceholder=\"https://\"\n\t\t\t\t\tvalue=\"${this.getVideoUrl()}\"\n\t\t\t\t\tonkeydown=\"${this.#handleTextBoxKeyDown.bind(this)}\"\n\t\t\t\t\toninput=\"${this.#handleTextBoxInput.bind(this)}\"\n\t\t\t\t\tdata-testid=\"video-dialog-textbox\"\n\t\t\t\t>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetStatusContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('status', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-video-dialog-status\">${Loc.getMessage('TEXT_EDITOR_VIDEO_INSERT_HINT')}</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tshowError(error: string)\n\t{\n\t\tDom.addClass(this.getStatusContainer(), '--error');\n\t\tDom.addClass(this.getUrlTextBox().parentNode, 'ui-ctl-warning');\n\n\t\tif (Type.isStringFilled(error))\n\t\t{\n\t\t\tthis.getStatusContainer().textContent = error;\n\t\t}\n\t}\n\n\tclearError()\n\t{\n\t\tDom.removeClass(this.getStatusContainer(), '--error');\n\t\tDom.removeClass(this.getUrlTextBox().parentNode, 'ui-ctl-warning');\n\t\tthis.getStatusContainer().textContent = Loc.getMessage('TEXT_EDITOR_VIDEO_INSERT_HINT');\n\t}\n\n\t#handleSaveBtnClick(): void\n\t{\n\t\tconst url: string = this.getUrlTextBox().value.trim();\n\t\tif (url.length > 0)\n\t\t{\n\t\t\tthis.setVideoUrl(url);\n\t\t\tthis.emit('onSave');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getUrlTextBox().focus();\n\t\t}\n\t}\n\n\t#handleTextBoxKeyDown(event: KeyboardEvent)\n\t{\n\t\tif (event.key === 'Enter')\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t\tthis.#handleSaveBtnClick();\n\t\t}\n\t}\n\n\t#handleTextBoxInput(event: KeyboardEvent)\n\t{\n\t\tthis.emit('onInput');\n\t}\n\n\t#handleCancelBtnClick(): void\n\t{\n\t\tthis.emit('onCancel');\n\t}\n}\n","export function validateVideoUrl(url: string): boolean\n{\n\treturn /^(http:|https:|\\/)/i.test(url);\n}\n","import { Type, Loc, Event } from 'main.core';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\n\nimport {\n\ttype BBCodeConversion,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n\ttype BBCodeExportOutput,\n\ttype BBCodeConversionFn,\n} from '../../bbcode';\n\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { $adjustDialogPosition } from '../../helpers/adjust-dialog-position';\n\nimport {\n\tcreateCommand,\n\t$createTextNode,\n\t$getSelection,\n\t$isRangeSelection,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\ttype LexicalNode,\n\ttype LexicalCommand,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nimport { $insertNodeToNearestRoot } from 'ui.lexical.utils';\nimport { $restoreSelection } from '../../helpers/restore-selection';\n\nimport Button from '../../toolbar/button';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\nimport BasePlugin from '../base-plugin';\nimport VideoDialog from './video-dialog';\n\nimport { sanitizeUrl } from '../../helpers/sanitize-url';\nimport { validateVideoUrl } from '../../helpers/validate-video-url';\n\nimport { $createVideoNode, VideoNode, type VideoPayload } from './video-node';\n\nimport { type TextEditor } from '../../text-editor';\n\nimport './video-plugin.css';\nimport { VideoService } from 'ui.video-service';\n\nexport type InsertVideoPayload = Readonly<VideoPayload>;\n\n/** @memberof BX.UI.TextEditor.Plugins.Video */\nexport const INSERT_VIDEO_COMMAND: LexicalCommand<InsertVideoPayload> = createCommand('INSERT_VIDEO_COMMAND');\n\n/** @memberof BX.UI.TextEditor.Plugins.Video */\nexport const INSERT_VIDEO_DIALOG_COMMAND: LexicalCommand = createCommand('INSERT_VIDEO_DIALOG_COMMAND');\n\nexport class VideoPlugin extends BasePlugin\n{\n\t#videoDialog: VideoDialog = null;\n\t#onEditorScroll: Function = this.#handleEditorScroll.bind(this);\n\t#lastSelection: RangeSelection = null;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Video';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [VideoNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tvideo: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\t// [video type={type} width={width} height={height}]{url}[/video]\n\t\t\t\t\tconst src = node.getContent().trim();\n\t\t\t\t\tconst width = Number(node.getAttribute('width'));\n\t\t\t\t\tconst height = Number(node.getAttribute('height'));\n\t\t\t\t\tif (validateVideoUrl(src))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tnode: $createVideoNode({ src: sanitizeUrl(src), width, height }),\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createTextNode(node.toString()),\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tvideo: (lexicalNode: VideoNode): BBCodeExportOutput => {\n\t\t\t\tconst attributes = {};\n\t\t\t\tconst width = lexicalNode.getWidth();\n\t\t\t\tconst height = lexicalNode.getHeight();\n\t\t\t\tif (Type.isNumber(width) && Type.isNumber(height))\n\t\t\t\t{\n\t\t\t\t\tattributes.width = width;\n\t\t\t\t\tattributes.height = height;\n\t\t\t\t}\n\n\t\t\t\tconst provider = lexicalNode.getProvider();\n\t\t\t\tif (Type.isStringFilled(provider))\n\t\t\t\t{\n\t\t\t\t\tattributes.type = provider;\n\t\t\t\t}\n\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({\n\t\t\t\t\t\tname: 'video',\n\t\t\t\t\t\tinline: false,\n\t\t\t\t\t\tattributes,\n\t\t\t\t\t}),\n\t\t\t\t\tafter: (elementNode: BBCodeElementNode) => {\n\t\t\t\t\t\telementNode.setChildren([scheme.createText(lexicalNode.getSrc())]);\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: VideoNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tvideo: 'video',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_VIDEO_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tif (Type.isPlainObject(payload) && validateVideoUrl(payload.src))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst videoNode = $createVideoNode({\n\t\t\t\t\t\t\tsrc: VideoService.getEmbeddedUrl(payload.src) || payload.src,\n\t\t\t\t\t\t\twidth: payload.width,\n\t\t\t\t\t\t\theight: payload.height,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$insertNodeToNearestRoot(videoNode);\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_VIDEO_DIALOG_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = selection.clone();\n\t\t\t\t\tif (this.#videoDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#videoDialog.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND, { sender: 'video-dialog' });\n\n\t\t\t\t\tthis.#videoDialog = new VideoDialog({\n\t\t\t\t\t\t// for an embedded popup: document.body -> this.getEditor().getScrollerContainer()\n\t\t\t\t\t\ttargetContainer: document.body,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tonSave: () => {\n\t\t\t\t\t\t\t\tconst url = this.#videoDialog.getVideoUrl();\n\t\t\t\t\t\t\t\tif (!Type.isStringFilled(url))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.#videoDialog.hide();\n\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (!validateVideoUrl(url))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.#videoDialog.showError(Loc.getMessage('TEXT_EDITOR_INVALID_URL'));\n\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_VIDEO_COMMAND, { src: url });\n\n\t\t\t\t\t\t\t\tthis.#videoDialog.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonInput: () => {\n\t\t\t\t\t\t\t\tthis.#videoDialog.clearError();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonCancel: () => {\n\t\t\t\t\t\t\t\tthis.#videoDialog.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\t\t\tif ($adjustDialogPosition(this.#videoDialog.getPopup(), this.getEditor()))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tEvent.bind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\t\t\t\t\t\t\t\tthis.getEditor().highlightSelection();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\t\t\tthis.#handleDialogDestroy();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\t\t\tthis.#handleDialogDestroy();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tthis.#videoDialog.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (payload?.sender === 'video-dialog')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = null;\n\n\t\t\t\t\tif (this.#videoDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#videoDialog.hide();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.#videoDialog !== null && this.#videoDialog.isShown();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#restoreSelection(): boolean\n\t{\n\t\tconst success = $restoreSelection(this.#lastSelection);\n\t\tthis.#lastSelection = null;\n\n\t\treturn success;\n\t}\n\n\t#handleDialogDestroy(): void\n\t{\n\t\tif (this.#videoDialog === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#videoDialog = null;\n\t\tEvent.unbind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\tthis.getEditor().resetHighlightSelection();\n\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\t\t\t// this.getEditor().focus();\n\t\t});\n\t}\n\n\t#handleEditorScroll(): void\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\t$adjustDialogPosition(this.#videoDialog.getPopup(), this.getEditor());\n\t\t});\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('video', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --insert-video\"></span>');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_VIDEO'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tif (this.#videoDialog !== null && this.#videoDialog.isShown())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.getEditor().focus(() => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_VIDEO_DIALOG_COMMAND);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#videoDialog !== null)\n\t\t{\n\t\t\tthis.#videoDialog.destroy();\n\t\t}\n\t}\n}\n","import { type RangeSelection, type TextNode } from 'ui.lexical.core';\nimport { FORMAT_PREDICATES } from './constants';\n\nexport function printFormatProperties(nodeOrSelection: TextNode | RangeSelection): string\n{\n\tlet str = FORMAT_PREDICATES.map((predicate) => predicate(nodeOrSelection))\n\t\t.filter(Boolean)\n\t\t.join(', ')\n\t\t.toLocaleLowerCase();\n\n\tif (str !== '')\n\t{\n\t\tstr = `format: ${str}`;\n\t}\n\n\treturn str;\n}\n","import { Type } from 'main.core';\nimport { $isTextNode, LexicalNode, type TextNode } from 'ui.lexical.core';\nimport { $isLinkNode, type LinkNode } from 'ui.lexical.link';\nimport { $isCodeNode, $isCodeTokenNode, type CodeNode, type CodeTokenNode } from '../plugins/code';\nimport {\n\t$isFileNode,\n\t$isFileImageNode,\n\t$isFileVideoNode,\n\ttype FileNode,\n\ttype FileImageNode,\n\ttype FileVideoNode,\n} from '../plugins/file';\n\nimport { $isImageNode, type ImageNode } from '../plugins/image';\nimport { $isMentionNode, type MentionNode } from '../plugins/mention';\nimport { $isSmileyNode, type SmileyNode } from '../plugins/smiley';\nimport { $isVideoNode, type VideoNode } from '../plugins/video';\n\nimport { DETAIL_PREDICATES, MODE_PREDICATES, NON_SINGLE_WIDTH_CHARS_REPLACEMENT } from './constants';\nimport { printFormatProperties } from './print-format-properties';\n\nexport function printNode(node: LexicalNode): string\n{\n\tif ($isCodeTokenNode(node))\n\t{\n\t\tconst codeTokenNode: CodeTokenNode = node;\n\n\t\treturn `{ ${codeTokenNode.__highlightType}: \"${normalize(codeTokenNode.getTextContent())}\" }`;\n\t}\n\n\tif ($isCodeNode(node))\n\t{\n\t\tconst codeTokenNode: CodeNode = node;\n\n\t\treturn `{ children: ${codeTokenNode.getChildrenSize()} }`;\n\t}\n\n\tif ($isTextNode(node))\n\t{\n\t\tconst text = node.getTextContent();\n\t\tconst title = text.length === 0 ? '(empty)' : `\"${normalize(text)}\"`;\n\t\tconst properties = printAllTextNodeProperties(node);\n\n\t\treturn [title, properties.length > 0 ? `{ ${properties} }` : null]\n\t\t\t.filter(Boolean)\n\t\t\t.join(' ')\n\t\t\t.trim();\n\t}\n\n\tif ($isFileImageNode(node))\n\t{\n\t\tconst fileImageNode: FileImageNode = node;\n\n\t\treturn `{ id: ${fileImageNode.getId()}, width: ${fileImageNode.getWidth()}, height: ${fileImageNode.getHeight()} }`;\n\t}\n\n\tif ($isFileNode(node))\n\t{\n\t\tconst fileNode: FileNode = node;\n\n\t\treturn `{ id: ${fileNode.getId()} }`;\n\t}\n\n\tif ($isFileVideoNode(node))\n\t{\n\t\tconst fileVideoNode: FileVideoNode = node;\n\n\t\treturn `{ id: ${fileVideoNode.getId()} }`;\n\t}\n\n\tif ($isSmileyNode(node))\n\t{\n\t\tconst smileyNode: SmileyNode = node;\n\n\t\treturn `{ typing: ${smileyNode.getTyping()}, width: ${smileyNode.getWidth()}, height: ${smileyNode.getHeight()} }`;\n\t}\n\n\tif ($isVideoNode(node))\n\t{\n\t\tconst videoNode: VideoNode = node;\n\n\t\treturn `{ width: ${videoNode.getWidth()}, height: ${videoNode.getHeight()} }`;\n\t}\n\n\tif ($isMentionNode(node))\n\t{\n\t\tconst mentionNode: MentionNode = node;\n\n\t\treturn `{ entityId: ${mentionNode.getEntityId()}, id: ${mentionNode.getId()} }`;\n\t}\n\n\tif ($isImageNode(node))\n\t{\n\t\tconst imageNode: ImageNode = node;\n\n\t\treturn `{ width: ${imageNode.getWidth()}, height: ${imageNode.getHeight()} }`;\n\t}\n\n\tif ($isLinkNode(node))\n\t{\n\t\tconst linkNode: LinkNode = node;\n\t\tconst link = linkNode.getURL();\n\t\tconst title = link.length === 0 ? '(empty)' : `\"${normalize(link)}\"`;\n\t\tconst properties = printAllLinkNodeProperties(linkNode);\n\n\t\treturn [title, properties.length > 0 ? `{ ${properties} }` : null]\n\t\t\t.filter(Boolean)\n\t\t\t.join(' ')\n\t\t\t.trim();\n\t}\n\n\treturn '';\n}\n\nfunction normalize(text: string)\n{\n\treturn Object.entries(NON_SINGLE_WIDTH_CHARS_REPLACEMENT).reduce(\n\t\t(acc, [key, value]) => acc.replace(new RegExp(key, 'g'), String(value)),\n\t\ttext,\n\t);\n}\n\nfunction printAllTextNodeProperties(node: TextNode): string\n{\n\treturn [\n\t\tprintFormatProperties(node),\n\t\tprintDetailProperties(node),\n\t\tprintModeProperties(node),\n\t]\n\t\t.filter(Boolean)\n\t\t.join(', ');\n}\n\nfunction printAllLinkNodeProperties(node: LinkNode): string\n{\n\treturn [\n\t\tprintTargetProperties(node),\n\t\tprintRelProperties(node),\n\t\tprintTitleProperties(node),\n\t]\n\t\t.filter(Boolean)\n\t\t.join(', ');\n}\n\nfunction printTargetProperties(node: LinkNode): string\n{\n\tlet str = node.getTarget();\n\tif (!Type.isNil(str))\n\t{\n\t\tstr = `target: ${str}`;\n\t}\n\n\treturn str;\n}\n\nfunction printRelProperties(node: LinkNode): string\n{\n\tlet str = node.getRel();\n\tif (!Type.isNil(str))\n\t{\n\t\tstr = `rel: ${str}`;\n\t}\n\n\treturn str;\n}\n\nfunction printTitleProperties(node: LinkNode): string\n{\n\tlet str = node.getTitle();\n\tif (!Type.isNil(str))\n\t{\n\t\tstr = `title: ${str}`;\n\t}\n\n\treturn str;\n}\n\nfunction printDetailProperties(nodeOrSelection: TextNode): string\n{\n\tlet str = DETAIL_PREDICATES.map((predicate) => predicate(nodeOrSelection))\n\t\t.filter(Boolean)\n\t\t.join(', ')\n\t\t.toLocaleLowerCase();\n\n\tif (str !== '')\n\t{\n\t\tstr = `detail: ${str}`;\n\t}\n\n\treturn str;\n}\n\nfunction printModeProperties(nodeOrSelection: TextNode): string\n{\n\tlet str = MODE_PREDICATES.map((predicate) => predicate(nodeOrSelection))\n\t\t.filter(Boolean)\n\t\t.join(', ')\n\t\t.toLocaleLowerCase();\n\n\tif (str !== '')\n\t{\n\t\tstr = `mode: ${str}`;\n\t}\n\n\treturn str;\n}\n","import { $isNodeSelection } from 'ui.lexical.core';\nimport type { BaseSelection } from 'ui.lexical.core';\n\nexport function printNodeSelection(selection: BaseSelection): string\n{\n\tif (!$isNodeSelection(selection))\n\t{\n\t\treturn '';\n\t}\n\n\treturn `: node\\n  └ [${[...selection._nodes].join(', ')}]`;\n}\n","import { type RangeSelection } from 'ui.lexical.core';\nimport { printFormatProperties } from './print-format-properties';\n\nexport function printRangeSelection(selection: RangeSelection): string\n{\n\tlet res = '';\n\n\tconst formatText = printFormatProperties(selection);\n\n\tres += `: range ${formatText !== '' ? `{ ${formatText} }` : ''} ${\n\t\tselection.style !== '' ? `{ style: ${selection.style} } ` : ''\n\t}`;\n\n\tconst anchor = selection.anchor;\n\tconst focus = selection.focus;\n\tconst anchorOffset = anchor.offset;\n\tconst focusOffset = focus.offset;\n\n\tres += `\\n  ├ anchor { key: ${anchor.key}, offset: ${\n\t\tanchorOffset === null ? 'null' : anchorOffset\n\t}, type: ${anchor.type} }`;\n\tres += `\\n  └ focus { key: ${focus.key}, offset: ${\n\t\tfocusOffset === null ? 'null' : focusOffset\n\t}, type: ${focus.type} }`;\n\n\treturn res;\n}\n","import { type TableSelection } from 'ui.lexical.table';\n\nexport function printTableSelection(selection: TableSelection): string\n{\n\treturn `: table\\n  └ { table: ${selection.tableKey}, anchorCell: ${selection.anchor.key}, focusCell: ${selection.focus.key} }`;\n}\n","import {\n\t$isElementNode,\n\ttype ElementNode,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport { SYMBOLS } from './constants';\n\nexport function visitTree(\n\tcurrentNode: ElementNode,\n\tvisitor: (node: LexicalNode, indentArr: Array<string>) => void,\n\tindent: Array<string> = [],\n): void\n{\n\tconst childNodes = currentNode.getChildren();\n\tconst childNodesLength = childNodes.length;\n\n\tchildNodes.forEach((childNode, i) => {\n\t\tvisitor(\n\t\t\tchildNode,\n\t\t\tindent.concat(\n\t\t\t\ti === childNodesLength - 1\n\t\t\t\t\t? SYMBOLS.isLastChild\n\t\t\t\t\t: SYMBOLS.hasNextSibling,\n\t\t\t),\n\t\t);\n\n\t\tif ($isElementNode(childNode))\n\t\t{\n\t\t\tvisitTree(\n\t\t\t\tchildNode,\n\t\t\t\tvisitor,\n\t\t\t\tindent.concat(\n\t\t\t\t\ti === childNodesLength - 1\n\t\t\t\t\t\t? SYMBOLS.ancestorIsLastChild\n\t\t\t\t\t\t: SYMBOLS.ancestorHasNextSibling,\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\t});\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { $isElementNode } from 'ui.lexical.core';\nimport {\n\t$getRoot,\n\t$getSelection,\n\t$isNodeSelection,\n\t$isRangeSelection,\n\t$isTextNode,\n\ttype LexicalNode,\n\ttype BaseSelection,\n\ttype LexicalEditor,\n} from 'ui.lexical.core';\n\nimport { $isTableSelection } from 'ui.lexical.table';\nimport { NON_SINGLE_WIDTH_CHARS_REGEX, SYMBOLS } from './constants';\nimport { printNode } from './print-node';\nimport { printNodeSelection } from './print-node-selection';\nimport { printRangeSelection } from './print-range-selection';\nimport { printTableSelection } from './print-table-selection';\nimport { visitTree } from './visit-tree';\n\nimport { type TextEditor } from '../text-editor';\n\nexport function generateContent(editor: TextEditor | LexicalEditor): string\n{\n\tconst editorState = editor.getEditorState();\n\n\t// if (exportDOM)\n\t// {\n\t// \tlet htmlString = '';\n\t// \teditorState.read(() => {\n\t// \t\thtmlString = printPrettyHTML($generateHtmlFromNodes(editor));\n\t// \t});\n\t// \treturn htmlString;\n\t// }\n\n\tlet res = ' root\\n';\n\n\tconst selectionString = editorState.read(() => {\n\t\tconst selection = $getSelection();\n\t\tvisitTree($getRoot(), (node: LexicalNode, indent: Array<string>) => {\n\t\t\tconst nodeKey = node.getKey();\n\t\t\tconst nodeKeyDisplay = `(${nodeKey})`;\n\t\t\tconst typeDisplay = node.getType() || '';\n\t\t\tconst isSelected = node.isSelected();\n\n\t\t\tres += `${isSelected ? SYMBOLS.selectedLine : ' '} ${indent.join(\n\t\t\t\t' ',\n\t\t\t)} ${nodeKeyDisplay} ${typeDisplay} ${printNode(node)}\\n`;\n\n\t\t\tres += printSelectedCharsLine({\n\t\t\t\tindent,\n\t\t\t\tisSelected,\n\t\t\t\tnode,\n\t\t\t\tnodeKeyDisplay,\n\t\t\t\tselection,\n\t\t\t\ttypeDisplay,\n\t\t\t});\n\t\t});\n\n\t\tif (selection === null)\n\t\t{\n\t\t\treturn ': null';\n\t\t}\n\n\t\tif ($isRangeSelection(selection))\n\t\t{\n\t\t\treturn printRangeSelection(selection);\n\t\t}\n\n\t\tif ($isTableSelection(selection))\n\t\t{\n\t\t\treturn printTableSelection(selection);\n\t\t}\n\n\t\treturn printNodeSelection(selection);\n\t});\n\n\tres += `\\n selection${selectionString}`;\n\n\treturn res;\n}\n\nfunction printSelectedCharsLine({\n\tindent,\n\tisSelected,\n\tnode,\n\tnodeKeyDisplay,\n\tselection,\n\ttypeDisplay,\n}: {\n\tindent: Array<string>;\n\tisSelected: boolean;\n\tnode: LexicalNode;\n\tnodeKeyDisplay: string;\n\tselection: BaseSelection | null;\n\ttypeDisplay: string;\n}): string\n{\n\t// No selection or node is not selected.\n\tif (\n\t\t!$isTextNode(node)\n\t\t|| !$isRangeSelection(selection)\n\t\t|| !isSelected\n\t\t|| $isElementNode(node)\n\t)\n\t{\n\t\treturn '';\n\t}\n\n\t// No selected characters.\n\tconst anchor = selection.anchor;\n\tconst focus = selection.focus;\n\n\tif (\n\t\tnode.getTextContent() === ''\n\t\t|| (anchor.getNode() === selection.focus.getNode()\n\t\t\t&& anchor.offset === focus.offset)\n\t)\n\t{\n\t\treturn '';\n\t}\n\n\tconst [start, end] = $getSelectionStartEnd(node, selection);\n\n\tif (start === end)\n\t{\n\t\treturn '';\n\t}\n\n\tconst selectionLastIndent = (\n\t\tindent[indent.length - 1] === SYMBOLS.hasNextSibling\n\t\t\t? SYMBOLS.ancestorHasNextSibling\n\t\t\t: SYMBOLS.ancestorIsLastChild\n\t);\n\n\tconst indentionChars = [...indent.slice(0, -1), selectionLastIndent];\n\tconst unselectedChars = Array.from({ length: start + 1 }).fill(' ');\n\tconst selectedChars = Array.from({ length: end - start }).fill(SYMBOLS.selectedChar);\n\tconst paddingLength = typeDisplay.length + 3; // 2 for the spaces around + 1 for the double quote.\n\tconst nodePrintSpaces = Array.from({ length: nodeKeyDisplay.length + paddingLength }).fill(' ');\n\n\treturn (\n\t\t`${[\n\t\t\tSYMBOLS.selectedLine,\n\t\t\tindentionChars.join(' '),\n\t\t\t[...nodePrintSpaces, ...unselectedChars, ...selectedChars].join(''),\n\t\t].join(' ')}\\n`\n\t);\n}\n\nfunction $getSelectionStartEnd(node: LexicalNode, selection: BaseSelection): [number, number]\n{\n\tconst anchorAndFocus = selection.getStartEndPoints();\n\tif ($isNodeSelection(selection) || anchorAndFocus === null)\n\t{\n\t\treturn [-1, -1];\n\t}\n\n\tconst [anchor, focus] = anchorAndFocus;\n\tconst textContent = node.getTextContent();\n\tconst textLength = textContent.length;\n\n\tlet start = -1;\n\tlet end = -1;\n\n\t// Only one node is being selected.\n\tif (anchor.type === 'text' && focus.type === 'text')\n\t{\n\t\tconst anchorNode = anchor.getNode();\n\t\tconst focusNode = focus.getNode();\n\n\t\tif (\n\t\t\tanchorNode === focusNode\n\t\t\t&& node === anchorNode\n\t\t\t&& anchor.offset !== focus.offset\n\t\t)\n\t\t{\n\t\t\t[start, end] = (\n\t\t\t\tanchor.offset < focus.offset\n\t\t\t\t\t? [anchor.offset, focus.offset]\n\t\t\t\t\t: [focus.offset, anchor.offset]\n\t\t\t);\n\t\t}\n\t\telse if (node === anchorNode)\n\t\t{\n\t\t\t[start, end] = anchorNode.isBefore(focusNode)\n\t\t\t\t? [anchor.offset, textLength]\n\t\t\t\t: [0, anchor.offset];\n\t\t}\n\t\telse if (node === focusNode)\n\t\t{\n\t\t\t[start, end] = focusNode.isBefore(anchorNode)\n\t\t\t\t? [focus.offset, textLength]\n\t\t\t\t: [0, focus.offset];\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Node is within selection but not the anchor nor focus.\n\t\t\t[start, end] = [0, textLength];\n\t\t}\n\t}\n\n\t// Account for non-single width characters.\n\tconst numNonSingleWidthCharBeforeSelection = (\n\t\ttextContent.slice(0, start).match(NON_SINGLE_WIDTH_CHARS_REGEX) || []\n\t).length;\n\tconst numNonSingleWidthCharInSelection = (\n\t\ttextContent.slice(start, end).match(NON_SINGLE_WIDTH_CHARS_REGEX) || []\n\t).length;\n\n\treturn [\n\t\tstart + numNonSingleWidthCharBeforeSelection,\n\t\tend + numNonSingleWidthCharBeforeSelection + numNonSingleWidthCharInSelection,\n\t];\n}\n","export function createHashCode(s): number\n{\n\treturn [...s].reduce(\n\t\t(hash, c) => Math.trunc(Math.imul(31, hash) + c.codePointAt(0)),\n\t\t0,\n\t);\n}\n","import {\n\t$getRoot,\n\t$isDecoratorNode,\n\t$isElementNode,\n\t$isParagraphNode,\n\t$isTextNode,\n\ttype DecoratorNode,\n\ttype ElementNode,\n} from 'ui.lexical.core';\n\nexport function $isRootEmpty(trim: boolean = true): boolean\n{\n\tconst root = $getRoot();\n\tlet text = root.getTextContent();\n\tif (trim)\n\t{\n\t\ttext = text.trim();\n\t}\n\n\tif (text !== '')\n\t{\n\t\treturn false;\n\t}\n\n\tconst children = root.getChildren();\n\tconst childrenLength = children.length;\n\tif (childrenLength > 1)\n\t{\n\t\treturn false;\n\t}\n\n\tfor (let i = 0; i < childrenLength; i++)\n\t{\n\t\tconst topBlock: ElementNode | DecoratorNode = children[i];\n\t\tif ($isDecoratorNode(topBlock))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif ($isElementNode(topBlock))\n\t\t{\n\t\t\tif (!$isParagraphNode(topBlock))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (topBlock.__indent !== 0)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst topBlockChildren = topBlock.getChildren();\n\t\t\tconst topBlockChildrenLength = topBlockChildren.length;\n\n\t\t\tfor (let s = 0; s < topBlockChildrenLength; s++)\n\t\t\t{\n\t\t\t\tconst child = topBlockChildren[i];\n\t\t\t\tif (!$isTextNode(child))\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn true;\n}\n","export const defaultTheme = {\n\tblockCursor: 'ui-text-editor__block-cursor',\n\tindent: 'ui-text-editor__indent',\n\tltr: 'ui-text-editor__ltr',\n\trtl: 'ui-text-editor__rtl',\n\n\theading: {\n\t\th1: 'ui-typography-heading-h1',\n\t\th2: 'ui-typography-heading-h2',\n\t\th3: 'ui-typography-heading-h3',\n\t\th4: 'ui-typography-heading-h4',\n\t\th5: 'ui-typography-heading-h5',\n\t\th6: 'ui-typography-heading-h6',\n\t},\n\thashtag: 'ui-typography-hashtag',\n\tlink: 'ui-typography-link',\n\tlist: {\n\t\tlistitem: 'ui-typography-li',\n\t\tnested: {\n\t\t\tlist: '--nested',\n\t\t\tlistitem: 'ui-text-editor__nestedListItem --nested',\n\t\t},\n\t\tolDepth: [\n\t\t\t'ui-typography-ol ui-text-editor__ol1',\n\t\t\t'ui-typography-ol ui-text-editor__ol2',\n\t\t\t'ui-typography-ol ui-text-editor__ol3',\n\t\t\t'ui-typography-ol ui-text-editor__ol4',\n\t\t\t'ui-typography-ol ui-text-editor__ol5',\n\t\t],\n\t\tul: 'ui-typography-ul',\n\t},\n\tparagraph: 'ui-typography-paragraph ui-text-editor__paragraph',\n\ttext: {\n\t\tbold: 'ui-typography-text-bold',\n\t\tcode: 'ui-typography-text-code',\n\t\titalic: 'ui-typography-text-italic',\n\t\tstrikethrough: 'ui-typography-text-strikethrough',\n\t\tsubscript: 'ui-typography-text-subscript',\n\t\tsuperscript: 'ui-typography-text-superscript',\n\t\tunderline: 'ui-typography-text-underline',\n\t\tunderlineStrikethrough: 'ui-typography-text-underline-strikethrough',\n\t},\n\tmention: 'ui-typography-mention',\n\tquote: 'ui-typography-quote',\n\tspoiler: {\n\t\tcontainer: 'ui-typography-spoiler',\n\t\ttitle: 'ui-typography-spoiler-title ui-icon-set__scope',\n\t\tcontent: 'ui-typography-spoiler-content',\n\t},\n\tsmiley: 'ui-typography-smiley',\n\tcode: 'ui-typography-code',\n\tcodeHighlight: {\n\t\toperator: 'ui-typography-token-operator',\n\t\tpunctuation: 'ui-typography-token-punctuation',\n\t\tcomment: 'ui-typography-token-comment',\n\t\tword: 'ui-typography-token-word',\n\t\tkeyword: 'ui-typography-token-keyword',\n\t\tboolean: 'ui-typography-token-boolean',\n\t\tregex: 'ui-typography-token-regex',\n\t\tstring: 'ui-typography-token-string',\n\t\tnumber: 'ui-typography-token-number',\n\t\tsemicolon: 'ui-typography-token-semicolon',\n\t\tbracket: 'ui-typography-token-bracket',\n\t\tbrace: 'ui-typography-token-brace',\n\t\tparentheses: 'ui-typography-token-parentheses',\n\t},\n\n\ttable: 'ui-typography-table',\n\ttableRow: 'ui-typography-table-row',\n\ttableCell: 'ui-typography-table-cell',\n\ttableCellHeader: 'ui-typography-table-cell-header',\n\ttableSelection: 'ui-typography-table-selection',\n\n\timage: {\n\t\tcontainer: 'ui-typography-image-container ui-text-editor__image-container',\n\t\timg: 'ui-typography-image',\n\t},\n\n\tvideo: {\n\t\tcontainer: 'ui-typography-video-container ui-text-editor__video-container',\n\t\tobject: 'ui-typography-video-object ui-text-editor__video-object',\n\t},\n\n\tfile: 'ui-text-editor__file',\n};\n","import { Type } from 'main.core';\n\nimport { type TextEditor } from '../text-editor';\nimport type { PluginConstructor } from './base-plugin';\nimport BasePlugin from './base-plugin';\n\nexport default class PluginCollection\n{\n\t#pluginConstructors: Map<string, PluginConstructor> = new Map();\n\t#plugins: Map<string, BasePlugin> = new Map();\n\t#availablePlugins: Map<string, PluginConstructor> = new Map();\n\n\tconstructor(\n\t\tbuiltinPlugins: PluginConstructor[] = [],\n\t\tplugins: Array<string | PluginConstructor> = [],\n\t\tpluginsToRemove: Array<string | PluginConstructor> = [],\n\t)\n\t{\n\t\tfor (const pluginConstructor of builtinPlugins)\n\t\t{\n\t\t\tif (pluginConstructor.getName())\n\t\t\t{\n\t\t\t\tthis.#availablePlugins.set(pluginConstructor.getName(), pluginConstructor);\n\t\t\t}\n\t\t}\n\n\t\tfor (const plugin: string | PluginConstructor of plugins)\n\t\t{\n\t\t\tif (Type.isFunction(plugin) && plugin.getName() && !this.#availablePlugins.has(plugin.getName()))\n\t\t\t{\n\t\t\t\tthis.#availablePlugins.set(plugin.getName(), plugin);\n\t\t\t}\n\t\t}\n\n\t\tconst pluginsToLoad = plugins.filter((plugin: string | PluginConstructor) => {\n\t\t\tif (pluginsToRemove.includes(plugin))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (Type.isFunction(plugin) && pluginsToRemove.includes(plugin.getName()))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn !pluginsToRemove.includes(this.#availablePlugins.get(plugin));\n\t\t});\n\n\t\tpluginsToLoad\n\t\t\t.map((plugin: PluginConstructor | string) => {\n\t\t\t\treturn Type.isFunction(plugin) ? plugin : this.#availablePlugins.get(plugin);\n\t\t\t})\n\t\t\t.forEach((pluginConstructor: PluginConstructor) => {\n\t\t\t\tif (Type.isFunction(pluginConstructor))\n\t\t\t\t{\n\t\t\t\t\tthis.#pluginConstructors.set(pluginConstructor.getName(), pluginConstructor);\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\t}\n\n\tinit(textEditor: TextEditor): void\n\t{\n\t\tconst instances = [];\n\t\tfor (const [, PluginConstruct] of this.#pluginConstructors)\n\t\t{\n\t\t\tconst plugin = new PluginConstruct(textEditor);\n\t\t\tif (!(plugin instanceof BasePlugin))\n\t\t\t{\n\t\t\t\tthrow new TypeError('TextEditor: a plugin must be an instance of TextEditor.BasePlugin.');\n\t\t\t}\n\n\t\t\tthis.#plugins.set(PluginConstruct.getName(), plugin);\n\t\t\tinstances.push(plugin);\n\t\t}\n\n\t\tinstances.forEach((instance: BasePlugin) => {\n\t\t\tinstance.afterInit();\n\t\t});\n\t}\n\n\tgetConstructors(): PluginConstructor[]\n\t{\n\t\treturn [...this.#pluginConstructors.values()];\n\t}\n\n\tgetPlugins(): Map<string, BasePlugin>\n\t{\n\t\treturn this.#plugins;\n\t}\n\n\t[Symbol.iterator](): IterableIterator<[string, BasePlugin]>\n\t{\n\t\treturn this.#plugins[Symbol.iterator]();\n\t}\n\n\tget(key: PluginConstructor | string): BasePlugin | null\n\t{\n\t\tconst name: string = Type.isFunction(key) ? key.getName() : key;\n\n\t\treturn this.#plugins.get(name) || null;\n\t}\n\n\thas(key: PluginConstructor | string): boolean\n\t{\n\t\tconst name: string = Type.isFunction(key) ? key.getName() : key;\n\n\t\treturn this.#plugins.has(name);\n\t}\n}\n","type Component = {\n\tcallback: Function,\n};\n\nexport default class ComponentRegistry\n{\n\t#components: Map<string, Component> = new Map();\n\n\tregister(name: string, callback: () => {}): void\n\t{\n\t\tthis.#components.set(this.constructor.#normalizeName(name), { callback });\n\t}\n\n\tcreate(name): Object\n\t{\n\t\tconst component: Component = this.#components.get(this.constructor.#normalizeName(name));\n\n\t\treturn component ? component.callback() : null;\n\t}\n\n\tstatic #normalizeName(name: string): string\n\t{\n\t\treturn String(name).toLowerCase();\n\t}\n}\n","/* eslint-disable @bitrix24/bitrix24-rules/no-native-dom-methods */\n\nimport { Type } from 'main.core';\nimport { $createParagraphNode, $isElementNode, $isRootNode, $isTextNode } from 'ui.lexical.core';\nimport { type ElementNode, type LexicalNode } from 'ui.lexical.core';\nimport { type TextEditor } from './text-editor';\nimport { type SchemeNodeValidation, type SchemeValidationOptions } from './types/scheme-validation-options';\n\nexport default class SchemeValidation\n{\n\t#editor: TextEditor = null;\n\t#nodeTypeToBBCodeType: Map<string, string> = new Map();\n\t#nodeValidation: Map<string, Object> = new Map();\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tthis.#editor = editor;\n\n\t\tthis.#initNodeValidation();\n\t}\n\n\tisNodeAllowed(parent: LexicalNode | string, child: LexicalNode | string): boolean\n\t{\n\t\tconst parentCode = Type.isString(parent) ? parent : this.#nodeTypeToBBCodeType.get(parent.getType());\n\t\tconst childCode = Type.isString(child) ? child : this.#nodeTypeToBBCodeType.get(child.getType());\n\n\t\tif (!parentCode)\n\t\t{\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.warn(`TextEditor: parent node (${parent.getType()}) doesn't have a bbcode tag.`);\n\t\t}\n\n\t\tif (!childCode)\n\t\t{\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.warn(`TextEditor: child node (${child.getType()}) doesn't have a bbcode tag.`);\n\t\t}\n\n\t\treturn this.#editor.getBBCodeScheme().isChildAllowed(parentCode, childCode);\n\t}\n\n\tfindAllowedParent(node: LexicalNode): ElementNode | null\n\t{\n\t\tlet parent: ElementNode = node.getParent();\n\t\twhile (parent !== null)\n\t\t{\n\t\t\tif (this.isNodeAllowed(parent, node))\n\t\t\t{\n\t\t\t\treturn parent;\n\t\t\t}\n\n\t\t\tparent = parent.getParent();\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t#initNodeValidation(): void\n\t{\n\t\tconst handleNodeTransform = this.#handleNodeTransform.bind(this);\n\t\tfor (const [, plugin] of this.#editor.getPlugins())\n\t\t{\n\t\t\tconst validation: SchemeValidationOptions | null = plugin.validateScheme();\n\t\t\tif (!Type.isPlainObject(validation))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (Type.isArrayFilled(validation.nodes))\n\t\t\t{\n\t\t\t\tvalidation.nodes.forEach((nodeValidation: SchemeNodeValidation) => {\n\t\t\t\t\tthis.#editor.registerNodeTransform(nodeValidation.nodeClass, handleNodeTransform);\n\t\t\t\t\tif (Type.isFunction(nodeValidation.validate))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#nodeValidation.set(nodeValidation.nodeClass.getType(), { validate: nodeValidation.validate });\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (Type.isPlainObject(validation.bbcodeMap))\n\t\t\t{\n\t\t\t\tfor (const [nodeType, bbcodeTag] of Object.entries(validation.bbcodeMap))\n\t\t\t\t{\n\t\t\t\t\tthis.#nodeTypeToBBCodeType.set(nodeType, bbcodeTag);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t#handleNodeTransform(node: LexicalNode | ElementNode): void\n\t{\n\t\tconst { validate = null } = this.#nodeValidation.get(node.getType()) || {};\n\t\tif (validate !== null && validate(node, this) === true)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst parent: ElementNode = node.getParent();\n\t\tif (this.isNodeAllowed(parent, node))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\t// eslint-disable-next-line no-console\n\t\tconsole.warn(`TextEditor: ${node.getType()} is not allowed in ${parent.getType()}`);\n\n\t\tthis.moveToNextParent(node);\n\t}\n\n\tmoveToNextParent(node: LexicalNode | ElementNode, removeOnFail: boolean = true): boolean\n\t{\n\t\tlet parent: ElementNode = node.getParent();\n\t\tlet targetNode: ElementNode = null;\n\t\twhile (parent.getParent() !== null)\n\t\t{\n\t\t\tif (this.isNodeAllowed(parent.getParent(), node))\n\t\t\t{\n\t\t\t\ttargetNode = parent;\n\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tparent = parent.getParent();\n\t\t}\n\n\t\tif (targetNode === null)\n\t\t{\n\t\t\tif (removeOnFail)\n\t\t\t{\n\t\t\t\tnode.remove();\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\n\t\tif ($isRootNode(targetNode.getParent()) && ($isTextNode(node) || ($isElementNode(node) && node.isInline())))\n\t\t{\n\t\t\ttargetNode.insertBefore($createParagraphNode().append(node));\n\n\t\t\treturn true;\n\t\t}\n\n\t\ttargetNode.insertBefore(node);\n\n\t\treturn true;\n\t}\n}\n","import { registerRichText } from 'ui.lexical.rich-text';\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport class RichTextPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.cleanUpRegister(\n\t\t\tregisterRichText(editor.getLexicalEditor()),\n\t\t);\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'RichText';\n\t}\n}\n","import type { DOMConversion, DOMConversionMap, DOMConversionOutput, SerializedElementNode } from 'ui.lexical.core';\nimport { $createLineBreakNode, $createTextNode, ElementNode } from 'ui.lexical.core';\n\nexport class ClipboardPlainTableNode extends ElementNode\n{\n\tstatic getType(): string\n\t{\n\t\treturn 'plain-table-node';\n\t}\n\n\tstatic clone(node: ClipboardPlainTableNode): ClipboardPlainTableNode\n\t{\n\t\tthrow new Error('Not implemented');\n\t}\n\n\tstatic importJSON(serializedNode: SerializedElementNode): ClipboardPlainTableNode\n\t{\n\t\tthrow new Error('Not implemented');\n\t}\n\n\texportJSON(): SerializedElementNode\n\t{\n\t\tthrow new Error('Not implemented');\n\t}\n\n\tstatic importDOM(): DOMConversionMap | null\n\t{\n\t\treturn {\n\t\t\ttable: (): DOMConversion => {\n\t\t\t\treturn {\n\t\t\t\t\tconversion: convertTableToPlainText,\n\t\t\t\t\tpriority: 0,\n\t\t\t\t};\n\t\t\t},\n\t\t\ttr: (): DOMConversion => {\n\t\t\t\treturn {\n\t\t\t\t\tconversion: () => ({ node: null }),\n\t\t\t\t\tpriority: 0,\n\t\t\t\t};\n\t\t\t},\n\t\t\ttd: (): DOMConversion => {\n\t\t\t\treturn {\n\t\t\t\t\tconversion: () => ({ node: null }),\n\t\t\t\t\tpriority: 0,\n\t\t\t\t};\n\t\t\t},\n\t\t\tth: (): DOMConversion => {\n\t\t\t\treturn {\n\t\t\t\t\tconversion: () => ({ node: null }),\n\t\t\t\t\tpriority: 0,\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n}\n\nfunction convertTableToPlainText(table: HTMLTableElement): DOMConversionOutput\n{\n\tconst nodes = [];\n\tconst rows = [...table.rows];\n\tfor (const row of rows)\n\t{\n\t\tif (nodes.length > 0)\n\t\t{\n\t\t\tnodes.push($createLineBreakNode());\n\t\t}\n\n\t\tconst cells = [];\n\t\tfor (const cell of row.cells)\n\t\t{\n\t\t\tif (cells.length > 0)\n\t\t\t{\n\t\t\t\t// cells.push($createTabNode());\n\t\t\t\tcells.push($createTextNode(' '));\n\t\t\t}\n\n\t\t\tcells.push($createTextNode(cell.textContent.trim()));\n\t\t}\n\n\t\tnodes.push(...cells);\n\t}\n\n\treturn {\n\t\tnode: nodes,\n\t};\n}\n","import type { LexicalNode, LexicalNodeReplacement } from 'ui.lexical.core';\nimport type { TextEditor } from 'ui.text-editor';\nimport type { PluginConstructor } from '../base-plugin';\nimport BasePlugin from '../base-plugin';\nimport { ClipboardPlainTableNode } from './clipboard-plain-table-node';\n\nexport class ClipboardPlugin extends BasePlugin\n{\n\tstatic getName(): string\n\t{\n\t\treturn 'Clipboard';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode> | LexicalNodeReplacement>\n\t{\n\t\tconst nodes = [];\n\n\t\tconst tablePluginExists = editor.getPlugins().getConstructors().some(\n\t\t\t(plugin: PluginConstructor): boolean => {\n\t\t\t\treturn plugin.getName() === 'Table';\n\t\t\t},\n\t\t);\n\n\t\tif (!tablePluginExists)\n\t\t{\n\t\t\tnodes.push(ClipboardPlainTableNode);\n\t\t}\n\n\t\treturn nodes;\n\t}\n}\n","import { Loc, Browser } from 'main.core';\nimport { type TextNode } from 'ui.lexical.core';\n\nimport {\n\tFORMAT_TEXT_COMMAND,\n} from 'ui.lexical.core';\n\nimport Button from '../../toolbar/button';\nimport BasePlugin from '../base-plugin';\n\nimport {\n\tconvertTextFormatElement,\n\twrapNodeWith,\n\ttype BBCodeExportConversion,\n\ttype BBCodeConversion,\n\ttype BBCodeImportConversion,\n} from '../../bbcode';\n\nimport { type TextEditor } from '../../text-editor';\n\nexport class BoldPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Bold';\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tb: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tcolor: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tbackground: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tsize: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\t'text:bold': (lexicalNode: TextNode, node: Node): Node | null => {\n\t\t\t\tif (lexicalNode.hasFormat('bold'))\n\t\t\t\t{\n\t\t\t\t\treturn wrapNodeWith(node, 'b', this.getEditor());\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('bold', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --bold\"></span>');\n\t\t\tbutton.setFormat('bold');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_BOLD', { '#keystroke#': Browser.isMac() ? '⌘B' : 'Ctrl+B' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_TEXT_COMMAND, 'bold');\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","import { Browser, Loc } from 'main.core';\n\nimport {\n\twrapNodeWith,\n\tconvertTextFormatElement,\n\ttype BBCodeConversion,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n} from '../../bbcode';\n\nimport Button from '../../toolbar/button';\n\nimport {\n\tFORMAT_TEXT_COMMAND,\n\ttype TextNode,\n} from 'ui.lexical.core';\n\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport class ItalicPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Italic';\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\ti: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\t'text:italic': (lexicalNode: TextNode, node: Node): Node | null => {\n\t\t\t\tif (lexicalNode.hasFormat('italic'))\n\t\t\t\t{\n\t\t\t\t\treturn wrapNodeWith(node, 'i', this.getEditor());\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('italic', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --italic\"></span>');\n\t\t\tbutton.setFormat('italic');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_ITALIC', { '#keystroke#': Browser.isMac() ? '⌘I' : 'Ctrl+I' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_TEXT_COMMAND, 'italic');\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","import { Browser, Loc } from 'main.core';\n\nimport {\n\tconvertTextFormatElement,\n\twrapNodeWith,\n\ttype BBCodeConversion,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n} from '../../bbcode';\n\nimport Button from '../../toolbar/button';\n\nimport {\n\tCOMMAND_PRIORITY_NORMAL,\n\tFORMAT_TEXT_COMMAND,\n\tKEY_MODIFIER_COMMAND,\n\ttype TextNode,\n} from 'ui.lexical.core';\n\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport class StrikethroughPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerComponents();\n\t\tthis.#registerKeyModifierCommand();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Strikethrough';\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\ts: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tdel: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\t'text:strikethrough': (lexicalNode: TextNode, node: Node): Node | null => {\n\t\t\t\tif (lexicalNode.hasFormat('strikethrough'))\n\t\t\t\t{\n\t\t\t\t\treturn wrapNodeWith(node, 's', this.getEditor());\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerKeyModifierCommand(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_MODIFIER_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tconst event: KeyboardEvent = payload;\n\t\t\t\t\tconst { code, ctrlKey, metaKey, shiftKey } = event;\n\t\t\t\t\tif (code === 'KeyX' && (ctrlKey || metaKey) && shiftKey)\n\t\t\t\t\t{\n\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_TEXT_COMMAND, 'strikethrough');\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('strikethrough', () => {\n\t\t\tconst button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --strikethrough\"></span>');\n\t\t\tbutton.setFormat('strikethrough');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_STRIKETHROUGH', { '#keystroke#': Browser.isMac() ? '⌘⇧X' : 'Ctrl+Shift+X' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', () => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_TEXT_COMMAND, 'strikethrough');\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","import { Browser, Loc } from 'main.core';\n\nimport {\n\twrapNodeWith,\n\tconvertTextFormatElement,\n\ttype BBCodeConversion,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n} from '../../bbcode';\n\nimport Button from '../../toolbar/button';\n\nimport {\n\tFORMAT_TEXT_COMMAND,\n\ttype TextNode,\n} from 'ui.lexical.core';\n\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport class UnderlinePlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Underline';\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tu: (): BBCodeConversion => ({\n\t\t\t\tconversion: convertTextFormatElement,\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\t'text:underline': (lexicalNode: TextNode, node: Node): Node | null => {\n\t\t\t\tif (lexicalNode.hasFormat('underline'))\n\t\t\t\t{\n\t\t\t\t\treturn wrapNodeWith(node, 'u', this.getEditor());\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('underline', () => {\n\t\t\tconst button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --underline\"></span>');\n\t\t\tbutton.setFormat('underline');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_UNDERLINE', { '#keystroke#': Browser.isMac() ? '⌘U' : 'Ctrl+U' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', () => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(FORMAT_TEXT_COMMAND, 'underline');\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","import { Loc } from 'main.core';\n\nimport {\n\t$getSelection,\n\t$isRangeSelection,\n\t$isTextNode,\n\tcreateCommand,\n\tCOMMAND_PRIORITY_EDITOR,\n\ttype LexicalCommand,\n\ttype BaseSelection,\n\ttype TextNode,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport { $isTableSelection } from 'ui.lexical.table';\nimport { $getNearestBlockElementAncestorOrThrow } from 'ui.lexical.utils';\n\nimport Button from '../../toolbar/button';\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport const CLEAR_FORMATTING_COMMAND: LexicalCommand = createCommand('CLEAR_FORMATTING_COMMAND');\n\nexport class ClearFormatPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'ClearFormat';\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tCLEAR_FORMATTING_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tconst selection: BaseSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection) && !$isTableSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst anchor = selection.anchor;\n\t\t\t\t\tconst focus = selection.focus;\n\t\t\t\t\tconst nodes = selection.getNodes();\n\t\t\t\t\tconst extractedNodes = selection.extract();\n\n\t\t\t\t\tif (anchor.key === focus.key && anchor.offset === focus.offset)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tnodes.forEach((node: LexicalNode, idx) => {\n\t\t\t\t\t\t// We split the first and last node by the selection\n\t\t\t\t\t\t// So that we don't format unselected text inside those nodes\n\t\t\t\t\t\tif ($isTextNode(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// Use a separate variable to ensure TS does not lose the refinement\n\t\t\t\t\t\t\tlet textNode: TextNode = node;\n\t\t\t\t\t\t\tif (idx === 0 && anchor.offset !== 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttextNode = textNode.splitText(anchor.offset)[1] || textNode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (idx === nodes.length - 1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttextNode = textNode.splitText(focus.offset)[0] || textNode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t/**\n\t\t\t\t\t\t\t * If the selected text has one format applied\n\t\t\t\t\t\t\t * selecting a portion of the text, could\n\t\t\t\t\t\t\t * clear the format to the wrong portion of the text.\n\t\t\t\t\t\t\t *\n\t\t\t\t\t\t\t * The cleared text is based on the length of the selected text.\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\t// We need this in case the selected text only has one format\n\t\t\t\t\t\t\tconst extractedTextNode = extractedNodes[0];\n\t\t\t\t\t\t\tif (nodes.length === 1 && $isTextNode(extractedTextNode))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttextNode = extractedTextNode;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (textNode.__style !== '')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttextNode.setStyle('');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (textNode.__format !== 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttextNode.setFormat(0);\n\t\t\t\t\t\t\t\t$getNearestBlockElementAncestorOrThrow(textNode).setFormat('');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t/* else if ($isHeadingNode(node) || $isQuoteNode(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode.replace($createParagraphNode(), true);\n\t\t\t\t\t\t} */\n\t\t\t\t\t});\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('clear-format', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --remove-formatting\"></span>');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_CLEAR_FORMATTING'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(CLEAR_FORMATTING_COMMAND);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","import { Dom, Tag, Type, Loc } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\nimport { EventEmitter, type BaseEvent } from 'main.core.events';\nimport { Popup, PopupTargetOptions, PopupTarget } from 'main.popup';\n\nimport './link-editor.css';\n\nimport { sanitizeUrl } from '../../helpers/sanitize-url';\n\nexport type LinkEditorOptions = {\n\teditMode?: boolean,\n\tautoLinkMode?: boolean,\n\tlinkUrl?: string,\n\ttargetContainer?: HTMLElement,\n\tevents?: Object<string, (event: BaseEvent) => {}>,\n}\n\nexport class LinkEditor extends EventEmitter\n{\n\t#popup: Popup = null;\n\t#editMode: boolean = null;\n\t#autoLinkMode: boolean = null;\n\t#linkUrl: string = '';\n\t#targetContainer: HTMLElement = null;\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\n\tconstructor(options: LinkEditorOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.LinkEditor');\n\n\t\tconst linkEditorOptions: LinkEditorOptions = Type.isPlainObject(options) ? options : {};\n\n\t\tthis.setTargetContainer(linkEditorOptions.targetContainer);\n\t\tthis.setLinkUrl(linkEditorOptions.linkUrl);\n\n\t\tif (Type.isBoolean(linkEditorOptions.editMode))\n\t\t{\n\t\t\tthis.setEditMode(linkEditorOptions.editMode);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setEditMode(this.#linkUrl === '');\n\t\t}\n\n\t\tthis.setAutoLinkMode(options.autoLinkMode);\n\n\t\tthis.subscribeFromOptions(linkEditorOptions.events);\n\t}\n\n\tshow(options: { target: PopupTarget, targetOptions: PopupTargetOptions } = {}): void\n\t{\n\t\tconst target: PopupTarget = options.target ?? undefined;\n\t\tconst targetOptions: PopupTargetOptions = Type.isPlainObject(options.targetOptions) ? options.targetOptions : {};\n\n\t\tif (!Type.isUndefined(target))\n\t\t{\n\t\t\tthis.getPopup().setBindElement(target);\n\t\t}\n\n\t\tthis.getPopup().adjustPosition({\n\t\t\t...targetOptions,\n\t\t\tforceBindPosition: true,\n\t\t});\n\n\t\tthis.getPopup().show();\n\t}\n\n\tisShown(): boolean\n\t{\n\t\treturn this.#popup !== null && this.#popup.isShown();\n\t}\n\n\thide(): void\n\t{\n\t\tthis.getPopup().close();\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.getPopup().destroy();\n\t}\n\n\tsetAutoLinkMode(autoLinkMode: boolean = true): void\n\t{\n\t\tif (autoLinkMode === this.#autoLinkMode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (autoLinkMode)\n\t\t{\n\t\t\tDom.addClass(this.getContainer(), '--auto-link-mode');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.getContainer(), '--auto-link-mode');\n\t\t}\n\n\t\tif (this.#popup !== null)\n\t\t{\n\t\t\tthis.#popup.adjustPosition();\n\t\t}\n\n\t\tthis.#autoLinkMode = autoLinkMode;\n\t}\n\n\tsetEditMode(editMode: boolean = true): void\n\t{\n\t\tif (editMode === this.#editMode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (editMode)\n\t\t{\n\t\t\tDom.addClass(this.getContainer(), '--edit-mode');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.getContainer(), '--edit-mode');\n\t\t}\n\n\t\tif (this.#popup !== null)\n\t\t{\n\t\t\tthis.#popup.adjustPosition();\n\t\t}\n\n\t\tthis.#editMode = editMode;\n\t}\n\n\tsetLinkUrl(url: string): void\n\t{\n\t\tif (Type.isString(url))\n\t\t{\n\t\t\tthis.#linkUrl = sanitizeUrl(url);\n\n\t\t\tthis.getLinkTextBox().value = this.#linkUrl;\n\t\t\tthis.getLinkLabel().textContent = this.#linkUrl;\n\t\t\tthis.getLinkLabel().href = this.#linkUrl;\n\t\t}\n\t}\n\n\tgetLinkUrl(): string\n\t{\n\t\treturn this.#linkUrl;\n\t}\n\n\tsetTargetContainer(container: HTMLElement): void\n\t{\n\t\tif (Type.isElementNode(container))\n\t\t{\n\t\t\tthis.#targetContainer = container;\n\t\t}\n\t}\n\n\tgetTargetContainer(): HTMLElement | null\n\t{\n\t\treturn this.#targetContainer;\n\t}\n\n\tgetPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tautoHide: true,\n\t\t\t\tcacheable: false,\n\t\t\t\tpadding: 0,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\ttargetContainer: this.getTargetContainer(),\n\t\t\t\tcontent: this.getContainer(),\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.emit('onClose');\n\t\t\t\t\t},\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.emit('onDestroy');\n\t\t\t\t\t},\n\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\tthis.emit('onShow');\n\t\t\t\t\t},\n\t\t\t\t\tonAfterShow: () => {\n\t\t\t\t\t\tif (this.#editMode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.getLinkTextBox().focus();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-link-editor\">\n\t\t\t\t\t<div class=\"ui-text-editor-link-form\">\n\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-s ui-ctl-inline ui-ctl-w100 ui-text-editor-link-textbox\">\n\t\t\t\t\t\t\t<div class=\"ui-ctl-tag\">${Loc.getMessage('TEXT_EDITOR_LINK_URL')}</div>\n\t\t\t\t\t\t\t${this.getLinkTextBox()}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button type=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-link-form-button\" \n\t\t\t\t\t\t\tonclick=\"${this.#handleSaveBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"save-link-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --check\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button \n\t\t\t\t\t\t\ttype=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-link-form-button\"\n\t\t\t\t\t\t\tonclick=\"${this.#handleCancelBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"cancel-link-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --cross-60\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"ui-text-editor-link-preview\">\n\t\t\t\t\t\t${this.getLinkLabel()}\n\t\t\t\t\t\t<button \n\t\t\t\t\t\t\ttype=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-link-form-button\"\n\t\t\t\t\t\t\tonclick=\"${this.#handleEditBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"edit-link-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --pencil-60\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button \n\t\t\t\t\t\t\ttype=\"button\" \n\t\t\t\t\t\t\tclass=\"ui-text-editor-link-form-button ui-text-editor-link-form-delete-btn\"\n\t\t\t\t\t\t\tonclick=\"${this.#handleUnlinkBtnClick.bind(this)}\"\n\t\t\t\t\t\t\tdata-testid=\"unlink-btn\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class=\"ui-icon-set --delete-hyperlink\"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetLinkTextBox(): HTMLInputElement\n\t{\n\t\treturn this.#refs.remember('link-textbox', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<input \n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\tplaceholder=\"https://\"\n\t\t\t\t\tvalue=\"${this.getLinkUrl()}\"\n\t\t\t\t\tonkeydown=\"${this.#handleLinkTextBoxKeyDown.bind(this)}\"\n\t\t\t\t\tdata-testid=\"link-textbox-input\"\n\t\t\t\t>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetLinkLabel(): HTMLAnchorElement\n\t{\n\t\treturn this.#refs.remember('link-label', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<a href=\"\" target=\"_blank\" class=\"ui-text-editor-link-label\"></a>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#handleSaveBtnClick(): void\n\t{\n\t\tconst url: string = this.getLinkTextBox().value.trim();\n\t\tif (url.length > 0)\n\t\t{\n\t\t\tthis.setLinkUrl(url);\n\t\t\tthis.emit('onSave');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getLinkTextBox().focus();\n\t\t}\n\t}\n\n\t#handleLinkTextBoxKeyDown(event: KeyboardEvent)\n\t{\n\t\tif (event.key === 'Enter')\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t\tthis.#handleSaveBtnClick();\n\t\t}\n\t}\n\n\t#handleCancelBtnClick(): void\n\t{\n\t\tthis.emit('onCancel');\n\t}\n\n\t#handleEditBtnClick(): void\n\t{\n\t\tthis.setEditMode(true);\n\t\tthis.getLinkTextBox().focus();\n\t\tthis.getLinkTextBox().select();\n\t}\n\n\t#handleUnlinkBtnClick(): void\n\t{\n\t\tthis.emit('onUnlink');\n\t}\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { type JsonObject } from 'main.core';\nimport { $applyNodeReplacement, type EditorConfig, type NodeKey } from 'ui.lexical.core';\nimport { LinkNode, type LinkAttributes } from 'ui.lexical.link';\n\nexport class CustomLinkNode extends LinkNode\n{\n\tconstructor(url: string = '', attributes: LinkAttributes = {}, key: NodeKey = null)\n\t{\n\t\tsuper(url, attributes, key);\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'custom-link';\n\t}\n\n\tstatic clone(node: CustomLinkNode): CustomLinkNode\n\t{\n\t\treturn new CustomLinkNode(\n\t\t\tnode.__url,\n\t\t\t{\n\t\t\t\trel: node.__rel,\n\t\t\t\ttarget: node.__target,\n\t\t\t\ttitle: node.__title,\n\t\t\t},\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tstatic importJSON(serializedLinkNode): LinkNode\n\t{\n\t\treturn super.importJSON(serializedLinkNode);\n\t}\n\n\texportJSON(): JsonObject\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'custom-link',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst element = super.createDOM(config);\n\n\t\telement.setAttribute('data-slider-ignore-autobinding', 'true');\n\n\t\treturn element;\n\t}\n}\n\nexport function $createCustomLinkNode(url: string = '', attributes: LinkAttributes = {}): CustomLinkNode\n{\n\treturn $applyNodeReplacement(new CustomLinkNode(url, attributes));\n}\n","export function validateUrl(url: string, allowDomainRelativeUrl: boolean = true): boolean\n{\n\tif (allowDomainRelativeUrl)\n\t{\n\t\treturn /^(http:|https:|mailto:|tel:|sms:|\\/)/i.test(url);\n\t}\n\n\treturn /^(http:|https:|mailto:|tel:|sms:)/i.test(url);\n}\n\nexport const URL_REGEX = (\n\t/^((https?:\\/\\/(www\\.)?)|(www\\.))[\\w#%+.:=@~-]{1,256}\\.[\\d()A-Za-z]{1,6}\\b([\\w#%&()+./:=?@[\\]~-]*)(?<![%()+.:\\]-])$/\n);\n\nexport const EMAIL_REGEX = (\n\t/^(([^\\s\"(),.:;<>@[\\\\\\]]+(\\.[^\\s\"(),.:;<>@[\\\\\\]]+)*)|(\".+\"))@((\\[(?:\\d{1,3}\\.){3}\\d{1,3}])|(([\\dA-Za-z-]+\\.)+[A-Za-z]{2,}))$/\n);\n","/* eslint-disable no-underscore-dangle */\nimport { Browser, Event, Loc, Type, Validation } from 'main.core';\n\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\nimport type { BaseEvent } from 'main.core.events';\nimport type {\n\tBBCodeConversion,\n\tBBCodeConversionFn,\n\tBBCodeExportConversion,\n\tBBCodeExportOutput,\n\tBBCodeImportConversion,\n} from '../../bbcode';\n\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { UNFORMATTED } from '../../constants';\nimport { $adjustDialogPosition } from '../../helpers/adjust-dialog-position';\nimport { getSelectedNode } from '../../helpers/get-selected-node';\n\nimport Button from '../../toolbar/button';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\nimport { TextEditorLexicalNode } from '../../types/text-editor-lexical-node';\nimport BasePlugin from '../base-plugin';\nimport { LinkEditor } from './link-editor';\nimport { $createCustomLinkNode, CustomLinkNode } from './custom-link-node';\n\nimport { sanitizeUrl } from '../../helpers/sanitize-url';\nimport { EMAIL_REGEX, URL_REGEX, validateUrl } from '../../helpers/validate-url';\nimport { $restoreSelection } from '../../helpers/restore-selection';\n\nimport {\n\tCOMMAND_PRIORITY_LOW,\n\tCOMMAND_PRIORITY_NORMAL,\n\tPASTE_COMMAND,\n\tKEY_MODIFIER_COMMAND,\n\t$isTextNode,\n\t$isElementNode,\n\t$getSelection,\n\t$isRangeSelection,\n\t$insertNodes,\n\t$isRootOrShadowRoot,\n\t$createParagraphNode,\n\t$createTextNode,\n\t$getNodeByKey,\n\tcreateCommand,\n\ttype LexicalNode,\n\ttype RangeSelection,\n\ttype NodeKey,\n\ttype LexicalCommand,\n\ttype LexicalNodeReplacement,\n} from 'ui.lexical.core';\n\nimport { $wrapNodeInElement, $findMatchingParent, mergeRegister } from 'ui.lexical.utils';\n\nimport {\n\tLinkNode,\n\tTOGGLE_LINK_COMMAND,\n\t$toggleLink,\n\t$createLinkNode,\n\t$isLinkNode,\n\t$isAutoLinkNode,\n\ttype LinkAttributes,\n\ttype AutoLinkNode,\n} from 'ui.lexical.link';\n\nimport { type TextEditor } from '../../text-editor';\n\nexport const INSERT_LINK_DIALOG_COMMAND: LexicalCommand<string> = createCommand('INSERT_LINK_DIALOG_COMMAND');\n\nexport class LinkPlugin extends BasePlugin\n{\n\t#linkEditor: LinkEditor = null;\n\t#onEditorScroll: Function = this.#handleEditorScroll.bind(this);\n\t#lastSelection: RangeSelection = null;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerListeners();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Link';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode> | LexicalNodeReplacement>\n\t{\n\t\treturn [\n\t\t\tLinkNode,\n\t\t\tCustomLinkNode,\n\t\t\t{\n\t\t\t\treplace: LinkNode,\n\t\t\t\twith: (node: LinkNode) => {\n\t\t\t\t\treturn $createCustomLinkNode(\n\t\t\t\t\t\tnode.__url,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trel: node.__rel,\n\t\t\t\t\t\t\ttarget: node.__target,\n\t\t\t\t\t\t\ttitle: node.__title,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t\twithClass: CustomLinkNode,\n\t\t\t},\n\t\t];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\turl: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\t// [url]{url}[/url]\n\t\t\t\t\t// [url={url}]{text}[/url]\n\t\t\t\t\tlet url = node.getValue();\n\t\t\t\t\tif (!validateUrl(url))\n\t\t\t\t\t{\n\t\t\t\t\t\turl = node.toPlainText();\n\t\t\t\t\t\tif (!validateUrl(url))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn { node: null };\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createLinkNode(sanitizeUrl(url), { target: '_blank' }),\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tlink: (lexicalNode: LinkNode): BBCodeExportOutput => exportLinkNode(lexicalNode, this.getEditor()),\n\t\t\t'custom-link': (lexicalNode: LinkNode): BBCodeExportOutput => exportLinkNode(lexicalNode, this.getEditor()),\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: CustomLinkNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tlink: 'url',\n\t\t\t\t'custom-link': 'url',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerEventListener(LinkNode, 'click', (event: Event, nodeKey: NodeKey) => {\n\t\t\t\tconst linkNode: LinkNode = $getNodeByKey(nodeKey);\n\t\t\t\tif ($isLinkNode(linkNode))\n\t\t\t\t{\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_LINK_DIALOG_COMMAND, linkNode);\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.#registerToggleLinkCommand(),\n\t\t\tthis.#registerInsertLinkCommand(),\n\t\t\tthis.#registerKeyModifierCommand(),\n\t\t\tthis.#registerPasteCommand(),\n\t\t);\n\t}\n\n\t#registerToggleLinkCommand(): () => void\n\t{\n\t\treturn this.getEditor().registerCommand(\n\t\t\tTOGGLE_LINK_COMMAND,\n\t\t\t(payload): boolean => {\n\t\t\t\tif (payload === null)\n\t\t\t\t{\n\t\t\t\t\t$toggleLink(payload);\n\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tlet url = null;\n\t\t\t\tlet originalUrl = null;\n\n\t\t\t\tlet attributes = {};\n\t\t\t\tif (Type.isStringFilled(payload))\n\t\t\t\t{\n\t\t\t\t\turl = payload;\n\t\t\t\t}\n\t\t\t\telse if (Type.isPlainObject(payload))\n\t\t\t\t{\n\t\t\t\t\tconst { target, rel, title } = payload;\n\t\t\t\t\tattributes = { rel, target, title };\n\t\t\t\t\turl = payload.url;\n\t\t\t\t\toriginalUrl = payload.originalUrl || null;\n\t\t\t\t}\n\n\t\t\t\tif (Type.isStringFilled(url))\n\t\t\t\t{\n\t\t\t\t\tif (!Type.isStringFilled(attributes.target))\n\t\t\t\t\t{\n\t\t\t\t\t\tattributes.target = '_blank';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (validateUrl(url))\n\t\t\t\t\t{\n\t\t\t\t\t\tif (selection.isCollapsed() && !this.#isLinkSelected(selection))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#insertLink(selection, url, attributes, originalUrl);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$toggleLink(url, attributes);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t);\n\t}\n\n\t#registerInsertLinkCommand(): () => void\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_LINK_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection) || !this.getEditor().isEditable())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = selection.clone();\n\t\t\t\t\tif (this.#linkEditor !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#linkEditor.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\tlet lineNode = null;\n\t\t\t\t\tlet linkUrl = null;\n\n\t\t\t\t\tif ($isLinkNode(payload))\n\t\t\t\t\t{\n\t\t\t\t\t\tlineNode = payload;\n\t\t\t\t\t\tlinkUrl = lineNode.getURL();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tconst $isUnformatted = $findMatchingParent(\n\t\t\t\t\t\t\tselection.anchor.getNode(),\n\t\t\t\t\t\t\t(node: TextEditorLexicalNode) => {\n\t\t\t\t\t\t\t\treturn (node.__flags & UNFORMATTED) !== 0;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif ($isUnformatted)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst node = getSelectedNode(selection);\n\t\t\t\t\t\tconst linkParent = $findMatchingParent(node, $isLinkNode);\n\n\t\t\t\t\t\tif (linkParent)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlineNode = linkParent;\n\t\t\t\t\t\t\tlinkUrl = lineNode.getURL();\n\t\t\t\t\t\t\tlineNode.select();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if ($isLinkNode(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlineNode = node;\n\t\t\t\t\t\t\tlinkUrl = lineNode.getURL();\n\t\t\t\t\t\t\tlineNode.select();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND, { sender: 'link-dialog' });\n\n\t\t\t\t\tthis.#linkEditor = new LinkEditor({\n\t\t\t\t\t\tlinkUrl,\n\t\t\t\t\t\tautoLinkMode: $isAutoLinkNode(lineNode),\n\t\t\t\t\t\t// for an embedded popup: document.body -> this.getEditor().getScrollerContainer()\n\t\t\t\t\t\ttargetContainer: document.body,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tonSave: (event: BaseEvent) => {\n\t\t\t\t\t\t\t\tconst linkEditor: LinkEditor = event.getTarget();\n\t\t\t\t\t\t\t\tlet url = linkEditor.getLinkUrl();\n\t\t\t\t\t\t\t\tif (!Type.isStringFilled(url))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlinkEditor.hide();\n\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tconst protocol = Validation.isEmail(url) ? 'mailto:' : 'https://';\n\t\t\t\t\t\t\t\tconst originalUrl = url;\n\t\t\t\t\t\t\t\tif (!validateUrl(url))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\turl = `${protocol}${url}`;\n\t\t\t\t\t\t\t\t\tlinkEditor.setLinkUrl(url);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (lineNode === null)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\t\t\t\t\tthis.#restoreSelection();\n\n\t\t\t\t\t\t\t\t\t\tthis.getEditor().dispatchCommand(TOGGLE_LINK_COMMAND, { url, originalUrl, rel: null });\n\t\t\t\t\t\t\t\t\t\tlinkEditor.setEditMode(false);\n\n\t\t\t\t\t\t\t\t\t\tconst currentSelection: RangeSelection = $getSelection();\n\t\t\t\t\t\t\t\t\t\tif ($isRangeSelection(currentSelection))\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tthis.#lastSelection = currentSelection.clone();\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tif (!$isRangeSelection(currentSelection) || currentSelection.isCollapsed())\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tlinkEditor.hide();\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tthis.#convertAutoLinkToLink(currentSelection);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\t\t\t\t\tlineNode.setURL(url);\n\t\t\t\t\t\t\t\t\t\tthis.#convertAutoLinkToLink($getSelection());\n\t\t\t\t\t\t\t\t\t\tlinkEditor.setAutoLinkMode(false);\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\tlinkEditor.setEditMode(false);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.getEditor().resetHighlightSelection();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonCancel: (event: BaseEvent) => {\n\t\t\t\t\t\t\t\tconst linkEditor: LinkEditor = event.getTarget();\n\t\t\t\t\t\t\t\tlinkEditor.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonUnlink: (event: BaseEvent) => {\n\t\t\t\t\t\t\t\tif (lineNode === null)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.getEditor().dispatchCommand(TOGGLE_LINK_COMMAND, null);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\t\t\t\t\tconst children = lineNode.getChildren();\n\t\t\t\t\t\t\t\t\t\tfor (const child of children)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-dom-methods\n\t\t\t\t\t\t\t\t\t\t\tlineNode.insertBefore(child);\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tlineNode.remove();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tconst linkEditor: LinkEditor = event.getTarget();\n\t\t\t\t\t\t\t\tlinkEditor.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\t\t\tif ($adjustDialogPosition(this.#linkEditor.getPopup(), this.getEditor()))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tEvent.bind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\t\t\t\t\t\t\t\tthis.getEditor().highlightSelection();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\t\t\tthis.#handleDialogDestroy();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\t\t\tthis.#handleDialogDestroy();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.#linkEditor.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (payload?.sender === 'link-dialog')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = null;\n\n\t\t\t\t\tif (this.#linkEditor !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#linkEditor.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.#linkEditor !== null && this.#linkEditor.isShown();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#restoreSelection(): void\n\t{\n\t\t$restoreSelection(this.#lastSelection);\n\t\tthis.#lastSelection = null;\n\t}\n\n\t#handleDialogDestroy(): void\n\t{\n\t\tif (this.#linkEditor === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#linkEditor = null;\n\t\tEvent.unbind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\tthis.getEditor().resetHighlightSelection();\n\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\t\t\t// this.getEditor().focus();\n\t\t});\n\t}\n\n\t#handleEditorScroll(): void\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\t$adjustDialogPosition(this.#linkEditor.getPopup(), this.getEditor());\n\t\t});\n\t}\n\n\t#registerKeyModifierCommand(): () => void\n\t{\n\t\treturn this.getEditor().registerCommand(\n\t\t\tKEY_MODIFIER_COMMAND,\n\t\t\t(payload) => {\n\t\t\t\tconst event: KeyboardEvent = payload;\n\t\t\t\tconst { code, ctrlKey, metaKey } = event;\n\t\t\t\tif (code === 'KeyK' && (ctrlKey || metaKey))\n\t\t\t\t{\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_LINK_DIALOG_COMMAND);\n\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t);\n\t}\n\n\t#registerPasteCommand(): () => void\n\t{\n\t\treturn this.getEditor().registerCommand(\n\t\t\tPASTE_COMMAND,\n\t\t\t(event) => {\n\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\tif (\n\t\t\t\t\t!$isRangeSelection(selection)\n\t\t\t\t\t|| !(event instanceof ClipboardEvent)\n\t\t\t\t\t|| event.clipboardData === null\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tconst clipboardText = event.clipboardData.getData('text');\n\t\t\t\tif (!URL_REGEX.test(clipboardText))\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tconst url = clipboardText.startsWith('http') ? clipboardText : `https://${clipboardText}`;\n\t\t\t\tif (selection.isCollapsed())\n\t\t\t\t{\n\t\t\t\t\tconst success = this.getEditor().dispatchCommand(TOGGLE_LINK_COMMAND, { url });\n\t\t\t\t\tif (success)\n\t\t\t\t\t{\n\t\t\t\t\t\tevent.preventDefault();\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (!selection.getNodes().some((node) => $isElementNode(node)))\n\t\t\t\t{\n\t\t\t\t\t$toggleLink(url);\n\t\t\t\t\tevent.preventDefault();\n\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tCOMMAND_PRIORITY_NORMAL,\n\t\t);\n\t}\n\n\t#insertLink(selection: RangeSelection, url: string, attributes?: LinkAttributes, originalUrl?: string): void\n\t{\n\t\tconst linkUrl = sanitizeUrl(url);\n\t\tconst linkNode = $createLinkNode(linkUrl, attributes);\n\t\tlinkNode.append($createTextNode(Type.isStringFilled(originalUrl) ? originalUrl : linkUrl));\n\n\t\tconst anchor = selection.anchor;\n\t\tif (anchor.type === 'text' && anchor.getNode().isSimpleText())\n\t\t{\n\t\t\tconst anchorNode = anchor.getNode();\n\t\t\tconst selectionOffset = anchor.offset;\n\n\t\t\tconst splitNodes = anchorNode.splitText(selectionOffset);\n\t\t\tif (selectionOffset === 0)\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-dom-methods\n\t\t\t\tsplitNodes[0].insertBefore(linkNode);\n\t\t\t\tlinkNode.select();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsplitNodes[0].insertAfter(linkNode);\n\t\t\t\tlinkNode.select();\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$insertNodes([linkNode]);\n\t\t\tif ($isRootOrShadowRoot(linkNode.getParentOrThrow()))\n\t\t\t{\n\t\t\t\t$wrapNodeInElement(linkNode, $createParagraphNode).selectEnd();\n\t\t\t}\n\t\t}\n\t}\n\n\t#isLinkSelected(selection: RangeSelection): boolean\n\t{\n\t\tconst node = getSelectedNode(selection);\n\t\tconst parent = node.getParent();\n\n\t\treturn $isLinkNode(parent) || $isLinkNode(node);\n\t}\n\n\t#convertAutoLinkToLink(selection: RangeSelection): boolean\n\t{\n\t\tif ($isRangeSelection(selection))\n\t\t{\n\t\t\tconst parent: AutoLinkNode = getSelectedNode(selection).getParent();\n\t\t\tif ($isAutoLinkNode(parent))\n\t\t\t{\n\t\t\t\tconst linkNode = $createLinkNode(\n\t\t\t\t\tparent.getURL(),\n\t\t\t\t\t{\n\t\t\t\t\t\trel: parent.getRel(),\n\t\t\t\t\t\ttarget: Type.isStringFilled(parent.getTarget()) ? parent.getTarget() : '_blank',\n\t\t\t\t\t\ttitle: parent.getTitle(),\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\tparent.replace(linkNode, true);\n\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('link', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --link-3\"></span>');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_LINK'));\n\t\t\tbutton.setBlockType('link');\n\t\t\tbutton.disableInsideUnformatted();\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_LINK', { '#keystroke#': Browser.isMac() ? '⌘K' : 'Ctrl+K' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tif (this.#linkEditor !== null && this.#linkEditor.isShown())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.getEditor().focus(() => {\n\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_LINK_DIALOG_COMMAND);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#linkEditor !== null)\n\t\t{\n\t\t\tthis.#linkEditor.destroy();\n\t\t}\n\t}\n}\n\nexport function exportLinkNode(lexicalNode: LinkNode, editor: TextEditor): BBCodeExportOutput\n{\n\tconst url = lexicalNode.getURL();\n\tconst children = lexicalNode.getChildren();\n\tconst isSimpleText = (\n\t\tchildren.length === 1\n\t\t&& $isTextNode(children[0])\n\t\t&& children[0].getFormat() === 0\n\t);\n\n\tconst scheme = editor.getBBCodeScheme();\n\tif (isSimpleText && children[0].getTextContent() === url)\n\t{\n\t\treturn {\n\t\t\tnode: scheme.createElement({ name: 'url' }),\n\t\t};\n\t}\n\n\treturn {\n\t\tnode: scheme.createElement({ name: 'url', value: url }),\n\t};\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { type JsonObject } from 'main.core';\nimport { $applyNodeReplacement, type EditorConfig, type NodeKey } from 'ui.lexical.core';\nimport { AutoLinkNode, type LinkAttributes } from 'ui.lexical.link';\n\nexport class CustomAutoLinkNode extends AutoLinkNode\n{\n\tconstructor(url: string = '', attributes: LinkAttributes = {}, key: NodeKey = null)\n\t{\n\t\tsuper(url, attributes, key);\n\t}\n\n\tstatic getType(): string\n\t{\n\t\treturn 'custom-autolink';\n\t}\n\n\tstatic clone(node: CustomAutoLinkNode): CustomAutoLinkNode\n\t{\n\t\treturn new CustomAutoLinkNode(\n\t\t\tnode.__url,\n\t\t\t{\n\t\t\t\tisUnlinked: node.__isUnlinked,\n\t\t\t\trel: node.__rel,\n\t\t\t\ttarget: node.__target,\n\t\t\t\ttitle: node.__title,\n\t\t\t},\n\t\t\tnode.__key,\n\t\t);\n\t}\n\n\tstatic importJSON(serializedLinkNode): AutoLinkNode\n\t{\n\t\treturn super.importJSON(serializedLinkNode);\n\t}\n\n\texportJSON(): JsonObject\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'custom-autolink',\n\t\t\tversion: 1,\n\t\t};\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst element = super.createDOM(config);\n\n\t\telement.setAttribute('data-slider-ignore-autobinding', 'true');\n\n\t\treturn element;\n\t}\n}\n\nexport function $createCustomAutoLinkNode(url: string = '', attributes: LinkAttributes = {}): CustomAutoLinkNode\n{\n\treturn $applyNodeReplacement(new CustomAutoLinkNode(url, attributes));\n}\n","/* eslint-disable no-underscore-dangle */\n\nimport { Type } from 'main.core';\n\nimport {\n\tTextNode,\n\t$createTextNode,\n\t$isElementNode,\n\t$isLineBreakNode,\n\t$isTextNode,\n\ttype LexicalNode,\n\ttype ElementNode,\n} from 'ui.lexical.core';\n\nimport {\n\t$createAutoLinkNode,\n\t$isAutoLinkNode,\n\t$isLinkNode,\n\tAutoLinkNode,\n\ttype LinkAttributes, LinkNode,\n} from 'ui.lexical.link';\n\nimport { $findMatchingParent } from 'ui.lexical.utils';\n\nimport { UNFORMATTED } from '../../constants';\nimport { type TextEditorLexicalNode } from '../../types/text-editor-lexical-node';\nimport { exportLinkNode } from '../link';\nimport { $createCustomAutoLinkNode, CustomAutoLinkNode } from './custom-autolink-node';\n\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nimport type { BBCodeExportConversion, BBCodeExportOutput } from '../../bbcode';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nconst URL_REGEX = (\n\t/((https?:\\/\\/(www\\.)?)|(www\\.))[\\w#%+.:=@~-]{1,256}\\.[\\d()A-Za-z]{1,6}\\b([\\w#%&()+./:=?@[\\]~-]*)(?<![%()+.:\\]-])/\n);\n\nconst EMAIL_REGEX = (\n\t/(([^\\s\"(),.:;<>@[\\\\\\]]+(\\.[^\\s\"(),.:;<>@[\\\\\\]]+)*)|(\".+\"))@((\\[(?:\\d{1,3}\\.){3}\\d{1,3}])|(([\\dA-Za-z-]+\\.)+[A-Za-z]{2,}))/\n);\n\nconst MATCHERS = [\n\tcreateLinkMatcherWithRegExp(URL_REGEX, (text: string) => {\n\t\treturn text.startsWith('http') ? text : `https://${text}`;\n\t}),\n\tcreateLinkMatcherWithRegExp(EMAIL_REGEX, (text: string) => {\n\t\treturn `mailto:${text}`;\n\t}),\n];\n\ntype ChangeHandler = (url: string | null, prevUrl: string | null) => void;\n\ntype LinkMatcherResult = {\n\tattributes?: LinkAttributes;\n\tindex: number;\n\tlength: number;\n\ttext: string;\n\turl: string;\n};\n\nexport type LinkMatcher = (text: string) => LinkMatcherResult | null;\n\nexport class AutoLinkPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerListeners();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'AutoLink';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [\n\t\t\tAutoLinkNode,\n\t\t\tCustomAutoLinkNode,\n\t\t\t{\n\t\t\t\treplace: AutoLinkNode,\n\t\t\t\twith: (node: AutoLinkNode) => {\n\t\t\t\t\treturn $createCustomAutoLinkNode(\n\t\t\t\t\t\tnode.__url,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tisUnlinked: node.__isUnlinked,\n\t\t\t\t\t\t\trel: node.__rel,\n\t\t\t\t\t\t\ttarget: node.__target,\n\t\t\t\t\t\t\ttitle: node.__title,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t\twithClass: CustomAutoLinkNode,\n\t\t\t},\n\t\t];\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tautolink: (lexicalNode: LinkNode): BBCodeExportOutput => exportLinkNode(lexicalNode, this.getEditor()),\n\t\t\t'custom-autolink': (lexicalNode: LinkNode): BBCodeExportOutput => exportLinkNode(lexicalNode, this.getEditor()),\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: CustomAutoLinkNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tautolink: 'url',\n\t\t\t\t'custom-autolink': 'url',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tconst onChange = (url: string | null, prevUrl: string | null) => {};\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerNodeTransform(TextNode, (textNode: TextNode) => {\n\t\t\t\tconst parent = textNode.getParentOrThrow();\n\t\t\t\tconst previous = textNode.getPreviousSibling();\n\t\t\t\tif ($isAutoLinkNode(parent))\n\t\t\t\t{\n\t\t\t\t\thandleLinkEdit(parent, MATCHERS, onChange);\n\t\t\t\t}\n\t\t\t\telse if (!$isLinkNode(parent))\n\t\t\t\t{\n\t\t\t\t\tif (\n\t\t\t\t\t\ttextNode.isSimpleText()\n\t\t\t\t\t\t&& (startsWithSeparator(textNode.getTextContent()) || !$isAutoLinkNode(previous))\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst $isUnformatted = $findMatchingParent(\n\t\t\t\t\t\t\ttextNode,\n\t\t\t\t\t\t\t(parentNode: TextEditorLexicalNode) => {\n\t\t\t\t\t\t\t\treturn (parentNode.__flags & UNFORMATTED) !== 0;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (!$isUnformatted)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thandleLinkCreation(textNode, MATCHERS, onChange);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\thandleBadNeighbors(textNode, MATCHERS, onChange);\n\t\t\t\t}\n\t\t\t}),\n\t\t);\n\t}\n}\n\nfunction createLinkMatcherWithRegExp(\n\tregExp: RegExp,\n\turlTransformer: (text: string) => string = (text) => text,\n): LinkMatcherResult\n{\n\treturn (text: string) => {\n\t\tconst match = regExp.exec(text);\n\t\tif (match === null)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tindex: match.index,\n\t\t\tlength: match[0].length,\n\t\t\ttext: match[0],\n\t\t\turl: urlTransformer(text),\n\t\t};\n\t};\n}\n\nfunction findFirstMatch(text: string, matchers: Array<LinkMatcher>): LinkMatcherResult | null\n{\n\tfor (const matcher of matchers)\n\t{\n\t\tconst match = matcher(text);\n\t\tif (match)\n\t\t{\n\t\t\treturn match;\n\t\t}\n\t}\n\n\treturn null;\n}\n\nconst PUNCTUATION_OR_SPACE = /[\\s(),.;[\\]]/;\n\nfunction isSeparator(char: string): boolean\n{\n\treturn PUNCTUATION_OR_SPACE.test(char);\n}\n\nfunction endsWithSeparator(textContent: string): boolean\n{\n\treturn isSeparator(textContent[textContent.length - 1]);\n}\n\nfunction startsWithSeparator(textContent: string): boolean\n{\n\treturn isSeparator(textContent[0]);\n}\n\nfunction startsWithFullStop(textContent: string): boolean\n{\n\treturn /^\\.[\\dA-Za-z]+/.test(textContent);\n}\n\nfunction isPreviousNodeValid(node: LexicalNode): boolean\n{\n\tlet previousNode = node.getPreviousSibling();\n\tif ($isElementNode(previousNode))\n\t{\n\t\tpreviousNode = previousNode.getLastDescendant();\n\t}\n\n\treturn (\n\t\tpreviousNode === null\n\t\t|| $isLineBreakNode(previousNode)\n\t\t|| ($isTextNode(previousNode) && endsWithSeparator(previousNode.getTextContent()))\n\t);\n}\n\nfunction isNextNodeValid(node: LexicalNode): boolean\n{\n\tlet nextNode = node.getNextSibling();\n\tif ($isElementNode(nextNode))\n\t{\n\t\tnextNode = nextNode.getFirstDescendant();\n\t}\n\n\treturn (\n\t\tnextNode === null\n\t\t|| $isLineBreakNode(nextNode)\n\t\t|| ($isTextNode(nextNode) && startsWithSeparator(nextNode.getTextContent()))\n\t);\n}\n\nfunction isContentAroundIsValid(matchStart: number, matchEnd: number, text: string, node: TextNode): boolean\n{\n\tconst contentBeforeIsValid = matchStart > 0 ? isSeparator(text[matchStart - 1]) : isPreviousNodeValid(node);\n\tif (!contentBeforeIsValid)\n\t{\n\t\treturn false;\n\t}\n\n\t// contentAfterIsValid\n\treturn matchEnd < text.length ? isSeparator(text[matchEnd]) : isNextNodeValid(node);\n}\n\nfunction handleLinkCreation(node: TextNode, matchers: Array<LinkMatcher>, onChange: ChangeHandler): void\n{\n\tconst nodeText = node.getTextContent();\n\tlet text = nodeText;\n\tlet invalidMatchEnd = 0;\n\tlet remainingTextNode = node;\n\tlet match: LinkMatcherResult | null = findFirstMatch(text, matchers);\n\twhile (match !== null)\n\t{\n\t\tconst matchStart = match.index;\n\t\tconst matchLength = match.length;\n\t\tconst matchEnd = matchStart + matchLength;\n\t\tconst isValid = isContentAroundIsValid(\n\t\t\tinvalidMatchEnd + matchStart,\n\t\t\tinvalidMatchEnd + matchEnd,\n\t\t\tnodeText,\n\t\t\tnode,\n\t\t);\n\n\t\tif (isValid)\n\t\t{\n\t\t\tlet linkTextNode = null;\n\t\t\tif (invalidMatchEnd + matchStart === 0)\n\t\t\t{\n\t\t\t\t[linkTextNode, remainingTextNode] = remainingTextNode.splitText(\n\t\t\t\t\tinvalidMatchEnd + matchLength,\n\t\t\t\t);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t[, linkTextNode, remainingTextNode] = remainingTextNode.splitText(\n\t\t\t\t\tinvalidMatchEnd + matchStart,\n\t\t\t\t\tinvalidMatchEnd + matchStart + matchLength,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst attributes = Type.isPlainObject(match.attributes) ? { ...match.attributes } : {};\n\t\t\tif (!Type.isStringFilled(attributes.target))\n\t\t\t{\n\t\t\t\tattributes.target = '_blank';\n\t\t\t}\n\n\t\t\tconst linkNode = $createAutoLinkNode(match.url, attributes);\n\t\t\tconst textNode = $createTextNode(match.text);\n\t\t\ttextNode.setFormat(linkTextNode.getFormat());\n\t\t\ttextNode.setDetail(linkTextNode.getDetail());\n\t\t\tlinkNode.append(textNode);\n\t\t\tlinkTextNode.replace(linkNode);\n\t\t\tonChange(match.url, null);\n\t\t\tinvalidMatchEnd = 0;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tinvalidMatchEnd += matchEnd;\n\t\t}\n\n\t\ttext = text.slice(Math.max(0, matchEnd));\n\t\tmatch = findFirstMatch(text, matchers);\n\t}\n}\n\nfunction handleLinkEdit(linkNode: AutoLinkNode, matchers: Array<LinkMatcher>, onChange: ChangeHandler): void\n{\n\t// Check children are simple text\n\tconst children = linkNode.getChildren();\n\tconst childrenLength = children.length;\n\tfor (let i = 0; i < childrenLength; i++)\n\t{\n\t\tconst child = children[i];\n\t\tif (!$isTextNode(child) || !child.isSimpleText())\n\t\t{\n\t\t\treplaceWithChildren(linkNode);\n\t\t\tonChange(null, linkNode.getURL());\n\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check text content fully matches\n\tconst text = linkNode.getTextContent();\n\tconst match = findFirstMatch(text, matchers);\n\tif (match === null || match.text !== text)\n\t{\n\t\treplaceWithChildren(linkNode);\n\t\tonChange(null, linkNode.getURL());\n\n\t\treturn;\n\t}\n\n\t// Check neighbors\n\tif (!isPreviousNodeValid(linkNode) || !isNextNodeValid(linkNode))\n\t{\n\t\treplaceWithChildren(linkNode);\n\t\tonChange(null, linkNode.getURL());\n\n\t\treturn;\n\t}\n\n\tconst url = linkNode.getURL();\n\tif (url !== match.url)\n\t{\n\t\tlinkNode.setURL(match.url);\n\t\tonChange(match.url, url);\n\t}\n\n\tif (match.attributes)\n\t{\n\t\tconst rel = linkNode.getRel();\n\t\tif (rel !== match.attributes.rel)\n\t\t{\n\t\t\tlinkNode.setRel(match.attributes.rel || null);\n\t\t\tonChange(match.attributes.rel || null, rel);\n\t\t}\n\n\t\tconst target = linkNode.getTarget();\n\t\tif (target !== match.attributes.target)\n\t\t{\n\t\t\tlinkNode.setTarget(match.attributes.target || null);\n\t\t\tonChange(match.attributes.target || null, target);\n\t\t}\n\t}\n}\n\n// Bad neighbours are edits in neighbor nodes that make AutoLinks incompatible.\n// Given the creation preconditions, these can only be simple text nodes.\nfunction handleBadNeighbors(textNode: TextNode, matchers: Array<LinkMatcher>, onChange: ChangeHandler): void\n{\n\tconst previousSibling = textNode.getPreviousSibling();\n\tconst nextSibling = textNode.getNextSibling();\n\tconst text = textNode.getTextContent();\n\n\tif ($isAutoLinkNode(previousSibling) && (!startsWithSeparator(text) || startsWithFullStop(text)))\n\t{\n\t\tpreviousSibling.append(textNode);\n\t\thandleLinkEdit(previousSibling, matchers, onChange);\n\t\tonChange(null, previousSibling.getURL());\n\t}\n\n\tif ($isAutoLinkNode(nextSibling) && !endsWithSeparator(text))\n\t{\n\t\treplaceWithChildren(nextSibling);\n\t\thandleLinkEdit(nextSibling, matchers, onChange);\n\t\tonChange(null, nextSibling.getURL());\n\t}\n}\n\nfunction replaceWithChildren(node: ElementNode): Array<LexicalNode>\n{\n\tconst children = node.getChildren();\n\tconst childrenLength = children.length;\n\n\tfor (let j = childrenLength - 1; j >= 0; j--)\n\t{\n\t\tnode.insertAfter(children[j]);\n\t}\n\n\tnode.remove();\n\n\treturn children.map((child) => child.getLatest());\n}\n","import {\n\tKEY_TAB_COMMAND,\n\tINDENT_CONTENT_COMMAND,\n\tOUTDENT_CONTENT_COMMAND,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\t$getSelection,\n\t$isElementNode,\n\t$isRangeSelection,\n\ttype RangeSelection,\n\ttype ElementNode,\n} from 'ui.lexical.core';\n\nimport { $findMatchingParent } from 'ui.lexical.utils';\nimport { $isListItemNode } from 'ui.lexical.list';\n\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport class TabIndentPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerListeners();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'TabIndent';\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tKEY_TAB_COMMAND,\n\t\t\t\t(event): boolean => {\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tif (!$isRangeSelection(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.getEditor().dispatchCommand(\n\t\t\t\t\t\tevent.shiftKey ? OUTDENT_CONTENT_COMMAND : INDENT_CONTENT_COMMAND,\n\t\t\t\t\t\t{ event, triggerByTab: true },\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\n\t\t\t// Turn off RichText built-in indents\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINDENT_CONTENT_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tconst selection = $getSelection();\n\t\t\t\t\tif ($isSelectionInList(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\tpayload?.event.preventDefault();\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tOUTDENT_CONTENT_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tconst selection = $getSelection();\n\t\t\t\t\tif ($isSelectionInList(selection))\n\t\t\t\t\t{\n\t\t\t\t\t\tpayload?.event.preventDefault();\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n}\n\nfunction $isSelectionInList(selection: null | RangeSelection): boolean\n{\n\tif (!$isRangeSelection(selection))\n\t{\n\t\treturn false;\n\t}\n\n\tconst isBackward: boolean = selection.isBackward();\n\tconst firstPoint = isBackward ? selection.focus : selection.anchor;\n\tconst firstNode = firstPoint.getNode();\n\n\tif ($isListItemNode(firstNode))\n\t{\n\t\treturn true;\n\t}\n\n\tconst parentNode = $findMatchingParent(\n\t\tfirstNode,\n\t\t(node: ElementNode) => $isElementNode(node) && !node.isInline(),\n\t);\n\n\treturn $isListItemNode(parentNode);\n}\n","import { Loc } from 'main.core';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\nimport { $findMatchingParent } from 'ui.lexical.utils';\n\nimport Button from '../../toolbar/button';\nimport BasePlugin from '../base-plugin';\n\nimport {\n\tCOMMAND_PRIORITY_LOW,\n\tINSERT_PARAGRAPH_COMMAND,\n\tINDENT_CONTENT_COMMAND,\n\tCOMMAND_PRIORITY_CRITICAL,\n\t$getSelection,\n\t$isRangeSelection,\n\t$isElementNode,\n\ttype RangeSelection,\n\ttype ElementNode,\n\ttype LexicalNode,\n} from 'ui.lexical.core';\n\nimport {\n\tINSERT_ORDERED_LIST_COMMAND,\n\tINSERT_UNORDERED_LIST_COMMAND,\n\tREMOVE_LIST_COMMAND,\n\tinsertList,\n\tremoveList,\n\t$handleListInsertParagraph,\n\t$isListItemNode,\n\t$isListNode,\n\t$getListDepth,\n\t$createListItemNode,\n\t$createListNode,\n\tListNode,\n\tListItemNode,\n} from 'ui.lexical.list';\n\nimport { type TextEditor } from '../../text-editor';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\nimport type {\n\tBBCodeConversion,\n\tBBCodeImportConversion,\n\tBBCodeConversionFn,\n\tBBCodeExportOutput,\n\tBBCodeExportConversion,\n} from '../../bbcode';\n\nexport class ListPlugin extends BasePlugin\n{\n\t#maxIndent: number = 5;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#maxIndent = editor.getOption('list.maxIndent', this.#maxIndent);\n\t\tthis.#registerListeners();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'List';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [ListNode, ListItemNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\tlist: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: node.getValue() === '1' ? $createListNode('number', 1) : $createListNode('bullet'),\n\t\t\t\t\t\t// after: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t\t\t\t\t// \tconst normalizedListItems: Array<ListItemNode> = [];\n\t\t\t\t\t\t// \tfor (const node of childLexicalNodes)\n\t\t\t\t\t\t// \t{\n\t\t\t\t\t\t// \t\tif ($isListItemNode(node))\n\t\t\t\t\t\t// \t\t{\n\t\t\t\t\t\t// \t\t\tnormalizedListItems.push(node);\n\t\t\t\t\t\t// \t\t\tconst children = node.getChildren();\n\t\t\t\t\t\t// \t\t\tif (children.length > 1)\n\t\t\t\t\t\t// \t\t\t{\n\t\t\t\t\t\t// \t\t\t\tchildren.forEach((child) => {\n\t\t\t\t\t\t// \t\t\t\t\tif ($isListNode(child))\n\t\t\t\t\t\t// \t\t\t\t\t{\n\t\t\t\t\t\t// \t\t\t\t\t\tnormalizedListItems.push(this.#wrapInListItem(child));\n\t\t\t\t\t\t// \t\t\t\t\t}\n\t\t\t\t\t\t// \t\t\t\t});\n\t\t\t\t\t\t// \t\t\t}\n\t\t\t\t\t\t// \t\t}\n\t\t\t\t\t\t// \t\telse\n\t\t\t\t\t\t// \t\t{\n\t\t\t\t\t\t// \t\t\tnormalizedListItems.push(this.#wrapInListItem(node));\n\t\t\t\t\t\t// \t\t}\n\t\t\t\t\t\t// \t}\n\t\t\t\t\t\t//\n\t\t\t\t\t\t// \treturn normalizedListItems;\n\t\t\t\t\t\t// },\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\t'*': (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createListItemNode(),\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\tlist: (lexicalNode: ListNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\t\t\t\tconst node = scheme.createElement({ name: 'list' });\n\t\t\t\tif (lexicalNode.getListType() === 'number')\n\t\t\t\t{\n\t\t\t\t\tnode.setValue('1');\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tnode,\n\t\t\t\t};\n\t\t\t},\n\t\t\tlistitem: (lexicalNode: LexicalNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: '*' }),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [{\n\t\t\t\tnodeClass: ListNode,\n\t\t\t}],\n\t\t\tbbcodeMap: {\n\t\t\t\tlist: 'list',\n\t\t\t\tlistitem: '*',\n\t\t\t},\n\t\t};\n\t}\n\n\t// static #wrapInListItem(node: LexicalNode): ListItemNode\n\t// {\n\t// \tconst listItemWrapper = $createListItemNode();\n\t//\n\t// \treturn listItemWrapper.append(node);\n\t// }\n\n\t#registerListeners(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_ORDERED_LIST_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tinsertList(this.getLexicalEditor(), 'number');\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_UNORDERED_LIST_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tinsertList(this.getLexicalEditor(), 'bullet');\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tREMOVE_LIST_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tremoveList(this.getLexicalEditor());\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_PARAGRAPH_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn $handleListInsertParagraph();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINDENT_CONTENT_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tconst totalDepth = this.#getTotalListDepth();\n\t\t\t\t\tif (totalDepth > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tpayload?.event.preventDefault();\n\n\t\t\t\t\t\treturn totalDepth > this.#maxIndent;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('bulleted-list', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --bulleted-list\"></span>');\n\t\t\tbutton.setBlockType('bullet');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_BULLETED_LIST'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tif (button.isActive())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(REMOVE_LIST_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_UNORDERED_LIST_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\n\t\tthis.getEditor().getComponentRegistry().register('numbered-list', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --numbered-list\"></span>');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_NUMBERED_LIST'));\n\t\t\tbutton.setBlockType('number');\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\t\t\t\tthis.getEditor().update((): void => {\n\t\t\t\t\tif (button.isActive())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(REMOVE_LIST_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_ORDERED_LIST_COMMAND);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\t#getTotalListDepth(): number\n\t{\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif (!$isRangeSelection(selection))\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst elementNodesInSelection: Set<ElementNode> = this.#getElementNodesInSelection(selection);\n\t\tlet totalDepth = 0;\n\t\tfor (const elementNode of elementNodesInSelection)\n\t\t{\n\t\t\tif ($isListNode(elementNode))\n\t\t\t{\n\t\t\t\ttotalDepth = Math.max($getListDepth(elementNode) + 1, totalDepth);\n\t\t\t}\n\t\t\telse if ($isListItemNode(elementNode))\n\t\t\t{\n\t\t\t\tconst parent = elementNode.getParent();\n\t\t\t\tif (!$isListNode(parent))\n\t\t\t\t{\n\t\t\t\t\tthrow new Error('TextEditor: A ListItemNode must have a ListNode for a parent.');\n\t\t\t\t}\n\n\t\t\t\ttotalDepth = Math.max($getListDepth(parent) + 1, totalDepth);\n\t\t\t}\n\t\t}\n\n\t\treturn totalDepth;\n\t}\n\n\t#getElementNodesInSelection(selection: RangeSelection): Set<ElementNode>\n\t{\n\t\tconst nodesInSelection = selection.getNodes();\n\t\tconst predicate = (node: ElementNode) => $isElementNode(node) && !node.isInline();\n\n\t\tif (nodesInSelection.length === 0)\n\t\t{\n\t\t\treturn new Set([\n\t\t\t\t$findMatchingParent(selection.anchor.getNode(), predicate),\n\t\t\t\t$findMatchingParent(selection.focus.getNode(), predicate),\n\t\t\t]);\n\t\t}\n\n\t\treturn new Set(\n\t\t\tnodesInSelection.map((n) => ($isElementNode(n) ? n : $findMatchingParent(n, predicate))),\n\t\t);\n\t}\n}\n","import { Dom, Tag, Type } from 'main.core';\nimport { type BaseCache, MemoryCache } from 'main.core.cache';\nimport { type BaseEvent, EventEmitter } from 'main.core.events';\nimport { Popup } from 'main.popup';\nimport './table-dialog.css';\n\nexport type TableDialogOptions = {\n\ttargetNode?: HTMLElement,\n\tevents?: Object<string, (event: BaseEvent) => {}>,\n}\n\nexport default class TableDialog extends EventEmitter\n{\n\t#popup: Popup = null;\n\t#targetNode: HTMLElement = null;\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\t#lastSelectedBox: HTMLElement = null;\n\n\tconstructor(dialogOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.TableDialog');\n\n\t\tconst options: TableDialogOptions = Type.isPlainObject(dialogOptions) ? dialogOptions : {};\n\n\t\tthis.setTargetNode(options.targetNode);\n\t\tthis.subscribeFromOptions(options.events);\n\t}\n\n\tshow(): void\n\t{\n\t\tthis.getPopup().adjustPosition({ forceBindPosition: true });\n\t\tthis.getPopup().show();\n\t}\n\n\thide(): void\n\t{\n\t\tthis.getPopup().close();\n\t}\n\n\tisShown(): boolean\n\t{\n\t\treturn this.#popup !== null && this.#popup.isShown();\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.getPopup().destroy();\n\t}\n\n\tsetTargetNode(container: HTMLElement): void\n\t{\n\t\tif (Type.isElementNode(container))\n\t\t{\n\t\t\tthis.#targetNode = container;\n\t\t}\n\t}\n\n\tgetTargetNode(): HTMLElement | null\n\t{\n\t\treturn this.#targetNode;\n\t}\n\n\tgetPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tconst targetNode = this.getTargetNode();\n\t\t\tconst rect = targetNode.getBoundingClientRect();\n\t\t\tconst targetNodeWidth = rect.width;\n\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tautoHide: true,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tpadding: 0,\n\t\t\t\tcontent: Tag.render`\n\t\t\t\t\t<div class=\"ui-text-editor-table-dialog\" onclick=\"${this.#handleClick.bind(this)}\">\n\t\t\t\t\t\t${this.getGridContainer()}\n\t\t\t\t\t\t${this.getCaptionContainer()}\n\t\t\t\t\t</div>\n\t\t\t\t`,\n\t\t\t\tbindElement: this.getTargetNode(),\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.emit('onClose');\n\t\t\t\t\t},\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.emit('onDestroy');\n\t\t\t\t\t},\n\t\t\t\t\tonShow: (event) => {\n\t\t\t\t\t\tconst popup = event.getTarget();\n\t\t\t\t\t\tconst popupWidth = popup.getPopupContainer().offsetWidth;\n\t\t\t\t\t\tconst offsetLeft = (targetNodeWidth / 2) - (popupWidth / 2);\n\t\t\t\t\t\tconst angleShift = Popup.getOption('angleLeftOffset') - Popup.getOption('angleMinTop');\n\n\t\t\t\t\t\tpopup.setAngle({ offset: popupWidth / 2 - angleShift });\n\t\t\t\t\t\tpopup.setOffset({ offsetLeft: offsetLeft + Popup.getOption('angleLeftOffset') });\n\n\t\t\t\t\t\tthis.#lastSelectedBox = null;\n\t\t\t\t\t\tthis.#highlightBoxes(1, 1);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\tgetGridContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('grid', () => {\n\t\t\tconst buttons = [];\n\t\t\tfor (let index = 0; index < 100; index++)\n\t\t\t{\n\t\t\t\tconst row = Math.floor(index / 10);\n\t\t\t\tconst column = index % 10;\n\n\t\t\t\tbuttons.push(Tag.render`\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"ui-text-editor-table-dialog-box\"\n\t\t\t\t\t\tdata-column=\"${column + 1}\"\n\t\t\t\t\t\tdata-row=\"${row + 1}\"\n\t\t\t\t\t></button>\n\t\t\t\t`);\n\t\t\t}\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div \n\t\t\t\t\tclass=\"ui-text-editor-table-dialog-grid\" \n\t\t\t\t\tonmousemove=\"${this.#handleMouseMove.bind(this)}\"\n\t\t\t\t>${buttons}</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetCaptionContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('caption', () => {\n\t\t\treturn Tag.render`<div class=\"ui-text-editor-table-dialog-caption\"></div>`;\n\t\t});\n\t}\n\n\t#handleMouseMove(event: MouseEvent)\n\t{\n\t\tif (this.#lastSelectedBox !== event.target && Dom.hasClass(event.target, 'ui-text-editor-table-dialog-box'))\n\t\t{\n\t\t\tconst { row, column } = event.target.dataset;\n\t\t\tthis.#highlightBoxes(row, column);\n\t\t\tthis.#lastSelectedBox = event.target;\n\t\t}\n\t}\n\n\t#handleClick(event: MouseEvent)\n\t{\n\t\tif (this.#lastSelectedBox)\n\t\t{\n\t\t\tconst { row, column } = this.#lastSelectedBox.dataset;\n\t\t\tthis.emit('onSelect', { rows: row, columns: column });\n\t\t}\n\t}\n\n\t#highlightBoxes(rows: number, columns: number)\n\t{\n\t\tlet index = 0;\n\t\tfor (const box of this.getGridContainer().children)\n\t\t{\n\t\t\tconst boxRow = Math.floor(index / 10);\n\t\t\tconst boxColumn = index % 10;\n\t\t\tconst selected = boxRow < rows && boxColumn < columns;\n\t\t\tif (selected)\n\t\t\t{\n\t\t\t\tDom.addClass(box, '--selected');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(box, '--selected');\n\t\t\t}\n\n\t\t\tindex++;\n\t\t}\n\n\t\tthis.getCaptionContainer().textContent = rows && columns ? `${rows} x ${columns}` : '';\n\t}\n}\n","/* eslint-disable @bitrix24/bitrix24-rules/no-native-dom-methods */\nimport { Type, Text, Loc } from 'main.core';\nimport type { BaseEvent } from 'main.core.events';\nimport type { BBCodeElementNode } from 'ui.bbcode.model';\nimport {\n\t$normalizeTextNodes,\n\tshouldWrapInParagraph,\n\ttype BBCodeExportConversion,\n\ttype BBCodeConversion,\n\ttype BBCodeConversionFn,\n\ttype BBCodeExportOutput,\n\ttype BBCodeImportConversion,\n} from '../../bbcode';\n\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport BasePlugin from '../base-plugin';\nimport Button from '../../toolbar/button';\n\nimport {\n\t$isTextNode,\n\tcreateCommand,\n\t$getNodeByKey,\n\t$createParagraphNode,\n\tCOMMAND_PRIORITY_LOW,\n\tCOMMAND_PRIORITY_EDITOR,\n\ttype NodeKey,\n\ttype LexicalCommand,\n\ttype LexicalNode,\n\ttype ElementNode,\n} from 'ui.lexical.core';\n\nimport {\n\tTableNode,\n\tTableCellNode,\n\tTableRowNode,\n\t$isTableNode,\n\t$createTableNode,\n\t$createTableCellNode,\n\t$createTableRowNode,\n\t$createTableNodeWithDimensions,\n\tapplyTableHandlers,\n\tTableCellHeaderStates,\n\tINSERT_TABLE_COMMAND,\n\tTableSelection,\n} from 'ui.lexical.table';\n\nimport { $insertNodeToNearestRoot } from 'ui.lexical.utils';\n\nimport { type TextEditor } from '../../text-editor';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nimport TableDialog from './table-dialog';\n\nexport const INSERT_TABLE_DIALOG_COMMAND: LexicalCommand = createCommand('INSERT_TABLE_DIALOG_COMMAND');\n\nexport class TablePlugin extends BasePlugin\n{\n\t#tableDialog: TableDialog = null;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerCommands();\n\t\tthis.#registerListeners();\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Table';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [\n\t\t\tTableNode,\n\t\t\tTableCellNode,\n\t\t\tTableRowNode,\n\t\t];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn {\n\t\t\ttable: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createTableNode(),\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\ttr: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createTableRowNode(),\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\ttd: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createTableCellNode(),\n\t\t\t\t\t\tafter: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t\t\t\t\t\treturn $normalizeTextNodes(childLexicalNodes);\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t\tth: (): BBCodeConversion => ({\n\t\t\t\tconversion: (node: BBCodeElementNode): BBCodeConversionFn | null => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tnode: $createTableCellNode(TableCellHeaderStates.ROW),\n\t\t\t\t\t\tafter: (childLexicalNodes: Array<LexicalNode>): Array<LexicalNode> => {\n\t\t\t\t\t\t\treturn $normalizeTextNodes(childLexicalNodes);\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tpriority: 0,\n\t\t\t}),\n\t\t};\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\ttable: (): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'table' }),\n\t\t\t\t};\n\t\t\t},\n\t\t\ttablerow: (): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: 'tr' }),\n\t\t\t\t};\n\t\t\t},\n\t\t\ttablecell: (node: TableCellNode): BBCodeExportOutput => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createElement({ name: node.hasHeader() ? 'th' : 'td' }),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tnodes: [\n\t\t\t\t{\n\t\t\t\t\tnodeClass: TableNode,\n\t\t\t\t\tvalidate: ((tableNode: TableNode) => {\n\t\t\t\t\t\tif (tableNode.getChildrenSize() === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttableNode.remove();\n\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tnodeClass: TableCellNode,\n\t\t\t\t\tvalidate: ((tableCellNode: TableCellNode) => {\n\t\t\t\t\t\ttableCellNode.getChildren().forEach((child: LexicalNode | ElementNode) => {\n\t\t\t\t\t\t\tif (shouldWrapInParagraph(child))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst paragraph = $createParagraphNode();\n\t\t\t\t\t\t\t\tchild.replace(paragraph);\n\t\t\t\t\t\t\t\tparagraph.append(child);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tbbcodeMap: {\n\t\t\t\ttable: 'table',\n\t\t\t\ttablerow: 'tr',\n\t\t\t\ttablecell: 'td',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('table', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --table-editor\"></span>');\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_TABLE'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().dispatchCommand(INSERT_TABLE_DIALOG_COMMAND, {\n\t\t\t\t\ttargetNode: button.getContainer(),\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_TABLE_COMMAND,\n\t\t\t\t({ columns, rows }) => {\n\t\t\t\t\tconst rowCount = Math.max(1, Text.toNumber(rows));\n\t\t\t\t\tconst columnCount = Math.max(1, Text.toNumber(columns));\n\t\t\t\t\tconst tableNode = $createTableNodeWithDimensions(rowCount, columnCount, false);\n\t\t\t\t\t$insertNodeToNearestRoot(tableNode);\n\n\t\t\t\t\tconst firstDescendant: LexicalNode = tableNode.getFirstDescendant();\n\t\t\t\t\tif ($isTextNode(firstDescendant))\n\t\t\t\t\t{\n\t\t\t\t\t\tfirstDescendant.select();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_TABLE_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (!Type.isPlainObject(payload) || !Type.isElementNode(payload.targetNode))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.#tableDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.#tableDialog.getTargetNode() === payload.targetNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#tableDialog.show();\n\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.#tableDialog.destroy();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#tableDialog = new TableDialog({\n\t\t\t\t\t\ttargetNode: payload.targetNode,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tonSelect: (event: BaseEvent) => {\n\t\t\t\t\t\t\t\tthis.getEditor().dispatchCommand(INSERT_TABLE_COMMAND, event.getData());\n\t\t\t\t\t\t\t\tthis.#tableDialog.hide();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\t\t\tthis.#tableDialog = null;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.#tableDialog.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tif (this.#tableDialog !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#tableDialog.hide();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.#tableDialog !== null && this.#tableDialog.isShown();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tconst tableSelections: Map<NodeKey, TableSelection> = new Map();\n\t\tconst initializeTableNode = (tableNode: TableNode) => {\n\t\t\tconst nodeKey = tableNode.getKey();\n\t\t\tconst tableElement = this.getEditor().getElementByKey(nodeKey);\n\t\t\tif (tableElement && !tableSelections.has(nodeKey))\n\t\t\t{\n\t\t\t\tconst tableSelection = applyTableHandlers(\n\t\t\t\t\ttableNode,\n\t\t\t\t\ttableElement,\n\t\t\t\t\tthis.getLexicalEditor(),\n\t\t\t\t\ttrue,\n\t\t\t\t);\n\n\t\t\t\ttableSelections.set(nodeKey, tableSelection);\n\t\t\t}\n\t\t};\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerMutationListener(\n\t\t\t\tTableNode,\n\t\t\t\t(nodeMutations) => {\n\t\t\t\t\tfor (const [nodeKey, mutation] of nodeMutations)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (mutation === 'created')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.getEditor().getEditorState().read(() => {\n\t\t\t\t\t\t\t\tconst tableNode = $getNodeByKey(nodeKey);\n\t\t\t\t\t\t\t\tif ($isTableNode(tableNode))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tinitializeTableNode(tableNode);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (mutation === 'destroyed')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst tableSelection = tableSelections.get(nodeKey);\n\t\t\t\t\t\t\tif (tableSelection !== undefined)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttableSelection.removeListeners();\n\t\t\t\t\t\t\t\ttableSelections.delete(nodeKey);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t),\n\t\t);\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#tableDialog !== null)\n\t\t{\n\t\t\tthis.#tableDialog.destroy();\n\t\t}\n\t}\n}\n","/* eslint-disable no-underscore-dangle */\nimport { Dom, Type } from 'main.core';\n\nimport {\n\tTextNode,\n\t$applyNodeReplacement,\n\ttype EditorConfig,\n\ttype LexicalNode,\n\ttype NodeKey,\n\ttype SerializedTextNode,\n} from 'ui.lexical.core';\n\nexport class HashtagNode extends TextNode\n{\n\tstatic getType(): string\n\t{\n\t\treturn 'hashtag';\n\t}\n\n\tstatic clone(node: HashtagNode): HashtagNode\n\t{\n\t\treturn new HashtagNode(node.__text, node.__key);\n\t}\n\n\tconstructor(text: string, key?: NodeKey)\n\t{\n\t\tsuper(text, key);\n\t}\n\n\tcreateDOM(config: EditorConfig): HTMLElement\n\t{\n\t\tconst element = super.createDOM(config);\n\t\tif (Type.isStringFilled(config?.theme?.hashtag))\n\t\t{\n\t\t\tDom.addClass(element, config.theme.hashtag);\n\t\t}\n\n\t\treturn element;\n\t}\n\n\tstatic importJSON(serializedNode: SerializedTextNode): HashtagNode\n\t{\n\t\tconst node = $createHashtagNode(serializedNode.text);\n\t\tnode.setFormat(serializedNode.format);\n\t\tnode.setDetail(serializedNode.detail);\n\t\tnode.setMode(serializedNode.mode);\n\t\tnode.setStyle(serializedNode.style);\n\n\t\treturn node;\n\t}\n\n\texportJSON(): SerializedTextNode\n\t{\n\t\treturn {\n\t\t\t...super.exportJSON(),\n\t\t\ttype: 'hashtag',\n\t\t};\n\t}\n\n\tcanInsertTextBefore(): boolean\n\t{\n\t\treturn false;\n\t}\n\n\tisTextEntity(): true\n\t{\n\t\treturn true;\n\t}\n}\n\nexport function $createHashtagNode(text = ''): HashtagNode\n{\n\treturn $applyNodeReplacement(new HashtagNode(text));\n}\n\nexport function $isHashtagNode(node: LexicalNode | null | undefined): boolean\n{\n\treturn node instanceof HashtagNode;\n}\n","import type { LexicalNode, TextNode } from 'ui.lexical.core';\nimport {\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportConversion,\n} from '../../bbcode';\n\nimport { registerLexicalTextEntity } from 'ui.lexical.text';\n\nimport { HashtagNode, $createHashtagNode } from './hashtag-node';\nimport BasePlugin from '../base-plugin';\n\nimport { type TextEditor } from '../../text-editor';\nimport type { SchemeValidationOptions } from '../../types/scheme-validation-options';\n\nexport class HashtagPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#registerListeners();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Hashtag';\n\t}\n\n\tstatic getNodes(editor: TextEditor): Array<Class<LexicalNode>>\n\t{\n\t\treturn [HashtagNode];\n\t}\n\n\timportBBCode(): BBCodeImportConversion\n\t{\n\t\treturn null;\n\t}\n\n\texportBBCode(): BBCodeExportConversion\n\t{\n\t\treturn {\n\t\t\thashtag: (lexicalNode: TextNode, node: Node): Node | null => {\n\t\t\t\tconst scheme = this.getEditor().getBBCodeScheme();\n\n\t\t\t\treturn {\n\t\t\t\t\tnode: scheme.createText(lexicalNode.getTextContent()),\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\t}\n\n\tvalidateScheme(): SchemeValidationOptions | null\n\t{\n\t\treturn {\n\t\t\tbbcodeMap: {\n\t\t\t\thashtag: '#text',\n\t\t\t},\n\t\t};\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tconst createHashtagNode = (textNode: TextNode): HashtagNode => {\n\t\t\treturn $createHashtagNode(textNode.getTextContent());\n\t\t};\n\n\t\tconst getHashtagMatch = (text: string) => {\n\t\t\tconst match: RegExpMatchArray = /(?<=\\s+|^)#([^\\s,.<>[\\]]+)/is.exec(text);\n\t\t\tif (match === null)\n\t\t\t{\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst hashtagLength = match[0].length;\n\t\t\tconst startOffset = match.index;\n\t\t\tconst endOffset = startOffset + hashtagLength;\n\n\t\t\treturn {\n\t\t\t\tend: endOffset,\n\t\t\t\tstart: startOffset,\n\t\t\t};\n\t\t};\n\n\t\tthis.cleanUpRegister(\n\t\t\t...registerLexicalTextEntity(\n\t\t\t\tthis.getLexicalEditor(),\n\t\t\t\tgetHashtagMatch,\n\t\t\t\tHashtagNode,\n\t\t\t\tcreateHashtagNode,\n\t\t\t),\n\t\t);\n\t}\n}\n","import { Type } from 'main.core';\nimport { $createLineBreakNode, $createTabNode, $createTextNode, type TextNode } from 'ui.lexical.core';\n\nexport function $createNodesFromText(text: string): TextNode[]\n{\n\tif (!Type.isStringFilled(text))\n\t{\n\t\treturn [];\n\t}\n\n\tconst nodes = [];\n\tconst parts = text.split(/(\\r?\\n|\\t)/);\n\tconst length = parts.length;\n\tfor (let i = 0; i < length; i++)\n\t{\n\t\tconst part = parts[i];\n\t\tif (part === '\\n' || part === '\\r\\n')\n\t\t{\n\t\t\tnodes.push($createLineBreakNode());\n\t\t}\n\t\telse if (part === '\\t')\n\t\t{\n\t\t\tnodes.push($createTabNode());\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnodes.push($createTextNode(part));\n\t\t}\n\t}\n\n\treturn nodes;\n}\n","import { Runtime, Type, Dom, Tag, Loc, Event } from 'main.core';\nimport type { BaseEvent } from 'main.core.events';\nimport type { Copilot, CopilotOptions } from 'ai.copilot';\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { $createNodesFromText } from '../../helpers/create-nodes-from-text';\nimport { getEditorPaddings } from '../../helpers/get-editor-paddings';\nimport { $getSelectionPosition } from '../../helpers/get-selection-position';\n\nimport {\n\t$getSelection,\n\t$isRangeSelection,\n\t$isRootNode,\n\t$isTextNode,\n\tcreateCommand,\n\t$getRoot,\n\t$isParagraphNode,\n\t$createParagraphNode,\n\tCOMMAND_PRIORITY_EDITOR,\n\tCOMMAND_PRIORITY_LOW,\n\ttype LexicalCommand,\n\ttype PointType,\n\ttype TextNode,\n\ttype ElementNode,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nimport { $restoreSelection } from '../../helpers/restore-selection';\n\nimport Button from '../../toolbar/button';\nimport BasePlugin from '../base-plugin';\n\nimport { type TextEditor } from '../../text-editor';\n\nimport './copilot.css';\nimport { CustomParagraphNode } from '../paragraph/custom-paragraph-node';\n\nexport const INSERT_COPILOT_DIALOG_COMMAND: LexicalCommand = createCommand('INSERT_COPILOT_DIALOG_COMMAND');\n\nconst CopilotStatus = {\n\tINIT: 'init',\n\tLOADING: 'loading',\n\tLOADED: 'loaded',\n};\n\nexport class CopilotPlugin extends BasePlugin\n{\n\t#copilot: Copilot = null;\n\t#copilotStatus: boolean = CopilotStatus.INIT;\n\t#copilotOptions: CopilotOptions = null;\n\t#targetParagraph: HTMLParagraphElement = null;\n\t#lastSelection: RangeSelection = null;\n\t#onEditorScroll: Function = this.#handleEditorScroll.bind(this);\n\t#triggerBySpace: boolean = false;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#copilotOptions = editor.getOption('copilot.copilotOptions');\n\t\tif (Type.isPlainObject(this.#copilotOptions))\n\t\t{\n\t\t\tthis.#registerListeners();\n\t\t\tthis.#registerComponents();\n\t\t}\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Copilot';\n\t}\n\n\t#registerListeners(): void\n\t{\n\t\tthis.#triggerBySpace = this.getEditor().getOption('copilot.triggerBySpace', false);\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tINSERT_COPILOT_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tconst options = Type.isPlainObject(payload) ? payload : {};\n\t\t\t\t\tthis.show(options);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_EDITOR,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(payload): boolean => {\n\t\t\t\t\tif (payload?.sender === 'copilot')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#lastSelection = null;\n\n\t\t\t\t\tthis.#hide();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDIALOG_VISIBILITY_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\treturn this.isCopilotShown();\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.#triggerBySpace ? this.#registerParagraphNodeTransform() : () => {},\n\t\t);\n\t}\n\n\t#registerParagraphNodeTransform(): () => void\n\t{\n\t\treturn this.getEditor().registerNodeTransform(CustomParagraphNode, (node: CustomParagraphNode) => {\n\t\t\tif (node.getChildrenSize() !== 1 || !$isRootNode(node.getParent()))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!$isTextNode(node.getFirstChild()) || node.getFirstChild().getTextContent() !== ' ')\n\t\t\t{\n\t\t\t\tthis.#resetLoader();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tif (!$isRangeSelection(selection) || !selection.isCollapsed())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst anchorNode = selection.anchor.getNode();\n\t\t\tif (anchorNode !== node.getFirstChild())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.isCopilotLoaded() && !this.isCopilotLoading())\n\t\t\t{\n\t\t\t\tthis.#resetLoader();\n\t\t\t\tthis.#targetParagraph = this.getEditor().getElementByKey(node.getKey());\n\t\t\t\tif (this.#targetParagraph)\n\t\t\t\t{\n\t\t\t\t\tDom.addClass(this.#targetParagraph, 'ui-text-editor-loading-ellipsis');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tnode.getFirstChild().remove();\n\t\t\tnode.select();\n\t\t\tthis.show({\n\t\t\t\tonShow: () => this.#resetLoader(),\n\t\t\t\tonError: () => this.#resetLoader(),\n\t\t\t});\n\t\t});\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tthis.getEditor().getComponentRegistry().register('copilot', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tconst copilotIconClass = '--copilot-ai';\n\t\t\tconst refreshIconClass = '--refresh-5 ui-text-editor-copilot-loading';\n\t\t\tconst icon = Tag.render`\n\t\t\t\t<span class=\"ui-icon-set ${copilotIconClass}\" style=\"--ui-icon-set__icon-color: #8e52ec\"></span>\n\t\t\t`;\n\t\t\tbutton.setContent(icon);\n\t\t\tbutton.setTooltip(Loc.getMessage('TEXT_EDITOR_BTN_COPILOT'));\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().focus();\n\n\t\t\t\tif (this.isCopilotLoading())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst resetRefresh = () => {\n\t\t\t\t\tif (!Dom.hasClass(icon, copilotIconClass))\n\t\t\t\t\t{\n\t\t\t\t\t\tDom.removeClass(icon, refreshIconClass);\n\t\t\t\t\t\tDom.addClass(icon, copilotIconClass);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tthis.getEditor().dispatchCommand(\n\t\t\t\t\tINSERT_COPILOT_DIALOG_COMMAND,\n\t\t\t\t\t{\n\t\t\t\t\t\tonShow: resetRefresh,\n\t\t\t\t\t\tonError: resetRefresh,\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\tif (!this.isCopilotLoaded())\n\t\t\t\t{\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tif (!this.isCopilotLoaded())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tDom.removeClass(icon, copilotIconClass);\n\t\t\t\t\t\t\tDom.addClass(icon, refreshIconClass);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 500);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn button;\n\t\t});\n\t}\n\n\tshouldTriggerBySpace(): boolean\n\t{\n\t\treturn this.#triggerBySpace;\n\t}\n\n\tisCopilotLoaded(): boolean\n\t{\n\t\treturn this.#copilotStatus === CopilotStatus.LOADED;\n\t}\n\n\tisCopilotLoading(): boolean\n\t{\n\t\treturn this.#copilotStatus === CopilotStatus.LOADING;\n\t}\n\n\tisCopilotShown(): boolean\n\t{\n\t\treturn this.#copilot !== null && this.#copilot.isShown();\n\t}\n\n\tshow({ onShow, onError } = {})\n\t{\n\t\tif (this.isCopilotLoaded())\n\t\t{\n\t\t\tthis.#show({ onShow });\n\t\t}\n\t\telse if (!this.isCopilotLoading())\n\t\t{\n\t\t\tthis.#createCopilot()\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.#show({ onShow });\n\t\t\t\t}).catch(() => {\n\t\t\t\t\tif (Type.isFunction(onError))\n\t\t\t\t\t{\n\t\t\t\t\t\tonError();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t;\n\t\t}\n\t}\n\n\t#show({ onShow } = {})\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tif (!$isRangeSelection(selection) || !this.getEditor().isEditable())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND, { sender: 'copilot' });\n\n\t\t\tconst selectionText = selection.getTextContent();\n\t\t\tconst editorPosition = Dom.getPosition(this.getEditor().getScrollerContainer());\n\t\t\tconst width = Math.min(editorPosition.width, 600);\n\n\t\t\tthis.#lastSelection = selection.clone();\n\n\t\t\tconst selectedText = selectionText.trim();\n\t\t\tif (selectedText.length > 0)\n\t\t\t{\n\t\t\t\tthis.#copilot.setSelectedText(selectedText);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst wholeText = $getRoot().getTextContent().trim();\n\t\t\t\tif (wholeText.length > 0)\n\t\t\t\t{\n\t\t\t\t\tthis.#copilot.setContext(wholeText);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.#copilot.show({ width });\n\n\t\t\tthis.#adjustDialogPosition();\n\n\t\t\tEvent.bind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\n\t\t\tif (!selection.isCollapsed())\n\t\t\t{\n\t\t\t\tthis.getEditor().highlightSelection();\n\t\t\t}\n\n\t\t\tif (Type.isFunction(onShow))\n\t\t\t{\n\t\t\t\tonShow();\n\t\t\t}\n\t\t});\n\t}\n\n\t#hide()\n\t{\n\t\tif (this.isCopilotLoaded() && this.#copilot.isShown())\n\t\t{\n\t\t\tthis.#copilot.hide();\n\t\t}\n\t}\n\n\t#createCopilot(): Promise\n\t{\n\t\tif (this.isDestroyed())\n\t\t{\n\t\t\treturn Promise.reject(new Error('Copilot plugin was destroyed.'));\n\t\t}\n\n\t\tthis.#copilotStatus = CopilotStatus.LOADING;\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tRuntime.loadExtension('ai.copilot')\n\t\t\t\t.then(({ Copilot, CopilotEvents }) => {\n\t\t\t\t\tif (this.isDestroyed())\n\t\t\t\t\t{\n\t\t\t\t\t\treject(new Error('Copilot plugin was destroyed.'));\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#copilot = new Copilot({\n\t\t\t\t\t\tshowResultInCopilot: true,\n\t\t\t\t\t\t...this.#copilotOptions,\n\t\t\t\t\t\tautoHide: true,\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.#copilot.subscribe(CopilotEvents.FINISH_INIT, () => {\n\t\t\t\t\t\tif (this.isDestroyed())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treject(new Error('Copilot plugin was destroyed.'));\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.#copilotStatus = CopilotStatus.LOADED;\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.#copilot.subscribe(CopilotEvents.TEXT_SAVE, this.#handleCopilotSave.bind(this));\n\t\t\t\t\tthis.#copilot.subscribe(CopilotEvents.TEXT_PLACE_BELOW, this.#handleCopilotAddBelow.bind(this));\n\t\t\t\t\tthis.#copilot.subscribe(CopilotEvents.HIDE, this.#handleCopilotHide.bind(this));\n\n\t\t\t\t\tthis.#copilot.init();\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\treject();\n\t\t\t\t})\n\t\t\t;\n\t\t});\n\t}\n\n\t#resetLoader(): void\n\t{\n\t\tif (this.#targetParagraph)\n\t\t{\n\t\t\tDom.removeClass(this.#targetParagraph, 'ui-text-editor-loading-ellipsis');\n\t\t}\n\t}\n\n\t// #handleCopilotResult(event: BaseEvent): void\n\t// {\n\t// \tconsole.log('#handleCopilotResult', event.getData());\n\t// \tconst { result } = event.getData();\n\t// \tthis.getEditor().update(\n\t// \t\t() => {\n\t// \t\t\tthis.#targetParagraph.clear();\n\t// \t\t\tthis.#targetParagraph.append($createTextNode(result));\n\t// \t\t},\n\t// \t\t{\n\t// \t\t\tonUpdate: () => {\n\t// \t\t\t\tconst targetNode: HTMLElement = this.getEditor().getElementByKey(this.#targetParagraph.getKey());\n\t// \t\t\t\tthis.#copilot.adjustPosition(targetNode);\n\t// \t\t\t},\n\t// \t\t},\n\t// \t);\n\t// }\n\n\t#adjustDialogPosition(): void\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tconst selectionPosition = $getSelectionPosition(this.getEditor(), selection, document.body);\n\t\t\tif (selectionPosition === null)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.#lastSelection = selection.clone();\n\n\t\t\tconst { top, left, bottom } = selectionPosition;\n\t\t\tconst scrollerRect: DOMRect = Dom.getPosition(this.getEditor().getScrollerContainer());\n\t\t\tconst popupWidth = Math.min(scrollerRect.width, 600);\n\n\t\t\tconst editorPaddings = getEditorPaddings(this.getEditor());\n\n\t\t\tlet offsetLeft = popupWidth / 2;\n\t\t\tif (left - offsetLeft < scrollerRect.left)\n\t\t\t{\n\t\t\t\t// Left boundary\n\t\t\t\tconst overflow = scrollerRect.left - (left - offsetLeft);\n\t\t\t\toffsetLeft -= overflow + editorPaddings.left;\n\t\t\t}\n\t\t\telse if (scrollerRect.right < (left + popupWidth - offsetLeft))\n\t\t\t{\n\t\t\t\t// Right boundary\n\t\t\t\toffsetLeft += (left + popupWidth - offsetLeft) - scrollerRect.right + editorPaddings.right;\n\t\t\t}\n\n\t\t\tif (bottom < scrollerRect.top || top > scrollerRect.bottom)\n\t\t\t{\n\t\t\t\tthis.#copilot.adjust({ hide: true });\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#copilot.adjust({\n\t\t\t\t\thide: false,\n\t\t\t\t\tposition: { left: left - offsetLeft, top: bottom },\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\t#handleEditorScroll(): void\n\t{\n\t\tthis.#adjustDialogPosition();\n\t}\n\n\t#restoreSelection(): boolean\n\t{\n\t\tconst success = $restoreSelection(this.#lastSelection);\n\t\tthis.#lastSelection = null;\n\n\t\treturn success;\n\t}\n\n\t#handleCopilotSave(event: BaseEvent): void\n\t{\n\t\tconst { result } = event.getData();\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tif ($isRangeSelection(selection))\n\t\t\t{\n\t\t\t\tselection.insertRawText(result);\n\t\t\t}\n\n\t\t\tthis.#hide();\n\t\t});\n\t}\n\n\t#handleCopilotAddBelow(event: BaseEvent): void\n\t{\n\t\tconst { result } = event.getData();\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tif ($isRangeSelection(selection))\n\t\t\t{\n\t\t\t\tconst focus: PointType = selection.focus;\n\t\t\t\tconst focusNode: TextNode | ElementNode = focus.getNode();\n\t\t\t\tif (!selection.isCollapsed())\n\t\t\t\t{\n\t\t\t\t\tfocusNode.selectEnd();\n\t\t\t\t}\n\n\t\t\t\tconst parentNode: ElementNode = focusNode.getParent();\n\t\t\t\tif ($isParagraphNode(parentNode))\n\t\t\t\t{\n\t\t\t\t\tconst paragraph = $createParagraphNode();\n\t\t\t\t\tparagraph.append(...$createNodesFromText(result));\n\t\t\t\t\tparentNode.insertAfter(paragraph);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tselection.insertLineBreak();\n\t\t\t\t\tselection.insertRawText(result);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.#hide();\n\t\t});\n\t}\n\n\t#handleCopilotHide(): void\n\t{\n\t\tEvent.unbind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\tthis.getEditor().resetHighlightSelection();\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#restoreSelection();\n\t\t\t// this.getEditor().focus();\n\t\t});\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#copilot !== null)\n\t\t{\n\t\t\tthis.#copilot.hide();\n\t\t\tthis.#copilot = null;\n\t\t}\n\t}\n}\n","import { Browser, Loc } from 'main.core';\nimport Button from '../../toolbar/button';\nimport BasePlugin from '../base-plugin';\n\nimport { type TextEditor } from '../../text-editor';\n\nimport { registerHistory, createEmptyHistoryState } from 'ui.lexical.history';\n\nimport {\n\tUNDO_COMMAND,\n\tREDO_COMMAND,\n\tCAN_UNDO_COMMAND,\n\tCAN_REDO_COMMAND,\n\tCOMMAND_PRIORITY_CRITICAL,\n} from 'ui.lexical.core';\n\nexport class HistoryPlugin extends BasePlugin\n{\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tconst historyState = createEmptyHistoryState();\n\t\tthis.cleanUpRegister(\n\t\t\tregisterHistory(editor.getLexicalEditor(), historyState, 1000),\n\t\t);\n\n\t\tthis.#registerComponents();\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'History';\n\t}\n\n\t#registerComponents(): void\n\t{\n\t\tlet canUndo = false;\n\t\tthis.getEditor().getComponentRegistry().register('undo', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --undo\"></span>');\n\t\t\tbutton.setDisabled(!canUndo);\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_UNDO', { '#keystroke#': Browser.isMac() ? '⌘Z' : 'Ctrl+Z' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().dispatchCommand(UNDO_COMMAND);\n\t\t\t});\n\n\t\t\tbutton.setDisableCallback(() => {\n\t\t\t\treturn !canUndo || !this.getEditor().isEditable();\n\t\t\t});\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tCAN_UNDO_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tcanUndo = payload;\n\t\t\t\t\tbutton.setDisabled(!canUndo);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t);\n\n\t\t\treturn button;\n\t\t});\n\n\t\tlet canRedo = false;\n\t\tthis.getEditor().getComponentRegistry().register('redo', (): Button => {\n\t\t\tconst button: Button = new Button();\n\t\t\tbutton.setContent('<span class=\"ui-icon-set --redo\"></span>');\n\t\t\tbutton.setDisabled(!canRedo);\n\t\t\tbutton.setTooltip(\n\t\t\t\tLoc.getMessage('TEXT_EDITOR_BTN_REDO', { '#keystroke#': Browser.isMac() ? '⌘⇧Z' : 'Ctrl+Y' }),\n\t\t\t);\n\t\t\tbutton.subscribe('onClick', (): void => {\n\t\t\t\tthis.getEditor().dispatchCommand(REDO_COMMAND);\n\t\t\t});\n\n\t\t\tbutton.setDisableCallback(() => {\n\t\t\t\treturn !canRedo || !this.getEditor().isEditable();\n\t\t\t});\n\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tCAN_REDO_COMMAND,\n\t\t\t\t(payload) => {\n\t\t\t\t\tcanRedo = payload;\n\t\t\t\t\tbutton.setDisabled(!canRedo);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t);\n\n\t\t\treturn button;\n\t\t});\n\t}\n}\n","import { Dom, Event, Tag, Type, Text } from 'main.core';\nimport { HIDE_DIALOG_COMMAND } from '../../commands';\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nimport {\n\tCOMMAND_PRIORITY_HIGH,\n\tCOMMAND_PRIORITY_LOW,\n\tDRAGOVER_COMMAND,\n\tDROP_COMMAND,\n\t$getNearestNodeFromDOMNode,\n\t$getNodeByKey,\n\t$getRoot,\n\ttype RootNode,\n} from 'ui.lexical.core';\n\nimport { mergeRegister } from 'ui.lexical.utils';\n\nimport './block-toolbar.css';\n\nconst Direction = {\n\tDOWNWARD: 1,\n\tUPWARD: -1,\n\tINDETERMINATE: 0,\n};\n\nconst DRAG_DATA_FORMAT = 'application/x-ui-text-editor-drag-block';\n\nexport class BlockToolbarPlugin extends BasePlugin\n{\n\t#draggableBlockElement: HTMLElement = null;\n\t#lastBlockElementIndex: number = Infinity;\n\t#lastTargetElement: HTMLElement = null;\n\t#container: HTMLElement = null;\n\t#dropLine: HTMLElement = null;\n\t#isDragging = false;\n\n\t#bodyDragDropHandler: Function = null;\n\t#bodyDragOverHandler: Function = null;\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.#registerEvents(),\n\t\t\tthis.#registerListeners(),\n\t\t);\n\n\t\tthis.#bodyDragDropHandler = (event: DragEvent) => {\n\t\t\tthis.getEditor().dispatchCommand(DROP_COMMAND, event);\n\t\t};\n\n\t\tthis.#bodyDragOverHandler = (event: DragEvent) => {\n\t\t\t// prevent default to allow drop\n\t\t\tevent.preventDefault();\n\t\t};\n\n\t\tDom.append(this.getContainer(), this.getEditor().getScrollerContainer());\n\t\tDom.append(this.getDropLine(), this.getEditor().getScrollerContainer());\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'BlockToolbar';\n\t}\n\n\t#registerEvents(): () => void\n\t{\n\t\tconst scroller: HTMLElement = this.getEditor().getScrollerContainer();\n\t\tconst onMouseMove = this.#handleMouseMove.bind(this);\n\t\tconst onMouseLeave = this.#handleMouseLeave.bind(this);\n\t\tEvent.bind(scroller, 'mousemove', onMouseMove);\n\t\tEvent.bind(scroller, 'mouseleave', onMouseLeave);\n\n\t\treturn (): void => {\n\t\t\tEvent.unbind(scroller, 'mousemove', onMouseMove);\n\t\t\tEvent.unbind(scroller, 'mouseleave', onMouseLeave);\n\t\t};\n\t}\n\n\t#registerListeners(): () => void\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDRAGOVER_COMMAND,\n\t\t\t\tthis.#handleDragOver.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tDROP_COMMAND,\n\t\t\t\tthis.#handleDragDrop.bind(this),\n\t\t\t\tCOMMAND_PRIORITY_HIGH,\n\t\t\t),\n\t\t\tthis.getEditor().registerTextContentListener((): void => {\n\t\t\t\tthis.#setDraggableBlockElement(null);\n\t\t\t\tthis.#updatePosition();\n\t\t\t}),\n\t\t);\n\t}\n\n\t#handleMouseMove(event: MouseEvent): void\n\t{\n\t\tif (!this.getEditor().isEditable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst target = event.target;\n\t\tif (!(target instanceof HTMLElement))\n\t\t{\n\t\t\tthis.#setDraggableBlockElement(null);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (target.closest('.ui-text-editor-block-toolbar') !== null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst element = this.#findBlockElement(event);\n\t\tthis.#setDraggableBlockElement(element);\n\t}\n\n\t#handleMouseLeave(): void\n\t{\n\t\tthis.#setDraggableBlockElement(null);\n\t}\n\n\t#findBlockElement(event): HTMLElement | null\n\t{\n\t\tconst scroller = this.getEditor().getScrollerContainer();\n\t\tconst anchorElementRect = scroller.getBoundingClientRect();\n\t\tlet blockElem: HTMLElement | null = null;\n\n\t\tthis.getEditor().getEditorState().read(() => {\n\t\t\tconst root: RootNode = $getRoot();\n\t\t\tconst topLevelNodeKeys = root.getChildrenKeys();\n\t\t\tlet index: number = this.#getCurrentIndex(topLevelNodeKeys.length);\n\t\t\tlet direction: number = Direction.INDETERMINATE;\n\n\t\t\twhile (index >= 0 && index < topLevelNodeKeys.length)\n\t\t\t{\n\t\t\t\tconst key: string = topLevelNodeKeys[index];\n\t\t\t\tconst elem: HTMLElement | null = this.getEditor().getElementByKey(key);\n\t\t\t\tif (elem === null)\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tconst domRect = elem.getBoundingClientRect();\n\t\t\t\tconst { marginLeft, marginRight, marginTop, marginBottom } = window.getComputedStyle(elem);\n\n\t\t\t\tconst rect = new DOMRect(\n\t\t\t\t\tanchorElementRect.left + parseFloat(marginLeft),\n\t\t\t\t\tdomRect.y - parseFloat(marginTop),\n\t\t\t\t\tdomRect.width + parseFloat(marginRight),\n\t\t\t\t\tdomRect.height + parseFloat(marginBottom),\n\t\t\t\t);\n\n\t\t\t\tconst { x, y } = event;\n\t\t\t\tconst isOnTopSide = y < rect.top;\n\t\t\t\tconst isOnBottomSide = y > rect.bottom;\n\t\t\t\tconst isOnLeftSide = x < rect.left;\n\t\t\t\tconst isOnRightSide = x > rect.right;\n\t\t\t\tconst contains = !isOnTopSide && !isOnBottomSide && !isOnLeftSide && !isOnRightSide;\n\t\t\t\tif (contains)\n\t\t\t\t{\n\t\t\t\t\tblockElem = elem;\n\t\t\t\t\tthis.#lastBlockElementIndex = index;\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif (direction === Direction.INDETERMINATE)\n\t\t\t\t{\n\t\t\t\t\tif (isOnTopSide)\n\t\t\t\t\t{\n\t\t\t\t\t\tdirection = Direction.UPWARD;\n\t\t\t\t\t}\n\t\t\t\t\telse if (isOnBottomSide)\n\t\t\t\t\t{\n\t\t\t\t\t\tdirection = Direction.DOWNWARD;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// stop search block element\n\t\t\t\t\t\tdirection = Infinity;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tindex += direction;\n\t\t\t}\n\t\t});\n\n\t\treturn blockElem;\n\t}\n\n\t#getCurrentIndex(keysLength: number): number\n\t{\n\t\tif (keysLength === 0)\n\t\t{\n\t\t\treturn Infinity;\n\t\t}\n\n\t\tif (this.#lastBlockElementIndex >= 0 && this.#lastBlockElementIndex < keysLength)\n\t\t{\n\t\t\treturn this.#lastBlockElementIndex;\n\t\t}\n\n\t\treturn Math.floor(keysLength / 2);\n\t}\n\n\t#updatePosition(): void\n\t{\n\t\tif (this.#draggableBlockElement === null)\n\t\t{\n\t\t\tDom.style(this.getContainer(), {\n\t\t\t\topacity: 0,\n\t\t\t\ttransform: 'translateY(-10000px)',\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// const styles: CSSStyleDeclaration = window.getComputedStyle(this.#draggableBlockElement);\n\t\t\t// const lineHeight: number = Text.toNumber(styles.lineHeight);\n\t\t\t// const toolbarHeight: number = this.getContainer().offsetHeight;\n\t\t\t// const offset = lineHeight > 0 ? (lineHeight - toolbarHeight) / 2 : 3;\n\n\t\t\tconst offset = Text.toNumber(Dom.style(this.#draggableBlockElement, 'margin-top'));\n\t\t\tconst top: number = this.#draggableBlockElement.offsetTop + offset;\n\n\t\t\tDom.style(this.getContainer(), {\n\t\t\t\topacity: 1,\n\t\t\t\ttransform: `translateY(${top}px)`,\n\t\t\t});\n\t\t}\n\t}\n\n\t#setDraggableBlockElement(element: HTMLElement | null): void\n\t{\n\t\tconst changed = this.#draggableBlockElement !== element;\n\t\tthis.#draggableBlockElement = element;\n\n\t\tif (changed)\n\t\t{\n\t\t\tthis.#updatePosition();\n\t\t}\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\tif (this.#container === null)\n\t\t{\n\t\t\tthis.#container = Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-block-toolbar\">\n\t\t\t\t\t<div \n\t\t\t\t\t\tclass=\"ui-text-editor-block-drag-icon\" \n\t\t\t\t\t\tdraggable=\"true\"\n\t\t\t\t\t\tondragstart=\"${this.#handleDragStart.bind(this)}\" \n\t\t\t\t\t\tondragend=\"${this.#handleDragEnd.bind(this)}\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div \n\t\t\t\t\t\t\tclass=\"ui-icon-set --more-points\" \n\t\t\t\t\t\t\tstyle=\"--ui-icon-set__icon-size: 24px; margin-left: -4px\"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}\n\n\t\treturn this.#container;\n\t}\n\n\tgetDropLine(): HTMLElement\n\t{\n\t\tif (this.#dropLine === null)\n\t\t{\n\t\t\tthis.#dropLine = Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-block-drop-line\"></div>\n\t\t\t`;\n\t\t}\n\n\t\treturn this.#dropLine;\n\t}\n\n\t#handleDragStart(event: DragEvent): void\n\t{\n\t\tconst dataTransfer = event.dataTransfer;\n\t\tif (!dataTransfer || this.#draggableBlockElement === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.getEditor().dispatchCommand(HIDE_DIALOG_COMMAND);\n\n\t\tdataTransfer.setDragImage(this.#draggableBlockElement, 0, 0);\n\n\t\tlet nodeKey = '';\n\t\tthis.getEditor().update(() => {\n\t\t\tconst node = $getNearestNodeFromDOMNode(this.#draggableBlockElement);\n\t\t\tif (node)\n\t\t\t{\n\t\t\t\tnodeKey = node.getKey();\n\t\t\t}\n\t\t});\n\n\t\tdataTransfer.setData(DRAG_DATA_FORMAT, nodeKey);\n\t\tthis.#isDragging = true;\n\n\t\tEvent.bind(document.body, 'drop', this.#bodyDragDropHandler);\n\t\tEvent.bind(document.body, 'dragover', this.#bodyDragOverHandler);\n\t}\n\n\t#handleDragEnd(event: DragEvent): void\n\t{\n\t\tthis.#isDragging = false;\n\t\tthis.#hideDropLine();\n\n\t\tEvent.unbind(document.body, 'drop', this.#bodyDragDropHandler);\n\t\tEvent.unbind(document.body, 'dragover', this.#bodyDragOverHandler);\n\t}\n\n\t#handleDragOver(event: DragEvent): boolean\n\t{\n\t\tif (this.#isDragging === false)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst hasFiles = event.dataTransfer.types.includes('Files');\n\t\tif (hasFiles || !(event.target instanceof HTMLElement))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst targetBlockElement = this.#findBlockElement(event);\n\t\tif (targetBlockElement === null)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.#lastTargetElement = targetBlockElement;\n\n\t\tthis.#showDropLine(targetBlockElement, event);\n\t\tevent.preventDefault();\n\n\t\treturn true;\n\t}\n\n\t#handleDragDrop(event: DragEvent): boolean\n\t{\n\t\tif (this.#isDragging === false)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst hasFiles = event.dataTransfer.types.includes('Files');\n\t\tconst dragData = event.dataTransfer?.getData(DRAG_DATA_FORMAT) || '';\n\t\tif (hasFiles || !(event.target instanceof HTMLElement) || !Type.isStringFilled(dragData))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst draggedNode = $getNodeByKey(dragData);\n\t\tif (!draggedNode || !(event.target instanceof HTMLElement))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst targetBlockElement = this.#findBlockElement(event) || this.#lastTargetElement;\n\t\tif (!targetBlockElement)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst targetNode = $getNearestNodeFromDOMNode(targetBlockElement);\n\t\tif (!targetNode)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tEvent.unbind(document.body, 'drop', this.#bodyDragDropHandler);\n\t\tEvent.unbind(document.body, 'dragover', this.#bodyDragOverHandler);\n\n\t\tif (targetNode === draggedNode)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst { top: targetBlockElemTop, height: targetBlockElemHeight } = targetBlockElement.getBoundingClientRect();\n\t\tconst shouldInsertAfter = event.clientY - targetBlockElemTop > targetBlockElemHeight / 2;\n\t\tif (shouldInsertAfter)\n\t\t{\n\t\t\ttargetNode.insertAfter(draggedNode);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-dom-methods\n\t\t\ttargetNode.insertBefore(draggedNode);\n\t\t}\n\n\t\tthis.#setDraggableBlockElement(null);\n\n\t\treturn true;\n\t}\n\n\t#showDropLine(targetBlockElement: HTMLElement, event: DragEvent)\n\t{\n\t\tconst { top: targetBlockElemTop, height: targetBlockElemHeight } = targetBlockElement.getBoundingClientRect();\n\t\tconst targetStyle: CSSStyleDeclaration = window.getComputedStyle(targetBlockElement);\n\t\tconst relativePosition: DOMRect = Dom.getRelativePosition(targetBlockElement, targetBlockElement.offsetParent);\n\n\t\tlet lineTop: number = relativePosition.top;\n\t\tconst showAtBottom = event.clientY - targetBlockElemTop > targetBlockElemHeight / 2;\n\t\tif (showAtBottom)\n\t\t{\n\t\t\tlineTop += targetBlockElemHeight + parseFloat(targetStyle.marginBottom) * 1.5;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlineTop += parseFloat(targetStyle.marginTop) / 2;\n\t\t}\n\n\t\tconst DROP_LINE_HALF_HEIGHT = 2;\n\t\tconst CONTENT_EDITABLE_AREA_PADDING = 16;\n\t\tconst top: number = lineTop - DROP_LINE_HALF_HEIGHT;\n\n\t\tDom.style(this.getDropLine(), {\n\t\t\topacity: 0.4,\n\t\t\tleft: `${CONTENT_EDITABLE_AREA_PADDING}px`,\n\t\t\tright: `${CONTENT_EDITABLE_AREA_PADDING}px`,\n\t\t\ttransform: `translateY(${top}px)`,\n\t\t});\n\t}\n\n\t#hideDropLine(): void\n\t{\n\t\tDom.style(this.getDropLine(), {\n\t\t\topacity: 0,\n\t\t\ttransform: 'translate(-10000px, -10000px)',\n\t\t});\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tDom.remove(this.getContainer());\n\t\tDom.remove(this.getDropLine());\n\t}\n}\n","import { Tag } from 'main.core';\nimport ToolbarItem from './toolbar-item';\n\nexport default class Separator extends ToolbarItem\n{\n\t#container: HTMLElement = null;\n\n\tgetContainer(): HTMLElement\n\t{\n\t\tif (this.#container === null)\n\t\t{\n\t\t\tthis.#container = Tag.render`<span class=\"ui-text-editor-toolbar-separator\"></span>`;\n\t\t}\n\n\t\treturn this.#container;\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\treturn this.getContainer();\n\t}\n}\n","/* eslint-disable no-underscore-dangle */\nimport { Dom, Tag, Type, Event } from 'main.core';\nimport { MemoryCache, type BaseCache } from 'main.core.cache';\n\nimport 'ui.icon-set.editor';\nimport { UNFORMATTED } from '../constants';\n\nimport {\n\tSELECTION_CHANGE_COMMAND,\n\tCOMMAND_PRIORITY_CRITICAL,\n\tBLUR_COMMAND,\n\tFOCUS_COMMAND,\n\t$getSelection,\n\t$isRangeSelection,\n\t$getRoot,\n\ttype RangeSelection,\n\ttype LexicalNode,\n\ttype ElementNode,\n} from 'ui.lexical.core';\n\nimport { $findMatchingParent, $getNearestNodeOfType, mergeRegister } from 'ui.lexical.utils';\nimport { $isListNode, ListNode } from 'ui.lexical.list';\nimport { $isAutoLinkNode, $isLinkNode } from 'ui.lexical.link';\nimport { $isCodeTokenNode } from '../plugins/code';\n\nimport { type TextEditor } from '../text-editor';\nimport { TextEditorLexicalNode } from '../types/text-editor-lexical-node';\nimport type { ToolbarOptions, ToolbarItem } from '../types/toolbar-options';\nimport Separator from './separator';\nimport Button from './button';\n\nimport './toolbar.css';\n\nexport default class Toolbar\n{\n\t#textEditor: TextEditor = null;\n\t#items: ToolbarItem[] = [];\n\t#rendered: boolean = false;\n\t#moreBtn: Button = null;\n\t#refs: BaseCache<HTMLElement> = new MemoryCache();\n\t#resizeObserver: ResizeObserver = null;\n\t#timeoutId: number = null;\n\t#removeListeners: Function = null;\n\n\tconstructor(textEditor: TextEditor, options: ToolbarOptions)\n\t{\n\t\tthis.#textEditor = textEditor;\n\n\t\tconst toolbarOptions: ToolbarOptions = Type.isArray(options) ? options : [];\n\t\tthis.#fillFromOptions(toolbarOptions);\n\n\t\tif (this.#items.length > 0)\n\t\t{\n\t\t\tthis.#removeListeners = this.#registerListeners();\n\t\t\tthis.#resizeObserver = new ResizeObserver(this.#handleResize.bind(this));\n\t\t}\n\t}\n\n\trenderTo(container: HTMLElement): void\n\t{\n\t\tif (this.isRendered())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Type.isElementNode(container))\n\t\t{\n\t\t\tthis.#items.forEach((item: ToolbarItem) => {\n\t\t\t\tDom.append(item.render(), this.getItemsContainer());\n\t\t\t});\n\n\t\t\tDom.append(this.getContainer(), container);\n\n\t\t\tif (this.#resizeObserver !== null)\n\t\t\t{\n\t\t\t\tthis.#resizeObserver.observe(this.getContainer());\n\t\t\t}\n\n\t\t\tthis.#rendered = true;\n\t\t}\n\t}\n\n\tisEmpty(): boolean\n\t{\n\t\treturn this.#items.length === 0;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-toolbar-container\">\n\t\t\t\t\t${this.getItemsContainer()}\n\t\t\t\t\t${this.getMoreBtnContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetItemsContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('items-container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-toolbar-items\"></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetMoreBtnContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('more-btn-container', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-toolbar-more-btn\">\n\t\t\t\t${this.getMoreBtn().render()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetMoreBtn(): Button\n\t{\n\t\tif (this.#moreBtn === null)\n\t\t{\n\t\t\tconst resetAnimation = () => {\n\t\t\t\tEvent.unbind(this.getItemsContainer(), 'transitionend', resetAnimation);\n\t\t\t\tDom.style(this.getItemsContainer(), { height: null });\n\t\t\t\tDom.removeClass(this.getItemsContainer(), '--animating');\n\t\t\t};\n\n\t\t\tthis.#moreBtn = new Button();\n\t\t\tthis.#moreBtn.setContent('<span class=\"ui-text-editor-toolbar-more-btn-icon\"></span>');\n\t\t\tthis.#moreBtn.subscribe('onClick', (): void => {\n\t\t\t\tEvent.unbind(this.getItemsContainer(), 'transitionend', resetAnimation);\n\n\t\t\t\tif (Dom.hasClass(this.getContainer(), '--expanded'))\n\t\t\t\t{\n\t\t\t\t\tDom.style(this.getItemsContainer(), { height: `${this.getItemsContainer().scrollHeight}px` });\n\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\tDom.removeClass(this.getContainer(), '--expanded');\n\t\t\t\t\t\tDom.addClass(this.getItemsContainer(), '--animating');\n\t\t\t\t\t\tDom.style(this.getItemsContainer(), { height: null });\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tDom.addClass(this.getItemsContainer(), '--animating');\n\t\t\t\t\tDom.style(this.getItemsContainer(), { height: `${this.getItemsContainer().scrollHeight}px` });\n\t\t\t\t\tDom.addClass(this.getContainer(), '--expanded');\n\t\t\t\t}\n\n\t\t\t\tEvent.bind(this.getItemsContainer(), 'transitionend', resetAnimation);\n\t\t\t});\n\t\t}\n\n\t\treturn this.#moreBtn;\n\t}\n\n\tgetItems(): ToolbarItem[]\n\t{\n\t\treturn this.#items;\n\t}\n\n\tisRendered(): boolean\n\t{\n\t\treturn this.#rendered;\n\t}\n\n\tdestroy(): boolean\n\t{\n\t\tif (this.#removeListeners !== null)\n\t\t{\n\t\t\tthis.#removeListeners();\n\t\t}\n\n\t\tif (this.#resizeObserver !== null)\n\t\t{\n\t\t\tthis.#resizeObserver.disconnect();\n\t\t\tthis.#resizeObserver = null;\n\t\t}\n\n\t\tif (this.isRendered())\n\t\t{\n\t\t\tDom.remove(this.getContainer());\n\t\t}\n\n\t\tif (this.#timeoutId)\n\t\t{\n\t\t\tclearTimeout(this.#timeoutId);\n\t\t}\n\n\t\tthis.#items = null;\n\t\tthis.#refs = null;\n\t}\n\n\t#registerListeners(): () => {}\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.#textEditor.registerCommand(\n\t\t\t\tSELECTION_CHANGE_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tthis.update();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t\tthis.#textEditor.registerCommand(\n\t\t\t\tFOCUS_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tif (this.#timeoutId)\n\t\t\t\t\t{\n\t\t\t\t\t\tclearTimeout(this.#timeoutId);\n\t\t\t\t\t\tthis.#timeoutId = null;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t\tthis.#textEditor.registerCommand(\n\t\t\t\tBLUR_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tif (this.#timeoutId)\n\t\t\t\t\t{\n\t\t\t\t\t\tclearTimeout(this.#timeoutId);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#timeoutId = setTimeout((): void => {\n\t\t\t\t\t\tconst activeElement = document.activeElement;\n\t\t\t\t\t\tconst rootElement = this.#textEditor.getScrollerContainer();\n\t\t\t\t\t\tif (activeElement === null || !rootElement.contains(activeElement))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.reset();\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 400);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t\tthis.#textEditor.registerUpdateListener(() => {\n\t\t\t\tthis.update();\n\t\t\t}),\n\t\t\tthis.#textEditor.registerEditableListener(() => {\n\t\t\t\tthis.update();\n\t\t\t}),\n\t\t);\n\t}\n\n\t#fillFromOptions(options: ToolbarOptions)\n\t{\n\t\toptions.forEach((item: ToolbarItem) => {\n\t\t\tif (item === '|')\n\t\t\t{\n\t\t\t\tthis.#items.push(new Separator());\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst component = this.#textEditor.getComponentRegistry().create(item);\n\t\t\t\tif (component === null)\n\t\t\t\t{\n\t\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\t\tconsole.warn(`TextEditor Toolbar: \"${item}\" component doesn't exist.`);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#items.push(component);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t#handleResize(entries: ResizeObserverEntry[])\n\t{\n\t\tif (this.getContainer().offsetWidth === 0 || Dom.hasClass(this.getItemsContainer(), '--animating'))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst lastItem: ?ToolbarItem = this.#items.at(-1);\n\t\tif (!lastItem || lastItem.getContainer().offsetTop >= lastItem.getContainer().offsetHeight)\n\t\t{\n\t\t\tDom.addClass(this.getContainer(), '--overflowed');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.getContainer(), ['--overflowed', '--expanded']);\n\t\t}\n\t}\n\n\tupdate(): void\n\t{\n\t\tthis.#textEditor.getEditorState().read((): void => {\n\t\t\tlet selection: RangeSelection = $getSelection();\n\t\t\tif (!$isRangeSelection(selection))\n\t\t\t{\n\t\t\t\tselection = null;\n\t\t\t}\n\n\t\t\tlet unformattedNode = null;\n\t\t\tif (selection !== null)\n\t\t\t{\n\t\t\t\tunformattedNode = $findMatchingParent(\n\t\t\t\t\tselection.anchor.getNode(),\n\t\t\t\t\t(node: TextEditorLexicalNode): boolean => {\n\t\t\t\t\t\treturn (node.__flags & UNFORMATTED) !== 0;\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst blockTypes: Set<string> = selection === null ? new Set() : this.#getSelectionBlockTypes(selection);\n\t\t\tconst isReadOnly: boolean = !this.#textEditor.isEditable();\n\n\t\t\tthis.#items.forEach((item: Button) => {\n\t\t\t\tif (!(item instanceof Button))\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// First let's figure out a disabled status\n\t\t\t\tif (item.hasOwnDisableCallback())\n\t\t\t\t{\n\t\t\t\t\titem.setDisabled(item.invokeDisableCallback());\n\t\t\t\t}\n\t\t\t\telse if (isReadOnly)\n\t\t\t\t{\n\t\t\t\t\titem.disable();\n\t\t\t\t}\n\t\t\t\telse if (unformattedNode !== null && item.shouldDisableInsideUnformatted())\n\t\t\t\t{\n\t\t\t\t\titem.disable();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\titem.enable();\n\t\t\t\t}\n\n\t\t\t\t// Now set an active status\n\t\t\t\tif (item.isDisabled())\n\t\t\t\t{\n\t\t\t\t\titem.setActive(false);\n\t\t\t\t}\n\t\t\t\telse if (item.hasFormat())\n\t\t\t\t{\n\t\t\t\t\tconst format = item.getFormat();\n\t\t\t\t\titem.setActive(selection === null ? false : selection.hasFormat(format));\n\t\t\t\t}\n\t\t\t\telse if (item.getBlockType() !== null)\n\t\t\t\t{\n\t\t\t\t\titem.setActive(blockTypes.has(item.getBlockType()));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\treset(): void\n\t{\n\t\tthis.#items.forEach((item: Button) => {\n\t\t\tif (item instanceof Button)\n\t\t\t{\n\t\t\t\titem.setActive(false);\n\t\t\t}\n\t\t});\n\t}\n\n\t#getSelectionBlockTypes(selection: RangeSelection): Set<string>\n\t{\n\t\tconst anchorNode = selection.anchor.getNode();\n\t\tconst blockTypes = new Set();\n\t\tlet currentNode: ElementNode | LexicalNode | null = anchorNode;\n\t\twhile (currentNode !== $getRoot() && currentNode !== null)\n\t\t{\n\t\t\tconst blockType = this.#getBlockType(currentNode);\n\t\t\tblockTypes.add(blockType);\n\t\t\tcurrentNode = currentNode.getParent();\n\t\t}\n\n\t\treturn blockTypes;\n\t}\n\n\t#getBlockType(node: LexicalNode): string | null\n\t{\n\t\tif ($isListNode(node))\n\t\t{\n\t\t\tconst listNode: ListNode = node;\n\t\t\tconst parentList = $getNearestNodeOfType(listNode, ListNode);\n\n\t\t\treturn parentList ? parentList.getListType() : listNode.getListType();\n\t\t}\n\n\t\tif ($isLinkNode(node) || $isAutoLinkNode(node))\n\t\t{\n\t\t\treturn 'link';\n\t\t}\n\n\t\tif ($isCodeTokenNode(node))\n\t\t{\n\t\t\treturn 'code';\n\t\t}\n\n\t\treturn node.getType();\n\t}\n}\n","/*\neslint-disable no-underscore-dangle,\n@bitrix24/bitrix24-rules/no-pseudo-private,\n@bitrix24/bitrix24-rules/no-native-dom-methods\n*/\n\nimport { Tag, Runtime, Event } from 'main.core';\nimport { Popup } from 'main.popup';\nimport { DIALOG_VISIBILITY_COMMAND, HIDE_DIALOG_COMMAND } from '../../commands';\nimport { UNFORMATTED } from '../../constants';\nimport { $adjustDialogPosition, clearDialogPosition } from '../../helpers/adjust-dialog-position';\nimport { getSelectedNode } from '../../helpers/get-selected-node';\n\nimport Toolbar from '../../toolbar/toolbar';\n\nimport {\n\t$isTextNode,\n\t$getSelection,\n\t$isRangeSelection,\n\tSELECTION_CHANGE_COMMAND,\n\tCOMMAND_PRIORITY_CRITICAL,\n\tCOMMAND_PRIORITY_LOW,\n\ttype RangeSelection,\n} from 'ui.lexical.core';\n\nimport { $findMatchingParent, mergeRegister } from 'ui.lexical.utils';\nimport { TextEditorLexicalNode } from '../../types/text-editor-lexical-node';\n\nimport BasePlugin from '../base-plugin';\nimport { type TextEditor } from '../../text-editor';\n\nexport class FloatingToolbarPlugin extends BasePlugin\n{\n\t#popup: Popup = null;\n\t#toolbar: Toolbar = null;\n\t#showDebounced: Function = null;\n\t#onEditorScroll: Function = this.#handleEditorScroll.bind(this);\n\n\tconstructor(editor: TextEditor)\n\t{\n\t\tsuper(editor);\n\n\t\tthis.#showDebounced = Runtime.debounce(() => {\n\t\t\tthis.getEditor().update(() => {\n\t\t\t\tif (this.#shouldShowDialog())\n\t\t\t\t{\n\t\t\t\t\tthis.#show();\n\t\t\t\t}\n\t\t\t});\n\t\t}, 700);\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'FloatingToolbar';\n\t}\n\n\tafterInit(): void\n\t{\n\t\tconst toolbarOptions = this.getEditor().getOption('floatingToolbar', []);\n\t\tthis.#toolbar = new Toolbar(this.getEditor(), toolbarOptions);\n\t\tif (!this.#toolbar.isEmpty())\n\t\t{\n\t\t\tthis.cleanUpRegister(\n\t\t\t\tthis.#registerListeners(),\n\t\t\t);\n\t\t}\n\t}\n\n\t#registerListeners(): () => void\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tSELECTION_CHANGE_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tthis.update();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t\tthis.getEditor().registerUpdateListener(({ editorState }) => {\n\t\t\t\teditorState.read(() => {\n\t\t\t\t\tthis.update();\n\t\t\t\t});\n\t\t\t}),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_DIALOG_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tthis.hide();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n\n\tupdate(): void\n\t{\n\t\tif (this.#shouldShowDialog())\n\t\t{\n\t\t\tif (this.getPopup().isShown())\n\t\t\t{\n\t\t\t\tthis.#show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#showDebounced();\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getPopup().close();\n\t\t}\n\t}\n\n\t#show()\n\t{\n\t\tthis.getPopup().show();\n\t\tclearDialogPosition(this.getPopup());\n\t\tthis.#adjustDialogPosition();\n\t}\n\n\t#adjustDialogPosition(): boolean\n\t{\n\t\treturn $adjustDialogPosition(\n\t\t\tthis.getPopup(),\n\t\t\tthis.getEditor(),\n\t\t\tthis.#initDialogPosition,\n\t\t);\n\t}\n\n\t#initDialogPosition(selectionPosition: Object): string\n\t{\n\t\tconst { isBackward, isMultiline } = selectionPosition;\n\n\t\treturn isBackward || !isMultiline ? 'top' : 'bottom';\n\t}\n\n\t#handleEditorScroll(): void\n\t{\n\t\tthis.getEditor().update(() => {\n\t\t\tthis.#adjustDialogPosition();\n\t\t});\n\t}\n\n\t#shouldShowDialog(): boolean\n\t{\n\t\tif (this.getEditor().isComposing() || !this.getEditor().isEditable())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst selection: RangeSelection = $getSelection();\n\t\tif (!$isRangeSelection(selection) || selection.isCollapsed())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst nativeSelection = window.getSelection();\n\t\tif (nativeSelection === null || nativeSelection.isCollapsed)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst scrollerContainer = this.getEditor().getScrollerContainer();\n\t\tif (!scrollerContainer.contains(nativeSelection.anchorNode))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst $isUnformatted = $findMatchingParent(\n\t\t\tselection.anchor.getNode(),\n\t\t\t(node: TextEditorLexicalNode) => {\n\t\t\t\treturn (node.__flags & UNFORMATTED) !== 0;\n\t\t\t},\n\t\t);\n\n\t\tif ($isUnformatted || selection.getTextContent() === '')\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst rawTextContent = selection.getTextContent().replaceAll('\\n', '');\n\t\tif (!selection.isCollapsed() && rawTextContent === '')\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst isSomeDialogVisible = this.getEditor().dispatchCommand(DIALOG_VISIBILITY_COMMAND);\n\t\tif (isSomeDialogVisible)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst node = getSelectedNode(selection);\n\n\t\treturn $isTextNode(node);\n\t}\n\n\tgetPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tconst container = Tag.render`<div class=\"ui-text-editor-floating-toolbar\"></div>`;\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tcloseByEsc: true,\n\t\t\t\t// for an embedded popup: document.body -> this.getEditor().getScrollerContainer()\n\t\t\t\ttargetContainer: document.body,\n\t\t\t\tautoHide: true,\n\t\t\t\tcontent: container,\n\t\t\t\tautoHideHandler: (event: MouseEvent): boolean => {\n\t\t\t\t\tlet collapsed = true;\n\t\t\t\t\tconst nativeSelection = window.getSelection();\n\t\t\t\t\tif (nativeSelection.isCollapsed)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.getEditor().update(() => {\n\t\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\t\tcollapsed = selection === null || selection.isCollapsed();\n\t\t\t\t\t});\n\n\t\t\t\t\treturn collapsed;\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tonShow: () => {\n\t\t\t\t\t\tif (this.#adjustDialogPosition())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tEvent.bind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tEvent.unbind(this.getEditor().getScrollerContainer(), 'scroll', this.#onEditorScroll);\n\t\t\t\t\t\tclearDialogPosition(this.getPopup());\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.#toolbar.renderTo(container);\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\thide()\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.getPopup().close();\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\n\t\tif (this.#popup !== null)\n\t\t{\n\t\t\tthis.#popup.destroy();\n\t\t\tthis.#popup = null;\n\t\t}\n\n\t\tthis.#toolbar.destroy();\n\t\tthis.#toolbar = null;\n\t}\n}\n","import { Dom } from 'main.core';\nimport {\n\tCOMMAND_PRIORITY_LOW,\n\tcreateCommand,\n\ttype LexicalCommand,\n} from 'ui.lexical.core';\n\nimport Toolbar from '../../toolbar/toolbar';\nimport BasePlugin from '../base-plugin';\n\nexport const TOGGLE_TOOLBAR_COMMAND: LexicalCommand<void> = createCommand('TOGGLE_TOOLBAR_COMMAND');\nexport const SHOW_TOOLBAR_COMMAND: LexicalCommand<void> = createCommand('SHOW_TOOLBAR_COMMAND');\nexport const HIDE_TOOLBAR_COMMAND: LexicalCommand<void> = createCommand('HIDE_TOOLBAR_COMMAND');\n\nexport class ToolbarPlugin extends BasePlugin\n{\n\t#toolbar: Toolbar = null;\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Toolbar';\n\t}\n\n\tgetToolbar(): Toolbar\n\t{\n\t\treturn this.#toolbar;\n\t}\n\n\tisRendered(): boolean\n\t{\n\t\treturn this.#toolbar !== null && this.#toolbar.isRendered();\n\t}\n\n\tshow(): void\n\t{\n\t\tif (this.isRendered())\n\t\t{\n\t\t\tDom.removeClass(this.getEditor().getToolbarContainer(), '--hidden');\n\t\t}\n\t}\n\n\thide(): void\n\t{\n\t\tif (this.isRendered())\n\t\t{\n\t\t\tDom.addClass(this.getEditor().getToolbarContainer(), '--hidden');\n\t\t}\n\t}\n\n\tisShown(): boolean\n\t{\n\t\treturn this.isRendered() && !Dom.hasClass(this.getEditor().getToolbarContainer(), '--hidden');\n\t}\n\n\ttoggle(): void\n\t{\n\t\tif (this.isShown())\n\t\t{\n\t\t\tthis.hide();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.show();\n\t\t}\n\t}\n\n\tafterInit(): void\n\t{\n\t\tthis.#toolbar = new Toolbar(this.getEditor(), this.getEditor().getOption('toolbar'));\n\t\tif (!this.#toolbar.isEmpty())\n\t\t{\n\t\t\tthis.#registerCommands();\n\n\t\t\tthis.#toolbar.renderTo(this.getEditor().getToolbarContainer());\n\t\t\tconst hideToolbar = this.getEditor().getOption('hideToolbar', false);\n\t\t\tif (hideToolbar)\n\t\t\t{\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t}\n\t}\n\n\tdestroy(): void\n\t{\n\t\tsuper.destroy();\n\t\tthis.#toolbar.destroy();\n\t}\n\n\t#registerCommands(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tTOGGLE_TOOLBAR_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tthis.toggle();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tSHOW_TOOLBAR_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tthis.show();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tHIDE_TOOLBAR_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tthis.hide();\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\t\t);\n\t}\n}\n","import { Type, Dom, Tag, Text, Loc } from 'main.core';\nimport BasePlugin from '../base-plugin';\n\nimport {\n\t$getSelection,\n\t$isRangeSelection,\n\t$isRootNode,\n\t$isParagraphNode,\n\tSELECTION_CHANGE_COMMAND,\n\tCOMMAND_PRIORITY_CRITICAL,\n\tBLUR_COMMAND,\n\tPASTE_COMMAND,\n\ttype RangeSelection,\n\ttype ParagraphNode,\n} from 'ui.lexical.core';\n\nimport { $canShowPlaceholder } from 'ui.lexical.text';\n\nimport type { CopilotPlugin } from '../copilot';\nimport type { MentionPlugin } from '../mention';\n\nimport './placeholder.css';\n\nexport class PlaceholderPlugin extends BasePlugin\n{\n\t#placeholder: string = null;\n\t#placeholderNode: HTMLElement = null;\n\t#paragraphPlaceholder: string = null;\n\n\tafterInit()\n\t{\n\t\tconst placeholder = this.getEditor().getOption('placeholder');\n\t\tif (Type.isStringFilled(placeholder))\n\t\t{\n\t\t\tthis.#placeholder = placeholder;\n\t\t\tthis.#placeholderNode = Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-placeholder\">${Text.encode(this.#placeholder)}</div>\n\t\t\t`;\n\n\t\t\tDom.append(this.#placeholderNode, this.getEditor().getScrollerContainer());\n\n\t\t\tthis.#registerPlaceholderListeners();\n\t\t}\n\n\t\tlet paragraphPlaceholder = this.getEditor().getOption('paragraphPlaceholder');\n\t\tif (Type.isStringFilled(paragraphPlaceholder))\n\t\t{\n\t\t\tif (paragraphPlaceholder === 'auto')\n\t\t\t{\n\t\t\t\tconst copilotPlugin: CopilotPlugin = this.getEditor().getPlugin('Copilot');\n\t\t\t\tconst copilotEnabled = copilotPlugin !== null && copilotPlugin.shouldTriggerBySpace();\n\t\t\t\tconst mentionPlugin: MentionPlugin = this.getEditor().getPlugin('Mention');\n\t\t\t\tconst mentionEnabled = mentionPlugin !== null && mentionPlugin.shouldTriggerByAtSign();\n\t\t\t\tif (copilotEnabled && mentionEnabled)\n\t\t\t\t{\n\t\t\t\t\tparagraphPlaceholder = Loc.getMessage('TEXT_EDITOR_PLACEHOLDER_MENTION_COPILOT');\n\t\t\t\t}\n\t\t\t\telse if (copilotEnabled)\n\t\t\t\t{\n\t\t\t\t\tparagraphPlaceholder = Loc.getMessage('TEXT_EDITOR_PLACEHOLDER_COPILOT');\n\t\t\t\t}\n\t\t\t\telse if (mentionEnabled)\n\t\t\t\t{\n\t\t\t\t\tparagraphPlaceholder = Loc.getMessage('TEXT_EDITOR_PLACEHOLDER_MENTION');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (paragraphPlaceholder !== 'auto')\n\t\t\t{\n\t\t\t\tthis.#paragraphPlaceholder = paragraphPlaceholder;\n\t\t\t\tthis.#registerParagraphListeners();\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic getName(): string\n\t{\n\t\treturn 'Placeholder';\n\t}\n\n\t#registerPlaceholderListeners(): void\n\t{\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerUpdateListener(() => {\n\t\t\t\tthis.getEditor().getEditorState().read(() => {\n\t\t\t\t\tthis.#togglePlaceholder();\n\t\t\t\t});\n\t\t\t}),\n\t\t);\n\t}\n\n\t#togglePlaceholder(): void\n\t{\n\t\tif (this.#placeholder === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet canShowPlaceholder = $canShowPlaceholder(this.getLexicalEditor().isComposing());\n\t\tif (canShowPlaceholder && this.#paragraphPlaceholder !== null && this.#hasFocus())\n\t\t{\n\t\t\tcanShowPlaceholder = false;\n\t\t}\n\n\t\tif (canShowPlaceholder)\n\t\t{\n\t\t\tDom.addClass(this.#placeholderNode, '--shown');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.removeClass(this.#placeholderNode, '--shown');\n\t\t}\n\t}\n\n\t#hasFocus(): boolean\n\t{\n\t\tconst activeElement = document.activeElement;\n\t\tconst rootElement = this.getEditor().getRootElement();\n\n\t\treturn rootElement !== null && activeElement !== null && rootElement.contains(activeElement);\n\t}\n\n\t#hidePlaceholder(): void\n\t{\n\t\tif (this.#placeholderNode !== null)\n\t\t{\n\t\t\tDom.removeClass(this.#placeholderNode, '--shown');\n\t\t}\n\t}\n\n\t#registerParagraphListeners(): void\n\t{\n\t\tlet lastEmptyParagraph: ParagraphNode = null;\n\t\tconst resetParagraphPlaceholder = () => {\n\t\t\tif (lastEmptyParagraph)\n\t\t\t{\n\t\t\t\tconst htmlElement: HTMLParagraphElement | null = this.getEditor().getElementByKey(lastEmptyParagraph.getKey());\n\t\t\t\tif (htmlElement)\n\t\t\t\t{\n\t\t\t\t\tdelete htmlElement.dataset.placeholder;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tthis.cleanUpRegister(\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tSELECTION_CHANGE_COMMAND,\n\t\t\t\t() => {\n\t\t\t\t\tif (!this.getEditor().isEditable())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\t\t\tlet currentParagraph: ParagraphNode | null = null;\n\t\t\t\t\tif ($isRangeSelection(selection) && selection.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tconst node = selection.anchor.getNode();\n\t\t\t\t\t\tif ($isParagraphNode(node) && $isRootNode(node.getParent()) && node.isEmpty())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst htmlElement: HTMLParagraphElement | null = this.getEditor().getElementByKey(node.getKey());\n\t\t\t\t\t\t\tif (htmlElement && this.#hasFocus())\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\thtmlElement.dataset.placeholder = this.#paragraphPlaceholder;\n\t\t\t\t\t\t\t\tcurrentParagraph = node;\n\t\t\t\t\t\t\t\tthis.#hidePlaceholder();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (lastEmptyParagraph && lastEmptyParagraph !== currentParagraph)\n\t\t\t\t\t{\n\t\t\t\t\t\tresetParagraphPlaceholder();\n\t\t\t\t\t}\n\n\t\t\t\t\tlastEmptyParagraph = currentParagraph;\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tPASTE_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tresetParagraphPlaceholder();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t\t// this.getEditor().registerCommand(\n\t\t\t// \tFOCUS_COMMAND,\n\t\t\t// \t(): boolean => {\n\t\t\t// \t\tresetParagraphPlaceholder();\n\t\t\t//\n\t\t\t// \t\treturn false;\n\t\t\t// \t},\n\t\t\t// \tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t// ),\n\t\t\tthis.getEditor().registerCommand(\n\t\t\t\tBLUR_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tresetParagraphPlaceholder();\n\t\t\t\t\tthis.#togglePlaceholder();\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\t\t);\n\t}\n}\n","/* eslint-disable @bitrix24/bitrix24-rules/no-native-dom-methods */\nimport { Tag, Dom, Type, Cache, Event, Browser, Text } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { SettingsCollection } from 'main.core.collections';\nimport { DefaultBBCodeScheme, type BBCodeScheme } from 'ui.bbcode.model';\nimport { createDOMRange, createRectsFromDOMRange } from 'ui.lexical.selection';\nimport { HIDE_DIALOG_COMMAND } from './commands';\nimport { NewLineMode } from './constants';\nimport { createHashCode } from './helpers/create-hash-code';\nimport { $isRootEmpty } from './helpers/is-root-empty';\n\nimport { defaultTheme } from './themes/default-theme';\nimport PluginCollection from './plugins/plugin-collection';\nimport ComponentRegistry from './component-registry';\nimport SchemeValidation from './scheme-validation';\nimport BasePlugin from './plugins/base-plugin';\n\nimport { RichTextPlugin } from './plugins/rich-text';\nimport { ParagraphPlugin } from './plugins/paragraph';\nimport { ClipboardPlugin } from './plugins/clipboard';\nimport { BoldPlugin } from './plugins/bold';\nimport { ItalicPlugin } from './plugins/italic';\nimport { StrikethroughPlugin } from './plugins/strikethrough';\nimport { UnderlinePlugin } from './plugins/underline';\nimport { ClearFormatPlugin } from './plugins/clear-format';\nimport { MentionPlugin } from './plugins/mention';\nimport { CodePlugin } from './plugins/code';\nimport { QuotePlugin } from './plugins/quote';\nimport { LinkPlugin } from './plugins/link';\nimport { AutoLinkPlugin } from './plugins/auto-link';\nimport { TabIndentPlugin } from './plugins/tab-indent';\nimport { ListPlugin } from './plugins/list';\nimport { ImagePlugin } from './plugins/image';\nimport { VideoPlugin } from './plugins/video';\nimport { SmileyPlugin } from './plugins/smiley';\nimport { SpoilerPlugin } from './plugins/spoiler';\nimport { TablePlugin } from './plugins/table';\nimport { HashtagPlugin } from './plugins/hashtag';\nimport { CopilotPlugin } from './plugins/copilot';\nimport { HistoryPlugin } from './plugins/history';\nimport { BlockToolbarPlugin } from './plugins/block-toolbar';\nimport { FloatingToolbarPlugin } from './plugins/floating-toolbar';\nimport { ToolbarPlugin } from './plugins/toolbar';\nimport { PlaceholderPlugin } from './plugins/placeholder';\nimport { FilePlugin } from './plugins/file';\n\nimport {\n\t$importFromBBCode,\n\t$exportToBBCode,\n\ttype BBCodeImportMap,\n\ttype BBCodeExportConversion,\n\ttype BBCodeImportConversion,\n\ttype BBCodeExportMap,\n} from './bbcode';\n\nimport {\n\tcreateEditor,\n\t$getRoot,\n\t$createParagraphNode,\n\t$getSelection,\n\t$isRangeSelection,\n\t$getNearestNodeFromDOMNode,\n\t$setSelection,\n\tFOCUS_COMMAND,\n\tBLUR_COMMAND,\n\tKEY_ENTER_COMMAND,\n\tCOMMAND_PRIORITY_LOW,\n\tCOMMAND_PRIORITY_CRITICAL,\n\tCLEAR_HISTORY_COMMAND,\n\ttype LexicalEditor,\n\ttype NodeKey,\n\ttype RootNode,\n\ttype LexicalNode,\n\ttype RangeSelection,\n\ttype EditorThemeClasses,\n\ttype EditorState,\n} from 'ui.lexical.core';\n\nimport { $findMatchingParent, mergeRegister } from 'ui.lexical.utils';\n\nimport type DecoratorComponent from './decorator-component';\nimport type { PluginConstructor } from './plugins/base-plugin';\nimport type { ClearOptions } from './types/clear-options';\nimport type { InitialEditorStateType } from './types/initial-editor-state-type';\nimport type { SetTextOptions } from './types/set-text-options';\nimport type { TextEditorOptions } from './types/text-editor-options';\nimport type { DecoratorOptions } from './types/decorator-options';\nimport type { NewLineModeType } from './types/new-line-mode-type';\n\nconst CollapsingState = {\n\tCOLLAPSED: 'collapsed',\n\tCOLLAPSING: 'collapsing',\n\tEXPANDED: 'expanded',\n\tEXPANDING: 'expanding',\n};\n\nimport './css/layout.css';\n\n/**\n * @memberof BX.UI.TextEditor\n */\nexport class TextEditor extends EventEmitter\n{\n\t#lexicalEditor: LexicalEditor = null;\n\t#componentRegistry: ComponentRegistry = new ComponentRegistry();\n\t#refs: typeof(Cache.MemoryCache) = new Cache.MemoryCache();\n\t#options: SettingsCollection = null;\n\t#plugins: PluginCollection = null;\n\t#newLineMode: NewLineModeType = NewLineMode.MIXED;\n\t#bbcodeScheme: BBCodeScheme = null;\n\t#schemeValidation: SchemeValidation = null;\n\t#bbcodeImportMap: BBCodeImportMap;\n\t#bbcodeExportMap: BBCodeExportMap;\n\t#themeClasses: EditorThemeClasses = {};\n\n\t#decoratorNodes: Set<NodeKey> = new Set();\n\t#decoratorComponents: Map<string, DecoratorComponent> = new Map();\n\t#removeListeners: Function = null;\n\n\t#highlightContainer = Tag.render`<div class=\"ui-text-editor-selection-highlighting\"></div>`;\n\t#autoFocus: boolean = false;\n\t#minHeight: Number | null = null;\n\t#maxHeight: Number | null = null;\n\n\t#collapsingMode: boolean = false;\n\t#collapsingState: string = CollapsingState.EXPANDED;\n\t#collapsingTransitionEnd: Function = this.#handleCollapsingTransition.bind(this);\n\t#paragraphHeight: number = null;\n\n\t#resizeObserver: ResizeObserver = null;\n\t#destroying: boolean = false;\n\t#rendered: boolean = false;\n\t#prevEmptyStatus: boolean = true;\n\n\tconstructor(editorOptions: TextEditorOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.UI.TextEditor.Editor');\n\n\t\tconst defaultOptions: TextEditorOptions = this.constructor.getDefaultOptions();\n\t\tconst options: TextEditorOptions = Type.isPlainObject(editorOptions) ? editorOptions : {};\n\t\tthis.#options = new SettingsCollection({ ...defaultOptions, ...options });\n\n\t\tconst builtinPlugins = [...this.constructor.getBuiltinPlugins()];\n\t\tconst plugins: Array<string | PluginConstructor> = this.#options.get('plugins', builtinPlugins);\n\t\tconst extraPlugins: Array<PluginConstructor> = this.#options.get('extraPlugins', []);\n\t\tconst pluginsToRemove: Array<PluginConstructor> = this.#options.get('removePlugins', []);\n\n\t\tconst newLineMode = this.#options.get('newLineMode');\n\t\tif ([NewLineMode.LINE_BREAK, NewLineMode.PARAGRAPH].includes(newLineMode))\n\t\t{\n\t\t\tthis.#newLineMode = newLineMode;\n\t\t}\n\n\t\tthis.#themeClasses = defaultTheme;\n\n\t\tthis.#plugins = new PluginCollection(builtinPlugins, [...plugins, ...extraPlugins], pluginsToRemove);\n\t\tconst constructors = this.#plugins.getConstructors();\n\t\tconst nodes = constructors.map((pluginConstructor: PluginConstructor) => {\n\t\t\treturn pluginConstructor.getNodes(this);\n\t\t});\n\n\t\tthis.#lexicalEditor = createEditor({\n\t\t\t// uses when you copy-paste from one to another editor\n\t\t\tnamespace: Type.isStringFilled(options.namespace) ? options.namespace : this.#createNamespace(constructors),\n\t\t\tnodes: nodes.flat(),\n\t\t\tonError: (error: Error) => {\n\t\t\t\tconsole.error(error);\n\t\t\t},\n\t\t\ttheme: this.#themeClasses,\n\t\t\teditable: this.#options.get('editable') !== false,\n\t\t});\n\n\t\tthis.setMinHeight(options.minHeight);\n\t\tthis.setMaxHeight(options.maxHeight);\n\t\tthis.setAutoFocus(options.autoFocus);\n\t\tthis.setVisualOptions(options.visualOptions);\n\n\t\tthis.#removeListeners = mergeRegister(\n\t\t\tthis.#registerCommands(),\n\t\t\tthis.#initDecorateNodes(nodes.flat()),\n\t\t);\n\n\t\tthis.#plugins.init(this);\n\n\t\tthis.#bbcodeImportMap = this.#initBBCodeImportMap();\n\t\tthis.#bbcodeExportMap = this.#initBBCodeExportMap();\n\t\tthis.#bbcodeScheme = this.#initBBCodeScheme();\n\t\tthis.#schemeValidation = new SchemeValidation(this);\n\n\t\tthis.subscribeFromOptions(options.events);\n\t}\n\n\tstatic getBuiltinPlugins(): Class<BasePlugin>[]\n\t{\n\t\treturn [\n\t\t\tRichTextPlugin,\n\t\t\tParagraphPlugin,\n\t\t\tClipboardPlugin,\n\t\t\tBoldPlugin,\n\t\t\tUnderlinePlugin,\n\t\t\tItalicPlugin,\n\t\t\tStrikethroughPlugin,\n\t\t\tClearFormatPlugin,\n\t\t\tTabIndentPlugin,\n\t\t\tCodePlugin,\n\t\t\tQuotePlugin,\n\t\t\tListPlugin,\n\t\t\tMentionPlugin,\n\t\t\tLinkPlugin,\n\t\t\tAutoLinkPlugin,\n\t\t\tImagePlugin,\n\t\t\tVideoPlugin,\n\t\t\tSmileyPlugin,\n\t\t\tSpoilerPlugin,\n\t\t\tTablePlugin,\n\t\t\tHashtagPlugin,\n\t\t\tCopilotPlugin,\n\t\t\tHistoryPlugin,\n\t\t\tBlockToolbarPlugin,\n\t\t\tFloatingToolbarPlugin,\n\t\t\tToolbarPlugin,\n\t\t\tPlaceholderPlugin,\n\t\t\tFilePlugin,\n\t\t];\n\t}\n\n\tstatic getDefaultOptions(): TextEditorOptions\n\t{\n\t\treturn {};\n\t}\n\n\tgetComponentRegistry(): ComponentRegistry\n\t{\n\t\treturn this.#componentRegistry;\n\t}\n\n\tgetOptions(): SettingsCollection\n\t{\n\t\treturn this.#options;\n\t}\n\n\tgetOption(path: string, defaultValue: any = null): any\n\t{\n\t\treturn this.#options.get(path, defaultValue);\n\t}\n\n\tgetThemeClasses(): EditorThemeClasses\n\t{\n\t\treturn this.#themeClasses;\n\t}\n\n\tgetThemeClass(tagName: string): string\n\t{\n\t\tconst className = this.#themeClasses[tagName];\n\t\tif (className !== undefined)\n\t\t{\n\t\t\treturn className;\n\t\t}\n\n\t\treturn '';\n\t}\n\n\tgetNewLineMode(): NewLineModeType\n\t{\n\t\treturn this.#newLineMode;\n\t}\n\n\t#initEditorState(initialEditorState?: InitialEditorStateType, options?: SetTextOptions): void\n\t{\n\t\tif (Type.isNil(initialEditorState))\n\t\t{\n\t\t\tthis.#lexicalEditor.update(() => {\n\t\t\t\tconst root = $getRoot();\n\t\t\t\tif (root.isEmpty())\n\t\t\t\t{\n\t\t\t\t\tconst paragraph = $createParagraphNode();\n\t\t\t\t\troot.append(paragraph);\n\t\t\t\t}\n\t\t\t}, options);\n\t\t}\n\t\telse if (Type.isPlainObject(initialEditorState) || Type.isStringFilled(initialEditorState))\n\t\t{\n\t\t\tconst parsedEditorState: EditorState = this.#lexicalEditor.parseEditorState(initialEditorState);\n\t\t\tthis.#lexicalEditor.setEditorState(parsedEditorState);\n\t\t}\n\t\telse if (Type.isFunction(initialEditorState))\n\t\t{\n\t\t\tthis.#lexicalEditor.update(() => {\n\t\t\t\tconst root = $getRoot();\n\t\t\t\tif (root.isEmpty())\n\t\t\t\t{\n\t\t\t\t\tinitialEditorState(this.#lexicalEditor);\n\t\t\t\t}\n\t\t\t}, options);\n\t\t}\n\t}\n\n\t#initDecorateNodes(editorNodes: Class<LexicalNode>[]): () => void\n\t{\n\t\tconst removeListeners = [];\n\t\teditorNodes.forEach((nodeClass) => {\n\t\t\tif (nodeClass.useDecoratorComponent)\n\t\t\t{\n\t\t\t\tconst removeListener = this.registerMutationListener(\n\t\t\t\t\tnodeClass,\n\t\t\t\t\t(nodes, payload) => {\n\t\t\t\t\t\tfor (const [key, val] of nodes)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (val === 'destroyed')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst component: DecoratorComponent = this.#decoratorComponents.get(key);\n\t\t\t\t\t\t\t\tif (component)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tcomponent.destroy();\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.#decoratorComponents.delete(key);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.#decoratorNodes.add(key);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\tremoveListeners.push(removeListener);\n\t\t\t}\n\t\t});\n\n\t\tconst removeListener = this.#lexicalEditor.registerDecoratorListener(\n\t\t\t(decorators: Record<NodeKey, DecoratorOptions>) => {\n\t\t\t\tthis.#decoratorNodes.forEach((nodeKey) => {\n\t\t\t\t\tconst decorator = decorators[nodeKey];\n\t\t\t\t\tconst {\n\t\t\t\t\t\tcomponentClass: DecoratorClass,\n\t\t\t\t\t\toptions: decoratorOptions,\n\t\t\t\t\t} = decorator;\n\n\t\t\t\t\tconst component = this.#decoratorComponents.get(nodeKey);\n\t\t\t\t\tconst htmlElement = this.#lexicalEditor.getElementByKey(nodeKey);\n\t\t\t\t\tif (htmlElement?.innerHTML && component)\n\t\t\t\t\t{\n\t\t\t\t\t\tcomponent.update(decoratorOptions);\n\t\t\t\t\t}\n\t\t\t\t\telse if (htmlElement)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#decoratorComponents.set(\n\t\t\t\t\t\t\tnodeKey,\n\t\t\t\t\t\t\tnew DecoratorClass({\n\t\t\t\t\t\t\t\ttextEditor: this,\n\t\t\t\t\t\t\t\ttarget: htmlElement,\n\t\t\t\t\t\t\t\tnodeKey,\n\t\t\t\t\t\t\t\toptions: decoratorOptions,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tthis.#decoratorNodes.clear();\n\t\t\t},\n\t\t);\n\n\t\tremoveListeners.push(removeListener);\n\n\t\treturn mergeRegister(...removeListeners);\n\t}\n\n\t#registerCommands(): () => void\n\t{\n\t\treturn mergeRegister(\n\t\t\tthis.registerCommand(\n\t\t\t\tFOCUS_COMMAND,\n\t\t\t\t(): boolean => {\n\t\t\t\t\tif (\n\t\t\t\t\t\tthis.isCollapsingModeEnabled()\n\t\t\t\t\t\t&& this.#collapsingState === CollapsingState.COLLAPSED\n\t\t\t\t\t\t&& this.isEmpty(false)\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.expand();\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.emit('onFocus');\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\n\t\t\tthis.registerCommand(\n\t\t\t\tBLUR_COMMAND,\n\t\t\t\t(event): boolean => {\n\t\t\t\t\tif (\n\t\t\t\t\t\tthis.isCollapsingModeEnabled()\n\t\t\t\t\t\t&& (\n\t\t\t\t\t\t\tthis.#collapsingState === CollapsingState.COLLAPSING\n\t\t\t\t\t\t\t|| this.#collapsingState === CollapsingState.EXPANDING\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.emit('onBlur');\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_CRITICAL,\n\t\t\t),\n\n\t\t\tthis.registerUpdateListener(\n\t\t\t\t({ dirtyElements, dirtyLeaves, prevEditorState, tags }) => {\n\t\t\t\t\tconst isComposing = this.isComposing();\n\t\t\t\t\tconst hasContentChanges = dirtyLeaves.size > 0 || dirtyElements.size > 0;\n\t\t\t\t\tif (isComposing || !hasContentChanges)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst isInitialChange: boolean = prevEditorState.isEmpty();\n\t\t\t\t\tif (this.#options.get('collapsingMode') === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (isInitialChange)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#initCollapsingMode();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (this.isCollapsed() && !this.isEmpty())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.expand(false);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!isInitialChange && tags.has('history-merge'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.emit('onChange', { isInitialChange, tags });\n\n\t\t\t\t\tconst isEmpty = this.isEmpty();\n\t\t\t\t\tif (this.#prevEmptyStatus !== isEmpty)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#prevEmptyStatus = isEmpty;\n\t\t\t\t\t\tthis.emit('onEmptyContentToggle', { isEmpty, isInitialChange });\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t),\n\n\t\t\tthis.registerCommand(\n\t\t\t\tKEY_ENTER_COMMAND,\n\t\t\t\t(event: KeyboardEvent) => {\n\t\t\t\t\tconst { code, ctrlKey, metaKey } = event;\n\t\t\t\t\tif ((Browser.isMac() && metaKey) || ctrlKey)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.emit('onMetaEnter');\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (code === 'Escape')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.emit('onEscape');\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tCOMMAND_PRIORITY_LOW,\n\t\t\t),\n\n\t\t\tthis.registerEditableListener((isEditable: boolean): boolean => {\n\t\t\t\tthis.getEditableContainer().contentEditable = isEditable;\n\t\t\t\tif (isEditable)\n\t\t\t\t{\n\t\t\t\t\tDom.removeClass(this.getRootContainer(), '--read-only');\n\t\t\t\t\tDom.addClass(this.getRootContainer(), '--editable');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tDom.removeClass(this.getRootContainer(), '--editable');\n\t\t\t\t\tDom.addClass(this.getRootContainer(), '--read-only');\n\t\t\t\t}\n\n\t\t\t\tthis.emit('onEditable', { isEditable });\n\t\t\t}),\n\t\t);\n\t}\n\n\t#createNamespace(plugins: PluginConstructor[]): string\n\t{\n\t\tconst hashCode = createHashCode(\n\t\t\tplugins\n\t\t\t\t.map((node) => node.getName())\n\t\t\t\t.sort()\n\t\t\t\t.join('-'),\n\t\t);\n\n\t\treturn String(hashCode);\n\t}\n\n\tgetBBCodeScheme(): BBCodeScheme\n\t{\n\t\treturn this.#bbcodeScheme;\n\t}\n\n\tgetSchemeValidation(): SchemeValidation\n\t{\n\t\treturn this.#schemeValidation;\n\t}\n\n\t#initBBCodeImportMap(): BBCodeImportMap\n\t{\n\t\tconst importMap: BBCodeImportMap = new Map();\n\t\tfor (const [, plugin] of this.#plugins)\n\t\t{\n\t\t\tconst map: BBCodeImportConversion = plugin.importBBCode();\n\t\t\tif (map !== null)\n\t\t\t{\n\t\t\t\tObject.keys(map).forEach((key: string): void => {\n\t\t\t\t\tlet currentValue = importMap.get(key);\n\t\t\t\t\tif (currentValue === undefined)\n\t\t\t\t\t{\n\t\t\t\t\t\tcurrentValue = [];\n\t\t\t\t\t\timportMap.set(key, currentValue);\n\t\t\t\t\t}\n\n\t\t\t\t\tcurrentValue.push(map[key]);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn importMap;\n\t}\n\n\t#initBBCodeExportMap(): BBCodeImportMap\n\t{\n\t\tconst exportMap: BBCodeExportMap = new Map();\n\t\tfor (const [, plugin] of this.#plugins)\n\t\t{\n\t\t\tconst map: BBCodeExportConversion | null = plugin.exportBBCode();\n\t\t\tif (map !== null)\n\t\t\t{\n\t\t\t\tObject.keys(map).forEach((nodeType: string): void => {\n\t\t\t\t\tif (Type.isFunction(map[nodeType]))\n\t\t\t\t\t{\n\t\t\t\t\t\texportMap.set(nodeType, map[nodeType]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn exportMap;\n\t}\n\n\t#initBBCodeScheme(): BBCodeScheme\n\t{\n\t\tconst filePlugin: FilePlugin = this.getPlugin('File');\n\t\tconst fileTag = filePlugin?.isEnabled() ? filePlugin.getMode() : 'none';\n\n\t\treturn new DefaultBBCodeScheme({ fileTag });\n\t}\n\n\tsetText(text: string, options?: SetTextOptions): void\n\t{\n\t\tif (Type.isString(text))\n\t\t{\n\t\t\tconst updateOptions = {\n\t\t\t\tdiscrete: Type.isPlainObject(options) && options.discrete === true,\n\t\t\t};\n\n\t\t\tthis.#lexicalEditor.update((): void => {\n\t\t\t\tconst lexicalNodes: Array<LexicalNode> = $importFromBBCode(text, this);\n\t\t\t\tconst root: RootNode = $getRoot();\n\t\t\t\troot.clear();\n\t\t\t\troot.append(...lexicalNodes);\n\t\t\t\t$setSelection(null);\n\t\t\t}, updateOptions);\n\t\t}\n\t}\n\n\tclear(options?: ClearOptions): void\n\t{\n\t\tconst updateOptions = {\n\t\t\tdiscrete: Type.isPlainObject(options) && options.discrete === true,\n\t\t};\n\n\t\tthis.#lexicalEditor.update((): void => {\n\t\t\tconst root: RootNode = $getRoot();\n\t\t\tconst paragraph = $createParagraphNode();\n\t\t\troot.clear();\n\t\t\troot.append(paragraph);\n\n\t\t\t// const selection = $getSelection();\n\t\t\t// if (selection !== null)\n\t\t\t// {\n\t\t\t// \tparagraph.select();\n\t\t\t// }\n\n\t\t\t$setSelection(null);\n\t\t}, updateOptions);\n\t}\n\n\tclearHistory(): void\n\t{\n\t\tthis.dispatchCommand(CLEAR_HISTORY_COMMAND);\n\t}\n\n\tgetText(): string\n\t{\n\t\treturn this.#lexicalEditor.getEditorState().read(() => {\n\t\t\tconst bbCodeAst = $exportToBBCode($getRoot(), this);\n\n\t\t\t// console.log(\"bbCodeAst\", bbCodeAst);\n\n\t\t\treturn bbCodeAst.toString();\n\t\t});\n\t}\n\n\tisEmpty(trim: boolean = true): boolean\n\t{\n\t\treturn this.#lexicalEditor.getEditorState().read(() => {\n\t\t\treturn $isRootEmpty(trim);\n\t\t});\n\t}\n\n\tsetAutoFocus(flag: boolean): void\n\t{\n\t\tif (Type.isBoolean(flag))\n\t\t{\n\t\t\tthis.#autoFocus = flag;\n\t\t}\n\t}\n\n\thasAutoFocus(): boolean\n\t{\n\t\treturn this.#autoFocus;\n\t}\n\n\tsetMinHeight(minHeight: number | null): void\n\t{\n\t\tif ((Type.isNumber(minHeight) && minHeight > 0) || minHeight === null)\n\t\t{\n\t\t\tconst changed = this.#minHeight !== minHeight;\n\t\t\tthis.#minHeight = minHeight;\n\n\t\t\tif (changed)\n\t\t\t{\n\t\t\t\tDom.style(\n\t\t\t\t\tthis.getScrollerContainer(),\n\t\t\t\t\t'--ui-text-editor-min-height',\n\t\t\t\t\tminHeight > 0 ? `${minHeight}px` : null,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tgetMinHeight(): number | null\n\t{\n\t\treturn this.#minHeight;\n\t}\n\n\tsetMaxHeight(maxHeight: number | null): void\n\t{\n\t\tif ((Type.isNumber(maxHeight) && maxHeight > 0) || maxHeight === null)\n\t\t{\n\t\t\tconst changed = this.#maxHeight !== maxHeight;\n\t\t\tthis.#maxHeight = maxHeight;\n\n\t\t\tif (changed)\n\t\t\t{\n\t\t\t\tDom.style(\n\t\t\t\t\tthis.getScrollerContainer(),\n\t\t\t\t\t'--ui-text-editor-max-height',\n\t\t\t\t\tmaxHeight > 0 ? `${maxHeight}px` : null,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tgetMaxHeight(): number | null\n\t{\n\t\treturn this.#maxHeight;\n\t}\n\n\tsetVisualOptions(options: TextEditorOptions['visualOption']): void\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const [option, value] of Object.entries(options))\n\t\t{\n\t\t\tconst name = Text.toKebabCase(option);\n\n\t\t\tDom.style(\n\t\t\t\tthis.getRootContainer(),\n\t\t\t\t`--ui-text-editor-${name}`,\n\t\t\t\tvalue,\n\t\t\t);\n\t\t}\n\t}\n\n\t#initCollapsingMode()\n\t{\n\t\tthis.#collapsingMode = true;\n\t\tif (this.isEmpty())\n\t\t{\n\t\t\tthis.#collapse('hide', false, true);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.expand(false);\n\t\t}\n\t}\n\n\tisCollapsingModeEnabled(): boolean\n\t{\n\t\treturn this.#collapsingMode;\n\t}\n\n\tisCollapsed(): boolean\n\t{\n\t\treturn this.#collapsingState === CollapsingState.COLLAPSED;\n\t}\n\n\t#collapse(mode: 'show' | 'hide' | 'toggle' = 'hide', animate: boolean = true, initialState: boolean = false): void\n\t{\n\t\tif (!this.isCollapsingModeEnabled())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst collapsed = (\n\t\t\tthis.#collapsingState === CollapsingState.COLLAPSED || this.#collapsingState === CollapsingState.COLLAPSING\n\t\t);\n\n\t\tconst expanded = (\n\t\t\tthis.#collapsingState === CollapsingState.EXPANDED || this.#collapsingState === CollapsingState.EXPANDING\n\t\t);\n\n\t\tif ((mode === 'hide' && collapsed) || (mode === 'show' && expanded))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (animate === false)\n\t\t{\n\t\t\tif (collapsed)\n\t\t\t{\n\t\t\t\tthis.#collapsingState = CollapsingState.EXPANDED;\n\t\t\t\tDom.removeClass(this.getRootContainer(), '--collapsed');\n\t\t\t\tthis.emit('onCollapsingToggle', { isOpen: true });\n\t\t\t\tthis.focus();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#collapsingState = CollapsingState.COLLAPSED;\n\t\t\t\tDom.addClass(this.getRootContainer(), '--collapsed');\n\t\t\t\tthis.emit('onCollapsingToggle', { isOpen: false });\n\t\t\t\tthis.clear();\n\t\t\t\tthis.clearHistory();\n\t\t\t\tif (!initialState)\n\t\t\t\t{\n\t\t\t\t\tthis.blur();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tEvent.unbind(this.getRootContainer(), 'transitionend', this.#collapsingTransitionEnd);\n\n\t\tif (collapsed)\n\t\t{\n\t\t\tthis.#collapsingState = CollapsingState.EXPANDING;\n\t\t\tthis.blur(); // to avoid a root container scrolling because of a browser focus\n\n\t\t\tconst currentHeight = this.getRootContainer().offsetHeight;\n\t\t\tDom.removeClass(this.getRootContainer(), ['--collapsed', '--collapsing']);\n\t\t\tDom.style(this.getRootContainer(), { height: `${currentHeight}px`, overflow: 'hidden' });\n\t\t\tDom.style(this.getInnerContainer(), { opacity: 0 });\n\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tDom.addClass(this.getRootContainer(), '--expanding');\n\t\t\t\tDom.style(this.getRootContainer(), { height: `${this.getRootContainer().scrollHeight}px` });\n\t\t\t\tDom.style(this.getInnerContainer(), { opacity: 1 });\n\n\t\t\t\tthis.emit('onCollapsingToggle', { isOpen: true });\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#collapsingState = CollapsingState.COLLAPSING;\n\n\t\t\tconst currentHeight = this.getRootContainer().offsetHeight;\n\n\t\t\tDom.removeClass(this.getRootContainer(), ['--expanding']);\n\t\t\tDom.style(this.getRootContainer(), { height: `${currentHeight}px`, overflow: 'hidden' });\n\t\t\tDom.style(this.getInnerContainer(), { opacity: 1 });\n\n\t\t\tthis.blur();\n\n\t\t\tconst paragraphHeight = this.getParagraphHeight();\n\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tDom.addClass(this.getRootContainer(), '--collapsing');\n\t\t\t\tDom.style(this.getRootContainer(), { height: `${paragraphHeight}px` });\n\t\t\t\tDom.style(this.getInnerContainer(), { opacity: 0 });\n\n\t\t\t\tthis.emit('onCollapsingToggle', { isOpen: false });\n\t\t\t});\n\t\t}\n\n\t\tEvent.bind(this.getRootContainer(), 'transitionend', this.#collapsingTransitionEnd);\n\t}\n\n\tcollapse(animate: boolean = true): void\n\t{\n\t\tthis.#collapse('hide', animate);\n\t}\n\n\texpand(animate: boolean = true): void\n\t{\n\t\tthis.#collapse('show', animate);\n\t}\n\n\ttoggle(animate: boolean = true): void\n\t{\n\t\tthis.#collapse('toggle', animate);\n\t}\n\n\tgetParagraphHeight(): number\n\t{\n\t\tif (this.#paragraphHeight !== null)\n\t\t{\n\t\t\treturn this.#paragraphHeight;\n\t\t}\n\n\t\tconst className = this.getThemeClasses().paragraph || '';\n\t\tconst paragraph = Tag.render`<p class=\"${className}\"><br /></p>`;\n\n\t\tDom.style(paragraph, {\n\t\t\tposition: 'absolute',\n\t\t\ttransform: 'translateY(-1000px)',\n\t\t});\n\n\t\tDom.append(paragraph, this.getScrollerContainer());\n\n\t\tthis.#paragraphHeight = (\n\t\t\tparagraph.offsetHeight\n\t\t\t+ Text.toNumber(Dom.style(paragraph, 'margin-top'))\n\t\t\t+ Text.toNumber(Dom.style(paragraph, 'margin-bottom'))\n\t\t);\n\n\t\tDom.remove(paragraph);\n\n\t\treturn this.#paragraphHeight;\n\t}\n\n\t#handleCollapsingTransition(): void\n\t{\n\t\tEvent.unbind(this.getRootContainer(), 'transitionend', this.#collapsingTransitionEnd);\n\n\t\tDom.style(this.getRootContainer(), { height: null, overflow: null });\n\t\tDom.style(this.getInnerContainer(), { opacity: null });\n\t\tDom.removeClass(this.getRootContainer(), ['--expanding', '--collapsing']);\n\n\t\tif (this.#collapsingState === CollapsingState.COLLAPSING)\n\t\t{\n\t\t\tDom.addClass(this.getRootContainer(), '--collapsed');\n\t\t\tthis.#collapsingState = CollapsingState.COLLAPSED;\n\t\t\tthis.clear();\n\t\t\tthis.clearHistory();\n\t\t\tthis.blur();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.focus();\n\t\t\tthis.#collapsingState = CollapsingState.EXPANDED;\n\t\t}\n\t}\n\n\tgetLexicalEditor(): LexicalEditor\n\t{\n\t\treturn this.#lexicalEditor;\n\t}\n\n\tsetRootElement(contentEditableElement: null | HTMLElement)\n\t{\n\t\tif (Type.isElementNode(contentEditableElement) || contentEditableElement === null)\n\t\t{\n\t\t\tthis.#lexicalEditor.setRootElement(contentEditableElement);\n\t\t}\n\t}\n\n\tgetBBCodeExportMap(): BBCodeExportMap\n\t{\n\t\treturn this.#bbcodeExportMap;\n\t}\n\n\tgetBBCodeImportMap(): BBCodeImportMap\n\t{\n\t\treturn this.#bbcodeImportMap;\n\t}\n\n\tgetEditorState(): EditorState\n\t{\n\t\treturn this.#lexicalEditor.getEditorState();\n\t}\n\n\tgetPlugins(): PluginCollection\n\t{\n\t\treturn this.#plugins;\n\t}\n\n\tgetPlugin(key: PluginConstructor | string): BasePlugin | null\n\t{\n\t\treturn this.#plugins.get(key);\n\t}\n\n\tgetElementByKey(key: NodeKey): HTMLElement | null\n\t{\n\t\treturn this.#lexicalEditor.getElementByKey(key);\n\t}\n\n\tsetEditorState(editorState: EditorState, options?: Object): void\n\t{\n\t\tthis.#lexicalEditor.setEditorState(editorState, options);\n\t}\n\n\tsetEditable(editable: boolean): void\n\t{\n\t\tif (Type.isBoolean(editable))\n\t\t{\n\t\t\tthis.dispatchCommand(HIDE_DIALOG_COMMAND);\n\t\t\tif (!editable)\n\t\t\t{\n\t\t\t\tthis.blur();\n\t\t\t}\n\n\t\t\tthis.#lexicalEditor.setEditable(editable);\n\t\t}\n\t}\n\n\tisEditable(): boolean\n\t{\n\t\treturn this.#lexicalEditor.isEditable();\n\t}\n\n\tregisterUpdateListener(listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerUpdateListener(listener);\n\t}\n\n\tregisterEditableListener(listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerEditableListener(listener);\n\t}\n\n\tregisterCommand(command, listener, priority): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerCommand(command, listener, priority);\n\t}\n\n\tdispatchCommand(type, payload): boolean\n\t{\n\t\treturn this.#lexicalEditor.dispatchCommand(type, payload);\n\t}\n\n\tregisterMutationListener(klass, listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerMutationListener(klass, listener);\n\t}\n\n\tregisterNodeTransform(klass, listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerNodeTransform(klass, listener);\n\t}\n\n\tregisterTextContentListener(listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerTextContentListener(listener);\n\t}\n\n\tregisterDecoratorListener(listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerDecoratorListener(listener);\n\t}\n\n\tregisterRootListener(listener): () => void\n\t{\n\t\treturn this.#lexicalEditor.registerRootListener(listener);\n\t}\n\n\tregisterEventListener(\n\t\tnodeType: Class<LexicalNode>,\n\t\teventType: string,\n\t\teventListener: (event: Event, nodeKey: NodeKey) => void,\n\t): () => void\n\t{\n\t\tconst isCaptured = ['mouseenter', 'mouseleave'].includes(eventType);\n\t\tconst handleEvent = (event: Event) => {\n\t\t\tthis.update(() => {\n\t\t\t\tconst nearestNode = $getNearestNodeFromDOMNode(event.target);\n\t\t\t\tif (nearestNode !== null)\n\t\t\t\t{\n\t\t\t\t\tconst targetNode = (\n\t\t\t\t\t\tisCaptured\n\t\t\t\t\t\t\t? (nearestNode instanceof nodeType ? nearestNode : null)\n\t\t\t\t\t\t\t: $findMatchingParent(nearestNode, (node) => node instanceof nodeType)\n\t\t\t\t\t);\n\n\t\t\t\t\tif (targetNode !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\teventListener(event, targetNode.getKey());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\treturn this.registerRootListener((rootElement, prevRootElement): void => {\n\t\t\tif (rootElement)\n\t\t\t{\n\t\t\t\tEvent.bind(rootElement, eventType, handleEvent, isCaptured);\n\t\t\t}\n\n\t\t\tif (prevRootElement)\n\t\t\t{\n\t\t\t\tEvent.unbind(prevRootElement, eventType, handleEvent, isCaptured);\n\t\t\t}\n\t\t});\n\t}\n\n\tupdate(updateFn: () => void, options?: Object): void\n\t{\n\t\tthis.#lexicalEditor.update(updateFn, options);\n\t}\n\n\tfocus(\n\t\tcallbackFn?: () => void,\n\t\toptions?: { defaultSelection?: 'rootStart' | 'rootEnd' },\n\t): void\n\t{\n\t\tif (!document.hasFocus())\n\t\t{\n\t\t\twindow.focus();\n\t\t}\n\n\t\tthis.#lexicalEditor.focus(\n\t\t\tType.isFunction(callbackFn) ? callbackFn : null,\n\t\t\tType.isPlainObject(options) ? options : { defaultSelection: 'rootStart' },\n\t\t);\n\t}\n\n\thasFocus(): boolean\n\t{\n\t\treturn this.getRootElement().contains(document.activeElement);\n\t}\n\n\tblur(): void\n\t{\n\t\tthis.#lexicalEditor.blur();\n\t}\n\n\tisComposing(): boolean\n\t{\n\t\treturn this.#lexicalEditor.isComposing();\n\t}\n\n\tgetRootElement(): null | HTMLElement\n\t{\n\t\treturn this.#lexicalEditor.getRootElement();\n\t}\n\n\thasNodes(nodes: Array): boolean\n\t{\n\t\treturn this.#lexicalEditor.hasNodes(nodes);\n\t}\n\n\tgetRootContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('root', () => {\n\t\t\tconst classes = [\n\t\t\t\tthis.isEditable() ? '--editable' : '--read-only',\n\t\t\t];\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor ${classes.join(' ')}\">\n\t\t\t\t\t${this.getInnerContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetInnerContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('inner', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-inner\">\n\t\t\t\t\t${this.getHeaderContainer()}\n\t\t\t\t\t${this.getToolbarContainer()}\n\t\t\t\t\t${this.getScrollerContainer()}\n\t\t\t\t\t${this.getFooterContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetToolbarContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('toolbar', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-toolbar\" tabindex=\"-1\"></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetScrollerContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('scroller', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-scroller\">\n\t\t\t\t\t${this.getEditableContainer()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetEditableContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('editable', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div \n\t\t\t\t\tclass=\"ui-text-editor-editable\" \n\t\t\t\t\tcontenteditable=\"${this.isEditable() ? 'true' : 'false'}\" \n\t\t\t\t\tspellcheck=\"true\"\n\t\t\t\t></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetFooterContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('footer', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-slot ui-text-editor-footer\" tabindex=\"-1\"></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetHeaderContainer(): HTMLElement\n\t{\n\t\treturn this.#refs.remember('header', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-text-editor-slot ui-text-editor-header\" tabindex=\"-1\"></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\trenderTo(container: HTMLElement, replaceNode: boolean = false): void\n\t{\n\t\tif (!Type.isElementNode(container))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.isRendered())\n\t\t{\n\t\t\tif (Type.isStringFilled(this.#options.get('content')))\n\t\t\t{\n\t\t\t\tthis.setText(this.#options.get('content'));\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#initEditorState(this.#options.get('editorState'));\n\t\t\t}\n\t\t}\n\n\t\tif (replaceNode)\n\t\t{\n\t\t\tDom.replace(container, this.getRootContainer());\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.append(this.getRootContainer(), container);\n\t\t}\n\n\t\tthis.#lexicalEditor.setRootElement(this.getEditableContainer());\n\n\t\tif (this.hasAutoFocus())\n\t\t{\n\t\t\tthis.focus(null, { defaultSelection: 'rootStart' });\n\t\t}\n\n\t\tif (!this.#rendered)\n\t\t{\n\t\t\tthis.#resizeObserver = new ResizeObserver(() => {\n\t\t\t\tthis.emit('onResize');\n\t\t\t\tthis.dispatchCommand(HIDE_DIALOG_COMMAND, { context: 'resize' });\n\t\t\t});\n\n\t\t\tthis.#resizeObserver.observe(this.getScrollerContainer());\n\t\t}\n\n\t\tthis.#rendered = true;\n\t}\n\n\tisRendered(): boolean\n\t{\n\t\treturn this.#rendered;\n\t}\n\n\thighlightSelection(): void\n\t{\n\t\tthis.getEditorState().read(() => {\n\t\t\tconst selection: RangeSelection = $getSelection();\n\t\t\tif (!$isRangeSelection(selection) || selection.isCollapsed())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst anchor = selection.anchor;\n\t\t\tconst focus = selection.focus;\n\t\t\tconst range = createDOMRange(\n\t\t\t\tthis.#lexicalEditor,\n\t\t\t\tanchor.getNode(),\n\t\t\t\tanchor.offset,\n\t\t\t\tfocus.getNode(),\n\t\t\t\tfocus.offset,\n\t\t\t);\n\n\t\t\tif (range !== null)\n\t\t\t{\n\t\t\t\tconst scrollerContainer = this.getScrollerContainer();\n\t\t\t\tconst scrollerRect = scrollerContainer.getBoundingClientRect();\n\t\t\t\tconst selectionRects = createRectsFromDOMRange(this.#lexicalEditor, range);\n\t\t\t\tconst selectionRectsLength = selectionRects.length;\n\n\t\t\t\tthis.#highlightContainer.innerHTML = '';\n\n\t\t\t\tfor (let i = 0; i < selectionRectsLength; i++)\n\t\t\t\t{\n\t\t\t\t\tconst selectionRect = selectionRects[i];\n\t\t\t\t\tconst elem = Tag.render`<span class=\"ui-text-editor-selection-part\"></span>`;\n\t\t\t\t\tconst top = selectionRect.top - scrollerRect.top + scrollerContainer.scrollTop;\n\t\t\t\t\tconst left = selectionRect.left - scrollerRect.left + scrollerContainer.scrollLeft;\n\n\t\t\t\t\tDom.style(elem, {\n\t\t\t\t\t\ttop: `${top}px`,\n\t\t\t\t\t\tleft: `${left}px`,\n\t\t\t\t\t\theight: `${selectionRect.height}px`,\n\t\t\t\t\t\twidth: `${selectionRect.width}px`,\n\t\t\t\t\t});\n\n\t\t\t\t\tDom.append(elem, this.#highlightContainer);\n\t\t\t\t}\n\n\t\t\t\tDom.append(this.#highlightContainer, this.getScrollerContainer());\n\t\t\t}\n\t\t});\n\t}\n\n\tresetHighlightSelection(): void\n\t{\n\t\tDom.remove(this.#highlightContainer);\n\t}\n\n\tdestroy(): void\n\t{\n\t\tif (this.#destroying)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#destroying = true;\n\t\tthis.emit('onDestroy');\n\n\t\tfor (const [, plugin] of this.#plugins)\n\t\t{\n\t\t\tplugin.destroy();\n\t\t}\n\n\t\tthis.#removeListeners();\n\t\tif (this.isRendered())\n\t\t{\n\t\t\tthis.#resizeObserver.disconnect();\n\t\t\tthis.setRootElement(null);\n\t\t\tDom.remove(this.getRootContainer());\n\t\t}\n\n\t\tthis.#resizeObserver = null;\n\t\tthis.#plugins = null;\n\t\tthis.#lexicalEditor = null;\n\t\tthis.$refs = null;\n\t\tthis.#schemeValidation = null;\n\t\tthis.#bbcodeImportMap = null;\n\t\tthis.#bbcodeExportMap = null;\n\t\tthis.#decoratorNodes = null;\n\t\tthis.#decoratorComponents = null;\n\n\t\tObject.setPrototypeOf(this, null);\n\t}\n}\n","import { Type } from 'main.core';\nimport { TextEditor } from './text-editor';\nimport { type BitrixVueComponentProps } from 'ui.vue3';\n\nexport const TextEditorComponent: BitrixVueComponentProps = {\n\tname: 'TextEditorComponent',\n\tprops: {\n\t\teditorOptions: {\n\t\t\ttype: Object,\n\t\t},\n\t\teditorInstance: {\n\t\t\ttype: TextEditor,\n\t\t\tdefault: null,\n\t\t},\n\t\tevents: {\n\t\t\ttype: Object,\n\t\t\tdefault: {},\n\t\t},\n\t\teditable: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: null,\n\t\t},\n\t},\n\tsetup()\n\t{\n\t\treturn {\n\t\t\teditorClass: TextEditor,\n\t\t};\n\t},\n\tprovide(): Object<string, any> {\n\t\treturn {\n\t\t\teditor: this.editor,\n\t\t};\n\t},\n\tbeforeCreate()\n\t{\n\t\tif (this.editorInstance === null)\n\t\t{\n\t\t\tthis.hasOwnEditor = true;\n\n\t\t\tconst EditorClass = this.editorClass;\n\t\t\tthis.editor = new EditorClass(this.editorOptions);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.hasOwnEditor = false;\n\t\t\tthis.editor = this.editorInstance;\n\t\t}\n\n\t\tif (Type.isPlainObject(this.events))\n\t\t{\n\t\t\tfor (const [eventName, fn] of Object.entries(this.events))\n\t\t\t{\n\t\t\t\tthis.editor.subscribe(eventName, fn);\n\t\t\t}\n\t\t}\n\t},\n\tcomputed:\n\t{\n\t\theaderContainer(): string\n\t\t{\n\t\t\treturn this.editor.getHeaderContainer();\n\t\t},\n\t\tfooterContainer(): string\n\t\t{\n\t\t\treturn this.editor.getFooterContainer();\n\t\t},\n\t},\n\twatch:\n\t{\n\t\teditable(value: boolean): void\n\t\t{\n\t\t\tthis.editor.setEditable(value);\n\t\t},\n\t},\n\tmounted(): void\n\t{\n\t\tthis.editor.renderTo(this.$refs.container, true);\n\t},\n\tunmounted(): void\n\t{\n\t\tif (this.hasOwnEditor)\n\t\t{\n\t\t\tthis.editor.destroy();\n\t\t\tthis.editor = null;\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div ref=\"container\"></div>\n\t\t<Teleport :to=\"headerContainer\">\n\t\t\t<slot name=\"header\"></slot>\n\t\t</Teleport>\n\t\t<Teleport :to=\"footerContainer\">\n\t\t\t<slot name=\"footer\"></slot>\n\t\t</Teleport>\n\t`,\n};\n","import { type TextEditorOptions } from 'ui.text-editor';\nimport { NewLineMode } from '../constants';\nimport { TextEditor } from '../text-editor';\n\n/**\n * @memberof BX.UI.TextEditor\n */\nexport class BasicEditor extends TextEditor\n{\n\tstatic getDefaultOptions(): TextEditorOptions\n\t{\n\t\treturn {\n\t\t\tplugins: [\n\t\t\t\t'RichText',\n\t\t\t\t'Paragraph',\n\t\t\t\t'Clipboard',\n\t\t\t\t'Bold',\n\t\t\t\t'Underline',\n\t\t\t\t'Italic',\n\t\t\t\t'Strikethrough',\n\t\t\t\t'TabIndent',\n\t\t\t\t'List',\n\t\t\t\t'Mention',\n\t\t\t\t'Link',\n\t\t\t\t'AutoLink',\n\t\t\t\t'Image',\n\t\t\t\t'Copilot',\n\t\t\t\t'History',\n\t\t\t\t'BlockToolbar',\n\t\t\t\t'FloatingToolbar',\n\t\t\t\t'Toolbar',\n\t\t\t\t'Placeholder',\n\t\t\t\t'File',\n\t\t\t],\n\t\t\ttoolbar: [\n\t\t\t\t'bold', 'italic', 'underline', 'strikethrough',\n\t\t\t\t'|',\n\t\t\t\t'numbered-list', 'bulleted-list',\n\t\t\t\t'|',\n\t\t\t\t'link', 'copilot',\n\t\t\t],\n\t\t\tnewLineMode: NewLineMode.MIXED,\n\t\t};\n\t}\n}\n","import { TextEditorComponent } from '../text-editor-component';\nimport { BasicEditor } from './basic-editor';\nimport { type BitrixVueComponentProps } from 'ui.vue3';\n\nexport const BasicEditorComponent: BitrixVueComponentProps = {\n\tname: 'BasicEditorComponent',\n\textends: TextEditorComponent,\n\tsetup(): Object\n\t{\n\t\treturn {\n\t\t\teditorClass: BasicEditor,\n\t\t};\n\t},\n};\n","import type { TextEditorOptions } from './types/text-editor-options';\nimport type { NewLineModeType } from './types/new-line-mode-type';\nimport type { DecoratorComponentOptions } from './types/decorator-component-options';\nimport type { DecoratorOptions } from './types/decorator-options';\nimport type { ToolbarItem, ToolbarOptions } from './types/toolbar-options';\nimport type { InitialEditorStateType } from './types/initial-editor-state-type';\n\nimport * as AllCommands from './commands';\nimport * as AllConstants from './constants';\n\nimport { generateContent } from './debug/generate-content';\n\nimport { TextEditor } from './text-editor';\nimport { TextEditorComponent } from './text-editor-component';\n\nimport { BasicEditor } from './presets/basic-editor';\nimport { BasicEditorComponent } from './presets/basic-editor-component';\n\nimport BasePlugin from './plugins/base-plugin';\nimport Button from './toolbar/button';\n\nimport * as Paragraph from './plugins/paragraph';\nimport * as AutoLink from './plugins/auto-link';\nimport * as BlockToolbar from './plugins/block-toolbar';\nimport * as Bold from './plugins/bold';\nimport * as Code from './plugins/code';\nimport * as FloatingToolbar from './plugins/floating-toolbar';\nimport * as History from './plugins/history';\nimport * as Image from './plugins/image';\nimport * as Italic from './plugins/italic';\nimport * as Link from './plugins/link';\nimport * as List from './plugins/list';\nimport * as Mention from './plugins/mention';\nimport * as Quote from './plugins/quote';\nimport * as Strikethrough from './plugins/strikethrough';\nimport * as TabIndent from './plugins/tab-indent';\nimport * as Toolbar from './plugins/toolbar';\nimport * as Underline from './plugins/underline';\nimport * as Video from './plugins/video';\nimport * as Spoiler from './plugins/spoiler';\nimport * as Smiley from './plugins/smiley';\nimport * as Table from './plugins/table';\nimport * as Hashtag from './plugins/hashtag';\nimport * as File from './plugins/file';\nimport * as Copilot from './plugins/copilot';\n\n/**\n * @namespace BX.UI.TextEditor.Plugins\n */\nconst Plugins = {\n\tParagraph,\n\tAutoLink,\n\tBlockToolbar,\n\tBold,\n\tCode,\n\tFloatingToolbar,\n\tHistory,\n\tImage,\n\tItalic,\n\tLink,\n\tList,\n\tMention,\n\tQuote,\n\tStrikethrough,\n\tTabIndent,\n\tToolbar,\n\tUnderline,\n\tVideo,\n\tSpoiler,\n\tSmiley,\n\tTable,\n\tHashtag,\n\tFile,\n\tCopilot,\n};\n\n/**\n * @namespace BX.UI.TextEditor.Commands\n */\nconst Commands = { ...AllCommands };\n\n/**\n * @namespace BX.UI.TextEditor.Commands\n */\nconst Constants = { ...AllConstants };\n\n/**\n * @namespace BX.UI.TextEditor.Debug\n */\nconst Debug = {\n\tgenerateContent,\n};\n\n/**\n * @namespace BX.UI.TextEditor\n */\nexport {\n\tTextEditor,\n\tBasicEditor,\n\tTextEditorComponent,\n\tBasicEditorComponent,\n\tBasePlugin,\n\tButton,\n\tPlugins,\n\tCommands,\n\tConstants,\n\tDebug,\n};\n\nexport type {\n\tTextEditorOptions,\n\tNewLineModeType,\n\tDecoratorComponentOptions,\n\tDecoratorOptions,\n\tToolbarOptions,\n\tToolbarItem,\n\tInitialEditorStateType,\n};\n"],"names":["HIDE_DIALOG_COMMAND","createCommand","DIALOG_VISIBILITY_COMMAND","DRAG_START_COMMAND","DRAG_END_COMMAND","UNFORMATTED","NewLineMode","LINE_BREAK","PARAGRAPH","MIXED","NON_SINGLE_WIDTH_CHARS_REPLACEMENT","Object","freeze","NON_SINGLE_WIDTH_CHARS_REGEX","RegExp","keys","join","SYMBOLS","ancestorHasNextSibling","ancestorIsLastChild","hasNextSibling","isLastChild","selectedChar","selectedLine","FORMAT_PREDICATES","node","hasFormat","DETAIL_PREDICATES","isDirectionless","isUnmergeable","MODE_PREDICATES","isToken","isSegmented","getSelectedNode","selection","anchor","focus","anchorNode","getNode","focusNode","isBackward","$isAtNodeEnd","nodeNameToTextFormat","b","strong","i","em","s","del","u","sub","sup","convertTextFormatElement","format","getName","undefined","forChild","lexicalNode","$isTextNode","toggleFormat","$importFromBBCode","bbcode","editor","normalize","scheme","getBBCodeScheme","parser","BBCodeParser","ast","parse","elements","getChildren","lexicalNodes","element","nodes","$createNodesFromBBCode","$normalizeTextNodes","forChildMap","Map","parentLexicalNode","BBCodeNewLineNode","$createLineBreakNode","BBCodeTabNode","$createTabNode","currentLexicalNode","transformFunction","getConversionFunction","transformOutput","postTransform","after","transformNodes","Array","isArray","length","forChildFunction","push","Type","isFunction","set","children","childLexicalNodes","child","getType","BBCodeNode","ELEMENT_NODE","elementNode","isVoid","$createTextNode","getOpeningTag","getClosingTag","toString","$isElementNode","append","shouldWrapInParagraph","isInline","$isDecoratorNode","result","currentParagraph","lineBreaks","$isLineBreakNode","$createEmptyParagraphs","$createParagraphNode","count","nodeName","currentConversion","importMap","getBBCodeImportMap","conversions","get","toLowerCase","conversion","bbCodeConversion","priority","convertTextNode","textNode","textContent","getContent","replaceAll","replace","$isParagraphEmpty","$isParagraphNode","isEmpty","every","test","getTextContent","trimEmptyParagraphs","trimmedNodes","splice","$exportToBBCode","root","createRoot","topLevelChildren","topLevelNode","$appendNodesToBBCode","currentNode","parentNode","getExportFunction","fragment","createFragment","childNode","appendChild","newElement","call","getParent","replaceChild","formats","type","exportMap","getBBCodeExportMap","exportFn","createText","encode","content","getFormat","forEach","formatFn","createNewLine","$isTabNode","createTab","wrapNodeWith","tag","createElement","name","BasePlugin","constructor","textEditor","Error","getNodes","importBBCode","exportBBCode","validateScheme","afterInit","getEditor","getLexicalEditor","cleanUpRegister","func","mergeRegister","isDestroyed","destroy","ToolbarItem","EventEmitter","setEventNamespace","getContainer","render","Button","setContent","isString","innerHTML","isElementNode","setFormat","setBlockType","getBlockType","setTooltip","tooltip","isStringFilled","Dom","attr","Text","disableInsideUnformatted","enableInsideUnformatted","shouldDisableInsideUnformatted","setActive","active","addClass","removeClass","isActive","setDisabled","disabled","disable","enable","isDisabled","hasOwnDisableCallback","setDisableCallback","fn","invokeDisableCallback","Tag","bind","emit","wrapTextInParagraph","text","parts","split","part","QuoteNode","ElementNode","clone","__key","createDOM","config","document","setAttribute","theme","quote","updateDOM","prevNode","importDOM","blockquote","$createQuoteNode","importJSON","serializedNode","setIndent","indent","setDirection","direction","exportJSON","canIndent","canReplaceWith","replacement","collapseAtStart","$removeQuote","canBeEmpty","isShadowRoot","$applyNodeReplacement","$isQuoteNode","quoteNode","lastElement","insertAfter","remove","$getAncestor","predicate","parent","getParentOrThrow","$isBlockNode","isParentRequired","$wrapNodes","$isRootOrShadowRoot","firstChild","getFirstChild","handled","Set","firstSelectedBlock","includes","unshift","add","getKey","firstNode","has","isParentHandled","INSERT_QUOTE_COMMAND","FORMAT_QUOTE_COMMAND","REMOVE_QUOTE_COMMAND","TOGGLE_QUOTE_COMMAND","QuotePlugin","nodeClass","validate","prevParagraph","paragraph","bbcodeMap","registerCommand","payload","isPlainObject","$insertNodeToNearestRoot","selectStart","COMMAND_PRIORITY_LOW","$getSelection","$getPreviousSelection","$isRangeSelection","$findMatchingParent","dispatchCommand","getNewLineMode","getComponentRegistry","register","button","Loc","getMessage","subscribe","update","convertSpoilerContentElement","domNode","$createSpoilerContentNode","SpoilerContentNode","dom","spoiler","div","hasAttribute","exportDOM","version","createParentElementNode","$createSpoilerNode","canInsertAfter","insertBefore","nodeToInsert","$isSpoilerContentNode","SpoilerTitleTextNode","TextNode","__text","$createSpoilerTitleTextNode","$isSpoilerTitleTextNode","INSERT_SPOILER_COMMAND","REMOVE_SPOILER_COMMAND","TOGGLE_SPOILER_COMMAND","SpoilerPlugin","SpoilerNode","SpoilerTitleNode","title","getValue","trimSpoilerTitle","$createSpoilerTitleNode","spoilerNode","titleNode","value","contentNode","DELETE_CHARACTER_COMMAND","KEY_ENTER_COMMAND","COMMAND_PRIORITY_NORMAL","INSERT_PARAGRAPH_COMMAND","event","spoilerTitleNode","$isSpoilerTitleNode","newBlock","insertNewAfter","PASTE_COMMAND","$getRoot","selectEnd","insertSpoiler","getContentNode","select","$isSpoilerNode","$removeSpoiler","registerNodeTransform","getChildrenSize","$setSelection","clear","isCollapsed","offset","topLevelElement","getTopLevelElement","container","getPreviousSibling","getOpen","setOpen","ctrlKey","metaKey","toggleOpen","ClipboardEvent","clipboardData","preventDefault","$insertDataTransferForPlainText","$createSpoiler","getTitleNode","trim","convertSummaryElement","__language","__flags","tabIndex","summary","restoreSelection","containerNode","getNextSibling","open","key","__open","details","Event","getEditorState","read","isOpen","isBoolean","nodesToAppend","writable","getWritable","getLatest","CustomParagraphNode","ParagraphNode","__mode","childrenLength","$hasUpdateTag","insertLineBreak","mode","p","h1","convertHeadingElement","h2","h3","h4","h5","h6","nextSibling","selectNext","prevSibling","selectPrevious","$isRootNode","getPrototypeOf","hasOwnProperty","serializedParagraphNode","FORMAT_PARAGRAPH_COMMAND","ParagraphPlugin","with","withClass","convertParagraphNode","left","right","center","justify","tab","linebreak","$setBlocksType","COMMAND_PRIORITY_EDITOR","RootNode","isAttached","console","warn","lastChild","getLastChild","KEY_ARROW_UP_COMMAND","KEY_ARROW_LEFT_COMMAND","KEY_ARROW_DOWN_COMMAND","KEY_ARROW_RIGHT_COMMAND","$isCodeNode","items","getData","hasLineBreaks","stopPropagation","html","dataTransfer","DataTransfer","setData","pasteEvent","bubbles","cancelable","getEditableContainer","dispatchEvent","getFirstDescendant","firstDescendant","lastDescendant","getLastDescendant","getTextContentSize","bbcodeNode","CodeTokenNode","highlightType","__highlightType","getHighlightType","self","className","getHighlightThemeClass","addClassNamesToElement","prevClassName","nextClassName","removeClassNamesFromElement","$createCodeTokenNode","setDetail","detail","setMode","setStyle","style","$createCodeNode","codeHighlight","$isCodeTokenNode","CodeNode","code","_config","isMultiLine","hasChildDOMNodeTag","convertPreElement","convertDivElement","pre","table","isGitHubCodeTable","convertTableElement","td","closest","isGitHubCodeCell","convertTableCellElement","convertCodeNoop","tr","firstPoint","isBefore","firstSelectionNode","getFirstCodeNodeOfLine","insertNodes","spaces","textSize","repeat","splitText","x","index","getIndexWithinParent","codeNode","nodesToInsert","last","isCode","isCodeElement","isCodeChildElement","domParent","cell","fontFamily","match","parentElement","classList","contains","tagName","hasChild","childNodes","FORMAT_CODE_COMMAND","TOGGLE_CODE_COMMAND","INSERT_CODE_COMMAND","CodePlugin","CodeParser","map","handleTextNodeTransform","FORMAT_TEXT_COMMAND","COMMAND_PRIORITY_HIGH","KEY_TAB_COMMAND","command","shiftKey","INSERT_TAB_COMMAND","$isSelectionInCode","$insertNodes","INDENT_CONTENT_COMMAND","OUTDENT_CONTENT_COMMAND","tokenNodes","getCodeTokenNodes","newSelection","insertRawText","codeParent","nodeKey","updateAndRetainSelection","$getNodeByKey","codeTokenNodes","diffRange","getDiffRange","from","to","nodesForReplacement","onUpdate","delete","skipTransforms","indentOrOutdent","tabOrOutdent","codeLines","$getCodeLines","selectionNodes","firstOfLine","lastOfLine","getLastCodeNodeOfLine","selectionFirst","selectionLast","codeLinesLength","line","is","anchorParent","lines","lastLine","entries","previousNode","nextNode","prevNodes","nextNodes","leadingMatch","isEqual","prevNodesLength","nextNodesLength","maxTrailingMatch","Math","min","trailingMatch","slice","nodeA","nodeB","tokens","token","partials","partialsLength","updateFn","anchorOffset","isNewLineAnchor","getChildAtIndex","textOffset","getPreviousSiblings","reduce","_node","hasChanges","some","isText","textContentSize","isNodeSelected","isSelected","createNodeSelection","subscribers","onSelect","unregisterListener","registerUpdateListener","subscribeFunc","registerEditableListener","isEditable","setSelected","selected","$isNodeSelection","$createNodeSelection","clearSelection","dispose","DecoratorComponent","componentOptions","target","options","getNodeKey","getTarget","getNodeSelection","getOptions","getOption","option","defaultValue","isUndefined","CLICK_COMMAND","KEY_DELETE_COMMAND","KEY_BACKSPACE_COMMAND","clamp","max","Direction","EAST","SOUTH","WEST","NORTH","FigureResizer","originalWidth","originalHeight","minWidth","minHeight","maxWidth","maxHeight","events","freeTransform","currentHeight","currentWidth","isResizing","ratio","startHeight","startWidth","startX","startY","isNumber","Infinity","subscribeFromOptions","show","hide","setTarget","Number","dataset","width","height","getBoundingClientRect","clientX","clientY","isHorizontal","isVertical","diff","floor","round","ceil","setTimeout","unbind","editorRootElement","getRootElement","FileImageComponent","MemoryCache","getImage","onResizeStart","onResizeEnd","draggable","remember","img","src","image","aspectRatio","figureResizer","$isFileImageNode","setWidthAndHeight","FileImageNode","DecoratorNode","serverFileId","info","__serverFileId","__info","__width","previewWidth","__height","previewHeight","getId","getServerFileId","getInfo","getWidth","getHeight","isResized","$createFileImageNode","fileImageId","fileImageInfo","JSON","span","decorate","componentClass","previewUrl","useDecoratorComponent","FileNode","fileInfo","$createFileNode","fileId","stringify","file","$isFileNode","calcImageSize","renderWidth","renderHeight","ratioWidth","ratioHeight","useOriginalSize","FileVideoComponent","onResize","adjust","attrs","video","create","controls","preload","playsinline","loadedmetadata","$isFileVideoNode","videoWidth","videoHeight","object","FileVideoNode","$createFileVideoNode","downloadUrl","getDragSelection","targetWindow","nodeType","defaultView","ownerDocument","range","domSelection","window","getSelection","caretRangeFromPoint","rangeParent","collapse","rangeOffset","getRangeAt","getNodeInSelection","DRAG_DATA_FORMAT","TRANSPARENT_IMAGE","registerDraggableNode","targetNode","onDrop","isTargetNode","getDraggableNode","DRAGSTART_COMMAND","draggableNode","success","handleDragStart","DRAGOVER_COMMAND","handleDragOver","DROP_COMMAND","handleDragDrop","setDragImage","data","canDrop","dragData","rangeSelection","$createRangeSelection","applyDOMRange","selectors","imageClassName","getThemeClass","HTMLElement","FileType","FILE","IMAGE","VIDEO","ADD_FILE_COMMAND","ADD_FILES_COMMAND","INSERT_FILE_COMMAND","REMOVE_FILE_COMMAND","GET_INSERTED_FILES_COMMAND","FilePlugin","modeOption","files","addFiles","isEnabled","getMode","getAttribute","createTextNode","getFile","fileType","getFileType","toInteger","attributes","id","inline","addFile","isArrayFilled","item","values","customData","objectId","isImage","isVideo","removeFile","skipHistoryStack","$nodesOfType","$wrapNodeInElement","validateImageUrl","url","ImageComponent","getMaxWidth","onerror","$isImageNode","ImageNode","__maxWidth","__src","$createImageNode","HTMLImageElement","imageNode","getSrc","setMaxWidth","paddings","WeakMap","getEditorPaddings","scrollerContainer","computedStyle","getComputedStyle","paddingLeft","parseFloat","paddingRight","$getSelectionPosition","createRange","rangeRects","getClientRects","isMultiline","rangeRect","top","getElementByKey","startContainer","startOffset","position","DOMRect","verticalGap","isBodyContainer","body","scrollLeft","pageXOffset","scrollTop","pageYOffset","bottom","scrollerRect","anchorKey","focusKey","anchorDOM","focusDOM","focusOffset","getDOMTextNode","getDOMIndexWithinParent","setStart","setEnd","collapsed","Node","TEXT_NODE","indexOf","lastPositionMap","$adjustDialogPosition","popup","initPosition","selectionPosition","getPosition","getScrollerContainer","popupRect","getPopupContainer","popupWidth","offsetLeft","editorPaddings","overflow","setOffset","initialPosition","lastPosition","setBindElement","adjustPosition","forceBindPosition","clearDialogPosition","$restoreSelection","lastSelection","isSelectionAlive","ATTRIBUTE_WHITESPACES","SAFE_URL","sanitizeUrl","normalizedUrl","ImageDialog","imageDialogOptions","setTargetContainer","targetContainer","targetOptions","getPopup","close","isShown","setImageUrl","getImageUrl","getTargetContainer","Popup","autoHide","cacheable","padding","closeByEsc","onClose","onDestroy","onShow","onAfterShow","getUrlTextBox","INSERT_IMAGE_COMMAND","INSERT_IMAGE_DIALOG_COMMAND","ImagePlugin","setChildren","sender","onSave","onCancel","highlightSelection","resetHighlightSelection","MentionNode","entityId","__entityId","__id","getEntityId","$createMentionNode","convertMentionElement","a","mention","canInsertTextBefore","canInsertTextAfter","getDirection","extractWithChild","destination","selectionLength","isParentOf","mentionEntityId","mentionId","mentionNode","$isMentionNode","PUNCTUATION","TRIGGERS","VALID_CHARS","VALID_JOINS","LENGTH_LIMIT","mentionRegex","INSERT_MENTION_COMMAND","INSERT_MENTION_DIALOG_COMMAND","MentionPlugin","entities","dialogOptions","entity","size","shouldTriggerByAtSign","isDialogVisible","isRendered","clearTimeout","error","before","currentText","needSpace","insertText","leadOffset","context","keyDownListener","KEY_DOWN_COMMAND","registerTextContentListener","minMatchLength","isSimpleText","isTextEntity","exec","maybeLeadingWhitespace","matchingString","replaceableString","selectionOffset","characterOffset","queryOffset","newNode","documentText","entryText","triggerOffset","queryMatch","userEvents","Runtime","loadExtension","then","exports","Dialog","entitySelectorOptions","multiple","enableSearch","clearSearchOnSelect","hideOnSelect","hideByEsc","offsetAnimation","compactView","onHide","selectedItem","nodeToReplace","getTitle","search","catch","forceTop","KEY_ESCAPE_COMMAND","SmileyNode","__typing","typing","getTyping","encodeURI","smiley","$createSmileyNode","isKeyboardSelectable","isIsolated","$isSmileyNode","SmileyDialog","setTargetNode","getTargetNode","rect","targetNodeWidth","bindElement","onFirstShow","dialog","BitrixVue","Smiles","app","createApp","methods","handleSelect","components","template","mount","getContentContainer","angleShift","setAngle","INSERT_SMILEY_COMMAND","INSERT_SMILEY_DIALOG_COMMAND","SmileyPlugin","SmileyManager","getSize","SmileyParser","getAll","handledTextNodes","$isUnformatted","splits","splitOffsets","acc","start","end","textNodes","smileyNode","registerMutationListener","nodeMutations","mutation","contentEditable","VideoComponent","$isVideoNode","VideoNode","__provider","uri","Uri","videoService","VideoService","createByHost","getHost","$createVideoNode","getProvider","provider","VideoDialog","videoDialogOptions","setVideoUrl","getVideoUrl","getStatusContainer","showError","clearError","validateVideoUrl","INSERT_VIDEO_COMMAND","INSERT_VIDEO_DIALOG_COMMAND","VideoPlugin","videoNode","getEmbeddedUrl","onInput","printFormatProperties","nodeOrSelection","str","filter","Boolean","toLocaleLowerCase","printNode","codeTokenNode","properties","printAllTextNodeProperties","fileImageNode","fileNode","fileVideoNode","$isLinkNode","linkNode","link","getURL","printAllLinkNodeProperties","String","printDetailProperties","printModeProperties","printTargetProperties","printRelProperties","printTitleProperties","isNil","getRel","printNodeSelection","_nodes","printRangeSelection","res","formatText","printTableSelection","tableKey","visitTree","visitor","childNodesLength","concat","generateContent","editorState","selectionString","nodeKeyDisplay","typeDisplay","printSelectedCharsLine","$isTableSelection","$getSelectionStartEnd","selectionLastIndent","indentionChars","unselectedChars","fill","selectedChars","paddingLength","nodePrintSpaces","anchorAndFocus","getStartEndPoints","textLength","numNonSingleWidthCharBeforeSelection","numNonSingleWidthCharInSelection","createHashCode","hash","c","trunc","imul","codePointAt","$isRootEmpty","topBlock","__indent","topBlockChildren","topBlockChildrenLength","defaultTheme","blockCursor","ltr","rtl","heading","hashtag","list","listitem","nested","olDepth","ul","bold","italic","strikethrough","subscript","superscript","underline","underlineStrikethrough","operator","punctuation","comment","word","keyword","boolean","regex","string","number","semicolon","bracket","brace","parentheses","tableRow","tableCell","tableCellHeader","tableSelection","Symbol","iterator","PluginCollection","builtinPlugins","plugins","pluginsToRemove","pluginConstructor","plugin","pluginsToLoad","init","instances","PluginConstruct","TypeError","instance","getConstructors","getPlugins","ComponentRegistry","callback","component","SchemeValidation","isNodeAllowed","parentCode","childCode","isChildAllowed","findAllowedParent","moveToNextParent","removeOnFail","handleNodeTransform","validation","nodeValidation","bbcodeTag","RichTextPlugin","registerRichText","ClipboardPlainTableNode","convertTableToPlainText","th","rows","row","cells","ClipboardPlugin","tablePluginExists","BoldPlugin","color","background","Browser","isMac","ItalicPlugin","StrikethroughPlugin","KEY_MODIFIER_COMMAND","UnderlinePlugin","CLEAR_FORMATTING_COMMAND","ClearFormatPlugin","extractedNodes","extract","idx","extractedTextNode","__style","__format","$getNearestBlockElementAncestorOrThrow","LinkEditor","linkEditorOptions","setLinkUrl","linkUrl","editMode","setEditMode","setAutoLinkMode","autoLinkMode","getLinkTextBox","getLinkLabel","href","getLinkUrl","CustomLinkNode","LinkNode","__url","rel","__rel","__target","__title","serializedLinkNode","$createCustomLinkNode","validateUrl","allowDomainRelativeUrl","URL_REGEX","INSERT_LINK_DIALOG_COMMAND","LinkPlugin","toPlainText","$createLinkNode","exportLinkNode","registerEventListener","TOGGLE_LINK_COMMAND","$toggleLink","originalUrl","lineNode","linkParent","$isAutoLinkNode","linkEditor","protocol","Validation","isEmail","currentSelection","setURL","onUnlink","clipboardText","startsWith","splitNodes","CustomAutoLinkNode","AutoLinkNode","isUnlinked","__isUnlinked","$createCustomAutoLinkNode","EMAIL_REGEX","MATCHERS","createLinkMatcherWithRegExp","AutoLinkPlugin","autolink","onChange","prevUrl","previous","handleLinkEdit","startsWithSeparator","handleLinkCreation","handleBadNeighbors","regExp","urlTransformer","findFirstMatch","matchers","matcher","PUNCTUATION_OR_SPACE","isSeparator","char","endsWithSeparator","startsWithFullStop","isPreviousNodeValid","isNextNodeValid","isContentAroundIsValid","matchStart","matchEnd","contentBeforeIsValid","nodeText","invalidMatchEnd","remainingTextNode","matchLength","isValid","linkTextNode","$createAutoLinkNode","getDetail","replaceWithChildren","setRel","previousSibling","j","TabIndentPlugin","triggerByTab","$isSelectionInList","$isListItemNode","ListPlugin","ListNode","ListItemNode","$createListNode","$createListItemNode","getListType","setValue","INSERT_ORDERED_LIST_COMMAND","insertList","INSERT_UNORDERED_LIST_COMMAND","REMOVE_LIST_COMMAND","removeList","$handleListInsertParagraph","totalDepth","COMMAND_PRIORITY_CRITICAL","elementNodesInSelection","$isListNode","$getListDepth","nodesInSelection","n","TableDialog","getGridContainer","getCaptionContainer","offsetWidth","buttons","column","hasClass","columns","box","boxRow","boxColumn","INSERT_TABLE_DIALOG_COMMAND","TablePlugin","TableNode","TableCellNode","TableRowNode","$createTableNode","$createTableRowNode","$createTableCellNode","TableCellHeaderStates","ROW","tablerow","tablecell","hasHeader","tableNode","tableCellNode","INSERT_TABLE_COMMAND","rowCount","toNumber","columnCount","$createTableNodeWithDimensions","tableSelections","initializeTableNode","tableElement","applyTableHandlers","$isTableNode","removeListeners","HashtagNode","$createHashtagNode","$isHashtagNode","HashtagPlugin","createHashtagNode","getHashtagMatch","hashtagLength","endOffset","registerLexicalTextEntity","$createNodesFromText","INSERT_COPILOT_DIALOG_COMMAND","CopilotStatus","INIT","LOADING","LOADED","CopilotPlugin","shouldTriggerBySpace","isCopilotLoaded","isCopilotLoading","isCopilotShown","onError","copilotIconClass","refreshIconClass","icon","resetRefresh","selectionText","editorPosition","selectedText","setSelectedText","wholeText","setContext","Promise","reject","resolve","Copilot","CopilotEvents","showResultInCopilot","FINISH_INIT","TEXT_SAVE","TEXT_PLACE_BELOW","HIDE","HistoryPlugin","historyState","createEmptyHistoryState","registerHistory","canUndo","UNDO_COMMAND","CAN_UNDO_COMMAND","canRedo","REDO_COMMAND","CAN_REDO_COMMAND","DOWNWARD","UPWARD","INDETERMINATE","BlockToolbarPlugin","getDropLine","scroller","onMouseMove","onMouseLeave","anchorElementRect","blockElem","topLevelNodeKeys","getChildrenKeys","elem","domRect","marginLeft","marginRight","marginTop","marginBottom","y","isOnTopSide","isOnBottomSide","isOnLeftSide","isOnRightSide","keysLength","opacity","transform","offsetTop","changed","$getNearestNodeFromDOMNode","hasFiles","types","targetBlockElement","draggedNode","targetBlockElemTop","targetBlockElemHeight","shouldInsertAfter","targetStyle","relativePosition","getRelativePosition","offsetParent","lineTop","showAtBottom","DROP_LINE_HALF_HEIGHT","CONTENT_EDITABLE_AREA_PADDING","Separator","Toolbar","toolbarOptions","ResizeObserver","renderTo","getItemsContainer","observe","getMoreBtnContainer","getMoreBtn","resetAnimation","scrollHeight","requestAnimationFrame","getItems","disconnect","unformattedNode","blockTypes","isReadOnly","reset","SELECTION_CHANGE_COMMAND","FOCUS_COMMAND","BLUR_COMMAND","activeElement","rootElement","lastItem","at","offsetHeight","blockType","listNode","parentList","$getNearestNodeOfType","FloatingToolbarPlugin","debounce","autoHideHandler","nativeSelection","isComposing","rawTextContent","isSomeDialogVisible","TOGGLE_TOOLBAR_COMMAND","SHOW_TOOLBAR_COMMAND","HIDE_TOOLBAR_COMMAND","ToolbarPlugin","getToolbar","getToolbarContainer","toggle","hideToolbar","PlaceholderPlugin","placeholder","paragraphPlaceholder","copilotPlugin","getPlugin","copilotEnabled","mentionPlugin","mentionEnabled","canShowPlaceholder","$canShowPlaceholder","lastEmptyParagraph","resetParagraphPlaceholder","htmlElement","CollapsingState","COLLAPSED","COLLAPSING","EXPANDED","EXPANDING","TextEditor","editorOptions","Cache","defaultOptions","getDefaultOptions","SettingsCollection","getBuiltinPlugins","extraPlugins","newLineMode","constructors","createEditor","namespace","flat","editable","setMinHeight","setMaxHeight","setAutoFocus","autoFocus","setVisualOptions","visualOptions","path","getThemeClasses","getSchemeValidation","setText","updateOptions","discrete","clearHistory","CLEAR_HISTORY_COMMAND","getText","bbCodeAst","flag","hasAutoFocus","getMinHeight","getMaxHeight","toKebabCase","getRootContainer","isCollapsingModeEnabled","animate","expand","getParagraphHeight","setRootElement","contentEditableElement","setEditorState","setEditable","blur","listener","klass","registerDecoratorListener","registerRootListener","eventType","eventListener","isCaptured","handleEvent","nearestNode","prevRootElement","callbackFn","hasFocus","defaultSelection","hasNodes","classes","getInnerContainer","getHeaderContainer","getFooterContainer","replaceNode","createDOMRange","selectionRects","createRectsFromDOMRange","selectionRectsLength","selectionRect","$refs","setPrototypeOf","initialEditorState","parsedEditorState","parseEditorState","editorNodes","removeListener","val","decorators","decorator","DecoratorClass","decoratorOptions","dirtyElements","dirtyLeaves","prevEditorState","tags","hasContentChanges","isInitialChange","hashCode","sort","currentValue","filePlugin","fileTag","DefaultBBCodeScheme","initialState","expanded","paragraphHeight","TextEditorComponent","props","editorInstance","default","setup","editorClass","provide","beforeCreate","hasOwnEditor","EditorClass","eventName","computed","headerContainer","footerContainer","watch","mounted","unmounted","BasicEditor","toolbar","BasicEditorComponent","extends","Plugins","Paragraph","AutoLink","BlockToolbar","Bold","Code","FloatingToolbar","History","Image","Italic","Link","List","Mention","Quote","Strikethrough","TabIndent","Underline","Video","Spoiler","Smiley","Table","Hashtag","File","Commands","AllCommands","Constants","AllConstants","Debug"],"mappings":"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"}