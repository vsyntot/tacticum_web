this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(e,t,n,s,i,r){"use strict";function o(e,t){if(!r.Type.isArray(e)){throw new TypeError("array is not a array")}if(!r.Type.isInteger(t)){throw new TypeError("index is not a integer")}const n=t<0?e.length+t:t;return e[n]}class c extends i.BBCodeScheme{getTagScheme(e){return new i.BBCodeTagScheme({name:"any"})}isAllowedTag(e){return true}isChildAllowed(e,t){return true}}const a=/\[(\/)?(\w+|\*)(.*?)]/gs;const l="\n";const h="\r\n";const d="\t";const u=e=>[l,h].includes(e);const f=e=>e===d;class p{static trimQuotes(e){const t=String(e);if(/^["'].*["']$/g.test(t)){return t.slice(1,-1)}return e}static toLowerCase(e){if(r.Type.isStringFilled(e)){return e.toLowerCase()}return e}tokenize(e){const t=[];const n=[];let s=0;e.replace(a,((i,r,o,c,a)=>{if(a>s){const n=e.slice(s,a);t.push(...this.parseText(n))}const l=Boolean(r)===false;const h=i.length+a;const d=this.parseAttributes(c);const u=p.toLowerCase(o);if(u==="list"&&l){n.push(false);t.push({type:"OPEN_TAG",name:u,value:d.value,attributes:Object.fromEntries(d.attributes)})}else if(u==="list"&&!l){if(n.length>0){if(n[n.length-1]){t.push({type:"CLOSE_TAG",name:"*"});n[n.length-1]=false}n.pop()}t.push({type:"CLOSE_TAG",name:u})}else if(u==="*"&&l){if(n.length>0){if(n[n.length-1]){t.push({type:"CLOSE_TAG",name:"*"})}n[n.length-1]=true}t.push({type:"OPEN_TAG",name:u,value:d.value,attributes:Object.fromEntries(d.attributes)})}else if(l){const n=e.slice(h);const s=!n.includes(`[/${o}]`);t.push({type:"OPEN_TAG",name:u,value:d.value,attributes:Object.fromEntries(d.attributes),unclosed:s})}else{t.push({type:"CLOSE_TAG",name:u})}s=h}));if(s<e.length){const n=e.slice(s);t.push(...this.parseText(n))}for(let e=n.length-1;e>=0;e--){if(n[e]){t.push({type:"CLOSE_TAG",name:"*"});n[e]=false}}return t}parseText(e){const t=[];if(r.Type.isStringFilled(e)){const n=/\\r\\n|\\n|\\t|\\.|.|\r\n|\n|\t/g;const s=[...e.matchAll(n)];let i="";for(const e of s){const n=e[0];if(u(n)){if(i){t.push({type:"TEXT",content:i});i=""}t.push({type:"LINEBREAK"})}else if(f(n)){if(i){t.push({type:"TEXT",content:i});i=""}t.push({type:"TAB"})}else{i+=n}}if(i){t.push({type:"TEXT",content:i})}}return t}parseAttributes(e){const t={value:"",attributes:[]};if(r.Type.isStringFilled(e)){if(e.startsWith("=")){t.value=p.trimQuotes(e.slice(1));return t}return e.trim().split(" ").filter(Boolean).reduce(((e,t)=>{const[n,s=""]=t.split("=");e.attributes.push([p.toLowerCase(n),p.trimQuotes(s)]);return e}),t)}return t}}const g=new c;class m{constructor(e={}){this.allowedLinkify=true;if(e.scheme){this.setScheme(e.scheme)}else{this.setScheme(new i.DefaultBBCodeScheme)}if(r.Type.isFunction(e.onUnknown)){this.setOnUnknown(e.onUnknown)}else{this.setOnUnknown(m.defaultOnUnknownHandler)}if(e.encoder instanceof n.BBCodeEncoder){this.setEncoder(e.encoder)}else{this.setEncoder(new n.BBCodeEncoder)}if(r.Type.isBoolean(e.linkify)){this.setIsAllowedLinkify(e.linkify)}}setScheme(e){this.scheme=e}getScheme(){return this.scheme}setOnUnknown(e){if(!r.Type.isFunction(e)){throw new TypeError("handler is not a function")}this.onUnknownHandler=e}getOnUnknownHandler(){return this.onUnknownHandler}setEncoder(e){if(e instanceof n.BBCodeEncoder){this.encoder=e}else{throw new TypeError("encoder is not BBCodeEncoder instance")}}getEncoder(){return this.encoder}setIsAllowedLinkify(e){this.allowedLinkify=Boolean(e)}isAllowedLinkify(){return this.allowedLinkify}canBeLinkified(e){if(e.getName()==="#text"){const n=["url","img","video","code"];const s=n.some((n=>Boolean(t.AstProcessor.findParentNodeByName(e,n))));return!s}return false}static defaultOnUnknownHandler(e,t){if(e.getType()===i.BBCodeNode.ELEMENT_NODE){const n=e.getName();if(["left","center","right","justify"].includes(n)){const n=t.createElement({name:"p"});e.replace(n);n.setChildren(e.getChildren())}else if(["background","color","size"].includes(n)){const n=t.createElement({name:"b"});e.replace(n);n.setChildren(e.getChildren())}else if(["span","font"].includes(n)){const n=t.createFragment({children:e.getChildren()});e.replace(n)}else{const n=e.getOpeningTag();const s=e.getClosingTag();e.replace(t.createText(n),...e.getChildren(),t.createText(s))}}}decodeAttributes(e){if(r.Type.isArrayFilled(e)){return e.map((([e,t])=>[e,this.getEncoder().decodeAttribute(t)]))}return e}parse(e){const t=new p;const n=t.tokenize(e);const r=g.createRoot();const c=[r];const a=[];let l=0;n.forEach((e=>{const t=c[l];switch(e.type){case"OPEN_TAG":{const n=this.getScheme().getTagScheme(e.name);const s=n&&n.isVoid();if(s){const n=g.createElement({name:e.name,value:this.getEncoder().decodeAttribute(e.value),attributes:this.decodeAttributes(e.attributes)});n.setScheme(this.getScheme());t.appendChild(n)}else if(e.unclosed){t.appendChild(g.createText(`[${e.name}]`))}else{const n=g.createElement({name:e.name,value:this.getEncoder().decodeAttribute(e.value),attributes:this.decodeAttributes(e.attributes)});t.appendChild(n);a.push(e.name);c.push(n);l++}break}case"CLOSE_TAG":{if(a.includes(e.name)){const t=a.indexOf(e.name);a.splice(t,1);c.pop();l--}else{t.appendChild(g.createText(`[/${e.name}]`))}break}case"TEXT":{t.appendChild(g.createText({content:this.getEncoder().decodeText(e.content)}));break}case"LINEBREAK":{t.appendChild(g.createNewLine());break}case"TAB":{t.appendChild(g.createTab());break}default:{break}}}));const h=e=>{let t=false;return e.getChildren().reduceRight(((e,n,s)=>{if(!t&&n.getName()==="#linebreak"){e.push(s)}else if(!t&&n.getName()!=="#tab"){t=true}return e}),[])};i.BBCodeNode.flattenAst(r).forEach((e=>{if(e.getName()==="*"){const t=h(e);if(t.length===1){e.setChildren(e.getChildren().slice(0,o(t,0)))}if(t.length>1&&(t&2)===0){e.setChildren(e.getChildren().slice(0,o(t,0)))}}if(this.isAllowedLinkify()&&this.canBeLinkified(e)){const t=e.toString({encode:false});const n=s.Linkify.tokenize(t);const i=n.map((e=>{if(e.t==="url"){return g.createElement({name:"url",value:e.toHref().replace(/^http:\/\//,"https://"),children:[g.createText(e.toString())]})}if(e.t==="email"){return g.createElement({name:"url",value:e.toHref(),children:[g.createText(e.toString())]})}return g.createText(e.toString())}));e.replace(...i)}}));i.BBCodeNode.flattenAst(r).forEach((e=>{const t=this.getScheme().getTagScheme(e);if(t){t.runOnParseHandler(e)}}));r.setScheme(this.getScheme(),this.getOnUnknownHandler());return r}}e.BBCodeParser=m})(this.BX.UI.BBCode=this.BX.UI.BBCode||{},BX.UI.BBCode,BX.UI.BBCode,BX.UI,BX.UI.BBCode,BX);
//# sourceMappingURL=parser.bundle.map.js