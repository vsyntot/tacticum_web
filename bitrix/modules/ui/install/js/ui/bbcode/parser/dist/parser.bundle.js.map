{"version":3,"file":"parser.bundle.js","sources":["../../shared/src/get-by-index.js","../src/parser-scheme.js","../src/tokenizer.js","../src/parser.js"],"sourcesContent":["import { Type } from 'main.core';\n\nexport function getByIndex<T>(array: Array<T>, index: number): ?T\n{\n\tif (!Type.isArray(array))\n\t{\n\t\tthrow new TypeError('array is not a array');\n\t}\n\n\tif (!Type.isInteger(index))\n\t{\n\t\tthrow new TypeError('index is not a integer');\n\t}\n\n\tconst preparedIndex = index < 0 ? array.length + index : index;\n\n\treturn array[preparedIndex];\n}\n","import { BBCodeScheme, BBCodeTagScheme, BBCodeNode } from 'ui.bbcode.model';\n\nexport class ParserScheme extends BBCodeScheme\n{\n\tgetTagScheme(tagName: string): BBCodeTagScheme\n\t{\n\t\treturn new BBCodeTagScheme({\n\t\t\tname: 'any',\n\t\t});\n\t}\n\n\tisAllowedTag(tagName: string): boolean\n\t{\n\t\treturn true;\n\t}\n\n\tisChildAllowed(parent: string | BBCodeNode, child: string | BBCodeNode): boolean\n\t{\n\t\treturn true;\n\t}\n}\n","import { Type } from 'main.core';\n\ntype BBCodeTokenType =\n\t| 'OPEN_TAG'\n\t| 'CLOSE_TAG'\n\t| 'TEXT'\n\t| 'LINEBREAK'\n\t| 'TAB';\n\ntype BaseBBCodeToken = {\n\ttype: BBCodeTokenType,\n};\n\ntype BBCodeOpenTagToken = BaseBBCodeToken & {\n\ttype: 'OPEN_TAG',\n\tname: string,\n\tvalue: ?string,\n\tattributes: {\n\t\t[key: string]: string,\n\t},\n\tunclosed: boolean,\n};\n\ntype BBCodeCloseTagToken = BaseBBCodeToken & {\n\ttype: 'CLOSE_TAG',\n};\n\ntype BBCodeTextToken = BaseBBCodeToken & {\n\ttype: 'TEXT',\n\tcontent: string,\n};\n\ntype BBCodeLinebreakToken = BaseBBCodeToken & {\n\ttype: 'LINEBREAK',\n};\n\ntype BBCodeTabToken = BaseBBCodeToken & {\n\ttype: 'TAB',\n};\n\nexport type BBCodeToken =\n\tBBCodeOpenTagToken\n\t| BBCodeCloseTagToken\n\t| BBCodeTextToken\n\t| BBCodeLinebreakToken\n\t| BBCodeTabToken;\n\nconst TAG_REGEX_GS: RegExp = /\\[(\\/)?(\\w+|\\*)(.*?)]/gs;\n\nconst LF = '\\n';\nconst CRLF = '\\r\\n';\nconst TAB = '\\t';\n\nconst isLinebreak = (symbol: string): boolean => {\n\treturn [LF, CRLF].includes(symbol);\n};\n\nconst isTab = (symbol: string): boolean => {\n\treturn symbol === TAB;\n};\n\nexport class BBCodeTokenizer\n{\n\tstatic trimQuotes(value: string): string\n\t{\n\t\tconst source = String(value);\n\t\tif ((/^[\"'].*[\"']$/g).test(source))\n\t\t{\n\t\t\treturn source.slice(1, -1);\n\t\t}\n\n\t\treturn value;\n\t}\n\n\tstatic toLowerCase(value: string): string\n\t{\n\t\tif (Type.isStringFilled(value))\n\t\t{\n\t\t\treturn value.toLowerCase();\n\t\t}\n\n\t\treturn value;\n\t}\n\n\ttokenize(bbcode: string): Array<BBCodeToken>\n\t{\n\t\tconst tokens: Array<BBCodeToken> = [];\n\t\tconst listNestingLevels: Array<boolean> = [];\n\n\t\tlet lastIndex = 0;\n\t\tbbcode.replace(TAG_REGEX_GS, (fullTag: string, slash: ?string, tagName: string, attrs: ?string, index: number) => {\n\t\t\tif (index > lastIndex)\n\t\t\t{\n\t\t\t\tconst textBetween = bbcode.slice(lastIndex, index);\n\t\t\t\ttokens.push(...this.parseText(textBetween));\n\t\t\t}\n\n\t\t\tconst isOpeningTag: boolean = Boolean(slash) === false;\n\t\t\tconst startIndex: number = fullTag.length + index;\n\t\t\tconst attributes = this.parseAttributes(attrs);\n\t\t\tconst lowerCaseTagName: string = BBCodeTokenizer.toLowerCase(tagName);\n\n\t\t\tif (lowerCaseTagName === 'list' && isOpeningTag)\n\t\t\t{\n\t\t\t\tlistNestingLevels.push(false);\n\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'OPEN_TAG',\n\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t\tvalue: attributes.value,\n\t\t\t\t\tattributes: Object.fromEntries(attributes.attributes),\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (lowerCaseTagName === 'list' && !isOpeningTag)\n\t\t\t{\n\t\t\t\tif (listNestingLevels.length > 0)\n\t\t\t\t{\n\t\t\t\t\tif (listNestingLevels[listNestingLevels.length - 1])\n\t\t\t\t\t{\n\t\t\t\t\t\ttokens.push({\n\t\t\t\t\t\t\ttype: 'CLOSE_TAG',\n\t\t\t\t\t\t\tname: '*',\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tlistNestingLevels[listNestingLevels.length - 1] = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tlistNestingLevels.pop();\n\t\t\t\t}\n\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'CLOSE_TAG',\n\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (lowerCaseTagName === '*' && isOpeningTag)\n\t\t\t{\n\t\t\t\tif (listNestingLevels.length > 0)\n\t\t\t\t{\n\t\t\t\t\tif (listNestingLevels[listNestingLevels.length - 1])\n\t\t\t\t\t{\n\t\t\t\t\t\ttokens.push({\n\t\t\t\t\t\t\ttype: 'CLOSE_TAG',\n\t\t\t\t\t\t\tname: '*',\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tlistNestingLevels[listNestingLevels.length - 1] = true;\n\t\t\t\t}\n\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'OPEN_TAG',\n\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t\tvalue: attributes.value,\n\t\t\t\t\tattributes: Object.fromEntries(attributes.attributes),\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (isOpeningTag)\n\t\t\t{\n\t\t\t\tconst nextContent: string = bbcode.slice(startIndex);\n\t\t\t\tconst unclosed: boolean = !nextContent.includes(`[/${tagName}]`);\n\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'OPEN_TAG',\n\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t\tvalue: attributes.value,\n\t\t\t\t\tattributes: Object.fromEntries(attributes.attributes),\n\t\t\t\t\tunclosed,\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'CLOSE_TAG',\n\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlastIndex = startIndex;\n\t\t});\n\n\t\tif (lastIndex < bbcode.length)\n\t\t{\n\t\t\tconst remainingText = bbcode.slice(lastIndex);\n\t\t\ttokens.push(...this.parseText(remainingText));\n\t\t}\n\n\t\tfor (let i = listNestingLevels.length - 1; i >= 0; i--)\n\t\t{\n\t\t\tif (listNestingLevels[i])\n\t\t\t{\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'CLOSE_TAG',\n\t\t\t\t\tname: '*',\n\t\t\t\t});\n\n\t\t\t\tlistNestingLevels[i] = false;\n\t\t\t}\n\t\t}\n\n\t\treturn tokens;\n\t}\n\n\tparseText(text: string): Array<BBCodeToken>\n\t{\n\t\tconst tokens: Array<BBCodeToken> = [];\n\n\t\tif (Type.isStringFilled(text))\n\t\t{\n\t\t\tconst regex = /\\\\r\\\\n|\\\\n|\\\\t|\\\\.|.|\\r\\n|\\n|\\t/g;\n\t\t\tconst matches = [...text.matchAll(regex)];\n\n\t\t\tlet textBuffer = '';\n\n\t\t\tfor (const match of matches)\n\t\t\t{\n\t\t\t\tconst char = match[0];\n\n\t\t\t\tif (isLinebreak(char))\n\t\t\t\t{\n\t\t\t\t\tif (textBuffer)\n\t\t\t\t\t{\n\t\t\t\t\t\ttokens.push({\n\t\t\t\t\t\t\ttype: 'TEXT',\n\t\t\t\t\t\t\tcontent: textBuffer,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\ttextBuffer = '';\n\t\t\t\t\t}\n\n\t\t\t\t\ttokens.push({\n\t\t\t\t\t\ttype: 'LINEBREAK',\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse if (isTab(char))\n\t\t\t\t{\n\t\t\t\t\tif (textBuffer)\n\t\t\t\t\t{\n\t\t\t\t\t\ttokens.push({\n\t\t\t\t\t\t\ttype: 'TEXT',\n\t\t\t\t\t\t\tcontent: textBuffer,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\ttextBuffer = '';\n\t\t\t\t\t}\n\n\t\t\t\t\ttokens.push({\n\t\t\t\t\t\ttype: 'TAB',\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\ttextBuffer += char;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (textBuffer)\n\t\t\t{\n\t\t\t\ttokens.push({\n\t\t\t\t\ttype: 'TEXT',\n\t\t\t\t\tcontent: textBuffer,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn tokens;\n\t}\n\n\tparseAttributes(sourceAttributes: string): { value: ?string, attributes: Array<[string, string]> }\n\t{\n\t\tconst result: {value: string, attributes: Array<Array<string, string>>} = { value: '', attributes: [] };\n\n\t\tif (Type.isStringFilled(sourceAttributes))\n\t\t{\n\t\t\tif (sourceAttributes.startsWith('='))\n\t\t\t{\n\t\t\t\tresult.value = BBCodeTokenizer.trimQuotes(\n\t\t\t\t\tsourceAttributes.slice(1),\n\t\t\t\t);\n\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn sourceAttributes\n\t\t\t\t.trim()\n\t\t\t\t.split(' ')\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.reduce((acc: typeof result, item: string) => {\n\t\t\t\t\tconst [key: string, value: string = ''] = item.split('=');\n\t\t\t\t\tacc.attributes.push([\n\t\t\t\t\t\tBBCodeTokenizer.toLowerCase(key),\n\t\t\t\t\t\tBBCodeTokenizer.trimQuotes(value),\n\t\t\t\t\t]);\n\n\t\t\t\t\treturn acc;\n\t\t\t\t}, result);\n\t\t}\n\n\t\treturn result;\n\t}\n}\n","import { Type } from 'main.core';\nimport { AstProcessor } from 'ui.bbcode.ast-processor';\nimport { getByIndex } from '../../shared';\nimport {\n\tBBCodeScheme,\n\tDefaultBBCodeScheme,\n\tBBCodeNode,\n\ttypeof BBCodeRootNode,\n\ttypeof BBCodeElementNode,\n\ttypeof BBCodeTextNode,\n\ttypeof BBCodeTagScheme,\n\ttype BBCodeContentNode,\n} from 'ui.bbcode.model';\nimport { BBCodeEncoder } from 'ui.bbcode.encoder';\nimport { Linkify } from 'ui.linkify';\nimport { ParserScheme } from './parser-scheme';\nimport { BBCodeTokenizer, type BBCodeToken } from './tokenizer';\n\nconst parserScheme = new ParserScheme();\n\ntype BBCodeParserOptions = {\n\tscheme?: BBCodeScheme,\n\tonUnknown?: (node: BBCodeContentNode, scheme: BBCodeScheme) => void,\n\tencoder?: BBCodeEncoder,\n\tlinkify?: boolean,\n};\n\nclass BBCodeParser\n{\n\tscheme: BBCodeScheme;\n\tencoder: BBCodeEncoder;\n\tonUnknownHandler: () => any;\n\tallowedLinkify: boolean = true;\n\n\tconstructor(options: BBCodeParserOptions = {})\n\t{\n\t\tif (options.scheme)\n\t\t{\n\t\t\tthis.setScheme(options.scheme);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setScheme(new DefaultBBCodeScheme());\n\t\t}\n\n\t\tif (Type.isFunction(options.onUnknown))\n\t\t{\n\t\t\tthis.setOnUnknown(options.onUnknown);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setOnUnknown(BBCodeParser.defaultOnUnknownHandler);\n\t\t}\n\n\t\tif (options.encoder instanceof BBCodeEncoder)\n\t\t{\n\t\t\tthis.setEncoder(options.encoder);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setEncoder(new BBCodeEncoder());\n\t\t}\n\n\t\tif (Type.isBoolean(options.linkify))\n\t\t{\n\t\t\tthis.setIsAllowedLinkify(options.linkify);\n\t\t}\n\t}\n\n\tsetScheme(scheme: BBCodeScheme)\n\t{\n\t\tthis.scheme = scheme;\n\t}\n\n\tgetScheme(): BBCodeScheme\n\t{\n\t\treturn this.scheme;\n\t}\n\n\tsetOnUnknown(handler: () => any)\n\t{\n\t\tif (!Type.isFunction(handler))\n\t\t{\n\t\t\tthrow new TypeError('handler is not a function');\n\t\t}\n\n\t\tthis.onUnknownHandler = handler;\n\t}\n\n\tgetOnUnknownHandler(): () => any\n\t{\n\t\treturn this.onUnknownHandler;\n\t}\n\n\tsetEncoder(encoder: BBCodeEncoder)\n\t{\n\t\tif (encoder instanceof BBCodeEncoder)\n\t\t{\n\t\t\tthis.encoder = encoder;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthrow new TypeError('encoder is not BBCodeEncoder instance');\n\t\t}\n\t}\n\n\tgetEncoder(): BBCodeEncoder\n\t{\n\t\treturn this.encoder;\n\t}\n\n\tsetIsAllowedLinkify(value: boolean)\n\t{\n\t\tthis.allowedLinkify = Boolean(value);\n\t}\n\n\tisAllowedLinkify(): boolean\n\t{\n\t\treturn this.allowedLinkify;\n\t}\n\n\tcanBeLinkified(node: BBCodeTextNode | BBCodeElementNode): boolean\n\t{\n\t\tif (node.getName() === '#text')\n\t\t{\n\t\t\tconst notAllowedNodeNames = ['url', 'img', 'video', 'code'];\n\t\t\tconst inNotAllowedNode = notAllowedNodeNames.some((name: string) => {\n\t\t\t\treturn Boolean(AstProcessor.findParentNodeByName(node, name));\n\t\t\t});\n\n\t\t\treturn !inNotAllowedNode;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tstatic defaultOnUnknownHandler(node: BBCodeContentNode, scheme: BBCodeScheme): ?Array<BBCodeContentNode>\n\t{\n\t\tif (node.getType() === BBCodeNode.ELEMENT_NODE)\n\t\t{\n\t\t\tconst nodeName: string = node.getName();\n\t\t\tif (['left', 'center', 'right', 'justify'].includes(nodeName))\n\t\t\t{\n\t\t\t\tconst newNode = scheme.createElement({\n\t\t\t\t\tname: 'p',\n\t\t\t\t});\n\t\t\t\tnode.replace(newNode);\n\t\t\t\tnewNode.setChildren(node.getChildren());\n\t\t\t}\n\t\t\telse if (['background', 'color', 'size'].includes(nodeName))\n\t\t\t{\n\t\t\t\tconst newNode = scheme.createElement({\n\t\t\t\t\tname: 'b',\n\t\t\t\t});\n\t\t\t\tnode.replace(newNode);\n\t\t\t\tnewNode.setChildren(node.getChildren());\n\t\t\t}\n\t\t\telse if (['span', 'font'].includes(nodeName))\n\t\t\t{\n\t\t\t\tconst fragment = scheme.createFragment({ children: node.getChildren() });\n\t\t\t\tnode.replace(fragment);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst openingTag: string = node.getOpeningTag();\n\t\t\t\tconst closingTag: string = node.getClosingTag();\n\n\t\t\t\tnode.replace(\n\t\t\t\t\tscheme.createText(openingTag),\n\t\t\t\t\t...node.getChildren(),\n\t\t\t\t\tscheme.createText(closingTag),\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tdecodeAttributes(sourceAttributes: Array<string, string>): Array<string, string>\n\t{\n\t\tif (Type.isArrayFilled(sourceAttributes))\n\t\t{\n\t\t\treturn sourceAttributes.map(([key, value]) => {\n\t\t\t\treturn [\n\t\t\t\t\tkey,\n\t\t\t\t\tthis.getEncoder().decodeAttribute(value),\n\t\t\t\t];\n\t\t\t});\n\t\t}\n\n\t\treturn sourceAttributes;\n\t}\n\n\tparse(bbcode: string): BBCodeRootNode\n\t{\n\t\tconst tokenizer = new BBCodeTokenizer();\n\t\tconst tokens = tokenizer.tokenize(bbcode);\n\n\t\tconst result: BBCodeRootNode = parserScheme.createRoot();\n\t\tconst stack = [result];\n\t\tconst wasOpened = [];\n\t\tlet level = 0;\n\n\t\ttokens.forEach((token: BBCodeToken) => {\n\t\t\tconst parent = stack[level];\n\n\t\t\tswitch (token.type)\n\t\t\t{\n\t\t\t\tcase 'OPEN_TAG': {\n\t\t\t\t\tconst tagScheme = this.getScheme().getTagScheme(token.name);\n\t\t\t\t\tconst isVoidTag = tagScheme && tagScheme.isVoid();\n\t\t\t\t\tif (isVoidTag)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst voidNode = parserScheme.createElement({\n\t\t\t\t\t\t\tname: token.name,\n\t\t\t\t\t\t\tvalue: this.getEncoder().decodeAttribute(token.value),\n\t\t\t\t\t\t\tattributes: this.decodeAttributes(token.attributes),\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tvoidNode.setScheme(this.getScheme());\n\t\t\t\t\t\tparent.appendChild(voidNode);\n\t\t\t\t\t}\n\t\t\t\t\telse if (token.unclosed)\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.appendChild(parserScheme.createText(`[${token.name}]`));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tconst currentNode = parserScheme.createElement({\n\t\t\t\t\t\t\tname: token.name,\n\t\t\t\t\t\t\tvalue: this.getEncoder().decodeAttribute(token.value),\n\t\t\t\t\t\t\tattributes: this.decodeAttributes(token.attributes),\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tparent.appendChild(currentNode);\n\t\t\t\t\t\twasOpened.push(token.name);\n\t\t\t\t\t\tstack.push(currentNode);\n\t\t\t\t\t\tlevel++;\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tcase 'CLOSE_TAG': {\n\t\t\t\t\tif (wasOpened.includes(token.name))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst openedTagIndex = wasOpened.indexOf(token.name);\n\t\t\t\t\t\twasOpened.splice(openedTagIndex, 1);\n\t\t\t\t\t\tstack.pop();\n\t\t\t\t\t\tlevel--;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.appendChild(parserScheme.createText(`[/${token.name}]`));\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tcase 'TEXT': {\n\t\t\t\t\tparent.appendChild(\n\t\t\t\t\t\tparserScheme.createText({\n\t\t\t\t\t\t\tcontent: this.getEncoder().decodeText(token.content),\n\t\t\t\t\t\t}),\n\t\t\t\t\t);\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tcase 'LINEBREAK': {\n\t\t\t\t\tparent.appendChild(parserScheme.createNewLine());\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tcase 'TAB': {\n\t\t\t\t\tparent.appendChild(parserScheme.createTab());\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tdefault: {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tconst getFinalLineBreaksIndexes = (node: BBCodeContentNode) => {\n\t\t\tlet skip = false;\n\n\t\t\treturn node\n\t\t\t\t.getChildren()\n\t\t\t\t.reduceRight((acc: Array<BBCodeContentNode>, child: BBCodeContentNode, index: number) => {\n\t\t\t\t\tif (!skip && child.getName() === '#linebreak')\n\t\t\t\t\t{\n\t\t\t\t\t\tacc.push(index);\n\t\t\t\t\t}\n\t\t\t\t\telse if (!skip && child.getName() !== '#tab')\n\t\t\t\t\t{\n\t\t\t\t\t\tskip = true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn acc;\n\t\t\t\t}, []);\n\t\t};\n\n\t\tBBCodeNode.flattenAst(result).forEach((node: BBCodeContentNode) => {\n\t\t\tif (node.getName() === '*')\n\t\t\t{\n\t\t\t\tconst finalLinebreaksIndexes: Array<number> = getFinalLineBreaksIndexes(node);\n\t\t\t\tif (finalLinebreaksIndexes.length === 1)\n\t\t\t\t{\n\t\t\t\t\tnode.setChildren(\n\t\t\t\t\t\tnode.getChildren().slice(0, getByIndex(finalLinebreaksIndexes, 0)),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (finalLinebreaksIndexes.length > 1 && (finalLinebreaksIndexes & 2) === 0)\n\t\t\t\t{\n\t\t\t\t\tnode.setChildren(\n\t\t\t\t\t\tnode.getChildren().slice(0, getByIndex(finalLinebreaksIndexes, 0)),\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tthis.isAllowedLinkify()\n\t\t\t\t&& this.canBeLinkified(node)\n\t\t\t)\n\t\t\t{\n\t\t\t\tconst content = node.toString({ encode: false });\n\t\t\t\tconst MultiTokens: Array<Linkify.MultiToken> = Linkify.tokenize(content);\n\n\t\t\t\tconst nodes = MultiTokens.map((token: Linkify.MultiToken) => {\n\t\t\t\t\tif (token.t === 'url')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn parserScheme.createElement({\n\t\t\t\t\t\t\tname: 'url',\n\t\t\t\t\t\t\tvalue: token.toHref().replace(/^http:\\/\\//, 'https://'),\n\t\t\t\t\t\t\tchildren: [\n\t\t\t\t\t\t\t\tparserScheme.createText(token.toString()),\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (token.t === 'email')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn parserScheme.createElement({\n\t\t\t\t\t\t\tname: 'url',\n\t\t\t\t\t\t\tvalue: token.toHref(),\n\t\t\t\t\t\t\tchildren: [\n\t\t\t\t\t\t\t\tparserScheme.createText(token.toString()),\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn parserScheme.createText(token.toString());\n\t\t\t\t});\n\n\t\t\t\tnode.replace(...nodes);\n\t\t\t}\n\t\t});\n\n\t\tBBCodeNode.flattenAst(result).forEach((node: BBCodeNode) => {\n\t\t\tconst tagScheme: BBCodeTagScheme = this.getScheme().getTagScheme(node);\n\t\t\tif (tagScheme)\n\t\t\t{\n\t\t\t\ttagScheme.runOnParseHandler(node);\n\t\t\t}\n\t\t});\n\n\t\tresult.setScheme(\n\t\t\tthis.getScheme(),\n\t\t\tthis.getOnUnknownHandler(),\n\t\t);\n\n\t\treturn result;\n\t}\n}\n\nexport {\n\tBBCodeParser,\n};\n"],"names":["getByIndex","array","index","Type","isArray","TypeError","isInteger","preparedIndex","length","ParserScheme","BBCodeScheme","getTagScheme","tagName","BBCodeTagScheme","name","isAllowedTag","isChildAllowed","parent","child","TAG_REGEX_GS","LF","CRLF","TAB","isLinebreak","symbol","includes","isTab","BBCodeTokenizer","trimQuotes","value","source","String","test","slice","toLowerCase","isStringFilled","tokenize","bbcode","tokens","listNestingLevels","lastIndex","replace","fullTag","slash","attrs","textBetween","push","parseText","isOpeningTag","Boolean","startIndex","attributes","parseAttributes","lowerCaseTagName","type","Object","fromEntries","pop","nextContent","unclosed","remainingText","i","text","regex","matches","matchAll","textBuffer","match","char","content","sourceAttributes","result","startsWith","trim","split","filter","reduce","acc","item","key","parserScheme","BBCodeParser","constructor","options","allowedLinkify","scheme","setScheme","DefaultBBCodeScheme","isFunction","onUnknown","setOnUnknown","defaultOnUnknownHandler","encoder","BBCodeEncoder","setEncoder","isBoolean","linkify","setIsAllowedLinkify","getScheme","handler","onUnknownHandler","getOnUnknownHandler","getEncoder","isAllowedLinkify","canBeLinkified","node","getName","notAllowedNodeNames","inNotAllowedNode","some","AstProcessor","findParentNodeByName","getType","BBCodeNode","ELEMENT_NODE","nodeName","newNode","createElement","setChildren","getChildren","fragment","createFragment","children","openingTag","getOpeningTag","closingTag","getClosingTag","createText","decodeAttributes","isArrayFilled","map","decodeAttribute","parse","tokenizer","createRoot","stack","wasOpened","level","forEach","token","tagScheme","isVoidTag","isVoid","voidNode","appendChild","currentNode","openedTagIndex","indexOf","splice","decodeText","createNewLine","createTab","getFinalLineBreaksIndexes","skip","reduceRight","flattenAst","finalLinebreaksIndexes","toString","encode","MultiTokens","Linkify","nodes","t","toHref","runOnParseHandler"],"mappings":"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"}