{"version":3,"file":"script.js","sources":["src/components/main.js","src/app.js"],"sourcesContent":["import { Type, Event } from 'main.core';\nimport { FileStatus, UploaderEvent } from 'ui.uploader.core';\nimport { TileWidgetComponent } from 'ui.uploader.tile-widget';\n\nexport { Main, AppContext };\n\ndeclare type AppContext = {\n\tid: number,\n\tentityId: string,\n\tentityValueId: string,\n\tfieldName: string,\n\tmultiple: boolean,\n\tsessionId: string,\n\tcontrollerOptions: Object\n};\n\nconst Main = {\n\tcomponents: {\n\t\tTileWidgetComponent,\n\t},\n\tdata(): Object\n\t{\n\t\treturn {\n\t\t\tdeletedValues: [],\n\t\t\tuploadedValues: [],\n\t\t\tuploadInProgress: false,\n\t\t};\n\t},\n\tprops: {\n\t\tfieldName: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tcontrolId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tcontext: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tvalues: {\n\t\t\ttype: Object,\n\t\t},\n\t},\n\n\tcomputed: {\n\t\tsessionInputName(): string\n\t\t{\n\t\t\treturn `${this.context.fieldName}_session_id`;\n\t\t},\n\t\tvalueInputName(): string\n\t\t{\n\t\t\treturn this.context.fieldName + (this.context.multiple ? '[]' : '');\n\t\t},\n\t\tdeletedValueInputName(): string\n\t\t{\n\t\t\treturn `${this.context.fieldName}_del${this.context.multiple ? '[]' : ''}`;\n\t\t},\n\t\tsessionId(): string\n\t\t{\n\t\t\treturn this.context.sessionId;\n\t\t},\n\t\tcurrentValues(): Array\n\t\t{\n\t\t\tconst values = [\n\t\t\t\t...this.values,\n\t\t\t\t...this.uploadedValues,\n\t\t\t];\n\n\t\t\treturn this.context.multiple ? values : values.slice(-1);\n\t\t},\n\t\tuploaderOptions(): Object\n\t\t{\n\t\t\treturn {\n\t\t\t\tcontroller: 'main.fileUploader.fieldFileUploaderController',\n\t\t\t\tcontrollerOptions: this.context.controllerOptions,\n\t\t\t\tfiles: this.values,\n\t\t\t\tevents: {\n\t\t\t\t\t[UploaderEvent.FILE_UPLOAD_COMPLETE]: (event) => {\n\t\t\t\t\t\tconst newFileId = event.getData()?.file?.getCustomData()?.realFileId;\n\t\t\t\t\t\tif (newFileId)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.uploadedValues.push(newFileId);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.emitChangeEvent();\n\t\t\t\t\t},\n\t\t\t\t\t[UploaderEvent.FILE_REMOVE]: (event) => {\n\t\t\t\t\t\tconst justUploadedDeletedFileId = event.getData()?.file?.getCustomData()?.realFileId;\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tjustUploadedDeletedFileId\n\t\t\t\t\t\t\t&& this.uploadedValues.includes(justUploadedDeletedFileId)\n\t\t\t\t\t\t) // just uploaded file was deleted\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.uploadedValues = this.uploadedValues.filter((id) => id !== justUploadedDeletedFileId);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst deletedFileId = event.getData()?.file?.getServerFileId();\n\n\t\t\t\t\t\tif (deletedFileId && Type.isInteger(deletedFileId)) // existed file was deleted\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.deletedValues.push(deletedFileId);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.emitChangeEvent();\n\t\t\t\t\t},\n\t\t\t\t\t[UploaderEvent.FILE_STATUS_CHANGE]: (event) => {\n\t\t\t\t\t\tconst files = event.getTarget()?.getFiles();\n\t\t\t\t\t\tif (!files)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst inProgress = files.some((file) => {\n\t\t\t\t\t\t\tconst status = file.getStatus();\n\n\t\t\t\t\t\t\treturn status === FileStatus.UPLOADING\n\t\t\t\t\t\t\t\t|| status === FileStatus.PREPARING\n\t\t\t\t\t\t\t\t|| status === FileStatus.PENDING\n\t\t\t\t\t\t\t\t|| status === FileStatus.UPLOADING\n\t\t\t\t\t\t\t;\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (this.uploadInProgress !== inProgress)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.uploadInProgress = inProgress;\n\t\t\t\t\t\t\tif (inProgress)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.emitUploadStartEvent();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.emitUploadCompleteEvent();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tmultiple: this.context.multiple,\n\t\t\t\tautoUpload: true,\n\t\t\t\ttreatOversizeImageAsFile: true,\n\t\t\t};\n\t\t},\n\t\twidgetOptions(): Object\n\t\t{\n\t\t\treturn {};\n\t\t},\n\t},\n\tmethods: {\n\t\temitChangeEvent(): void\n\t\t{\n\t\t\tBX.onCustomEvent(window, 'onUIEntityEditorUserFieldExternalChanged', [this.fieldName]);\n\t\t\tBX.onCustomEvent(window, 'onCrmEntityEditorUserFieldExternalChanged', [this.fieldName]);\n\t\t},\n\t\temitUploadStartEvent(): void\n\t\t{\n\t\t\tEvent.EventEmitter.emit('BX.UI.EntityEditor:onUserFieldFileUploadStart', { fieldName: this.fieldName });\n\t\t},\n\t\temitUploadCompleteEvent(): void\n\t\t{\n\t\t\tEvent.EventEmitter.emit('BX.UI.EntityEditor:onUserFieldFileUploadComplete', { fieldName: this.fieldName });\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"main-field-file-wrapper\">\n\t\t\t<input type=\"hidden\" :name=\"sessionInputName\" :value=\"sessionId\" />\n\t\t\t<input v-if=\"currentValues.length\" v-for=\"(value, index) in currentValues\" :key=\"index\" type=\"hidden\" :name=\"valueInputName\" :value=\"value\"/>\n\t\t\t<input v-else type=\"hidden\" :name=\"valueInputName\" />\n\n\t\t\t<input v-for=\"(value, index) in deletedValues\" :key=\"index\" type=\"hidden\" :name=\"deletedValueInputName\" :value=\"value\"/>\n\n\t\t\t<TileWidgetComponent\n\t\t\t\tref=\"uploader\"\n\t\t\t\t:uploaderOptions=\"uploaderOptions\"\n\t\t\t\t:widgetOptions=\"widgetOptions\"\n\t\t\t/>\n\t\t</div>\n\t`,\n};\n","import { Type } from 'main.core';\nimport { BitrixVue, VueCreateAppResult } from 'ui.vue3';\nimport { Main, AppContext } from './components/main';\n\ndeclare type AppConstructorParams = {\n\tfieldName: string,\n\tcontrolId: string,\n\tcontainerId: string,\n\tcontext: AppContext,\n\tvalue: Array,\n};\n\nexport class App\n{\n\t#app: ?VueCreateAppResult = null;\n\n\tconstructor(params: AppConstructorParams)\n\t{\n\t\tconst container = document.getElementById(params.containerId);\n\n\t\tif (!Type.isDomNode(container))\n\t\t{\n\t\t\tthrow new Error('container not found');\n\t\t}\n\n\t\tthis.#app = BitrixVue.createApp(\n\t\t\t{\n\t\t\t\t...Main,\n\t\t\t},\n\t\t\t{\n\t\t\t\tfieldName: params.fieldName,\n\t\t\t\tcontrolId: params.controlId,\n\t\t\t\tcontext: params.context,\n\t\t\t\tvalues: params.value.map((value) => parseInt(value, 10)),\n\t\t\t},\n\t\t);\n\n\t\tthis.#app.mount(container);\n\t}\n}\n"],"names":["Main","components","TileWidgetComponent","data","deletedValues","uploadedValues","uploadInProgress","props","fieldName","type","String","required","controlId","context","Object","values","computed","sessionInputName","valueInputName","multiple","deletedValueInputName","sessionId","currentValues","slice","uploaderOptions","controller","controllerOptions","files","events","UploaderEvent","FILE_UPLOAD_COMPLETE","event","newFileId","getData","file","getCustomData","realFileId","push","emitChangeEvent","FILE_REMOVE","justUploadedDeletedFileId","includes","filter","id","deletedFileId","getServerFileId","Type","isInteger","FILE_STATUS_CHANGE","getTarget","getFiles","inProgress","some","status","getStatus","FileStatus","UPLOADING","PREPARING","PENDING","emitUploadStartEvent","emitUploadCompleteEvent","autoUpload","treatOversizeImageAsFile","widgetOptions","methods","BX","onCustomEvent","window","Event","EventEmitter","emit","template","App","params","container","document","getElementById","containerId","isDomNode","Error","BitrixVue","createApp","value","map","parseInt","mount"],"mappings":"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"}