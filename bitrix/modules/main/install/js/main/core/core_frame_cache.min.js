(function(e){if(e.BX.frameCache)return;var a=e.BX;var t="compositeCache";var s=1440;var r=["bitrix_sessid","USER_ID","SERVER_TIME","USER_TZ_OFFSET","USER_TZ_AUTO"];var i="/bitrix/tools/composite_data.php";var n=false;a.frameCache=function(){};a.frameCache.localStorage=new a.LocalStorage({prefix:""});a.frameCache.init=function(){this.cacheDataBase=null;this.tableParams={tableName:"composite",fields:[{name:"id",unique:true},"content","hash","props"]};this.frameDataReceived=false;this.frameDataInserted=false;if(a.type.isString(e.frameDataString)&&e.frameDataString.length>0){a.frameCache.onFrameDataReceived(e.frameDataString)}this.vars=e.frameCacheVars?e.frameCacheVars:{dynamicBlocks:{},page_url:"",params:{},storageBlocks:[]};var i=a.frameCache.localStorage.get(t)||{};for(var n=0;n<r.length;n++){var o=r[n];if(typeof a.message[o]!="undefined"){i[o]=a.message[o]}}a.frameCache.localStorage.set(t,i,s);a.addCustomEvent("onBXMessageNotFound",(function(e){if(a.util.in_array(e,r)){var s=a.frameCache.localStorage.get(t);if(s&&typeof s[e]!="undefined"){a.message[e]=s[e]}else{a.frameCache.getCompositeMessages()}}}));if(!e.frameUpdateInvoked){this.update(false);e.frameUpdateInvoked=true}if(e.frameRequestStart){a.ready((function(){a.onCustomEvent("onCacheDataRequestStart");a.frameCache.tryUpdateSessid()}))}if(e.frameRequestFail){a.ready((function(){setTimeout((function(){a.onCustomEvent("onFrameDataRequestFail",[e.frameRequestFail])}),0)}))}a.frameCache.insertBanner()};a.frameCache.getCompositeMessages=function(){try{a.ajax({method:"GET",dataType:"json",url:i,async:false,data:"",onsuccess:function(e){a.frameCache.setCompositeVars(e)}})}catch(e){a.debug("Composite sync request failed.")}};a.frameCache.setCompositeVars=function(e){if(!e){return}else if(e.lang){e=e.lang}var i=a.frameCache.localStorage.get(t)||{};for(var n in e){if(e.hasOwnProperty(n)){a.message[n]=e[n];if(a.util.in_array(n,r)){i[n]=e[n]}}}a.frameCache.localStorage.set(t,i,s)};a.frameCache.insertBlock=function(e){if(!e){return}let t=null;const s="bxdynamic_";if(e.ID.startsWith(s)){const s=a(`${e.ID}_start`);const r=a(`${e.ID}_end`);if(!s||!r){a.debug(`Dynamic area ${e.ID} was not found`);return}t=[s,r]}else{t=a(e.ID);if(!t){a.debug(`Container ${e.ID} was not found`);return}}this.insertHTML(t,e);this.processInlineJS(e)};a.frameCache.insertHTML=function(e,t){if(a.Type.isArray(e)){const[s,r]=e;a.frameCache.removeNodes(s,r);s.insertAdjacentHTML("afterEnd",t.CONTENT)}else{if(t.PROPS.USE_ANIMATION){e.style.opacity=0;e.innerHTML=t.CONTENT;new a.easing({duration:1500,start:{opacity:0},finish:{opacity:100},transition:a.easing.makeEaseOut(a.easing.transitions.quart),step:a=>{e.style.opacity=a.opacity/100},complete:()=>{e.style.cssText=""}}).animate()}else{e.innerHTML=t.CONTENT}}};a.frameCache.processInlineJS=function(e){a.ajax.processRequestData(e.CONTENT,{scriptsRunFirst:false,dataType:"HTML"});if(a.Type.isArray(e.PROPS.BUNDLE_JS)){a.setJSList(e.PROPS.BUNDLE_JS)}if(a.Type.isArray(e.PROPS.BUNDLE_CSS)){a.setCSSList(e.PROPS.BUNDLE_CSS)}};a.frameCache.loadAssets=function(e,t){const s=[];const r=[];for(const t of e){const e=this.getStringAssets(t);if(a.Type.isStringFilled(e.html)){document.head.insertAdjacentHTML("beforeend",e.html)}a.evalGlobal(e.inlineJS.join(";"));r.push(...e.styles);if(a.Type.isArrayFilled(t.PROPS.CSS)){r.push(...t.PROPS.CSS)}s.push(...e.externalJS);if(a.Type.isArrayFilled(t.PROPS.JS)){s.push(...t.PROPS.JS)}}const i=[...r,...s];if(i.length>0){a.load(i,t)}else{t()}};a.frameCache.getStringAssets=function(e){const t={styles:[],inlineJS:[],externalJS:[],html:""};if(!a.Type.isArrayFilled(e.PROPS.STRINGS)){return t}const s=a.processHTML(e.PROPS.STRINGS.join(""),false);for(let e=0,a=s.SCRIPT.length;e<a;e++){const a=s.SCRIPT[e];if(a.isInternal){t.inlineJS.push(a.JS)}else{t.externalJS.push(a.JS)}}t.styles=s.STYLE;t.html=s.HTML;return t};a.frameCache.removeNodes=function(e,a){var t=false;var s=e.parentNode;var r=Array.prototype.slice.call(s.childNodes);for(var i=0,n=r.length;i<n;i++){if(t){if(r[i]===a){break}else{s.removeChild(r[i])}}else if(r[i]===e){t=true}}};a.frameCache.update=function(e,t){t=!!t;e=typeof e=="undefined"?true:e;if(e){this.requestData()}if(!t){a.ready(a.proxy((function(){if(!this.frameDataReceived){this.invokeCache()}}),this))}};a.frameCache.invokeCache=function(){if(this.vars.storageBlocks&&this.vars.storageBlocks.length>0){a.onCustomEvent(this,"onCacheInvokeBefore",[this.vars.storageBlocks]);this.readCacheWithID(this.vars.storageBlocks,a.proxy(this.insertFromCache,this))}};a.frameCache.handleResponse=function(t){if(t==null)return;a.onCustomEvent("onFrameDataReceivedBefore",[t]);if(a.Type.isArray(t.dynamicBlocks)){this.insertBlocks(t.dynamicBlocks,false);this.writeCache(t.dynamicBlocks)}a.onCustomEvent("onFrameDataReceived",[t]);if(t.isManifestUpdated=="1"&&this.vars.CACHE_MODE==="APPCACHE"&&e.applicationCache&&(e.applicationCache.status==e.applicationCache.IDLE||e.applicationCache.status==e.applicationCache.UPDATEREADY)){e.applicationCache.update()}if(t.htmlCacheChanged===true&&this.vars.CACHE_MODE==="HTMLCACHE"){a.onCustomEvent("onHtmlCacheChanged",[t])}if(a.type.isArray(t.spread)){for(var s=0;s<t.spread.length;s++){(new Image).src=t.spread[s]}}};a.frameCache.requestData=function(){var t=[{name:"BX-ACTION-TYPE",value:"get_dynamic"},{name:"BX-REF",value:document.referrer},{name:"BX-CACHE-MODE",value:this.vars.CACHE_MODE},{name:"BX-CACHE-BLOCKS",value:this.vars.dynamicBlocks?JSON.stringify(this.vars.dynamicBlocks):""}];if(this.vars.AUTO_UPDATE===false&&this.vars.AUTO_UPDATE_TTL&&this.vars.AUTO_UPDATE_TTL>0){var s=Date.parse(document.lastModified);if(!isNaN(s)){var r=(new Date).getTime();if(s+this.vars.AUTO_UPDATE_TTL*1e3<r){t.push({name:"BX-INVALIDATE-CACHE",value:"Y"})}}}if(this.vars.CACHE_MODE==="APPCACHE"){t.push({name:"BX-APPCACHE-PARAMS",value:JSON.stringify(this.vars.PARAMS)});t.push({name:"BX-APPCACHE-URL",value:this.vars.PAGE_URL?this.vars.PAGE_URL:""})}a.onCustomEvent("onCacheDataRequestStart");var i=e.location.href;var n=i.indexOf("#");if(n>0){i=i.substring(0,n)}i+=(i.indexOf("?")>=0?"&":"?")+"bxrand="+(new Date).getTime();a.ajax({timeout:60,method:"GET",url:i,data:{},headers:t,skipBxHeader:true,processData:false,onsuccess:a.proxy(a.frameCache.onFrameDataReceived,this),onfailure:function(){e.frameRequestFail={error:true,reason:"bad_response",url:i,xhr:this.xhr,status:this.xhr?this.xhr.status:0};a.onCustomEvent("onFrameDataRequestFail",[e.frameRequestFail])}})};a.frameCache.onFrameDataReceived=function(t){var s=null;try{s=JSON.parse(t)}catch(s){var r={error:true,reason:"bad_eval",response:t};e.frameRequestFail=r;a.ready((function(){setTimeout((function(){a.onCustomEvent("onFrameDataRequestFail",[r])}),0)}));return}this.frameDataReceived=true;if(s&&a.type.isNotEmptyString(s.redirect_url)){e.location=s.redirect_url;return}if(s&&s.error===true){e.frameRequestFail=s;a.ready(a.proxy((function(){setTimeout(a.proxy((function(){a.onCustomEvent("onFrameDataRequestFail",[s])}),this),0)}),this));return}a.frameCache.setCompositeVars(s);a.ready(a.proxy((function(){this.handleResponse(s);this.tryUpdateSessid()}),this))};a.frameCache.insertFromCache=function(e,t){if(!this.frameDataReceived){var s=e.items;if(s.length>0){for(var r=0;r<s.length;r++){s[r].PROPS=JSON.parse(s[r].PROPS)}this.insertBlocks(s,true)}a.onCustomEvent(this,"onCacheInvokeAfter",[this.vars.storageBlocks,e])}};a.frameCache.insertBlocks=function(t,s){const r=new Set;for(const e of t){a.onCustomEvent("onBeforeDynamicBlockUpdate",[e,s]);if(e.PROPS.AUTO_UPDATE===false){continue}if(e&&e.HASH&&e.PROPS&&e.PROPS.ID){this.vars.dynamicBlocks[e.PROPS.ID]=e.HASH}r.add(e)}this.loadAssets(r,(()=>{for(const e of r){this.insertBlock(e)}if(e.performance){const a=performance.getEntries();for(const e of a){if(e.initiatorType==="xmlhttprequest"&&e.name&&/bxrand=\d+/.test(e.name)){this.requestTiming=e}}if(e.performance.measure){e.performance.measure("Composite:LCP");const a=performance.getEntriesByName("Composite:LCP");if(a.length>0&&a[0].duration){this.lcp=Math.ceil(a[0].duration)}}}a.onCustomEvent("onFrameDataProcessed",[t,s]);this.frameDataInserted=true}))};a.frameCache.writeCache=function(e){for(var a=0;a<e.length;a++){if(e[a].PROPS.USE_BROWSER_STORAGE===true){this.writeCacheWithID(e[a].ID,e[a].CONTENT,e[a].HASH,JSON.stringify(e[a].PROPS))}}};a.frameCache.openDatabase=function(){var e=this.cacheDataBase!=null;if(!e){this.cacheDataBase=new a.Dexie("composite");if(this.cacheDataBase!=null){this.cacheDataBase.version(1).stores({composite:"&ID,CONTENT,HASH,PROPS"});e=true}}return e};a.frameCache.writeCacheWithID=function(e,t,s,r){if(a.frameCache.openDatabase()){if(typeof r=="object"){r=JSON.stringify(r)}this.cacheDataBase.composite.put({ID:e,CONTENT:t,HASH:s,PROPS:r})}};a.frameCache.readCacheWithID=function(e,t){if(a.frameCache.openDatabase()){this.cacheDataBase.composite.where("ID").anyOf(e).toArray().then(function(e){t({items:e})}.bind(this))}else if(typeof t!="undefined"){t({items:[]})}};a.frameCache.insertBanner=function(){if(!this.vars.banner||!a.type.isNotEmptyString(this.vars.banner.text)){return}a.ready(a.proxy((function(){var e=a.create("a",{props:{className:"bx-composite-btn"+(a.type.isNotEmptyString(this.vars.banner.style)?" bx-btn-"+this.vars.banner.style:""),href:this.vars.banner.url},attrs:{target:"_blank"},text:this.vars.banner.text});if(a.type.isNotEmptyString(this.vars.banner.bgcolor)){e.style.backgroundColor=this.vars.banner.bgcolor;if(a.util.in_array(this.vars.banner.bgcolor.toUpperCase(),["#FFF","#FFFFFF","WHITE"])){a.addClass(e,"bx-btn-border")}}var t=a("bx-composite-banner");if(t){t.appendChild(e)}else{a.addClass(e,"bx-composite-btn-fixed");document.body.appendChild(a.create("div",{style:{position:"relative"},children:[e]}))}}),this))};a.frameCache.tryUpdateSessid=function(){if(n){return}var e="bitrix_sessid";var s=false;if(typeof a.message[e]!="undefined"){s=a.message[e]}else{var r=a.frameCache.localStorage.get(t)||{};if(typeof r[e]!="undefined"){s=r[e]}}if(s!==false){n=true;this.updateSessid(s)}};a.frameCache.updateSessid=function(e){var a=document.getElementsByName("sessid");for(var t=0;t<a.length;t++){a[t].value=e}};a.frameCache.init()})(window);
//# sourceMappingURL=core_frame_cache.map.js