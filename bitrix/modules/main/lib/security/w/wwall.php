<? namespace Bitrix\Main\Security\W;$GLOBALS['____394824035']= array(base64_decode('dG'.'ltZQ='.'='),base64_decode('dGltZQ=='),base64_decode('an'.'Nvbl9'.'k'.'ZWNv'.'Z'.'G'.'U='),base64_decode('YXJ'.'yYXlfbWVyZ2U='),base64_decode('a'.'m9'.'pbg=='),base64_decode(''.'a'.'m9pb'.'g='.'='),base64_decode(''.'am'.'9pb'.'g'.'=='),base64_decode(''.'YXJyYXl'.'fc'.'G9'.'w'),base64_decode('YXJyY'.'Xlfc2hp'.'ZnQ='),base64_decode('Y'.'XJ'.'yYXlfc2hpZ'.'nQ='),base64_decode('YX'.'J'.'y'.'Y'.'Xl'.'fc'.'2hpZnQ'.'='),base64_decode('YXJyYXlfc'.'2hp'.'ZnQ='),base64_decode('YX'.'JyYXlfbW'.'VyZ'.'2U'.'='),base64_decode('aXNfYX'.'JyYX'.'k='),base64_decode('YXJy'.'YX'.'lfbW'.'VyZ2U='),base64_decode('aW5f'.'YXJ'.'y'.'YX'.'k='),base64_decode('aW5fYXJy'.'YXk='),base64_decode('aW5fYXJyYXk'.'='),base64_decode(''.'aW5fYXJ'.'yYXk='),base64_decode('aW'.'5'.'f'.'Y'.'XJyYXk='),base64_decode('dGl'.'tZQ=='),base64_decode('dGlt'.'ZQ=='),base64_decode('YXJy'.'YXl'.'f'.'bWF'.'w'),base64_decode('Z2V0'.'X'.'2x'.'v'.'Y'.'WR'.'l'.'ZF9leHRlbnNpb25z'),base64_decode('anN'.'vbl9l'.'b'.'mNvZG'.'U='),base64_decode('an'.'Nvbl9lbmNvZ'.'GU='),base64_decode('cGh'.'wd'.'mVyc2lv'.'bg=='),base64_decode('anNvb'.'l9lbm'.'Nv'.'ZGU'.'='),base64_decode('am9p'.'bg=='));if(!function_exists(__NAMESPACE__.'\\___1957060247')){function ___1957060247($_252515380){static $_484706935= false; if($_484706935 == false) $_484706935=array('V1d'.'BT'.'E'.'xfTE9DS'.'w'.'==','c2'.'V'.'jdXJ'.'pdHk'.'=','REFU'.'Q'.'Q==',''.'ey'.'I=',''.'V1dBTExfTE'.'9D'.'Sw==',''.'c2Vjd'.'XJp'.'dHk=',''.'U0VD'.'V'.'V'.'JJVFlf'.'V1'.'dBTEx'.'f'.'R'.'VhDRV'.'BUS'.'U9'.'O','Rk'.'F'.'JT'.'F9'.'DSEVDS0lORw='.'=','Q2F'.'u'.'IG'.'5vd'.'CBleG'.'Vjd'.'XRlIHd3YW'.'xsIHJ'.'1bGVzO'.'iA=',''.'IFR'.'yYWN'.'lOi'.'A=','U'.'kVRVUVTV'.'F9VUkk=','a'.'2V5'.'cw==','d'.'m'.'FsdWVz','U0VDVVJJ'.'VFlfV1dB'.'TExfT'.'U9'.'E'.'S'.'UZZ','L'.'g==','U0VD'.'VVJJVFlfV1'.'dB'.'TE'.'xfV'.'U5TRV'.'Q=','L'.'g==','U0VDV'.'V'.'JJ'.'VFlfV'.'1dBTE'.'xfRVhJV'.'A==',''.'L'.'g==','Z'.'2xvYmFs','a2V5cw==','d'.'mF'.'sdWV'.'z','Z'.'2V'.'0','Z'.'2V0','cG9'.'zdA==',''.'c'.'G9zdA==','Y29'.'va2ll','Y29va2ll',''.'cmV'.'xdWVzdA'.'==','cm'.'VxdWVzdA==','Z2xvY'.'m'.'Fs','Z2xvYmF'.'s','b'.'WFp'.'b'.'l'.'9zZ'.'WM'.'=','V'.'1dBTExfQUNUVUFMSVpFX1JVT'.'EVT','d'.'g'.'='.'=','dmVyc'.'2lvbg==',''.'aQ==','aXNJbnN0YWxsZWQ=','d'.'g'.'==','aW5p','b'.'W'.'9kd'.'Wxlc'.'w'.'==',''.'b'.'GljZW5'.'z'.'Z'.'Q='.'=','c'.'Ghw','d'.'g==','ZX'.'h0','c2VjdXJpd'.'Hk=','ZG'.'I=','dHl'.'wZQ==','ZG'.'I=','dmVyc2lvbg==','ZGI=','dHlwZQ==','Z'.'G'.'I=','dH'.'lwZQ'.'==','dmVyc2lvbg==','ZG'.'I'.'=',''.'dm'.'Vy'.'c2lv'.'bg==','ZW52'.'aXJ'.'vbm1l'.'bnQ'.'=','dm1fdmV'.'yc'.'2lvbg==','dm0=','d'.'g==','ZW5'.'2'.'aXJ'.'vbm'.'1'.'lbn'.'Q'.'=','dm1fdmVyc2l'.'v'.'bg==','c'.'2'.'9j'.'a2V0VGl'.'t'.'ZW'.'91dA==','c3RyZWFtV'.'Gl'.'tZW91dA'.'==','KCc=',''.'ZGF0'.'YQ'.'==','J'.'ywg'.'Jw==','b'.'W'.'9kd'.'Wxl',''.'J'.'ywgJ'.'w==',''.'bW9k'.'dWxlX3Zlc'.'nNp'.'b'.'24'.'=','Jyk=','LCA=','U0VDV'.'V'.'JJVFlfV'.'1dBTExfR'.'VhDRVBUSU9O','bWFpbg'.'==','R'.'kFJ'.'TF'.'9S'.'RUZ'.'SRV'.'NISU5'.'H',''.'Q2FuIG5v'.'d'.'CByZW'.'Z'.'yZXNo'.'IHd3YWx'.'sI'.'HJ1bG'.'VzOi'.'A=','I'.'FRy'.'Y'.'WNlOiA=','Z'.'GF0YQ==','ey'.'I'.'=','L'.'S0tLS1CR'.'U'.'dJTi'.'BQVU'.'J'.'MSUMg'.'S0VZ'.'LS'.'0'.'tLS'.'0=','Ck'.'1J'.'SU'.'JJak'.'FOQm'.'drcWhraU'.'c'.'5dz'.'BCQVFFRkFBT'.'0'.'NB'.'U'.'ThBT'.'Ul'.'JQkNn'.'S'.'0N'.'BUUVB'.'c'.'ThRRTBIam1ISlVTdFdW'.'Nm4we'.'m'.'EKU'.'lZvTHgwMkt6'.'YmZyYlMvUDZzV2F'.'4VHp'.'3OFN'.'lR1'.'R0YlRDT3'.'J'.'wSGk'.'1'.'U'.'UY2'.'T1J5a'.'lo'.'vWH'.'h6L0tMV'.'TFHYm'.'9mO'.'UNaMwo0ejdTa'.'3FVdDY2aWJYd'.'k9GQ'.'n'.'g0ZncvQVBQ'.'UkdE'.'c'.'XRtM'.'G'.'5EM'.'2ZnR3N1M1Jl'.'U'.'Gd3'.'M'.'jlpO'.'Ct2'.'bT'.'dtdEJ'.'L'.'SlVZb'.'DRyClZ'.'wYjZzZlpFVD'.'lLRWI2VDFIRFltRXZj'.'MWhxL2lpdXl4TH'.'Ja'.'Wmk1UTZ'.'VZmY0VUV2VEk'.'r'.'N'.'jh'.'zc0ZSa1Erb'.'3'.'d'.'UU'.'nkK'.'ZU9'.'JTW'.'JGaE0vVV'.'RtZ'.'lZZY'.'lRSR'.'nkyb1V'.'ROFdNe'.'mEybko'.'1U2F'.'oe'.'mkx'.'VUtPMW'.'pBal'.'h'.'UUFJyemM3QW'.'p'.'1'.'NjM5aj'.'F'.'PMAp'.'w'.'c'.'HFm'.'bTV4Z'.'1dsRkFKa0'.'hRV'.'GdiZG'.'Q1QVdxREZR'.'a3'.'Q5SEtrWStU'.'bm'.'ZC'.'TEdW'.'TXZWeVB3VE'.'hO'.'V'.'1FZQX'.'c0eHBnL3dBClp3SU'.'RBUU'.'FC'.'Ci'.'0tL'.'S0tRU5'.'EIFBVQkxJQyB'.'LRVktLS0tLQ='.'=');return base64_decode($_484706935[$_252515380]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_606086713= true; public function handle(){ try{  $_716367371= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_716367371)){ return;}  $_417972640= Cache::createInstance(); $_132508267= false; if($_417972640->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1470324056= $_417972640->getVars(); if($GLOBALS['____394824035'][0]()- $_1470324056> round(0+6.6666666666667+6.6666666666667+6.6666666666667)){  $_1148977598= Application::getConnection(); $_1847311887= RuleRecordTable::getTableName(); $_1148977598->truncateTable($_1847311887); RuleRecordTable::cleanCache(); $_417972640->clean(___1957060247(0), ___1957060247(1));}} elseif($_417972640->startDataCache()){  $_417972640->endDataCache($GLOBALS['____394824035'][1]()); $_132508267= true;} foreach($_716367371 as $_1274590209){ $_1551315058= new PublicKeyCipher; $_1544334984= $_1551315058->decrypt($_1274590209[___1957060247(2)], static::__798564710()); if(!str_starts_with($_1544334984, ___1957060247(3))){ continue;} $_877706510= $GLOBALS['____394824035'][2]($_1544334984, true); if(!empty($_877706510)){ $_1312038253= Rule::make($_877706510); $_194823824= $this->handleRule($_1312038253); $this->applyHandlingResults($_194823824);}}  if($_132508267){ $_417972640->clean(___1957060247(4), ___1957060247(5));}} catch(\Throwable $_1985028858){ $this->logEvent( ___1957060247(6), ___1957060247(7), ___1957060247(8). $_1985028858->getMessage(). ___1957060247(9). $_1985028858->getTraceAsString());}}  public function handleRule(Rule $_1312038253): array{ $_194823824=[]; if($_1312038253->matchPath($_SERVER[___1957060247(10)])){  $_88340790= $this->getContextElements($_1312038253->getContext()); foreach($_88340790 as $_1959229317 => &$_2143921665){ $_194823824= $GLOBALS['____394824035'][3]($_194823824, $this->recursiveContextKeyHandle($_1959229317, $_2143921665,[], $_1312038253));}} return $_194823824;}  public function applyHandlingResults(array $_194823824){ $_88340790= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_194823824 as $_769897237){ $_2143921665=& $_88340790[$_769897237->getContextName()]; $_42304954= $_769897237->getRuleResult(); $_1312038253= $_769897237->getRule(); if($_42304954 instanceof ModifyResult){ if($_1312038253->getProcess() === ___1957060247(11)){  static::rewriteContextKey( $_769897237->getContextName(), $_2143921665, $_769897237->getContextKey(), $_42304954->getCleanValue());} elseif($_1312038253->getProcess() === ___1957060247(12)){ static::rewriteContextValue( $_769897237->getContextName(), $_2143921665, $_769897237->getContextKey(), $_42304954->getCleanValue());} $this->logEvent( ___1957060247(13), $_769897237->getContextName(), $GLOBALS['____394824035'][4](___1957060247(14), $_769897237->getContextKey()));} elseif($_42304954 instanceof CheckResult &&!$_42304954->isSuccess()){ if($_42304954->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_769897237->getContextName(), $_2143921665, $_769897237->getContextKey(),); $this->logEvent( ___1957060247(15), $_769897237->getContextName(), $GLOBALS['____394824035'][5](___1957060247(16), $_769897237->getContextKey()));} elseif($_42304954->getAction() === RuleAction::EXIT){ $this->logEvent( ___1957060247(17), $_769897237->getContextName(), $GLOBALS['____394824035'][6](___1957060247(18), $_769897237->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_606086713= false;} protected function rewriteContextKey($_1959229317, &$_2143921665, $_2146486042, $_2000216775){ $_1460072465= $_2146486042;  $GLOBALS['____394824035'][7]($_1460072465); $_1460072465[]= $_2000216775; if($_1959229317 === ___1957060247(19)){ $_764889862= $GLOBALS['____394824035'][8]($_2146486042); $GLOBALS['____394824035'][9]($_1460072465); if(empty($_2146486042)){ $GLOBALS[$_2000216775]= $GLOBALS[$_764889862]; unset($GLOBALS[$_764889862]);} else{ $_2143921665=& $GLOBALS[$_764889862]; $_1570970613= ArrayHelper::getByNestedKey($_2143921665, $_2146486042);  ArrayHelper::setByNestedKey($_2143921665, $_1460072465, $_1570970613);  ArrayHelper::unsetByNestedKey($_2143921665, $_2146486042);}} else{ $_1570970613= ArrayHelper::getByNestedKey($_2143921665, $_2146486042);  ArrayHelper::setByNestedKey($_2143921665, $_1460072465, $_1570970613);  ArrayHelper::unsetByNestedKey($_2143921665, $_2146486042);}} protected function rewriteContextValue($_1959229317, &$_2143921665, $_1530772, $_1570970613){ if($_1959229317 === 'global'){ $_764889862= $GLOBALS['____394824035'][10]($_1530772); if(empty($_1530772)){ $GLOBALS[$_764889862]= $_1570970613;} else{ $_2143921665=& $GLOBALS[$_764889862]; ArrayHelper::setByNestedKey($_2143921665, $_1530772, $_1570970613);}} else{  ArrayHelper::setByNestedKey($_2143921665, $_1530772, $_1570970613);}} protected function unsetContextValue($_1959229317, &$_2143921665, $_1530772){ if($_1959229317 === 'global'){ $_764889862= $GLOBALS['____394824035'][11]($_1530772); if(empty($_1530772)){ unset($GLOBALS[$_764889862]);} else{ $_2143921665=& $GLOBALS[$_764889862]; ArrayHelper::unsetByNestedKey($_2143921665, $_1530772);}} else{ ArrayHelper::unsetByNestedKey($_2143921665, $_1530772);}}  protected function recursiveContextKeyHandle(string $_1959229317, array &$_2143921665, array $_1809676813, Rule $_1312038253): array{  $_194823824=[]; foreach($_2143921665 as $_1213186787 => $_1570970613){ $_1530772= $GLOBALS['____394824035'][12]($_1809676813,[$_1213186787]); if($_1312038253->matchKey($_1530772)){  if($_1312038253->getProcess() === ___1957060247(20)){ $_42304954= $_1312038253->evaluate($_1213186787);} elseif($_1312038253->getProcess() === ___1957060247(21)){ $_42304954= $_1312038253->evaluateValue($_1570970613);}  if(!empty($_42304954) && $_42304954 instanceof RuleResult){ $_194823824[]= new HandlingResult($_1959229317, $_1530772, $_42304954, $_1312038253);}}  if($GLOBALS['____394824035'][13]($_1570970613)){ $_194823824= $GLOBALS['____394824035'][14]($_194823824, $this->recursiveContextKeyHandle( $_1959229317, $_2143921665[$_1213186787], $_1530772, $_1312038253));}} return $_194823824;} protected function getContextElements(array $_1074048802){ $_801462318=[]; if($GLOBALS['____394824035'][15](___1957060247(22), $_1074048802, true)){ $_801462318[___1957060247(23)]= &$_GET;} if($GLOBALS['____394824035'][16](___1957060247(24), $_1074048802, true)){ $_801462318[___1957060247(25)]= &$_POST;} if($GLOBALS['____394824035'][17](___1957060247(26), $_1074048802, true)){ $_801462318[___1957060247(27)]= &$_COOKIE;} if($GLOBALS['____394824035'][18](___1957060247(28), $_1074048802, true)){ $_801462318[___1957060247(29)]= &$_REQUEST;} if($GLOBALS['____394824035'][19](___1957060247(30), $_1074048802, true)){ $_801462318[___1957060247(31)]= $GLOBALS;} return $_801462318;} public static function refreshRules(){ try{ $_1332412390= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____394824035'][20]()- $_1332412390)< static::CACHE_RULES_TTL){ return;} Option::set(___1957060247(32), ___1957060247(33), $GLOBALS['____394824035'][21]()); $_682747291= null;  $_383228862= $GLOBALS['____394824035'][22](function($_1256448863){ return[___1957060247(34) => $_1256448863[___1957060247(35)], ___1957060247(36) => (int) $_1256448863[___1957060247(37)]];}, ModuleManager::getModulesFromDisk());  $_362705772=[]; foreach($GLOBALS['____394824035'][23]() as $_2041827822){ $_45277225= new ReflectionExtension($_2041827822); $_362705772[$_2041827822]=[ ___1957060247(38) => $_45277225->getVersion(), ___1957060247(39) => $_45277225->getINIEntries()];} $_341797973=[ ___1957060247(40) => $GLOBALS['____394824035'][24]($_383228862), ___1957060247(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1957060247(42) => $GLOBALS['____394824035'][25]([ ___1957060247(43) => $GLOBALS['____394824035'][26](), ___1957060247(44) => $_362705772])]; if(Loader::includeModule(___1957060247(45))){ $_45044306= CSecuritySystemInformation::getSystemInformation(); if(isset($_45044306[___1957060247(46)][___1957060247(47)]) && isset($_45044306[___1957060247(48)][___1957060247(49)])){ $_341797973[___1957060247(50)]=[ ___1957060247(51) => $_45044306[___1957060247(52)][___1957060247(53)], ___1957060247(54) => $_45044306[___1957060247(55)][___1957060247(56)]];} if(isset($_45044306[___1957060247(57)][___1957060247(58)])){ $_341797973[___1957060247(59)]=[___1957060247(60) => $_45044306[___1957060247(61)][___1957060247(62)]];}}  $_1563327332= new HttpClient([ ___1957060247(63) => round(0+5), ___1957060247(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_314509460=(new UrlProvider())->getTechDomain(); $_840082258="https://wwall.{$_314509460}/rules.php"; $_1325408918= $_1563327332->post($_840082258, $_341797973); if($_1563327332->getStatus() == round(0+40+40+40+40+40) &&!empty($_1325408918)){ $_682747291= Json::decode($_1325408918);}  if($_682747291 !== null){ $_1148977598= Application::getConnection(); $_1847311887= RuleRecordTable::getTableName(); if(!empty($_682747291)){ foreach($_682747291 as $_905984815){ if(!static::checkRuleSign($_905984815)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____394824035'][27]($_905984815));}}}  $_1148977598->truncateTable($_1847311887);  if(!empty($_682747291)){ $_266805053=[]; foreach($_682747291 as $_905984815){ $_266805053[]= ___1957060247(65). $_1148977598->getSqlHelper()->forSql($_905984815[___1957060247(66)]). ___1957060247(67). $_1148977598->getSqlHelper()->forSql($_905984815[___1957060247(68)]). ___1957060247(69). $_1148977598->getSqlHelper()->forSql($_905984815[___1957060247(70)]). ___1957060247(71);} $_2021662718= $GLOBALS['____394824035'][28](___1957060247(72), $_266805053);  $_1148977598->query("INSERT INTO {$_1847311887} (DATA, MODULE, MODULE_VERSION) VALUES {$_2021662718}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1985028858){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1957060247(73), ___1957060247(74), ___1957060247(75), ___1957060247(76). $_1985028858->getMessage(). ___1957060247(77). $_1985028858->getTraceAsString());}} protected static function checkRuleSign($_1312038253){ $_1551315058= new PublicKeyCipher; $_877706510= $_1551315058->decrypt($_1312038253[___1957060247(78)], static::__798564710()); return str_starts_with($_877706510, ___1957060247(79));} private static function __798564710(){ $_587692175= ''; $_587692175 .= ___1957060247(80); $_587692175 .= ___1957060247(81); return $_587692175;} protected function logEvent($_1134738335, $_2124653581, $_467875744){ if($this->_606086713){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1134738335, 'main', $_2124653581, $_467875744);}}}?>